<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>1.3 预处理指令 - 文件导入、宏定义、环境变量读取 | 洞香春</title>
<meta name=keywords content="all"><meta name=description content='预处理指令主要的目的是方便脚本维护，方便脚本在不同环境下运行。
预处理之后，脚本才会开始解析。
1. include_file
   include_file "path_to_file"

Include the content of the file in config before parsing. path_to_file
must be a static string. Including file operation is done at startup. If
you change the content of included file, you have to restart the SIP
server to become effective.

路径必须是静态，修改脚本要重启
The path_to_file can be relative or absolute. If it is not absolute
path, first attempt is to locate it relative to current directory, and
if fails, relative to directory of the file that includes it. There is
no restriction where include can be used or what can contain - any part
of config file is ok. There is a limit of maximum 10 includes in depth,
otherwise you can use as many includes as you want. Reporting of the cfg
file syntax errors prints now the file name for easier troubleshooting.'><meta name=author content="Eddie Wang"><link rel=canonical href=https://wdd.js.org/kamailio/56/pre-processor/><link crossorigin=anonymous href=/assets/css/stylesheet.821c51435cba3e33e49e590a06514c54c32ac7957095ffcc1e0f390c47cf3228.css integrity="sha256-ghxRQ1y6PjPknlkKBlFMVMMqx5Vwlf/MHg85DEfPMig=" rel="preload stylesheet" as=style><link rel=icon href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/cowboy.ico><link rel=apple-touch-icon href=https://wdd.js.org/cowboy.ico><link rel=mask-icon href=https://wdd.js.org/cowboy.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://wdd.js.org/kamailio/56/pre-processor/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://wdd.js.org/kamailio/56/pre-processor/"><meta property="og:site_name" content="洞香春"><meta property="og:title" content="1.3 预处理指令 - 文件导入、宏定义、环境变量读取"><meta property="og:description" content='预处理指令主要的目的是方便脚本维护，方便脚本在不同环境下运行。 预处理之后，脚本才会开始解析。
1. include_file include_file "path_to_file" Include the content of the file in config before parsing. path_to_file must be a static string. Including file operation is done at startup. If you change the content of included file, you have to restart the SIP server to become effective.
路径必须是静态，修改脚本要重启
The path_to_file can be relative or absolute. If it is not absolute path, first attempt is to locate it relative to current directory, and if fails, relative to directory of the file that includes it. There is no restriction where include can be used or what can contain - any part of config file is ok. There is a limit of maximum 10 includes in depth, otherwise you can use as many includes as you want. Reporting of the cfg file syntax errors prints now the file name for easier troubleshooting.'><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="kamailio"><meta property="article:tag" content="All"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="1.3 预处理指令 - 文件导入、宏定义、环境变量读取"><meta name=twitter:description content='预处理指令主要的目的是方便脚本维护，方便脚本在不同环境下运行。
预处理之后，脚本才会开始解析。
1. include_file
   include_file "path_to_file"

Include the content of the file in config before parsing. path_to_file
must be a static string. Including file operation is done at startup. If
you change the content of included file, you have to restart the SIP
server to become effective.

路径必须是静态，修改脚本要重启
The path_to_file can be relative or absolute. If it is not absolute
path, first attempt is to locate it relative to current directory, and
if fails, relative to directory of the file that includes it. There is
no restriction where include can be used or what can contain - any part
of config file is ok. There is a limit of maximum 10 includes in depth,
otherwise you can use as many includes as you want. Reporting of the cfg
file syntax errors prints now the file name for easier troubleshooting.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"新朋友 - kamailio学习笔记","item":"https://wdd.js.org/kamailio/"},{"@type":"ListItem","position":2,"name":"Kamailio 5.6 Wiki","item":"https://wdd.js.org/kamailio/56/"},{"@type":"ListItem","position":3,"name":"1.3 预处理指令 - 文件导入、宏定义、环境变量读取","item":"https://wdd.js.org/kamailio/56/pre-processor/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"1.3 预处理指令 - 文件导入、宏定义、环境变量读取","name":"1.3 预处理指令 - 文件导入、宏定义、环境变量读取","description":"预处理指令主要的目的是方便脚本维护，方便脚本在不同环境下运行。 预处理之后，脚本才会开始解析。\n1. include_file include_file \u0026quot;path_to_file\u0026quot; Include the content of the file in config before parsing. path_to_file must be a static string. Including file operation is done at startup. If you change the content of included file, you have to restart the SIP server to become effective.\n路径必须是静态，修改脚本要重启\nThe path_to_file can be relative or absolute. If it is not absolute path, first attempt is to locate it relative to current directory, and if fails, relative to directory of the file that includes it. There is no restriction where include can be used or what can contain - any part of config file is ok. There is a limit of maximum 10 includes in depth, otherwise you can use as many includes as you want. Reporting of the cfg file syntax errors prints now the file name for easier troubleshooting.\n","keywords":["all"],"articleBody":"预处理指令主要的目的是方便脚本维护，方便脚本在不同环境下运行。 预处理之后，脚本才会开始解析。\n1. include_file include_file \"path_to_file\" Include the content of the file in config before parsing. path_to_file must be a static string. Including file operation is done at startup. If you change the content of included file, you have to restart the SIP server to become effective.\n路径必须是静态，修改脚本要重启\nThe path_to_file can be relative or absolute. If it is not absolute path, first attempt is to locate it relative to current directory, and if fails, relative to directory of the file that includes it. There is no restriction where include can be used or what can contain - any part of config file is ok. There is a limit of maximum 10 includes in depth, otherwise you can use as many includes as you want. Reporting of the cfg file syntax errors prints now the file name for easier troubleshooting.\n在出现语法错误时，会打印原始文件名，方便调试\nIf the included file is not found, the config file parser throws error. You can find this error message at the logging destination, usually in the system logging (file).\nYou can use also the syntax #!include_file or !!include_file.\nExample of usage:\nroute { ... include_file \"/sr/checks.cfg\" ... } --- /sr/checks.cfg --- if (!mf_process_maxfwd_header(\"10\")) { sl_send_reply(\"483\",\"Too Many Hops\"); exit; } --- 2. import_file import_file \"path_to_file\" Similar to include_file, but does not throw error if the included file is not found.\n3. define Control in C-style what parts of the config file are executed. The parts in non-defined zones are not loaded, ensuring lower memory usage and faster execution.\nAvailable directives:\n#!define NAME - define a keyword #!define NAME VALUE - define a keyword with value #!ifdef NAME - check if a keyword is defined #!ifndef - check if a keyword is not defined #!else - switch to false branch of ifdef/ifndef region #!endif - end ifdef/ifndef region #!trydef - add a define if not already defined #!redefine - force redefinition even if already defined Predefined keywords:\nKAMAILIO_X[_Y[_Z]] - Kamailio versions MOD_X - when module X has been loaded See ‘kamctl core.ppdefines_full’ for full list.\nAmong benefits:\neasy way to enable/disable features (e.g., see default cfg – controlling support of nat traversal, presence, etc…) switch control for parts where conditional statements were not possible (e.g., global parameters, module settings) faster by not using conditional statements inside routing blocks when switching between running environments Example: how to make config to be used in two environments, say testbed and production, controlled just by one define to switch between the two modes:\n... #!define TESTBED_MODE #!ifdef TESTBED_MODE debug=5 log_stderror=yes listen=192.168.1.1 #!else debug=2 log_stderror=no listen=10.0.0.1 #!endif ... #!ifdef TESTBED_MODE modparam(\"acc|auth_db|usrloc\", \"db_url\", \"mysql://kamailio:kamailiorw@localhost/kamailio_testbed\") #!else modparam(\"acc|auth_db|usrloc\", \"db_url\", \"mysql://kamailio:kamailiorw@10.0.0.2/kamailio_production\") #!endif ... #!ifdef TESTBED_MODE route[DEBUG] { xlog(\"SCRIPT: SIP $rm from: $fu to: $ru - srcip: $si\"\\n); } #!endif ... route { #!ifdef TESTBED_MODE route(DEBUG); #!endif ... } ... you can define values for IDs #!define MYINT 123 #!define MYSTR \"xyz\" defined IDs are replaced at startup, during config parsing, e.g.,: $var(x) = 100 + MYINT; is interpreted as: $var(x) = 100 + 123; you can have multi-line defined IDs #!define IDLOOP $var(i) = 0; \\ while($var(i)\u003c5) { \\ xlog(\"++++ $var(i)\\n\"); \\ $var(i) = $var(i) + 1; \\ } then in routing block route { ... IDLOOP ... } number of allowed defines is now set to 256 notes: multilines defines are reduced to single line, so line counter should be fine column counter goes inside the define value, but you have to omit the ‘\\’ and CR for the accurate inside-define position text on the same line as the directive will cause problems. Keep the directive lines clean and only comment on a line before or after. if using git to pull the kamailio.cfg to your machine, make sure that #!endif is NOT the last line of your config file. this causes a “different number of preprocessor directives” error. if you need, put a comment line after the #!endif line 4. defenv Preprocessor directive to define an ID to the value of an environment variable with the name ENVVAR.\n这里你思考一下，如果定义的环境变量不存在，会发生什么？\n#!defenv ID=ENVVAR It can also be just $!defenv ENVVAR and the defined ID is the ENVVAR name.\nExample:\n#!defenv SHELL If environment variable $SHELL is ‘/bin/bash’, then it is like:\n#!define SHELL /bin/bash Full expression variant:\n#!defenv ENVSHELL=SHELL Then it is like:\n#!define ENVSHELL /bin/bash It is a simplified alternative of using #!substdef with $env(NAME) in the replacement part.\n5. defenvs Similar to #!defenv, but the value is defined in between double quotes to make it convenient to be used as a string token.\n#!defenvs ENVVAR #!defenvs ID=ENVVAR 6. subst perform substitutions inside the strings of config (note that define is replacing only IDs - alphanumeric tokens not enclosed in quotes) #!subst offers an easy way to search and replace inside strings before cfg parsing. E.g.,: #!subst \"/regexp/subst/flags\" flags is optional and can be: ‘i’ - ignore case; ‘g’ - global replacement Example:\n#!subst \"/DBPASSWD/xyz/\" modparam(\"acc\", \"db_url\", \"mysql://user:DBPASSWD@localhost/db\") will do the substitution of db password in db_url parameter value 7. substdef #!substdef \"/ID/subst/\" Similar to subst, but in addition it adds a #!define ID subst.\n8. substdefs #!substdefs \"/ID/subst/\" Similar to subst, but in addition it adds a #!define ID “subst” (note the difference from #!substdef that the value for define is enclosed in double quotes, useful when the define is used in a place for a string value).\n9. trydefenv #!trydefenv ID=ENVVAR Similar to defenv, but will not error if the environmental variable is not set. This allows for boolean defines via system ENVVARs. For example, using an environmental variable to toggle loading of db_mysql:\n#!trydefenv WITH_MYSQL #!ifdef WITH_MYSQL loadmodule \"db_mysql.so\" #!ifdef 10. trydefenvs Similar to #!trydefenv, but the value is defined in between double quotes to make it convenient to be used as a string token.\n#!trydefenvs ENVVAR #!trydefenvs ID=ENVVAR ","wordCount":"952","inLanguage":"en","image":"https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"Eddie Wang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wdd.js.org/kamailio/56/pre-processor/"},"publisher":{"@type":"Organization","name":"洞香春","logo":{"@type":"ImageObject","url":"https://wdd.js.org/cowboy.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org/ accesskey=h title="洞香春 (Alt + H)"><img src=https://wdd.js.org/cowboy.ico alt aria-label=logo height=35>洞香春</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wdd.js.org/books/ title=读书><span>读书</span></a></li><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/golang/ title=Golang><span>Golang</span></a></li><li><a href=https://wdd.js.org/kamailio/ title=Kamailio><span>Kamailio</span></a></li><li><a href=https://wdd.js.org/kamailio/56/ title="Kamailio 5.6 wiki"><span>Kamailio 5.6 wiki</span></a></li><li><a href=https://wdd.js.org/network/ title=Network><span>Network</span></a></li><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/categories/ title=分类><span>分类</span></a></li><li><a href=https://wdd.js.org/fe/ title=前端><span>前端</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wdd.js.org/>Home</a>&nbsp;»&nbsp;<a href=https://wdd.js.org/kamailio/>新朋友 - kamailio学习笔记</a>&nbsp;»&nbsp;<a href=https://wdd.js.org/kamailio/56/>Kamailio 5.6 Wiki</a></div><h1 class="post-title entry-hint-parent">1.3 预处理指令 - 文件导入、宏定义、环境变量读取</h1><div class=post-meta>5 min&nbsp;·&nbsp;Eddie Wang&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/kamailio/56/pre-processor/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#1-include_file aria-label="1. include_file">1. include_file</a></li><li><a href=#2-import_file aria-label="2. import_file">2. import_file</a></li><li><a href=#3-define aria-label="3. define">3. define</a></li><li><a href=#4-defenv aria-label="4. defenv">4. defenv</a></li><li><a href=#5-defenvs aria-label="5. defenvs">5. defenvs</a></li><li><a href=#6-subst aria-label="6. subst">6. subst</a></li><li><a href=#7-substdef aria-label="7. substdef">7. substdef</a></li><li><a href=#8-substdefs aria-label="8. substdefs">8. substdefs</a></li><li><a href=#9-trydefenv aria-label="9. trydefenv">9. trydefenv</a></li><li><a href=#10-trydefenvs aria-label="10. trydefenvs">10. trydefenvs</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>预处理指令主要的目的是方便脚本维护，方便脚本在不同环境下运行。
预处理之后，脚本才会开始解析。</p><h1 id=1-include_file>1. include_file<a hidden class=anchor aria-hidden=true href=#1-include_file>#</a></h1><pre><code>   include_file &quot;path_to_file&quot;
</code></pre><p>Include the content of the file in config before parsing. path_to_file
must be a static string. Including file operation is done at startup. If
you change the content of included file, you have to restart the SIP
server to become effective.</p><blockquote><p>路径必须是静态，修改脚本要重启</p></blockquote><p>The path_to_file can be relative or absolute. If it is not absolute
path, first attempt is to locate it relative to current directory, and
if fails, relative to directory of the file that includes it. There is
no restriction where include can be used or what can contain - any part
of config file is ok. There is a limit of maximum 10 includes in depth,
otherwise you can use as many includes as you want. Reporting of the cfg
file syntax errors prints now the file name for easier troubleshooting.</p><blockquote><p>在出现语法错误时，会打印原始文件名，方便调试</p></blockquote><p>If the included file is not found, the config file parser throws error.
You can find this error message at the logging destination, usually in
the system logging (file).</p><p>You can use also the syntax <strong>#!include_file</strong> or <strong>!!include_file</strong>.</p><p>Example of usage:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>route {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    include_file <span style=color:#e6db74>&#34;/sr/checks.cfg&#34;</span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>---</span> <span style=color:#f92672>/</span>sr<span style=color:#f92672>/</span>checks.cfg <span style=color:#f92672>---</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>mf_process_maxfwd_header</span>(<span style=color:#e6db74>&#34;10&#34;</span>)) {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>sl_send_reply</span>(<span style=color:#e6db74>&#34;483&#34;</span>,<span style=color:#e6db74>&#34;Too Many Hops&#34;</span>);
</span></span><span style=display:flex><span>       exit;
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>---</span>
</span></span></code></pre></div><h1 id=2-import_file>2. import_file<a hidden class=anchor aria-hidden=true href=#2-import_file>#</a></h1><pre><code>   import_file &quot;path_to_file&quot;
</code></pre><p>Similar to <strong>include_file</strong>, but does not throw error if the included
file is not found.</p><h1 id=3-define>3. define<a hidden class=anchor aria-hidden=true href=#3-define>#</a></h1><p>Control in C-style what parts of the config file are executed. The parts
in non-defined zones are not loaded, ensuring lower memory usage and
faster execution.</p><p>Available directives:</p><ul><li><strong>#!define NAME</strong> - define a keyword</li><li><strong>#!define NAME VALUE</strong> - define a keyword with value</li><li><strong>#!ifdef NAME</strong> - check if a keyword is defined</li><li><strong>#!ifndef</strong> - check if a keyword is not defined</li><li><strong>#!else</strong> - switch to false branch of ifdef/ifndef region</li><li><strong>#!endif</strong> - end ifdef/ifndef region</li><li><strong>#!trydef</strong> - add a define if not already defined</li><li><strong>#!redefine</strong> - force redefinition even if already defined</li></ul><p>Predefined keywords:</p><ul><li><strong>KAMAILIO_X[_Y[_Z]]</strong> - Kamailio versions</li><li><strong>MOD_X</strong> - when module X has been loaded</li></ul><p>See &lsquo;kamctl core.ppdefines_full&rsquo; for full list.</p><p>Among benefits:</p><ul><li>easy way to enable/disable features (e.g., see default cfg &ndash;
controlling support of nat traversal, presence, etc&mldr;)</li><li>switch control for parts where conditional statements were not
possible (e.g., global parameters, module settings)</li><li>faster by not using conditional statements inside routing blocks
when switching between running environments</li></ul><p>Example: how to make config to be used in two environments, say testbed
and production, controlled just by one define to switch between the two
modes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!define TESTBED_MODE
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!ifdef TESTBED_MODE
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  debug<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>  log_stderror<span style=color:#f92672>=</span>yes
</span></span><span style=display:flex><span>  listen<span style=color:#f92672>=</span><span style=color:#ae81ff>192.168.1.1</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!else
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  debug<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  log_stderror<span style=color:#f92672>=</span>no
</span></span><span style=display:flex><span>  listen<span style=color:#f92672>=</span><span style=color:#ae81ff>10.0.0.1</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!ifdef TESTBED_MODE
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>modparam</span>(<span style=color:#e6db74>&#34;acc|auth_db|usrloc&#34;</span>, <span style=color:#e6db74>&#34;db_url&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;mysql://kamailio:kamailiorw@localhost/kamailio_testbed&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>#!else
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>modparam</span>(<span style=color:#e6db74>&#34;acc|auth_db|usrloc&#34;</span>, <span style=color:#e6db74>&#34;db_url&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;mysql://kamailio:kamailiorw@10.0.0.2/kamailio_production&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>#!endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!ifdef TESTBED_MODE
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>route[DEBUG] {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>xlog</span>(<span style=color:#e6db74>&#34;SCRIPT: SIP $rm from: $fu to: $ru - srcip: $si&#34;</span><span style=color:#960050;background-color:#1e0010>\</span>n);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>#!endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>route {
</span></span><span style=display:flex><span><span style=color:#75715e>#!ifdef TESTBED_MODE
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>route</span>(DEBUG);
</span></span><span style=display:flex><span><span style=color:#75715e>#!endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><ul><li>you can define values for IDs</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#!define MYINT 123
</span></span></span><span style=display:flex><span><span style=color:#75715e>#!define MYSTR &#34;xyz&#34;
</span></span></span></code></pre></div><ul><li>defined IDs are replaced at startup, during config parsing, e.g.,:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>var</span>(x) <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span> <span style=color:#f92672>+</span> MYINT;
</span></span></code></pre></div><ul><li>is interpreted as:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>var</span>(x) <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>123</span>;
</span></span></code></pre></div><ul><li>you can have multi-line defined IDs</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#!define IDLOOP $var(i) = 0; \
</span></span></span><span style=display:flex><span><span style=color:#75715e>                while($var(i)&lt;5) { \
</span></span></span><span style=display:flex><span><span style=color:#75715e>                    xlog(&#34;++++ $var(i)\n&#34;); \
</span></span></span><span style=display:flex><span><span style=color:#75715e>                    $var(i) = $var(i) + 1; \
</span></span></span><span style=display:flex><span><span style=color:#75715e>                }
</span></span></span></code></pre></div><ul><li>then in routing block</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>route {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    IDLOOP
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>number of allowed defines is now set to 256</li></ul><ul><li>notes:<ul><li>multilines defines are reduced to single line, so line counter
should be fine</li><li>column counter goes inside the define value, but you have to
omit the &lsquo;\&rsquo; and CR for the accurate inside-define position</li><li>text on the same line as the directive will cause problems. Keep
the directive lines clean and only comment on a line before or
after.</li><li>if using git to pull the kamailio.cfg to your machine, make
sure that #!endif is NOT the last line of your config file.
this causes a &ldquo;different number of preprocessor directives&rdquo;
error. if you need, put a comment line after the #!endif line</li></ul></li></ul><h1 id=4-defenv>4. defenv<a hidden class=anchor aria-hidden=true href=#4-defenv>#</a></h1><p>Preprocessor directive to define an ID to the value of an environment
variable with the name ENVVAR.</p><blockquote><p>这里你思考一下，如果定义的环境变量不存在，会发生什么？</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#!defenv ID=ENVVAR
</span></span></span></code></pre></div><p>It can also be just <strong>$!defenv ENVVAR</strong> and the defined ID is the ENVVAR
name.</p><p>Example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#!defenv SHELL
</span></span></span></code></pre></div><p>If environment variable $SHELL is &lsquo;/bin/bash&rsquo;, then it is like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#!define SHELL /bin/bash
</span></span></span></code></pre></div><p>Full expression variant:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#!defenv ENVSHELL=SHELL
</span></span></span></code></pre></div><p>Then it is like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#!define ENVSHELL /bin/bash
</span></span></span></code></pre></div><p>It is a simplified alternative of using <strong>#!substdef</strong> with
<strong>$env(NAME)</strong> in the replacement part.</p><h1 id=5-defenvs>5. defenvs<a hidden class=anchor aria-hidden=true href=#5-defenvs>#</a></h1><p>Similar to <strong>#!defenv</strong>, but the value is defined in between double
quotes to make it convenient to be used as a string token.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#!defenvs ENVVAR
</span></span></span><span style=display:flex><span><span style=color:#75715e>#!defenvs ID=ENVVAR
</span></span></span></code></pre></div><h1 id=6-subst>6. subst<a hidden class=anchor aria-hidden=true href=#6-subst>#</a></h1><ul><li>perform substitutions inside the strings of config (note that define
is replacing only IDs - alphanumeric tokens not enclosed in quotes)</li><li><code>#!subst</code> offers an easy way to search and replace inside strings
before cfg parsing. E.g.,:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#!subst &#34;/regexp/subst/flags&#34;
</span></span></span></code></pre></div><ul><li>flags is optional and can be: &lsquo;i&rsquo; - ignore case; &lsquo;g&rsquo; - global
replacement</li></ul><p>Example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#!subst &#34;/DBPASSWD/xyz/&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>modparam</span>(<span style=color:#e6db74>&#34;acc&#34;</span>, <span style=color:#e6db74>&#34;db_url&#34;</span>, <span style=color:#e6db74>&#34;mysql://user:DBPASSWD@localhost/db&#34;</span>)
</span></span></code></pre></div><ul><li>will do the substitution of db password in db_url parameter value</li></ul><h1 id=7-substdef>7. substdef<a hidden class=anchor aria-hidden=true href=#7-substdef>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#!substdef &#34;/ID/subst/&#34;
</span></span></span></code></pre></div><p>Similar to <strong>subst</strong>, but in addition it adds a <strong>#!define ID subst</strong>.</p><h1 id=8-substdefs>8. substdefs<a hidden class=anchor aria-hidden=true href=#8-substdefs>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#!substdefs &#34;/ID/subst/&#34;
</span></span></span></code></pre></div><p>Similar to <strong>subst</strong>, but in addition it adds a <strong>#!define ID &ldquo;subst&rdquo;</strong>
(note the difference from <code>#!substdef</code> that the value for define is
enclosed in double quotes, useful when the define is used in a place for
a string value).</p><h1 id=9-trydefenv>9. trydefenv<a hidden class=anchor aria-hidden=true href=#9-trydefenv>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#!trydefenv ID=ENVVAR
</span></span></span></code></pre></div><p>Similar to <strong>defenv</strong>, but will not error if the environmental variable
is not set. This allows for boolean defines via system ENVVARs. For
example, using an environmental variable to toggle loading of db_mysql:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#!trydefenv WITH_MYSQL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!ifdef WITH_MYSQL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>loadmodule <span style=color:#e6db74>&#34;db_mysql.so&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!ifdef
</span></span></span></code></pre></div><h1 id=10-trydefenvs>10. trydefenvs<a hidden class=anchor aria-hidden=true href=#10-trydefenvs>#</a></h1><p>Similar to <strong>#!trydefenv</strong>, but the value is defined in between double
quotes to make it convenient to be used as a string token.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#!trydefenvs ENVVAR
</span></span></span><span style=display:flex><span><span style=color:#75715e>#!trydefenvs ID=ENVVAR
</span></span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://wdd.js.org/tags/all/>All</a></li></ul></footer><script src=https://giscus.app/client.js data-repo=wangduanduan/wangduanduan.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxMTkyMjMyNjA=" data-category=Announcements data-category-id=DIC_kwDOBxsz3M4CAjBq data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2025 <a href=https://wdd.js.org/>洞香春</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>