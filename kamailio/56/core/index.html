<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>1. 核心概念 | 洞香春</title>
<meta name=keywords content="all"><meta name=description content='1.16. Custom Global Parameters
These are parameters that can be defined by the writer of kamailio.cfg
in order to be used inside routing blocks. One of the important
properties for custom global parameters is that their value can be
changed at runtime via RPC commands, without restarting Kamailio.
The definition of a custom global parameter must follow the pattern:
group.variable = value desc "description"

The value can be a quoted string or integer number.'><meta name=author content="Eddie Wang"><link rel=canonical href=https://wdd.js.org/kamailio/56/core/><link crossorigin=anonymous href=/assets/css/stylesheet.821c51435cba3e33e49e590a06514c54c32ac7957095ffcc1e0f390c47cf3228.css integrity="sha256-ghxRQ1y6PjPknlkKBlFMVMMqx5Vwlf/MHg85DEfPMig=" rel="preload stylesheet" as=style><link rel=icon href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/cowboy.ico><link rel=apple-touch-icon href=https://wdd.js.org/cowboy.ico><link rel=mask-icon href=https://wdd.js.org/cowboy.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://wdd.js.org/kamailio/56/core/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://wdd.js.org/kamailio/56/core/"><meta property="og:site_name" content="洞香春"><meta property="og:title" content="1. 核心概念"><meta property="og:description" content='1.16. Custom Global Parameters These are parameters that can be defined by the writer of kamailio.cfg in order to be used inside routing blocks. One of the important properties for custom global parameters is that their value can be changed at runtime via RPC commands, without restarting Kamailio.
The definition of a custom global parameter must follow the pattern:
group.variable = value desc "description" The value can be a quoted string or integer number.'><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="kamailio"><meta property="article:tag" content="All"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="1. 核心概念"><meta name=twitter:description content='1.16. Custom Global Parameters
These are parameters that can be defined by the writer of kamailio.cfg
in order to be used inside routing blocks. One of the important
properties for custom global parameters is that their value can be
changed at runtime via RPC commands, without restarting Kamailio.
The definition of a custom global parameter must follow the pattern:
group.variable = value desc "description"

The value can be a quoted string or integer number.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"新朋友 - kamailio学习笔记","item":"https://wdd.js.org/kamailio/"},{"@type":"ListItem","position":2,"name":"Kamailio 5.6 Wiki","item":"https://wdd.js.org/kamailio/56/"},{"@type":"ListItem","position":3,"name":"1. 核心概念","item":"https://wdd.js.org/kamailio/56/core/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"1. 核心概念","name":"1. 核心概念","description":"1.16. Custom Global Parameters These are parameters that can be defined by the writer of kamailio.cfg in order to be used inside routing blocks. One of the important properties for custom global parameters is that their value can be changed at runtime via RPC commands, without restarting Kamailio.\nThe definition of a custom global parameter must follow the pattern:\ngroup.variable = value desc \u0026quot;description\u0026quot; The value can be a quoted string or integer number.\n","keywords":["all"],"articleBody":"1.16. Custom Global Parameters These are parameters that can be defined by the writer of kamailio.cfg in order to be used inside routing blocks. One of the important properties for custom global parameters is that their value can be changed at runtime via RPC commands, without restarting Kamailio.\nThe definition of a custom global parameter must follow the pattern:\ngroup.variable = value desc \"description\" The value can be a quoted string or integer number.\nExample:\npstn.gw_ip = \"1.2.3.4\" desc \"PSTN GW Address\" The custom global parameter can be accessed inside a routing block via:\n$sel(cfg_get.group.variable) Example:\n$ru = \"sip:\" + $rU + \"@\" + $sel(cfg_get.pstn.gw_ip); Note: Some words cannot be used as (part of) names for custom variables or groups, and if they are used a syntax error is logged by kamailio. These keywords are: “yes”, “true”, “on”, “enable”, “no”, “false”, “off”, “disable”, “udp”, “UDP”, “tcp”, “TCP”, “tls”, “TLS”, “sctp”, “SCTP”, “ws”, “WS”, “wss”, “WSS”, “inet”, “INET”, “inet6”, “INET6”, “sslv23”, “SSLv23”, “SSLV23”, “sslv2”, “SSLv2”, “SSLV2”, “sslv3”, “SSLv3”, “SSLV3”, “tlsv1”, “TLSv1”, “TLSV1”\n1.17. Routing Blocks The routing blocks are the parts of the configuration file executed by kamailio at runtime. They can be seen as blocks of actions similar to functions (or procedures) from common programming languages.\nA routing block is identified by a specific token, followed by a name in between square brackets and actions in between curly braces.\nroute_block_id[NAME] { ACTIONS } The name can be any alphanumeric string, with specific routing blocks enforcing a particular format.\n🔥IMPORTANT: Note: route(number) is equivalent to route(\"number\").\nRoute blocks can be executed on network events (e.g., receiving a SIP message), timer events (e.g., retransmission timeout) or particular events specific to modules.\nThere can be so called sub-route blocks, which can be invoked from another route blocks, like a function. Invocation is done with route followed by the name of sub-route to execute, enclosed in between parentheses.\nExample:\nrequest_route{ ... route(\"test\"); ... } route[\"test\"]{ ... } 1.17.1. request_route Request routing block - is executed for each SIP request.\nIt contains a set of actions to be executed for SIP requests received from the network. It is the equivalent of main() function for handling the SIP requests.\n🔥IMPORTANT: For backward compatibility reasons, the main request route block can be identified by route{...} or route[0]{...}'.\nThe implicit action after execution of the main route block is to drop the SIP request. To send a reply or forward the request, explicit actions (e.g., sl_send_reply(), forward(), t_relay()) must be called inside the route block.\nExample of usage:\nrequest_route { if(is_method(\"OPTIONS\")) { # send reply for each options request sl_send_reply(\"200\", \"ok\"); exit(); } route(FWD); } route[FWD] { # forward according to uri forward(); } 1.17.2. route This block is used to define ‘sub-routes’ - group of actions that can be executed from another routing block. Originally targeted as being executed from ‘request_route’, it can be executed now from all the other blocks. Be sure you put there the actions valid for the root routing block executing the sub-route.\nThe definition of the sub-route block follows the general rules, with a name in between square brackets and actions between curly braces. A sub-route can return an integer value back to the routing block that executed it. The return code can be retrieved via $rc variables.\nEvaluation of the return of a subroute is done with following rules:\nnegative value is evaluated as false 0 - is interpreted as exit positive value is evaluated as true request_route { if(route(POSITIVE)) { xlog(\"return number is positive\\n\"); } if( ! route(NEGATIVE)) { xlog(\"return number is negative\\n\"); } if( route(ZERO)) { xlog(\"this log message does not appear\\n\"); } } route[POSITIVE] { return 10; } route[NEGATIVE] { return -8; } route[ZERO] { return 0; } A sub-route can execute another sub-route. There is a limit to the number of recursive levels, avoiding ending up in infinite loops – see max_recursive_level global parameter.\nThe sub-route blocks allow to make the configuration file modular, simplifying the logic and helping to avoid duplication of actions.\nIf no return is at the end of the routing block, the return code is the value of the last executed action, therefore it is highly recommended to return an explicit value (e.g., return(1)) to avoid unexpected config execution.\n1.17.3. branch_route Request’s branch routing block. It contains a set of actions to be taken for each branch of a SIP request. It is executed only by TM module after it was armed via t_on_branch(\"branch_route_index\").\nExample of usage:\nrequest_route { lookup(\"location\"); t_on_branch(\"OUT\"); if(!t_relay()) { sl_send_reply(\"500\", \"relaying failed\"); } } branch_route[OUT] { if(uri=~\"10\\.10\\.10\\.10\") { # discard branches that go to 10.10.10.10 drop(); } } 1.17.4. failure_route Failed transaction routing block. It contains a set of actions to be taken each transaction that received only negative replies (\u003e=300) for all branches. The failure_route is executed only by TM module after it was armed via t_on_failure(\"failure_route_index\").\nNote that in failure_route is processed the request that initiated the transaction, not the reply .\nExample of usage:\nrequest_route { lookup(\"location\"); t_on_failure(\"TOVOICEMAIL\"); if(!t_relay()) { sl_send_reply(\"500\", \"relaying failed\"); } } failure_route[TOVOICEMAIL] { if(is_method(\"INVITE\")) { # call failed - relay to voice mail t_relay_to_udp(\"voicemail.server.com\",\"5060\"); } } 1.17.5. reply_route Main SIP response (reply) handling block - it contains a set of actions to be executed for SIP replies. It is executed for all replies received from the network.\nIt does not have a name and it is executed by the core, before any other module handling the SIP reply. It is triggered only by SIP replies received on the network.\nThere is no network route that can be enforced for a SIP reply - it is sent based on Via header, according to SIP RFC3261 - therefore no dedicated actions for forwarding the reply must be used in this block.\nThis routing block is optional, if missing, the SIP reply is sent to the address in 2nd Via header.\nOne can decide to drop a SIP reply by using drop action.\nExample:\nreply_route { if(status==\"128\") { drop; } } 🔥IMPORTANT: Note: for backward compatibility reasons, the main reply routing block can be also identified by onreply_route {...} or onreply_route[0] {...}.\n1.17.6. onreply_route SIP reply routing block executed by tm module. It contains a set of actions to be taken for SIP replies in the context of an active transaction.\nThe onreply_route must be armed for the SIP requests whose replies should be processed within it, via t_on_reply(\"onreply_route_index\").\nCore ‘reply_route’ block is executed before a possible tm ‘onreply_route’ block.\nrequest_route { lookup(\"location\"); t_on_reply(\"LOGRPL\"); if(!t_relay()) { sl_send_reply(\"500\", \"relaying failed\"); } } reply_route { if(!t_check_trans()) { drop; } } onreply_route[LOGRPL] { if(status=~\"1[0-9][0-9]\") { log(\"provisional response\\n\"); } } 1.17.7. onsend_route The route is executed in when a SIP request is sent out. Only a limited number of commands are allowed (drop, if + all the checks, msg flag manipulations, send(), log(), textops::search()).\nIn this route the final destination of the message is available and can be checked (with snd_ip, snd_port, to_ip, to_port, snd_proto, snd_af).\nThis route is executed only when forwarding requests - it is not executed for replies, retransmissions, or locally generated messages (e.g. via fifo uac).\nExample:\nonsend_route { if(to_ip==1.2.3.4 \u0026\u0026 !isflagset(12)){ log(1, \"message blocked\\n\"); drop; } } snd_ip, snd_port - behave like src_ip/src_port, but contain the ip/port Kamailio will use to send the message to_ip, to_port - like above, but contain the ip/port the message will be sent to (not to be confused with dst_ip/dst_port, which are the destination of the original received request: Kamailio’s ip and port on which the message was received) snd_proto, snd_af - behave like proto/af but contain the protocol/address family that Kamailio will use to send the message msg:len - when used in an onsend_route, msg:len will contain the length of the message on the wire (after all the changes in the script are applied, Vias are added a.s.o) and not the lentgh of the original message. 1.17.8. event_route Generic type of route executed when specific events happen.\nPrototype: event_route[groupid:eventid]\ngroupid - should be the name of the module that triggers the event eventid - some meaningful short text describing the event 1.17.8.1. Core Event Routes Implementations:\nevent_route[core:worker-one-init] - executed by core after the first udp sip worker process executed the child_init() for all modules, before starting to process sip traffic note that due to forking, other sip workers can get faster to listening for sip traffic event_route[core:worker-one-init] { xlog(\"L_INFO\",\"Hello world\\n\"); } event_route[core:msg-received] - executed when a message is received from the network. It runs with a faked request and makes available the $rcv(key) variables to access what was received and related attribtues. it has to be enabled with received_route_mode global parameter. For usage via Kemi, set kemi.received_route_callback global parameter. if drop is executed, the received message is no longer processed event_route[core:msg-received] { xlog(\"rcv on $rcv(af)/$rcv(proto): ($rcv(len)) [$rcv(buf)] from [$rcv(srcip):$rcv(srcport)] to [$rcv(rcvip):$rcv(rcvport)]\\n\"); if($rcv(srcip) == \"1.2.3.4\") { drop; } } event_route[core:pre-routing] - executed by core on receiving SIP traffic before running request_route or reply_route. if drop is used, then the message is not processed further with request_route or reply_route in the same process. This can be useful together with sworker module which can delegate the processing to another worker. async_workers_group=\"name=reg;workers=4\" ... event_route[core:pre-routing] { xinfo(\"pre-routing rules\\n\"); if(is_method(\"REGISTER\")) { # delegate processing of REGISTERs to a special group of workers if(sworker_task(\"reg\")) { drop; } } } event_route[core:receive-parse-error] - executed by core on receiving a broken SIP message that can not be parsed. note that the SIP message is broken in this case, but it gets access to source and local socket addresses (ip, port, proto, af) as well as the whole message buffer and its size event_route[core:receive-parse-error] { xlog(\"got a parsing error from $si:$sp, message $mb\\n\"); } 1.17.8.2. Module Event Routes Here are only a few examples, to see if a module exports event_route blocks and when they are executed, check the readme of the module.\nevent_route[htable:mod-init] - executed by htable module after all modules have been initialised. Good for initialising values in hash tables. modparam(\"htable\", \"htable\", \"a=\u003esize=4;\") event_route[htable:mod-init] { $sht(a=\u003ecalls-to::10.10.10.10) = 0; $sht(a=\u003emax-calls-to::10.10.10.10) = 100; } request_route { if(is_method(\"INVITE\") \u0026\u0026 !has_totag()) { switch($rd) { case \"10.10.10.10\": lock(\"calls-to::10.10.10.10\"); $sht(a=\u003ecalls-to::10.10.10.10) = $sht(a=\u003ecalls-to::10.10.10.10) + 1; unlock(\"calls-to::10.10.10.10\"); if($sht(a=\u003ecalls-to::10.10.10.10)\u003e$sht(a=\u003emax-calls-to::10.10.10.10)) { sl_send_reply(\"500\", \"To many calls to .10\"); exit; } break; ... } } } event_route[tm:local-request] - executed on locally generated requests. event_route [tm:local-request] { # Handle locally generated requests xlog(\"L_INFO\", \"Routing locally generated $rm to \u003c$ru\u003e\\n\"); t_set_fr(10000, 10000); } event_route[tm:branch-failure] - executed on all failure responses. request_route { ... t_on_branch_failure(\"myroute\"); t_relay(); } event_route[tm:branch-failure:myroute] { xlog(\"L_INFO\", \"Handling $T_reply_code response to $rm to \u003c$ru\u003e\\n\"); if (t_check_status(\"430\")) { # Outbound flow failed unregister(\"location\", \"$tu\", \"$T_reply_ruid\"); if (t_next_contact_flow()) { t_relay(); } } } 1.18. Script Statements 1.18.1. if IF-ELSE statement\nPrototype:\nif(expr) { actions; } else { actions; } The expr should be a valid logical expression.\nThe logical operators that can be used in expr:\n==: equal !=: not equal =~: case-insensitive regular expression matching: Note: Posix regular expressions will be used, e.g. use [[:digit:]]{3} instead of \\d\\d\\d !~: regular expression not-matching (NOT PORTED from Kamailio 1.x, use !(x =~ y)) \u003e: greater \u003e=: greater or equal \u003c: less \u003c=: less or equal \u0026\u0026: logical AND ||: logical OR !: logical NOT Example of usage:\nif(is_method(\"INVITE\")) { log(\"this sip message is an invite\\n\"); } else { log(\"this sip message is not an invite\\n\"); } See also the FAQ for how the function return code is evaluated:\nHow is the function code evaluated 1.18.2. switch SWITCH statement - it can be used to test the value of a pseudo-variable.\nIMPORTANT NOTE: break can be used only to mark the end of a case branch (as it is in shell scripts). If you are trying to use break outside a case block the script will return error – you must use return there.\nExample of usage:\nroute { route(1); switch($retcode) { case -1: log(\"process INVITE requests here\\n\"); break; case 1: log(\"process REGISTER requests here\\n\"); break; case 2: case 3: log(\"process SUBSCRIBE and NOTIFY requests here\\n\"); break; default: log(\"process other requests here\\n\"); } # switch of R-URI username switch($rU) { case \"101\": log(\"destination number is 101\\n\"); break; case \"102\": log(\"destination number is 102\\n\"); break; case \"103\": case \"104\": log(\"destination number is 103 or 104\\n\"); break; default: log(\"unknown destination number\\n\"); } } route[1]{ if(is_method(\"INVITE\")) { return(-1); }; if(is_method(\"REGISTER\")) return(1); } if(is_method(\"SUBSCRIBE\")) return(2); } if(is_method(\"NOTIFY\")) return(3); } return(-2); } NOTE: take care while using return - return(0) stops the execution of the script.\n1.18.3. while while statement\nExample of usage:\n$var(i) = 0; while($var(i) \u003c 10) { xlog(\"counter: $var(i)\\n\"); $var(i) = $var(i) + 1; } 1.19. Script Operations Assignments together with string and arithmetic operations can be done directly in configuration file.\n1.19.1. Assignment Assignments can be done like in C, via = (equal). The following pseudo-variables can be used in left side of an assignment:\nUnordered List Item AVPs - to set the value of an AVP script variables ($var(...)) - to set the value of a script variable shared variables ($shv(...)) $ru - to set R-URI $rd - to set domain part of R-URI $rU - to set user part of R-URI $rp - to set the port of R-URI $du - to set dst URI $fs - to set send socket $br - to set branch $mf - to set message flags value $sf - to set script flags value $bf - to set branch flags value $var(a) = 123; For avp’s there a way to remove all values and assign a single value in one statement (in other words, delete existing AVPs with same name, add a new one with the right side value). This replaces the := assignment operator from kamailio \u003c 3.0.\n$(avp(i:3)[*]) = 123; $(avp(i:3)[*]) = $null; 1.19.2. String Operations For strings, + is available to concatenate.\n$var(a) = \"test\"; $var(b) = \"sip:\" + $var(a) + \"@\" + $fd; 1.19.3. Arithmetic Operations For numbers, one can use:\n+ : plus - : minus / : divide * : multiply % : modulo (Kamailio uses mod instead of %) | : bitwise OR \u0026 : bitwise AND ^ : bitwise XOR ~ : bitwise NOT \u003c\u003c : bitwise left shift \u003e\u003e : bitwise right shift Example:\n$var(a) = 4 + ( 7 \u0026 ( ~2 ) ); NOTE: to ensure the priority of operands in expression evaluations do use parenthesis.\nArithmetic expressions can be used in condition expressions.\nif( $var(a) \u0026 4 ) log(\"var a has third bit set\\n\"); 1.20. Operators type casts operators: (int), (str). string comparison: eq, ne integer comparison: ieq, ine Note: The names are not yet final (use them at your own risk). Future version might use ==/!= only for ints (ieq/ine) and eq/ne for strings (under debate). They are almost equivalent to == or !=, but they force the conversion of their operands (eq to string and ieq to int), allowing among other things better type checking on startup and more optimizations.\nNon equiv. examples:\n0 == \"\" (true) is not equivalent to 0 eq \"\" (false: it evaluates to \"0\" eq \"\").\n\"a\" ieq \"b\" (true: (int)\"a\" is 0 and (int)\"b\" is 0) is not equivalent to \"a\" == \"b\" (false).\nNote: internally == and != are converted on startup to eq/ne/ieq/ine whenever possible (both operand types can be safely determined at start time and they are the same).\nKamailio tries to guess what the user wanted when operators that support multiple types are used on different typed operands. In general convert the right operand to the type of the left operand and then perform the operation. Exception: the left operand is undef. This applies to the following operators: +, == and !=. Special case: undef as left operand: For +: undef + expr -\u003e undef is converted to string =\u003e \"\" + expr. For == and !=: undef == expr -\u003e undef is converted to type_of expr. If expr is undef, then undef == undef is true (internally is converted to string). expression evaluation changes: Kamailio will auto-convert to integer or string in function of the operators: int(undef)==0, int(\"\")==0, int(\"123\")==123, int(\"abc\")==0 str(undef)==\"\", str(123)==\"123\". script operators for dealing with empty/undefined variables defined expr - returns true if expr is defined, and false if not. Note: only a standalone avp or pvar can be undefined, everything else is defined. strlen(expr) - returns the lenght of expr evaluated as string. strempty(expr) - returns true if expr evaluates to the empty string (equivalent to expr==\"\"). Example: if (defined $v \u0026\u0026 !strempty($v)) $len=strlen($v); 1.21. Command Line Parameters Kamailio can be started with a set of command line parameters, providing more flexibility to control what is doing at runtime. Some of them can be quite useful when running on containerised environments.\nTo see the the available command line parameters, run kamailio -h:\n# kamailio -h version: kamailio 5.4.0-dev4 (x86_64/darwin) 8c1864 Usage: kamailio [options] Options: -a mode Auto aliases mode: enable with yes or on, disable with no or off --alias=val Add an alias, the value has to be '[proto:]hostname[:port]' (like for 'alias' global parameter) -A define Add config pre-processor define (e.g., -A WITH_AUTH, -A 'FLT_ACC=1', -A 'DEFVAL=\"str-val\"') -b nr Maximum receive buffer size which will not be exceeded by auto-probing procedure even if OS allows -c Check configuration file for syntax errors -d Debugging mode (multiple -d increase the level) -D Control how daemonize is done: -D..do not fork (almost) anyway; -DD..do not daemonize creator; -DDD..daemonize (default) -e Log messages printed in terminal colors (requires -E) -E Log to stderr -f file Configuration file (default: /usr/local/etc/kamailio/kamailio.cfg) -g gid Change gid (group id) -G file Create a pgid file -h This help message --help Long option for `-h` -I Print more internal compile flags and options -K Turn on \"via:\" host checking when forwarding replies -l address Listen on the specified address/interface (multiple -l mean listening on more addresses). The address format is [proto:]addr_lst[:port][/advaddr], where proto=udp|tcp|tls|sctp, addr_lst= addr|(addr, addr_lst), addr=host|ip_address|interface_name and advaddr=addr[:port] (advertised address). E.g: -l localhost, -l udp:127.0.0.1:5080, -l eth0:5062, -l udp:127.0.0.1:5080/1.2.3.4:5060, -l \"sctp:(eth0)\", -l \"(eth0, eth1, 127.0.0.1):5065\". The default behaviour is to listen on all the interfaces. --loadmodule=name load the module specified by name --log-engine=log engine name and data -L path Modules search path (default: /usr/local/lib64/kamailio/modules) -m nr Size of shared memory allocated in Megabytes --modparam=modname:paramname:type:value set the module parameter type has to be 's' for string value and 'i' for int value, example: --modparam=corex:alias_subdomains:s:kamailio.org -M nr Size of private memory allocated, in Megabytes -n processes Number of child processes to fork per interface (default: 8) -N Number of tcp child processes (default: equal to `-n') -O nr Script optimization level (debugging option) -P file Create a pid file -Q Number of sctp child processes (default: equal to `-n') -r Use dns to check if is necessary to add a \"received=\" field to a via -R Same as `-r` but use reverse dns; (to use both use `-rR`) --server-id=num set the value for server_id --subst=exp set a subst preprocessor directive --substdef=exp set a substdef preprocessor directive --substdefs=exp set a substdefs preprocessor directive -S disable sctp -t dir Chroot to \"dir\" -T Disable tcp -u uid Change uid (user id) -v Version number --version Long option for `-v` -V Alternative for `-v` -x name Specify internal manager for shared memory (shm) - can be: fm, qm or tlsf -X name Specify internal manager for private memory (pkg) - if omitted, the one for shm is used -Y dir Runtime dir path -w dir Change the working directory to \"dir\" (default: \"/\") -W type poll method (depending on support in OS, it can be: poll, epoll_lt, epoll_et, sigio_rt, select, kqueue, /dev/poll) 1.21.1. Log Engine CLI Parameter The –log-engine parameter allows to specify what logging engine to be used, which is practically about the format of the log messages. If not set at all, then Kamailio does the classic style of line-based plain text log messages.\nThe value of this parameter can be –log-engine=name or –log-engine=name:data.\nThe name of the log engine can be:\njson - write logs in structured JSON format the data for json log engine can be a set of character flags: a - add log prefix as a special field A - do not add log prefix c - add Call-ID (when available) as a dedicated JSON attribute j - the log prefix and message fields are printed in JSON structure format, detecting if they are enclosed in between { } or adding them as a text field M - strip EOL (’\\n’) from the value of the log message field N - do not add EOL at the end of JSON document p - the log prefix is printed as it is in the root json document, it has to start with comma (,) and be a valid set of json fields U - CEE (Common Event Expression) schema format - https://cee.mitre.org/language/1.0-beta1/core-profile.html Example of JSON logs when running Kamailio with “–log-engine=json:M” :\n{ \"idx\": 1, \"pid\": 18239, \"level\": \"DEBUG\", \"module\": \"maxfwd\", \"file\": \"mf_funcs.c\", \"line\": 74, \"function\": \"is_maxfwd_present\", \"logprefix\": \"{1 1 OPTIONS 715678756@192.168.188.20} \", \"message\": \"value = 70 \" } { \"idx\": 1, \"pid\": 18239, \"level\": \"DEBUG\", \"module\": \"core\", \"file\": \"core/socket_info.c\", \"line\": 644, \"function\": \"grep_sock_info\", \"logprefix\": \"{1 1 OPTIONS 715678756@192.168.188.20} \", \"message\": \"checking if host==us: 9==9 \u0026\u0026 [127.0.0.1] == [127.0.0.1]\" } Example config for printing log message with j flag:\nxinfo(\"{ \\\"src_ip\\\": \\\"$si\\\", \\\"method\\\": \\\"$rm\\\", \\\"text\\\": \\\"request received\\\" }\"); Example config for printing log messages with p flag:\nlog_prefix=\", \\\"src_ip\\\": \\\"$si\\\", \\\"tv\\\": $TV(Sn), \\\"mt\\\": $mt, \\\"ua\\\": \\\"$(ua{s.escape.common})\\\", \\\"cseq\\\": \\\"$hdr(CSeq)\\\"\" ","wordCount":"3553","inLanguage":"en","image":"https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"Eddie Wang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wdd.js.org/kamailio/56/core/"},"publisher":{"@type":"Organization","name":"洞香春","logo":{"@type":"ImageObject","url":"https://wdd.js.org/cowboy.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org/ accesskey=h title="洞香春 (Alt + H)"><img src=https://wdd.js.org/cowboy.ico alt aria-label=logo height=35>洞香春</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wdd.js.org/books/ title=读书><span>读书</span></a></li><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/golang/ title=Golang><span>Golang</span></a></li><li><a href=https://wdd.js.org/kamailio/ title=Kamailio><span>Kamailio</span></a></li><li><a href=https://wdd.js.org/kamailio/56/ title="Kamailio 5.6 wiki"><span>Kamailio 5.6 wiki</span></a></li><li><a href=https://wdd.js.org/network/ title=Network><span>Network</span></a></li><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/categories/ title=分类><span>分类</span></a></li><li><a href=https://wdd.js.org/fe/ title=前端><span>前端</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wdd.js.org/>Home</a>&nbsp;»&nbsp;<a href=https://wdd.js.org/kamailio/>新朋友 - kamailio学习笔记</a>&nbsp;»&nbsp;<a href=https://wdd.js.org/kamailio/56/>Kamailio 5.6 Wiki</a></div><h1 class="post-title entry-hint-parent">1. 核心概念</h1><div class=post-meta>17 min&nbsp;·&nbsp;Eddie Wang&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/kamailio/56/core/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#116-custom-global-parameters aria-label="1.16. Custom Global Parameters">1.16. Custom Global Parameters</a></li><li><a href=#117-routing-blocks aria-label="1.17. Routing Blocks">1.17. Routing Blocks</a><ul><li><a href=#1171-request_route aria-label="1.17.1. request_route">1.17.1. request_route</a></li><li><a href=#1172-route aria-label="1.17.2. route">1.17.2. route</a></li><li><a href=#1173-branch_route aria-label="1.17.3. branch_route">1.17.3. branch_route</a></li><li><a href=#1174-failure_route aria-label="1.17.4. failure_route">1.17.4. failure_route</a></li><li><a href=#1175-reply_route aria-label="1.17.5. reply_route">1.17.5. reply_route</a></li><li><a href=#1176-onreply_route aria-label="1.17.6. onreply_route">1.17.6. onreply_route</a></li><li><a href=#1177-onsend_route aria-label="1.17.7. onsend_route">1.17.7. onsend_route</a></li><li><a href=#1178-event_route aria-label="1.17.8. event_route">1.17.8. event_route</a><ul><li><a href=#11781-core-event-routes aria-label="1.17.8.1. Core Event Routes">1.17.8.1. Core Event Routes</a></li><li><a href=#11782-module-event-routes aria-label="1.17.8.2. Module Event Routes">1.17.8.2. Module Event Routes</a></li></ul></li></ul></li><li><a href=#118-script-statements aria-label="1.18. Script Statements">1.18. Script Statements</a><ul><li><a href=#1181-if aria-label="1.18.1. if">1.18.1. if</a></li><li><a href=#1182-switch aria-label="1.18.2. switch">1.18.2. switch</a></li><li><a href=#1183-while aria-label="1.18.3. while">1.18.3. while</a></li></ul></li><li><a href=#119-script-operations aria-label="1.19. Script Operations">1.19. Script Operations</a><ul><li><a href=#1191-assignment aria-label="1.19.1. Assignment">1.19.1. Assignment</a></li><li><a href=#1192-string-operations aria-label="1.19.2. String Operations">1.19.2. String Operations</a></li><li><a href=#1193-arithmetic-operations aria-label="1.19.3. Arithmetic Operations">1.19.3. Arithmetic Operations</a></li></ul></li><li><a href=#120-operators aria-label="1.20. Operators">1.20. Operators</a></li><li><a href=#121-command-line-parameters aria-label="1.21. Command Line Parameters">1.21. Command Line Parameters</a><ul><li><a href=#1211-log-engine-cli-parameter aria-label="1.21.1. Log Engine CLI Parameter">1.21.1. Log Engine CLI Parameter</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=116-custom-global-parameters>1.16. Custom Global Parameters<a hidden class=anchor aria-hidden=true href=#116-custom-global-parameters>#</a></h2><p>These are parameters that can be defined by the writer of kamailio.cfg
in order to be used inside routing blocks. One of the important
properties for custom global parameters is that their value can be
changed at runtime via RPC commands, without restarting Kamailio.</p><p>The definition of a custom global parameter must follow the pattern:</p><pre><code>group.variable = value desc &quot;description&quot;
</code></pre><p>The value can be a quoted string or integer number.</p><p>Example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>pstn.gw_ip <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1.2.3.4&#34;</span> desc <span style=color:#e6db74>&#34;PSTN GW Address&#34;</span>
</span></span></code></pre></div><p>The custom global parameter can be accessed inside a routing block via:</p><pre><code>$sel(cfg_get.group.variable)
</code></pre><p>Example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>ru <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sip:&#34;</span> <span style=color:#f92672>+</span> <span style=color:#960050;background-color:#1e0010>$</span>rU <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;@&#34;</span> <span style=color:#f92672>+</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>sel</span>(cfg_get.pstn.gw_ip);
</span></span></code></pre></div><p><strong>Note:</strong> Some words cannot be used as (part of) names for custom
variables or groups, and if they are used a syntax error is logged by
kamailio. These keywords are: &ldquo;yes&rdquo;, &ldquo;true&rdquo;, &ldquo;on&rdquo;, &ldquo;enable&rdquo;, &ldquo;no&rdquo;,
&ldquo;false&rdquo;, &ldquo;off&rdquo;, &ldquo;disable&rdquo;, &ldquo;udp&rdquo;, &ldquo;UDP&rdquo;, &ldquo;tcp&rdquo;, &ldquo;TCP&rdquo;, &ldquo;tls&rdquo;, &ldquo;TLS&rdquo;,
&ldquo;sctp&rdquo;, &ldquo;SCTP&rdquo;, &ldquo;ws&rdquo;, &ldquo;WS&rdquo;, &ldquo;wss&rdquo;, &ldquo;WSS&rdquo;, &ldquo;inet&rdquo;, &ldquo;INET&rdquo;, &ldquo;inet6&rdquo;,
&ldquo;INET6&rdquo;, &ldquo;sslv23&rdquo;, &ldquo;SSLv23&rdquo;, &ldquo;SSLV23&rdquo;, &ldquo;sslv2&rdquo;, &ldquo;SSLv2&rdquo;, &ldquo;SSLV2&rdquo;,
&ldquo;sslv3&rdquo;, &ldquo;SSLv3&rdquo;, &ldquo;SSLV3&rdquo;, &ldquo;tlsv1&rdquo;, &ldquo;TLSv1&rdquo;, &ldquo;TLSV1&rdquo;</p><h2 id=117-routing-blocks>1.17. Routing Blocks<a hidden class=anchor aria-hidden=true href=#117-routing-blocks>#</a></h2><p>The routing blocks are the parts of the configuration file executed by
kamailio at runtime. They can be seen as blocks of actions similar to
functions (or procedures) from common programming languages.</p><p>A routing block is identified by a specific token, followed by a name in
between square brackets and actions in between curly braces.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>route_block_id[NAME] {
</span></span><span style=display:flex><span>  ACTIONS
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The name can be any alphanumeric string, with specific routing blocks
enforcing a particular format.</p><p>🔥<strong>IMPORTANT</strong>: Note: <code>route(number)</code> is equivalent to <code>route("number")</code>.</p><p>Route blocks can be executed on network events (e.g., receiving a SIP
message), timer events (e.g., retransmission timeout) or particular
events specific to modules.</p><p>There can be so called sub-route blocks, which can be invoked from
another route blocks, like a function. Invocation is done with <code>route</code>
followed by the name of sub-route to execute, enclosed in between
parentheses.</p><p>Example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>  request_route{
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>route</span>(<span style=color:#e6db74>&#34;test&#34;</span>);
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  route[<span style=color:#e6db74>&#34;test&#34;</span>]{
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><h3 id=1171-request_route>1.17.1. request_route<a hidden class=anchor aria-hidden=true href=#1171-request_route>#</a></h3><p>Request routing block - is executed for each SIP request.</p><p>It contains a set of actions to be executed for SIP requests received
from the network. It is the equivalent of <code>main()</code> function for
handling the SIP requests.</p><p>🔥<strong>IMPORTANT</strong>: For backward compatibility reasons, the main request
<code>route</code> block can be identified by <code>route{...}</code> or
<code>route[0]{...}</code>'.</p><p>The implicit action after execution of the main route block is to drop
the SIP request. To send a reply or forward the request, explicit
actions (e.g., sl_send_reply(), forward(), t_relay()) must be called
inside the route block.</p><p>Example of usage:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    request_route {
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>is_method</span>(<span style=color:#e6db74>&#34;OPTIONS&#34;</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#75715e># send reply for each options request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>sl_send_reply</span>(<span style=color:#e6db74>&#34;200&#34;</span>, <span style=color:#e6db74>&#34;ok&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>exit</span>();
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>route</span>(FWD);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    route[FWD] {
</span></span><span style=display:flex><span>         <span style=color:#75715e># forward according to uri
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>         <span style=color:#a6e22e>forward</span>();
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><h3 id=1172-route>1.17.2. route<a hidden class=anchor aria-hidden=true href=#1172-route>#</a></h3><p>This block is used to define &lsquo;sub-routes&rsquo; - group of actions that can be
executed from another routing block. Originally targeted as being
executed from &lsquo;request_route&rsquo;, it can be executed now from all the other
blocks. Be sure you put there the actions valid for the root routing
block executing the sub-route.</p><p>The definition of the sub-route block follows the general rules, with a
name in between square brackets and actions between curly braces. A
sub-route can return an integer value back to the routing block that
executed it. The return code can be retrieved via $rc variables.</p><p>Evaluation of the return of a subroute is done with following rules:</p><ul><li>negative value is evaluated as false</li><li>0 - is interpreted as <strong>exit</strong></li><li>positive value is evaluated as true</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>request_route {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>route</span>(POSITIVE)) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xlog</span>(<span style=color:#e6db74>&#34;return number is positive</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span>( <span style=color:#f92672>!</span> <span style=color:#a6e22e>route</span>(NEGATIVE)) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xlog</span>(<span style=color:#e6db74>&#34;return number is negative</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span>( <span style=color:#a6e22e>route</span>(ZERO)) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xlog</span>(<span style=color:#e6db74>&#34;this log message does not appear</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>route[POSITIVE] {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>route[NEGATIVE] {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>8</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>route[ZERO] {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>A sub-route can execute another sub-route. There is a limit to the
number of recursive levels, avoiding ending up in infinite loops &ndash; see
<strong>max_recursive_level</strong> global parameter.</p><p>The sub-route blocks allow to make the configuration file modular,
simplifying the logic and helping to avoid duplication of actions.</p><p>If no <code>return</code> is at the end of the routing block, the return code is the value
of the last executed action, therefore it is highly recommended to return an
explicit value (e.g., <code>return(1)</code>) to avoid unexpected config execution.</p><h3 id=1173-branch_route>1.17.3. branch_route<a hidden class=anchor aria-hidden=true href=#1173-branch_route>#</a></h3><p>Request&rsquo;s branch routing block. It contains a set of actions to be taken
for each branch of a SIP request. It is executed only by TM module after
it was armed via <code>t_on_branch("branch_route_index")</code>.</p><p>Example of usage:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    request_route {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>lookup</span>(<span style=color:#e6db74>&#34;location&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>t_on_branch</span>(<span style=color:#e6db74>&#34;OUT&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>t_relay</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>sl_send_reply</span>(<span style=color:#e6db74>&#34;500&#34;</span>, <span style=color:#e6db74>&#34;relaying failed&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    branch_route[OUT] {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(uri<span style=color:#f92672>=~</span><span style=color:#e6db74>&#34;10\.10\.10\.10&#34;</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e># discard branches that go to 10.10.10.10
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>drop</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><h3 id=1174-failure_route>1.17.4. failure_route<a hidden class=anchor aria-hidden=true href=#1174-failure_route>#</a></h3><p>Failed transaction routing block. It contains a set of actions to be
taken each transaction that received only negative replies (<code>>=300</code>) for
all branches. The <code>failure_route</code> is executed only by TM module after it
was armed via <code>t_on_failure("failure_route_index")</code>.</p><p>Note that in <code>failure_route</code> is processed the request that initiated the
transaction, not the reply .</p><p>Example of usage:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    request_route {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>lookup</span>(<span style=color:#e6db74>&#34;location&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>t_on_failure</span>(<span style=color:#e6db74>&#34;TOVOICEMAIL&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>t_relay</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>sl_send_reply</span>(<span style=color:#e6db74>&#34;500&#34;</span>, <span style=color:#e6db74>&#34;relaying failed&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    failure_route[TOVOICEMAIL] {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>is_method</span>(<span style=color:#e6db74>&#34;INVITE&#34;</span>)) {
</span></span><span style=display:flex><span>             <span style=color:#75715e># call failed - relay to voice mail
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>             <span style=color:#a6e22e>t_relay_to_udp</span>(<span style=color:#e6db74>&#34;voicemail.server.com&#34;</span>,<span style=color:#e6db74>&#34;5060&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><h3 id=1175-reply_route>1.17.5. reply_route<a hidden class=anchor aria-hidden=true href=#1175-reply_route>#</a></h3><p>Main SIP response (reply) handling block - it contains a set of actions
to be executed for SIP replies. It is executed for all replies received
from the network.</p><p>It does not have a name and it is executed by the core, before any other
module handling the SIP reply. It is triggered only by SIP replies
received on the network.</p><p>There is no network route that can be enforced for a SIP reply - it is
sent based on Via header, according to SIP RFC3261 - therefore no
dedicated actions for forwarding the reply must be used in this block.</p><p>This routing block is optional, if missing, the SIP reply is sent to the
address in 2nd Via header.</p><p>One can decide to drop a SIP reply by using <strong>drop</strong> action.</p><p>Example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>reply_route {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span>(status<span style=color:#f92672>==</span><span style=color:#e6db74>&#34;128&#34;</span>) {
</span></span><span style=display:flex><span>    drop;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>🔥<strong>IMPORTANT</strong>: Note: for backward compatibility reasons, the main <code>reply</code>
routing block can be also identified by <code>onreply_route {...}</code> or
<code>onreply_route[0] {...}</code>.</p><h3 id=1176-onreply_route>1.17.6. onreply_route<a hidden class=anchor aria-hidden=true href=#1176-onreply_route>#</a></h3><p>SIP reply routing block executed by <strong>tm</strong> module. It contains a set of
actions to be taken for SIP replies in the context of an active
transaction.</p><p>The <code>onreply_route</code> must be armed for the SIP requests whose replies
should be processed within it, via <code>t_on_reply</code>("<code>onreply_route_index</code>").</p><p>Core &lsquo;reply_route&rsquo; block is executed before a possible <strong>tm</strong>
&lsquo;onreply_route&rsquo; block.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>  request_route {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lookup</span>(<span style=color:#e6db74>&#34;location&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>t_on_reply</span>(<span style=color:#e6db74>&#34;LOGRPL&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>t_relay</span>()) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>sl_send_reply</span>(<span style=color:#e6db74>&#34;500&#34;</span>, <span style=color:#e6db74>&#34;relaying failed&#34;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  reply_route {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>t_check_trans</span>()) {
</span></span><span style=display:flex><span>          drop;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  onreply_route[LOGRPL] {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span>(status<span style=color:#f92672>=~</span><span style=color:#e6db74>&#34;1[0-9][0-9]&#34;</span>) {
</span></span><span style=display:flex><span>           <span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;provisional response</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><h3 id=1177-onsend_route>1.17.7. onsend_route<a hidden class=anchor aria-hidden=true href=#1177-onsend_route>#</a></h3><p>The route is executed in when a SIP request is sent out. Only a limited
number of commands are allowed (<code>drop</code>, <code>if</code> + all the checks, msg flag
manipulations, <code>send()</code>, <code>log()</code>, <code>textops::search()</code>).</p><p>In this route the final destination of the message is available and can
be checked (with <code>snd_ip</code>, <code>snd_port</code>, <code>to_ip</code>, <code>to_port</code>, <code>snd_proto</code>, <code>snd_af</code>).</p><p>This route is executed only when forwarding requests - it is not
executed for replies, retransmissions, or locally generated messages
(e.g. via fifo uac).</p><p>Example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>  onsend_route {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(to_ip<span style=color:#f92672>==</span><span style=color:#ae81ff>1.2.3.4</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>isflagset</span>(<span style=color:#ae81ff>12</span>)){
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>log</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#34;message blocked</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>      drop;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><ul><li>snd_ip, snd_port - behave like src_ip/src_port, but contain the
ip/port Kamailio will use to send the message</li><li>to_ip, to_port - like above, but contain the ip/port the message
will be sent to (not to be confused with dst_ip/dst_port, which are
the destination of the original received request: Kamailio&rsquo;s ip and
port on which the message was received)</li><li>snd_proto, snd_af - behave like proto/af but contain the
protocol/address family that Kamailio will use to send the message</li><li>msg:len - when used in an onsend_route, msg:len will contain the
length of the message on the wire (after all the changes in the
script are applied, Vias are added a.s.o) and not the lentgh of the
original message.</li></ul><h3 id=1178-event_route>1.17.8. event_route<a hidden class=anchor aria-hidden=true href=#1178-event_route>#</a></h3><p>Generic type of route executed when specific events happen.</p><p>Prototype: <code>event_route[groupid:eventid]</code></p><ul><li>groupid - should be the name of the module that triggers the event</li><li>eventid - some meaningful short text describing the event</li></ul><h4 id=11781-core-event-routes>1.17.8.1. Core Event Routes<a hidden class=anchor aria-hidden=true href=#11781-core-event-routes>#</a></h4><p>Implementations:</p><ul><li><code>event_route[core:worker-one-init]</code> - executed by core after the
first udp sip worker process executed the child_init() for all
modules, before starting to process sip traffic<ul><li>note that due to forking, other sip workers can get faster to
listening for sip traffic</li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>event_route[core:worker<span style=color:#f92672>-</span>one<span style=color:#f92672>-</span>init] {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>xlog</span>(<span style=color:#e6db74>&#34;L_INFO&#34;</span>,<span style=color:#e6db74>&#34;Hello world</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>event_route[core:msg-received]</code> - executed when a message is
received from the network. It runs with a faked request and makes
available the $rcv(key) variables to access what was received and
related attribtues.<ul><li>it has to be enabled with received_route_mode global parameter.
For usage via Kemi, set kemi.received_route_callback global
parameter.</li><li>if drop is executed, the received message is no longer processed</li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>event_route[core:msg<span style=color:#f92672>-</span>received] {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>xlog</span>(<span style=color:#e6db74>&#34;rcv on $rcv(af)/$rcv(proto): ($rcv(len)) [$rcv(buf)] from [$rcv(srcip):$rcv(srcport)] to [$rcv(rcvip):$rcv(rcvport)]</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span>(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>rcv</span>(srcip) <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;1.2.3.4&#34;</span>) {
</span></span><span style=display:flex><span>    drop;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>event_route[core:pre-routing]</code> - executed by core on receiving
SIP traffic before running request_route or reply_route.<ul><li>if drop is used, then the message is not processed further with
request_route or reply_route in the same process. This can be
useful together with sworker module which can delegate the
processing to another worker.</li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>async_workers_group<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;name=reg;workers=4&#34;</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>event_route[core:pre<span style=color:#f92672>-</span>routing] {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xinfo</span>(<span style=color:#e6db74>&#34;pre-routing rules</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>is_method</span>(<span style=color:#e6db74>&#34;REGISTER&#34;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#75715e># delegate processing of REGISTERs to a special group of workers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>sworker_task</span>(<span style=color:#e6db74>&#34;reg&#34;</span>)) {
</span></span><span style=display:flex><span>            drop;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>event_route[core:receive-parse-error]</code> - executed by core
on receiving a broken SIP message that can not be parsed.<ul><li>note that the SIP message is broken in this case, but it gets
access to source and local socket addresses (ip, port, proto,
af) as well as the whole message buffer and its size</li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>event_route[core:receive<span style=color:#f92672>-</span>parse<span style=color:#f92672>-</span>error] {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>xlog</span>(<span style=color:#e6db74>&#34;got a parsing error from $si:$sp, message $mb</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=11782-module-event-routes>1.17.8.2. Module Event Routes<a hidden class=anchor aria-hidden=true href=#11782-module-event-routes>#</a></h4><p>Here are only a few examples, to see if a module exports event_route
blocks and when they are executed, check the readme of the module.</p><ul><li><code>event_route[htable:mod-init]</code> - executed by <strong>htable</strong> module
after all modules have been initialised. Good for initialising
values in hash tables.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a6e22e>modparam</span>(<span style=color:#e6db74>&#34;htable&#34;</span>, <span style=color:#e6db74>&#34;htable&#34;</span>, <span style=color:#e6db74>&#34;a=&gt;size=4;&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>event_route[htable:mod<span style=color:#f92672>-</span>init] {
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>sht</span>(a<span style=color:#f92672>=&gt;</span>calls<span style=color:#f92672>-</span>to<span style=color:#f92672>::</span><span style=color:#ae81ff>10.10.10.10</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>sht</span>(a<span style=color:#f92672>=&gt;</span>max<span style=color:#f92672>-</span>calls<span style=color:#f92672>-</span>to<span style=color:#f92672>::</span><span style=color:#ae81ff>10.10.10.10</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>request_route {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>is_method</span>(<span style=color:#e6db74>&#34;INVITE&#34;</span>) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>has_totag</span>())
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span>(<span style=color:#960050;background-color:#1e0010>$</span>rd) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;10.10.10.10&#34;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>lock</span>(<span style=color:#e6db74>&#34;calls-to::10.10.10.10&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>sht</span>(a<span style=color:#f92672>=&gt;</span>calls<span style=color:#f92672>-</span>to<span style=color:#f92672>::</span><span style=color:#ae81ff>10.10.10.10</span>) <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>sht</span>(a<span style=color:#f92672>=&gt;</span>calls<span style=color:#f92672>-</span>to<span style=color:#f92672>::</span><span style=color:#ae81ff>10.10.10.10</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>unlock</span>(<span style=color:#e6db74>&#34;calls-to::10.10.10.10&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>sht</span>(a<span style=color:#f92672>=&gt;</span>calls<span style=color:#f92672>-</span>to<span style=color:#f92672>::</span><span style=color:#ae81ff>10.10.10.10</span>)<span style=color:#f92672>&gt;</span><span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>sht</span>(a<span style=color:#f92672>=&gt;</span>max<span style=color:#f92672>-</span>calls<span style=color:#f92672>-</span>to<span style=color:#f92672>::</span><span style=color:#ae81ff>10.10.10.10</span>))
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>           <span style=color:#a6e22e>sl_send_reply</span>(<span style=color:#e6db74>&#34;500&#34;</span>, <span style=color:#e6db74>&#34;To many calls to .10&#34;</span>);
</span></span><span style=display:flex><span>           exit;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      ...
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>event_route[tm:local-request]</code> - executed on locally generated
requests.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>event_route [tm:local<span style=color:#f92672>-</span>request] { <span style=color:#960050;background-color:#1e0010>#</span> Handle locally generated requests
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>xlog</span>(<span style=color:#e6db74>&#34;L_INFO&#34;</span>, <span style=color:#e6db74>&#34;Routing locally generated $rm to &lt;$ru&gt;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>t_set_fr</span>(<span style=color:#ae81ff>10000</span>, <span style=color:#ae81ff>10000</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>event_route[tm:branch-failure]</code> - executed on all failure
responses.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>request_route {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t_on_branch_failure</span>(<span style=color:#e6db74>&#34;myroute&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t_relay</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>event_route[tm:branch<span style=color:#f92672>-</span>failure:myroute] {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>xlog</span>(<span style=color:#e6db74>&#34;L_INFO&#34;</span>, <span style=color:#e6db74>&#34;Handling $T_reply_code response to $rm to &lt;$ru&gt;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>t_check_status</span>(<span style=color:#e6db74>&#34;430&#34;</span>)) { <span style=color:#960050;background-color:#1e0010>#</span> Outbound flow failed
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>unregister</span>(<span style=color:#e6db74>&#34;location&#34;</span>, <span style=color:#e6db74>&#34;$tu&#34;</span>, <span style=color:#e6db74>&#34;$T_reply_ruid&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>t_next_contact_flow</span>()) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>t_relay</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=118-script-statements>1.18. Script Statements<a hidden class=anchor aria-hidden=true href=#118-script-statements>#</a></h2><h3 id=1181-if>1.18.1. if<a hidden class=anchor aria-hidden=true href=#1181-if>#</a></h3><p>IF-ELSE statement</p><p>Prototype:</p><pre><code>    if(expr) {
       actions;
    } else {
       actions;
    }
</code></pre><p>The <code>expr</code> should be a valid logical expression.</p><p>The logical operators that can be used in <code>expr</code>:</p><ul><li><code>==</code>: equal</li><li><code>!=</code>: not equal</li><li><code>=~</code>: case-insensitive regular expression matching: Note: Posix regular expressions will be used, e.g. use <code>[[:digit:]]{3}</code> instead of <code>\d\d\d</code></li><li><code>!~</code>: regular expression not-matching (NOT PORTED from Kamailio 1.x, use <code>!(x =~ y)</code>)</li><li><code>></code>: greater</li><li><code>>=</code>: greater or equal</li><li><code>&lt;</code>: less</li><li><code>&lt;=</code>: less or equal</li><li><code>&&</code>: logical AND</li><li><code>||</code>: logical OR</li><li><code>!</code>: logical NOT</li></ul><p>Example of usage:</p><pre><code>  if(is_method(&quot;INVITE&quot;))
  {
      log(&quot;this sip message is an invite\n&quot;);
  } else {
      log(&quot;this sip message is not an invite\n&quot;);
  }
</code></pre><p>See also the FAQ for how the function return code is evaluated:</p><ul><li><a href=../../tutorials/faq/main.md#how-is-the-function-return-code-evaluated>How is the function code evaluated</a></li></ul><h3 id=1182-switch>1.18.2. switch<a hidden class=anchor aria-hidden=true href=#1182-switch>#</a></h3><p>SWITCH statement - it can be used to test the value of a
pseudo-variable.</p><p>IMPORTANT NOTE: <code>break</code> can be used only to mark the end of a <code>case</code>
branch (as it is in shell scripts). If you are trying to use <code>break</code>
outside a <code>case</code> block the script will return error &ndash; you must use
<code>return</code> there.</p><p>Example of usage:</p><pre><code>    route {
        route(1);
        switch($retcode)
        {
            case -1:
                log(&quot;process INVITE requests here\n&quot;);
            break;
            case 1:
                log(&quot;process REGISTER requests here\n&quot;);
            break;
            case 2:
            case 3:
                log(&quot;process SUBSCRIBE and NOTIFY requests here\n&quot;);
            break;
            default:
                log(&quot;process other requests here\n&quot;);
       }

        # switch of R-URI username
        switch($rU)
        {
            case &quot;101&quot;:
                log(&quot;destination number is 101\n&quot;);
            break;
            case &quot;102&quot;:
                log(&quot;destination number is 102\n&quot;);
            break;
            case &quot;103&quot;:
            case &quot;104&quot;:
                log(&quot;destination number is 103 or 104\n&quot;);
            break;
            default:
                log(&quot;unknown destination number\n&quot;);
       }
    }

    route[1]{
        if(is_method(&quot;INVITE&quot;))
        {
            return(-1);
        };
        if(is_method(&quot;REGISTER&quot;))
            return(1);
        }
        if(is_method(&quot;SUBSCRIBE&quot;))
            return(2);
        }
        if(is_method(&quot;NOTIFY&quot;))
            return(3);
        }
        return(-2);
    }
</code></pre><p>NOTE: take care while using <code>return</code> - <code>return(0)</code> stops the execution
of the script.</p><h3 id=1183-while>1.18.3. while<a hidden class=anchor aria-hidden=true href=#1183-while>#</a></h3><p>while statement</p><p>Example of usage:</p><pre><code>  $var(i) = 0;
  while($var(i) &lt; 10)
  {
      xlog(&quot;counter: $var(i)\n&quot;);
      $var(i) = $var(i) + 1;
  }
</code></pre><h2 id=119-script-operations>1.19. Script Operations<a hidden class=anchor aria-hidden=true href=#119-script-operations>#</a></h2><p>Assignments together with string and arithmetic operations can be done
directly in configuration file.</p><h3 id=1191-assignment>1.19.1. Assignment<a hidden class=anchor aria-hidden=true href=#1191-assignment>#</a></h3><p>Assignments can be done like in C, via <code>=</code> (equal). The following
pseudo-variables can be used in left side of an assignment:</p><ul><li>Unordered List Item AVPs - to set the value of an AVP</li><li>script variables <code>($var(...))</code> - to set the value of a script variable</li><li>shared variables (<code>$shv(...)</code>)</li><li><code>$ru</code> - to set R-URI</li><li><code>$rd</code> - to set domain part of R-URI</li><li><code>$rU</code> - to set user part of R-URI</li><li><code>$rp</code> - to set the port of R-URI</li><li><code>$du</code> - to set dst URI</li><li><code>$fs</code> - to set send socket</li><li><code>$br</code> - to set branch</li><li><code>$mf</code> - to set message flags value</li><li><code>$sf</code> - to set script flags value</li><li><code>$bf</code> - to set branch flags value</li></ul><pre><code>$var(a) = 123;
</code></pre><p>For avp&rsquo;s there a way to remove all values and assign a single value in
one statement (in other words, delete existing AVPs with same name, add
a new one with the right side value). This replaces the <code>:=</code> assignment
operator from kamailio <code>&lt; 3.0</code>.</p><pre><code>$(avp(i:3)[*]) = 123;
$(avp(i:3)[*]) = $null;
</code></pre><h3 id=1192-string-operations>1.19.2. String Operations<a hidden class=anchor aria-hidden=true href=#1192-string-operations>#</a></h3><p>For strings, <code>+</code> is available to concatenate.</p><pre><code>$var(a) = &quot;test&quot;;
$var(b) = &quot;sip:&quot; + $var(a) + &quot;@&quot; + $fd;
</code></pre><h3 id=1193-arithmetic-operations>1.19.3. Arithmetic Operations<a hidden class=anchor aria-hidden=true href=#1193-arithmetic-operations>#</a></h3><p>For numbers, one can use:</p><ul><li><code>+</code> : plus</li><li><code>-</code> : minus</li><li><code>/</code> : divide</li><li><code>*</code> : multiply</li><li><code>%</code> : modulo (Kamailio uses <code>mod</code> instead of <code>%</code>)</li><li><code>|</code> : bitwise OR</li><li><code>&</code> : bitwise AND</li><li><code>^</code> : bitwise XOR</li><li><code>~</code> : bitwise NOT</li><li><code>&lt;&lt;</code> : bitwise left shift</li><li><code>>></code> : bitwise right shift</li></ul><p>Example:</p><pre><code>$var(a) = 4 + ( 7 &amp; ( ~2 ) );
</code></pre><p>NOTE: to ensure the priority of operands in expression evaluations do
use parenthesis.</p><p>Arithmetic expressions can be used in condition expressions.</p><pre><code>if( $var(a) &amp; 4 )
    log(&quot;var a has third bit set\n&quot;);
</code></pre><h2 id=120-operators>1.20. Operators<a hidden class=anchor aria-hidden=true href=#120-operators>#</a></h2><ol><li>type casts operators: <code>(int)</code>, <code>(str)</code>.</li><li>string comparison: <code>eq</code>, <code>ne</code></li><li>integer comparison: <code>ieq</code>, <code>ine</code></li></ol><p>Note: The names are not yet final (use them at your own risk). Future
version might use <code>==</code>/<code>!=</code> only for ints (<code>ieq/ine</code>) and <code>eq/ne</code> for strings
(under debate). They are almost equivalent to <code>==</code> or <code>!=</code>, but they force
the conversion of their operands (<code>eq</code> to string and <code>ieq</code> to int), allowing
among other things better type checking on startup and more
optimizations.</p><p>Non equiv. examples:</p><p><code>0 == ""</code> (true) is not equivalent to <code>0 eq ""</code> (false: it evaluates to <code>"0" eq ""</code>).</p><p><code>"a" ieq "b"</code> (true: <code>(int)"a" is 0</code> and <code>(int)"b" is 0</code>) is not equivalent to <code>"a" == "b"</code> (false).</p><p>Note: internally <code>==</code> and <code>!=</code> are converted on startup to <code>eq/ne/ieq/ine</code>
whenever possible (both operand types can be safely determined at start
time and they are the same).</p><ol><li>Kamailio tries to guess what the user wanted when operators that
support multiple types are used on different typed operands. In
general convert the right operand to the type of the left operand
and then perform the operation. Exception: the left operand is
undef. This applies to the following operators: <code>+</code>, <code>==</code> and <code>!=</code>.</li></ol><pre><code>   Special case: undef as left operand:
   For +: undef + expr -&gt; undef is converted to string =&gt; &quot;&quot; + expr.
   For == and !=:   undef == expr -&gt; undef is converted to type_of expr.
   If expr is undef, then undef == undef is true (internally is converted
   to string).
</code></pre><ol><li>expression evaluation changes: Kamailio will auto-convert to integer
or string in function of the operators:</li></ol><pre><code>     int(undef)==0,  int(&quot;&quot;)==0, int(&quot;123&quot;)==123, int(&quot;abc&quot;)==0
     str(undef)==&quot;&quot;, str(123)==&quot;123&quot;.
</code></pre><ol><li>script operators for dealing with empty/undefined variables</li></ol><pre><code>    defined expr - returns true if expr is defined, and false if not.
                   Note: only a standalone avp or pvar can be
                   undefined, everything else is defined.
    strlen(expr) - returns the lenght of expr evaluated as string.
    strempty(expr) - returns true if expr evaluates to the empty
                     string (equivalent to expr==&quot;&quot;).
    Example: if (defined $v &amp;&amp; !strempty($v)) $len=strlen($v);
</code></pre><h2 id=121-command-line-parameters>1.21. Command Line Parameters<a hidden class=anchor aria-hidden=true href=#121-command-line-parameters>#</a></h2><p>Kamailio can be started with a set of command line parameters, providing
more flexibility to control what is doing at runtime. Some of them can
be quite useful when running on containerised environments.</p><p>To see the the available command line parameters, run <strong>kamailio -h</strong>:</p><pre><code># kamailio -h

version: kamailio 5.4.0-dev4 (x86_64/darwin) 8c1864
Usage: kamailio [options]
Options:
    -a mode      Auto aliases mode: enable with yes or on,
                  disable with no or off
    --alias=val  Add an alias, the value has to be '[proto:]hostname[:port]'
                  (like for 'alias' global parameter)
    -A define    Add config pre-processor define (e.g., -A WITH_AUTH,
                  -A 'FLT_ACC=1', -A 'DEFVAL=&quot;str-val&quot;')
    -b nr        Maximum receive buffer size which will not be exceeded by
                  auto-probing procedure even if  OS allows
    -c           Check configuration file for syntax errors
    -d           Debugging mode (multiple -d increase the level)
    -D           Control how daemonize is done:
                  -D..do not fork (almost) anyway;
                  -DD..do not daemonize creator;
                  -DDD..daemonize (default)
    -e           Log messages printed in terminal colors (requires -E)
    -E           Log to stderr
    -f file      Configuration file (default: /usr/local/etc/kamailio/kamailio.cfg)
    -g gid       Change gid (group id)
    -G file      Create a pgid file
    -h           This help message
    --help       Long option for `-h`
    -I           Print more internal compile flags and options
    -K           Turn on &quot;via:&quot; host checking when forwarding replies
    -l address   Listen on the specified address/interface (multiple -l
                  mean listening on more addresses). The address format is
                  [proto:]addr_lst[:port][/advaddr],
                  where proto=udp|tcp|tls|sctp,
                  addr_lst= addr|(addr, addr_lst),
                  addr=host|ip_address|interface_name and
                  advaddr=addr[:port] (advertised address).
                  E.g: -l localhost, -l udp:127.0.0.1:5080, -l eth0:5062,
                  -l udp:127.0.0.1:5080/1.2.3.4:5060,
                  -l &quot;sctp:(eth0)&quot;, -l &quot;(eth0, eth1, 127.0.0.1):5065&quot;.
                  The default behaviour is to listen on all the interfaces.
    --loadmodule=name load the module specified by name
    --log-engine=log engine name and data
    -L path      Modules search path (default: /usr/local/lib64/kamailio/modules)
    -m nr        Size of shared memory allocated in Megabytes
    --modparam=modname:paramname:type:value set the module parameter
                  type has to be 's' for string value and 'i' for int value,
                  example: --modparam=corex:alias_subdomains:s:kamailio.org
    -M nr        Size of private memory allocated, in Megabytes
    -n processes Number of child processes to fork per interface
                  (default: 8)
    -N           Number of tcp child processes (default: equal to `-n')
    -O nr        Script optimization level (debugging option)
    -P file      Create a pid file
    -Q           Number of sctp child processes (default: equal to `-n')
    -r           Use dns to check if is necessary to add a &quot;received=&quot;
                  field to a via
    -R           Same as `-r` but use reverse dns;
                  (to use both use `-rR`)
    --server-id=num set the value for server_id
    --subst=exp set a subst preprocessor directive
    --substdef=exp set a substdef preprocessor directive
    --substdefs=exp set a substdefs preprocessor directive
    -S           disable sctp
    -t dir       Chroot to &quot;dir&quot;
    -T           Disable tcp
    -u uid       Change uid (user id)
    -v           Version number
    --version    Long option for `-v`
    -V           Alternative for `-v`
    -x name      Specify internal manager for shared memory (shm)
                  - can be: fm, qm or tlsf
    -X name      Specify internal manager for private memory (pkg)
                  - if omitted, the one for shm is used
    -Y dir       Runtime dir path
    -w dir       Change the working directory to &quot;dir&quot; (default: &quot;/&quot;)
    -W type      poll method (depending on support in OS, it can be: poll,
                  epoll_lt, epoll_et, sigio_rt, select, kqueue, /dev/poll)
</code></pre><h3 id=1211-log-engine-cli-parameter>1.21.1. Log Engine CLI Parameter<a hidden class=anchor aria-hidden=true href=#1211-log-engine-cli-parameter>#</a></h3><p>The <strong>&ndash;log-engine</strong> parameter allows to specify what logging engine to
be used, which is practically about the format of the log messages. If
not set at all, then Kamailio does the classic style of line-based plain
text log messages.</p><p>The value of this parameter can be <strong>&ndash;log-engine=name</strong> or
<strong>&ndash;log-engine=name:data</strong>.</p><p>The name of the log engine can be:</p><ul><li><strong>json</strong> - write logs in structured JSON format<ul><li>the <strong>data</strong> for <strong>json</strong> log engine can be a set of character
flags:<ul><li><strong>a</strong> - add log prefix as a special field</li><li><strong>A</strong> - do not add log prefix</li><li><strong>c</strong> - add Call-ID (when available) as a dedicated JSON
attribute</li><li><strong>j</strong> - the log prefix and message fields are printed in
JSON structure format, detecting if they are enclosed in
between <strong>{ }</strong> or adding them as a <strong>text</strong> field</li><li><strong>M</strong> - strip EOL (&rsquo;\n&rsquo;) from the value of the log message
field</li><li><strong>N</strong> - do not add EOL at the end of JSON document</li><li><strong>p</strong> - the log prefix is printed as it is in the root json
document, it has to start with comma (<strong>,</strong>) and be a valid
set of json fields</li><li><strong>U</strong> - CEE (Common Event Expression) schema format -
<a href=https://cee.mitre.org/language/1.0-beta1/core-profile.html>https://cee.mitre.org/language/1.0-beta1/core-profile.html</a></li></ul></li></ul></li></ul><p>Example of JSON logs when running Kamailio with
&ldquo;<strong>&ndash;log-engine=json:M</strong>&rdquo; :</p><pre><code>{ &quot;idx&quot;: 1, &quot;pid&quot;: 18239, &quot;level&quot;: &quot;DEBUG&quot;, &quot;module&quot;: &quot;maxfwd&quot;, &quot;file&quot;: &quot;mf_funcs.c&quot;, &quot;line&quot;: 74, &quot;function&quot;: &quot;is_maxfwd_present&quot;, &quot;logprefix&quot;: &quot;{1 1 OPTIONS 715678756@192.168.188.20} &quot;, &quot;message&quot;: &quot;value = 70 &quot; }

{ &quot;idx&quot;: 1, &quot;pid&quot;: 18239, &quot;level&quot;: &quot;DEBUG&quot;, &quot;module&quot;: &quot;core&quot;, &quot;file&quot;: &quot;core/socket_info.c&quot;, &quot;line&quot;: 644, &quot;function&quot;: &quot;grep_sock_info&quot;, &quot;logprefix&quot;: &quot;{1 1 OPTIONS 715678756@192.168.188.20} &quot;, &quot;message&quot;: &quot;checking if host==us: 9==9 &amp;&amp; [127.0.0.1] == [127.0.0.1]&quot; }
</code></pre><p>Example config for printing log message with <strong>j</strong> flag:</p><pre><code>xinfo(&quot;{ \&quot;src_ip\&quot;: \&quot;$si\&quot;, \&quot;method\&quot;: \&quot;$rm\&quot;, \&quot;text\&quot;: \&quot;request received\&quot; }&quot;);
</code></pre><p>Example config for printing log messages with <strong>p</strong> flag:</p><pre><code>log_prefix=&quot;, \&quot;src_ip\&quot;: \&quot;$si\&quot;, \&quot;tv\&quot;: $TV(Sn), \&quot;mt\&quot;: $mt, \&quot;ua\&quot;: \&quot;$(ua{s.escape.common})\&quot;, \&quot;cseq\&quot;: \&quot;$hdr(CSeq)\&quot;&quot;
</code></pre></div><footer class=post-footer><ul class=post-tags><li><a href=https://wdd.js.org/tags/all/>All</a></li></ul></footer><script src=https://giscus.app/client.js data-repo=wangduanduan/wangduanduan.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxMTkyMjMyNjA=" data-category=Announcements data-category-id=DIC_kwDOBxsz3M4CAjBq data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2025 <a href=https://wdd.js.org/>洞香春</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>