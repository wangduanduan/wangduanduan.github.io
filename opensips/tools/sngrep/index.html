<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>sngrep: 最好用的sip可视化抓包工具 | 洞香春</title><meta name=keywords content><meta name=description content="1. 安装 1.1. centos vim /etc/yum.repos.d/irontec.repo
[irontec] name=Irontec RPMs repository baseurl=http://packages.irontec.com/centos/$releasever/$basearch/ rpm &ndash;import http://packages.irontec.com/public.keyyum install sngrep
1.2 debian/ubuntu # debian 安装sngrep echo &#34;deb http://packages.irontec.com/debian jessie main&#34; >> /etc/apt/sources.list wget http://packages.irontec.com/public.key -q -O - | apt-key add - apt-get install sngrep -y debian buster 即 debian10以上可以直接 apt-get install sngrep 1.3 arch/manjaro yay -Syu sngrep 参考： https://aur.archlinux.org/packages/sngrep/
如果报错，编辑 /etc/makepkg.conf文件，删除其中的-Werror=format-security
CFLAGS=&#34;-march=x86-64 -mtune=generic -O2 -pipe -fno-plt -fexceptions \ -Wp,-D_FORTIFY_SOURCE=2 -Wformat -Werror=format-security \ -fstack-clash-protection -fcf-protection&#34; 2."><meta name=author content="Eddie Wang"><link rel=canonical href=https://wdd.js.org/opensips/tools/sngrep/><link crossorigin=anonymous href=/assets/css/stylesheet.min.ceab085cbbf58c0ec96f6d415d51b3b44e204edfd71a45b4fa2d4aac13f119d0.css integrity="sha256-zqsIXLv1jA7Jb21BXVGztE4gTt/XGkW0+i1KrBPxGdA=" rel="preload stylesheet" as=style><link crossorigin=anonymous herf=/font-awesome/css/font-awesome.min.css rel=stylesheet type=text/css><link rel=preload href=/cowboy.ico as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/cowboy.ico><link rel=apple-touch-icon href=https://wdd.js.org/cowboy.ico><link rel=mask-icon href=https://wdd.js.org/cowboy.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.119.0"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="sngrep: 最好用的sip可视化抓包工具"><meta property="og:description" content="1. 安装 1.1. centos vim /etc/yum.repos.d/irontec.repo
[irontec] name=Irontec RPMs repository baseurl=http://packages.irontec.com/centos/$releasever/$basearch/ rpm &ndash;import http://packages.irontec.com/public.keyyum install sngrep
1.2 debian/ubuntu # debian 安装sngrep echo &#34;deb http://packages.irontec.com/debian jessie main&#34; >> /etc/apt/sources.list wget http://packages.irontec.com/public.key -q -O - | apt-key add - apt-get install sngrep -y debian buster 即 debian10以上可以直接 apt-get install sngrep 1.3 arch/manjaro yay -Syu sngrep 参考： https://aur.archlinux.org/packages/sngrep/
如果报错，编辑 /etc/makepkg.conf文件，删除其中的-Werror=format-security
CFLAGS=&#34;-march=x86-64 -mtune=generic -O2 -pipe -fno-plt -fexceptions \ -Wp,-D_FORTIFY_SOURCE=2 -Wformat -Werror=format-security \ -fstack-clash-protection -fcf-protection&#34; 2."><meta property="og:type" content="article"><meta property="og:url" content="https://wdd.js.org/opensips/tools/sngrep/"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="opensips"><meta property="article:published_time" content="2019-07-02T22:19:09+08:00"><meta property="article:modified_time" content="2019-07-02T22:19:09+08:00"><meta property="og:site_name" content="洞香春"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="sngrep: 最好用的sip可视化抓包工具"><meta name=twitter:description content="1. 安装 1.1. centos vim /etc/yum.repos.d/irontec.repo
[irontec] name=Irontec RPMs repository baseurl=http://packages.irontec.com/centos/$releasever/$basearch/ rpm &ndash;import http://packages.irontec.com/public.keyyum install sngrep
1.2 debian/ubuntu # debian 安装sngrep echo &#34;deb http://packages.irontec.com/debian jessie main&#34; >> /etc/apt/sources.list wget http://packages.irontec.com/public.key -q -O - | apt-key add - apt-get install sngrep -y debian buster 即 debian10以上可以直接 apt-get install sngrep 1.3 arch/manjaro yay -Syu sngrep 参考： https://aur.archlinux.org/packages/sngrep/
如果报错，编辑 /etc/makepkg.conf文件，删除其中的-Werror=format-security
CFLAGS=&#34;-march=x86-64 -mtune=generic -O2 -pipe -fno-plt -fexceptions \ -Wp,-D_FORTIFY_SOURCE=2 -Wformat -Werror=format-security \ -fstack-clash-protection -fcf-protection&#34; 2."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"OpenSIPS2.4.X 中文实战系列","item":"https://wdd.js.org/opensips/"},{"@type":"ListItem","position":3,"name":"sngrep: 最好用的sip可视化抓包工具","item":"https://wdd.js.org/opensips/tools/sngrep/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"sngrep: 最好用的sip可视化抓包工具","name":"sngrep: 最好用的sip可视化抓包工具","description":"1. 安装 1.1. centos vim /etc/yum.repos.d/irontec.repo\n[irontec] name=Irontec RPMs repository baseurl=http://packages.irontec.com/centos/$releasever/$basearch/ rpm \u0026ndash;import http://packages.irontec.com/public.keyyum install sngrep\n1.2 debian/ubuntu # debian 安装sngrep echo \u0026#34;deb http://packages.irontec.com/debian jessie main\u0026#34; \u0026gt;\u0026gt; /etc/apt/sources.list wget http://packages.irontec.com/public.key -q -O - | apt-key add - apt-get install sngrep -y debian buster 即 debian10以上可以直接 apt-get install sngrep 1.3 arch/manjaro yay -Syu sngrep 参考： https://aur.archlinux.org/packages/sngrep/\n如果报错，编辑 /etc/makepkg.conf文件，删除其中的-Werror=format-security\nCFLAGS=\u0026#34;-march=x86-64 -mtune=generic -O2 -pipe -fno-plt -fexceptions \\ -Wp,-D_FORTIFY_SOURCE=2 -Wformat -Werror=format-security \\ -fstack-clash-protection -fcf-protection\u0026#34; 2.","keywords":[],"articleBody":"1. 安装 1.1. centos vim /etc/yum.repos.d/irontec.repo\n[irontec] name=Irontec RPMs repository baseurl=http://packages.irontec.com/centos/$releasever/$basearch/ rpm –import http://packages.irontec.com/public.keyyum install sngrep\n1.2 debian/ubuntu # debian 安装sngrep echo \"deb http://packages.irontec.com/debian jessie main\" \u003e\u003e /etc/apt/sources.list wget http://packages.irontec.com/public.key -q -O - | apt-key add - apt-get install sngrep -y debian buster 即 debian10以上可以直接 apt-get install sngrep 1.3 arch/manjaro yay -Syu sngrep 参考： https://aur.archlinux.org/packages/sngrep/\n如果报错，编辑 /etc/makepkg.conf文件，删除其中的-Werror=format-security\nCFLAGS=\"-march=x86-64 -mtune=generic -O2 -pipe -fno-plt -fexceptions \\ -Wp,-D_FORTIFY_SOURCE=2 -Wformat -Werror=format-security \\ -fstack-clash-protection -fcf-protection\" 2. 命令行参数 sngrep [-hVcivNqrD] [-IO pcap_dump] [-d dev] [-l limit] [-k keyfile] [-LH capture_url] [] [] -h --help: 显示帮助信息 -V --version: 显示版本信息 -d --device: 指定抓包的网卡 -I --input: 从pacp文件中解析sip包 -O --output: 输出捕获的包到pacp文件中 -c --calls: 仅显示invite消息 -r --rtp: Capture RTP packets payload 捕获rtp包 -l --limit: 限制捕获对话的数量 -i --icase: 使大小写不敏感 -v --invert: 颠倒（不太明白） -N --no-interface: Don’t display sngrep interface, just capture -q --quiet: Don’t print captured dialogs in no interface mode -D --dump-config: Print active configuration settings and exit -f --config: Read configuration from file -R --rotate: Rotate calls when capture limit have been reached. -H --eep-send: Homer sipcapture url (udp:X.X.X.X:XXXX) -L --eep-listen: Listen for encapsulated packets (udp:X.X.X.X:XXXX) -k --keyfile: RSA private keyfile to decrypt captured packets 3. 页面 sngrep有四个页面，每个页面都有一些不同的快捷键。\n呼叫列表页面 呼叫流程页面 原始呼叫信息页面 信息对比页面 3.1 呼叫列表页面 快捷键\nArrow keys: Move through the list，除了上下箭头还可以使用j,k来移动光标 Enter: Display current or selected dialog(s) message flow A: Auto scroll to new calls，自动滚动到新的call F2 or s: Save selected/all dialog(s) to a PCAP file, 保存dialog到pacp文件 F3 or / or TAB: Enter a display filter. This filter will be applied to the text lines in the list，进入搜索 F4 or x: Display current selected dialog and its related one. 回到第一个sip消息上 F5: Clear call list, 清空呼叫列表 F6 or r: Display selected dialog(s) messages in raw text, 显示原始的sip消息 F7 or f: Show advanded filters dialogs 显示高级过滤弹窗 F9 or l: Turn on/off address resolution if enabled F10 or t: Select displayed columns, 显示或者隐藏侧边sip消息栏 呼叫列表页面还能够显示两个弹窗, 按f可以显示高级过滤配置\n按t可以显示, 自定义呼叫列选项弹窗\n3.2 呼叫流程页面 快捷键\n**Keybindings:\nArrow keys: Move through messages Enter: Display current message raw (so you can copy payload) F2 or d: 显示sdp消息，f2的某个模式会让时序图更紧凑 F3 or t: 显示或者关闭sip侧边栏 F4 or x: 回到顶部 F5 or s: 每个ip地址仅仅显示一列 F6 or R: 显示原始的sip消息 F7 or c: 改变颜色模式, 有的颜色模式很容易让人无法区分当前查看的sip消息是哪一个，所以需要改变颜色模式 F9 or l: Turn on/off address resolution if enabled 9 and 0: 增加或者减少侧边栏的宽度 T: 重绘侧边栏 D: 仅显示带有sdp的消息 空格键：选中一个sip消息，再次找个sip消息，然后就会进入对比模式 F1 or h: 显式帮助信息页面 3.3 原始sip消息界面 3.3 消息对比界面 在呼叫列表页面按空格键选中一个消息，然后选择另外一个sip消息后，再次按空格键，就可以进入消息对比页面\n4. 分析媒体问题 使用 sngrep -r 可以用来捕获媒体流，默认不加 -r 则只能显示信令。\n在呼叫流程页面，按下F3, 可以动态的查看媒体流的情况。在分析语音问题时，这是非常方便的分析工具。 5. 扩展技法 5.1 无界面模式 假如说有个很大的语音文件，假如说有1.5G吧，如果用wireshark直接打开，有可能wireshark直接卡死，也有可能在搜索的时候就崩溃了。\n即使有sngrep来直接读取pcap文件，也可能会非常慢。\n假如说我们只想从这1.5G文件中找到本叫号码包含1234的，应该怎么处理呢？\n用下面的命令就可以：\nsngrep -rI test.pcap 1234 -N -O dst.pcap Dialog count: 17 -r 读区语音流 -I 从pcap文件中读取 -N 不要界面 -O 将匹配的结果写到其他文件中 经过上面的命令，一个很大的pcap文件，在处理之后，就会变成我们关心的小的包文件。比较容易处理了。\n5.1 个性化配置 在呼叫列表界面，按F8可以进入到个性化配置界面，如下：\n个性化配置页面有三个Tab页面, 三个页面可以用翻页的pageUp， pageDown来切换。在macbook上可能没有翻页键，那你要用fn + 上下方向键 来翻页\nInterface Capture Call Flow 在每个页面可以用上下键来选择不同的设置项，按左右键改变对应的值。也可以按空格键来改变对应的值。\n在每个Tab页面，可以按Tab键在设置项和下面的Accept和Save、Cancel之间切换。\n我们的个性化配置可以用Save来保存下来，不然每次都要再设置一边。\n1. interface 页面 2. Capture设置界面 配置抓包相关的信息，例如最大抓包的数量，网卡设备，是否启用事务，默认的保存文件路径等等。 3. Call Flow页面 这个页面用来设置呼叫时序图页面。就不再过多介绍。\n我用的比较多的，可能是Merge Columns witch same addrsss。 sngrep默认用IP:PORT作为时序图中的一个竖线。但是如果IP相同，端口号不同。sngrep就会划出很多竖线。启用了改项之后，就只会根据IP来划竖线。 区分IP和端口： Merge columns with same address on 表示只根据IP来划竖线 off 表示根据IP:PORT来划线，如果你想在竖线上能看到端口信息，则需要设置为off 如下图所示，Merge columns with same address: off 如何更容易区分当前是在哪一信令上？ 有时候移动的快一点，例如只能看到SIP消息是REGISTER, 但是具体是哪一个REGISTER， 看的眼疼也区分不出来。 这时候Call Flow中的Selected message highlight就派上用场。\nblod 加粗 reverse 反色 reverseblod 反色并且加粗 一般情况下，reverse或者reverseblod都能让你更好的区分，下面就是使用reverser模式下的时序图\n可以很明显的看到，第三个REGISTER的背景色变一大块，所以当前就是在第三个REGISTER信令上。 6 . sngrep使用注意点 不要长时间用sngrep抓包，否则sgrep会占用非常多的内存。如果必须抓一段时间的包，务必使用tcpdump。 某些情况下，sngrep会丢包 某些情况下，sngrep会什么包都抓包不到，注意此时很可能要使用-d去指定抓包的网卡 sngrep只能捕获本机网卡的收到和发送的流量。假如ABC分别是三台独立虚拟机的SIP服务器，在B上抓包只能分析A-B, 和B-C直接的流量。 再次强调：sngrep不适合长时间抓包，只适合短时间抓包分析问题。如果你需要记录所有的sip消息，并展示。可以考虑使用siphub，或者homer。 ","wordCount":"485","inLanguage":"en","datePublished":"2019-07-02T22:19:09+08:00","dateModified":"2019-07-02T22:19:09+08:00","author":{"@type":"Person","name":"Eddie Wang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wdd.js.org/opensips/tools/sngrep/"},"publisher":{"@type":"Organization","name":"洞香春","logo":{"@type":"ImageObject","url":"https://wdd.js.org/cowboy.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org accesskey=h title="洞香春 (Alt + H)"><img src=/cowboy.ico alt=logo aria-label=logo height=35>洞香春</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/fe/ title=Frontend><span>Frontend</span></a></li><li><a href=https://wdd.js.org/golang/ title=Golang><span>Golang</span></a></li><li><a href=https://wdd.js.org/container/ title=k8s/docker><span>k8s/docker</span></a></li><li><a href=https://wdd.js.org/network/ title=Network><span>Network</span></a></li><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/shell/ title=Shell><span>Shell</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/categories/ title=分类><span>分类</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wdd.js.org>Home</a>&nbsp;»&nbsp;<a href=https://wdd.js.org/opensips/>OpenSIPS2.4.X 中文实战系列</a></div><h1 class=post-title>sngrep: 最好用的sip可视化抓包工具</h1><div class=post-meta><span title='2019-07-02 22:19:09 +0800 CST'>2019-07-02 22:19:09</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;Eddie Wang</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#1-%e5%ae%89%e8%a3%85 aria-label="1. 安装">1. 安装</a><ul><li><a href=#11-centos aria-label="1.1. centos">1.1. centos</a></li><li><a href=#12-debianubuntu aria-label="1.2 debian/ubuntu">1.2 debian/ubuntu</a></li><li><a href=#13-archmanjaro aria-label="1.3 arch/manjaro">1.3 arch/manjaro</a></li></ul></li><li><a href=#2-%e5%91%bd%e4%bb%a4%e8%a1%8c%e5%8f%82%e6%95%b0 aria-label="2. 命令行参数">2. 命令行参数</a></li><li><a href=#3-%e9%a1%b5%e9%9d%a2 aria-label="3. 页面">3. 页面</a><ul><li><a href=#31-%e5%91%bc%e5%8f%ab%e5%88%97%e8%a1%a8%e9%a1%b5%e9%9d%a2 aria-label="3.1 呼叫列表页面">3.1 呼叫列表页面</a></li><li><a href=#32-%e5%91%bc%e5%8f%ab%e6%b5%81%e7%a8%8b%e9%a1%b5%e9%9d%a2 aria-label="3.2 呼叫流程页面">3.2 呼叫流程页面</a></li><li><a href=#33-%e5%8e%9f%e5%a7%8bsip%e6%b6%88%e6%81%af%e7%95%8c%e9%9d%a2 aria-label="3.3 原始sip消息界面">3.3 原始sip消息界面</a></li><li><a href=#33-%e6%b6%88%e6%81%af%e5%af%b9%e6%af%94%e7%95%8c%e9%9d%a2 aria-label="3.3 消息对比界面">3.3 消息对比界面</a></li></ul></li><li><a href=#4-%e5%88%86%e6%9e%90%e5%aa%92%e4%bd%93%e9%97%ae%e9%a2%98 aria-label="4. 分析媒体问题">4. 分析媒体问题</a></li><li><a href=#5-%e6%89%a9%e5%b1%95%e6%8a%80%e6%b3%95 aria-label="5. 扩展技法">5. 扩展技法</a><ul><li><a href=#51-%e6%97%a0%e7%95%8c%e9%9d%a2%e6%a8%a1%e5%bc%8f aria-label="5.1 无界面模式">5.1 无界面模式</a></li><li><a href=#51-%e4%b8%aa%e6%80%a7%e5%8c%96%e9%85%8d%e7%bd%ae aria-label="5.1 个性化配置">5.1 个性化配置</a><ul><li><a href=#1-interface-%e9%a1%b5%e9%9d%a2 aria-label="1. interface 页面">1. interface 页面</a></li><li><a href=#2-capture%e8%ae%be%e7%bd%ae%e7%95%8c%e9%9d%a2 aria-label="2. Capture设置界面">2. Capture设置界面</a></li><li><a href=#3-call-flow%e9%a1%b5%e9%9d%a2 aria-label="3. Call Flow页面">3. Call Flow页面</a><ul><li><a href=#%e5%8c%ba%e5%88%86ip%e5%92%8c%e7%ab%af%e5%8f%a3-merge-columns-with-same-address aria-label="区分IP和端口： Merge columns with same address">区分IP和端口： Merge columns with same address</a></li><li><a href=#%e5%a6%82%e4%bd%95%e6%9b%b4%e5%ae%b9%e6%98%93%e5%8c%ba%e5%88%86%e5%bd%93%e5%89%8d%e6%98%af%e5%9c%a8%e5%93%aa%e4%b8%80%e4%bf%a1%e4%bb%a4%e4%b8%8a aria-label=如何更容易区分当前是在哪一信令上？>如何更容易区分当前是在哪一信令上？</a></li></ul></li></ul></li></ul></li><li><a href=#6--sngrep%e4%bd%bf%e7%94%a8%e6%b3%a8%e6%84%8f%e7%82%b9 aria-label="6 . sngrep使用注意点">6 . sngrep使用注意点</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=1-安装>1. 安装<a hidden class=anchor aria-hidden=true href=#1-安装>#</a></h1><h2 id=11-centos>1.1. centos<a hidden class=anchor aria-hidden=true href=#11-centos>#</a></h2><p>vim /etc/yum.repos.d/irontec.repo</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>irontec<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>name<span style=color:#f92672>=</span>Irontec RPMs repository
</span></span><span style=display:flex><span>baseurl<span style=color:#f92672>=</span>http://packages.irontec.com/centos/$releasever/$basearch/
</span></span></code></pre></div><p>rpm &ndash;import <a href=http://packages.irontec.com/public.key>http://packages.irontec.com/public.key</a>yum install sngrep</p><h2 id=12-debianubuntu>1.2 debian/ubuntu<a hidden class=anchor aria-hidden=true href=#12-debianubuntu>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># debian 安装sngrep </span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;deb http://packages.irontec.com/debian jessie main&#34;</span> &gt;&gt; /etc/apt/sources.list
</span></span><span style=display:flex><span>wget http://packages.irontec.com/public.key -q -O - | apt-key add -
</span></span><span style=display:flex><span>apt-get install sngrep -y
</span></span></code></pre></div><p>debian buster 即 debian10以上可以直接 <code>apt-get install sngrep</code> </p><h2 id=13-archmanjaro>1.3 arch/manjaro<a hidden class=anchor aria-hidden=true href=#13-archmanjaro>#</a></h2><pre tabindex=0><code>yay -Syu sngrep
</code></pre><p>参考： <a href=https://aur.archlinux.org/packages/sngrep/>https://aur.archlinux.org/packages/sngrep/</a></p><p>如果报错，编辑 /etc/makepkg.conf文件，删除其中的<code>-Werror=format-security</code></p><pre tabindex=0><code>CFLAGS=&#34;-march=x86-64 -mtune=generic -O2 -pipe -fno-plt -fexceptions \
    -Wp,-D_FORTIFY_SOURCE=2 -Wformat -Werror=format-security \
    -fstack-clash-protection -fcf-protection&#34;
</code></pre><h1 id=2-命令行参数>2. 命令行参数<a hidden class=anchor aria-hidden=true href=#2-命令行参数>#</a></h1><pre tabindex=0><code>sngrep
	[-hVcivNqrD]
	[-IO pcap_dump]
  [-d dev]
  [-l limit]
  [-k keyfile]
  [-LH capture_url]
  [&lt;match expression&gt;]
  [&lt;bpf filter&gt;]
</code></pre><ul><li><code>-h --help</code>: 显示帮助信息</li><li><code>-V --version</code>: 显示版本信息</li><li><code>-d --device</code>: 指定抓包的网卡</li><li><code>-I --input</code>: 从pacp文件中解析sip包</li><li><code>-O --output</code>: 输出捕获的包到pacp文件中</li><li><code>-c --calls</code>: 仅显示invite消息</li><li><code>-r --rtp</code>: Capture RTP packets payload 捕获rtp包</li><li><code>-l --limit</code>: 限制捕获对话的数量</li><li><code>-i --icase</code>: 使大小写不敏感</li><li><code>-v --invert</code>: 颠倒（不太明白）</li><li><code>-N --no-interface</code>: Don&rsquo;t display sngrep interface, just capture</li><li><code>-q --quiet</code>: Don&rsquo;t print captured dialogs in no interface mode</li><li><code>-D --dump-config</code>: Print active configuration settings and exit</li><li><code>-f --config</code>: Read configuration from file</li><li><code>-R --rotate</code>: Rotate calls when capture limit have been reached.</li><li><code>-H --eep-send</code>: Homer sipcapture url (udp:X.X.X.X:XXXX)</li><li><code>-L --eep-listen</code>: Listen for encapsulated packets (udp:X.X.X.X:XXXX)</li><li><code>-k --keyfile</code>: RSA private keyfile to decrypt captured packets</li></ul><h1 id=3-页面>3. 页面<a hidden class=anchor aria-hidden=true href=#3-页面>#</a></h1><p>sngrep有四个页面，每个页面都有一些不同的快捷键。</p><ol><li>呼叫列表页面</li><li>呼叫流程页面</li><li>原始呼叫信息页面</li><li>信息对比页面</li></ol><h2 id=31-呼叫列表页面>3.1 呼叫列表页面<a hidden class=anchor aria-hidden=true href=#31-呼叫列表页面>#</a></h2><p><img loading=lazy src=2022-12-02-17-06-23.png alt></p><p><strong>快捷键</strong></p><ul><li><strong>Arrow keys</strong>: Move through the list，除了上下箭头还可以使用j,k来移动光标</li><li><strong>Enter</strong>: Display current or selected dialog(s) message flow</li><li><strong>A</strong>: Auto scroll to new calls，自动滚动到新的call</li><li><strong>F2 or s</strong>: Save selected/all dialog(s) to a PCAP file, 保存dialog到pacp文件</li><li><strong>F3 or / or TAB</strong>: Enter a display filter. This filter will be applied to the text lines in the list，进入搜索</li><li><strong>F4 or x</strong>: Display current selected dialog and its related one. 回到第一个sip消息上</li><li><strong>F5</strong>: Clear call list, 清空呼叫列表</li><li><strong>F6 or r</strong>: Display selected dialog(s) messages in raw text, 显示原始的sip消息</li><li><strong>F7 or f</strong>: Show advanded filters dialogs 显示高级过滤弹窗</li><li><strong>F9 or l</strong>: Turn on/off address resolution if enabled</li><li><strong>F10 or t</strong>: Select displayed columns, 显示或者隐藏侧边sip消息栏</li></ul><p>呼叫列表页面还能够显示两个弹窗, <strong>按f可以显示高级过滤配置</strong></p><p><img loading=lazy src=2022-12-02-17-07-15.png alt></p><p><strong>按t可以显示, 自定义呼叫列选项弹窗</strong></p><p><img loading=lazy src=2022-12-02-17-07-29.png alt></p><h2 id=32-呼叫流程页面>3.2 呼叫流程页面<a hidden class=anchor aria-hidden=true href=#32-呼叫流程页面>#</a></h2><p><img loading=lazy src=2022-12-02-17-07-40.png alt></p><p><strong>快捷键</strong></p><p>**Keybindings:</p><ul><li><strong>Arrow keys</strong>: Move through messages</li><li><strong>Enter</strong>: Display current message raw (so you can copy payload)</li><li><strong>F2 or d</strong>: 显示sdp消息，f2的某个模式会让时序图更紧凑</li><li><strong>F3 or t</strong>: 显示或者关闭sip侧边栏</li><li><strong>F4 or x</strong>: 回到顶部</li><li><strong>F5 or s</strong>: 每个ip地址仅仅显示一列</li><li><strong>F6 or R</strong>: 显示原始的sip消息</li><li><strong>F7 or c</strong>: 改变颜色模式, 有的颜色模式很容易让人无法区分当前查看的sip消息是哪一个，所以需要改变颜色模式</li><li><strong>F9 or l</strong>: Turn on/off address resolution if enabled</li><li><strong>9 and 0</strong>: 增加或者减少侧边栏的宽度</li><li><strong>T</strong>: 重绘侧边栏</li><li><strong>D</strong>: 仅显示带有sdp的消息</li><li>空格键：选中一个sip消息，再次找个sip消息，然后就会进入对比模式</li><li>F1 or h: 显式帮助信息页面</li></ul><p><img loading=lazy src=2022-12-02-17-07-54.png alt></p><h2 id=33-原始sip消息界面>3.3 原始sip消息界面<a hidden class=anchor aria-hidden=true href=#33-原始sip消息界面>#</a></h2><p><img loading=lazy src=2022-12-02-17-08-07.png alt></p><h2 id=33-消息对比界面>3.3 消息对比界面<a hidden class=anchor aria-hidden=true href=#33-消息对比界面>#</a></h2><p>在呼叫列表页面按空格键选中一个消息，然后选择另外一个sip消息后，再次按空格键，就可以进入消息对比页面</p><p><img loading=lazy src=2022-12-02-17-08-18.png alt></p><h1 id=4-分析媒体问题>4. 分析媒体问题<a hidden class=anchor aria-hidden=true href=#4-分析媒体问题>#</a></h1><p>使用 <code>sngrep -r</code> 可以用来捕获媒体流，默认不加 <code>-r</code> 则只能显示信令。</p><p>在呼叫流程页面，按下F3, 可以动态的查看媒体流的情况。在分析语音问题时，这是非常方便的分析工具。
<img loading=lazy src=2022-12-02-17-08-30.png alt></p><h1 id=5-扩展技法>5. 扩展技法<a hidden class=anchor aria-hidden=true href=#5-扩展技法>#</a></h1><h2 id=51-无界面模式>5.1 无界面模式<a hidden class=anchor aria-hidden=true href=#51-无界面模式>#</a></h2><p>假如说有个很大的语音文件，假如说有1.5G吧，如果用wireshark直接打开，有可能wireshark直接卡死，也有可能在搜索的时候就崩溃了。</p><p>即使有sngrep来直接读取pcap文件，也可能会非常慢。</p><p>假如说我们只想从这1.5G文件中找到本叫号码包含1234的，应该怎么处理呢？</p><p>用下面的命令就可以：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-systemverilog data-lang=systemverilog><span style=display:flex><span>sngrep <span style=color:#f92672>-</span>rI test.pcap <span style=color:#ae81ff>1234</span> <span style=color:#f92672>-</span>N <span style=color:#f92672>-</span>O dst.pcap
</span></span><span style=display:flex><span>Dialog count: <span style=color:#ae81ff>17</span>
</span></span></code></pre></div><ul><li>-r 读区语音流</li><li>-I 从pcap文件中读取</li><li>-N 不要界面</li><li>-O 将匹配的结果写到其他文件中</li></ul><p>经过上面的命令，一个很大的pcap文件，在处理之后，就会变成我们关心的小的包文件。比较容易处理了。</p><h2 id=51-个性化配置>5.1 个性化配置<a hidden class=anchor aria-hidden=true href=#51-个性化配置>#</a></h2><p>在呼叫列表界面，按F8可以进入到个性化配置界面，如下：</p><p>个性化配置页面有三个Tab页面, 三个页面可以用翻页的pageUp， pageDown来切换。在macbook上可能没有翻页键，那你要用fn + 上下方向键 来翻页</p><ul><li>Interface</li><li>Capture</li><li>Call Flow</li></ul><p>在每个页面可以用上下键来选择不同的设置项，按左右键改变对应的值。也可以按空格键来改变对应的值。</p><p>在每个Tab页面，可以按Tab键在设置项和下面的Accept和Save、Cancel之间切换。</p><p>我们的个性化配置可以用Save来保存下来，不然每次都要再设置一边。</p><h3 id=1-interface-页面>1. interface 页面<a hidden class=anchor aria-hidden=true href=#1-interface-页面>#</a></h3><p><img loading=lazy src=2022-12-02-17-08-43.png alt></p><h3 id=2-capture设置界面>2. Capture设置界面<a hidden class=anchor aria-hidden=true href=#2-capture设置界面>#</a></h3><p>配置抓包相关的信息，例如最大抓包的数量，网卡设备，是否启用事务，默认的保存文件路径等等。
<img loading=lazy src=2022-12-02-17-08-55.png alt></p><h3 id=3-call-flow页面>3. Call Flow页面<a hidden class=anchor aria-hidden=true href=#3-call-flow页面>#</a></h3><p>这个页面用来设置呼叫时序图页面。就不再过多介绍。</p><p>我用的比较多的，可能是Merge Columns witch same addrsss。 sngrep默认用IP:PORT作为时序图中的一个竖线。但是如果IP相同，端口号不同。sngrep就会划出很多竖线。启用了改项之后，就只会根据IP来划竖线。
<img loading=lazy src=2022-12-02-17-09-14.png alt></p><h4 id=区分ip和端口-merge-columns-with-same-address>区分IP和端口： Merge columns with same address<a hidden class=anchor aria-hidden=true href=#区分ip和端口-merge-columns-with-same-address>#</a></h4><ul><li>on 表示只根据IP来划竖线</li><li>off 表示根据IP:PORT来划线，如果你想在竖线上能看到端口信息，则需要设置为off</li></ul><p>如下图所示，Merge columns with same address: off
<img loading=lazy src=2022-12-02-17-09-29.png alt></p><h4 id=如何更容易区分当前是在哪一信令上>如何更容易区分当前是在哪一信令上？<a hidden class=anchor aria-hidden=true href=#如何更容易区分当前是在哪一信令上>#</a></h4><p>有时候移动的快一点，例如只能看到SIP消息是REGISTER, 但是具体是哪一个REGISTER， 看的眼疼也区分不出来。
<img loading=lazy src=2022-12-02-17-09-45.png alt></p><p>这时候Call Flow中的Selected message highlight就派上用场。</p><ul><li>blod 加粗</li><li>reverse 反色</li><li>reverseblod 反色并且加粗</li></ul><p>一般情况下，reverse或者reverseblod都能让你更好的区分，下面就是使用reverser模式下的时序图</p><p>可以很明显的看到，第三个REGISTER的背景色变一大块，所以当前就是在第三个REGISTER信令上。
<img loading=lazy src=2022-12-02-17-11-19.png alt></p><h1 id=6--sngrep使用注意点>6 . sngrep使用注意点<a hidden class=anchor aria-hidden=true href=#6--sngrep使用注意点>#</a></h1><ul><li>不要长时间用sngrep抓包，否则sgrep会占用非常多的内存。如果必须抓一段时间的包，务必使用tcpdump。</li><li>某些情况下，sngrep会丢包</li><li>某些情况下，sngrep会什么包都抓包不到，注意此时很可能要使用-d去指定抓包的网卡</li><li>sngrep只能捕获本机网卡的收到和发送的流量。假如ABC分别是三台独立虚拟机的SIP服务器，在B上抓包只能分析A-B, 和B-C直接的流量。</li><li>再次强调：sngrep不适合长时间抓包，只适合短时间抓包分析问题。如果你需要记录所有的sip消息，并展示。可以考虑使用siphub，或者homer。</li></ul></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://wdd.js.org>洞香春</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>