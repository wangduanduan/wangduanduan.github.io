<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>UDP分片导致SIP消息丢失 | 洞香春</title>
<meta name=keywords content><meta name=description content="
现象
有了开源的框架，我们可以很方便的运行一个VOIP系统。但是维护一个VOIP系统并非那么简单。特别是如果经常出现一些偶发的问题，需要用经验丰富的运维人员来从不同层面分析。
其中UDP分片，也可能是原因之一。
简介
以太网的最大MTU一般是1500字节，减去20字节的IP首部，8字节的UDP首部，UDP能承载的数据最大是1472字节。
如果一个SIP消息的报文超过1472就会分片。（实际上，如果网络的MTU比1500更小，那么达到分片的尺寸也会变小）
如下图，发送方通过以太网发送了4个报文，ABCD。其中D报文太了，而被分割成了三个报文。在传输过程中，D的一个分片丢失，接收方由于无法重新组装D报文，所以就将D报文的所有分片都丢弃。
这将会导致一下问题

发送方因接收不到响应，所以产生了重传
丢弃的分片导致其他的分片浪费了带宽
IP分片是对发送者来说是简单的，但是对于接收者来说，分片的组装将会占用更多的资源


RFC 3261中给出建议，某些情况下可以使用TCP来传输。

当MTU是未知的情况下，如果消息超过1300字节，则选择使用TCP传输
当MTU是已知情况下，SIP的消息的大小如果大于MTU-200, 则需要使用TCP传输。留下200字节的余量，是因为SIP消息的响应可能大于SIP消息的请求，为了避免响应消息超过MTU，所以要留下200字节的余量。


If a request is within 200 bytes of the path MTU, or if it is larger
  than 1300 bytes and the path MTU is unknown, the request MUST be sent

  using an RFC 2914 [43] congestion controlled transport protocol, such

  as TCP. If this causes a change in the transport protocol from the"><meta name=author content="Eddie Wang"><link rel=canonical href=https://wdd.js.org/opensips/ch7/big-udp-msg/><link crossorigin=anonymous href=/assets/css/stylesheet.821c51435cba3e33e49e590a06514c54c32ac7957095ffcc1e0f390c47cf3228.css integrity="sha256-ghxRQ1y6PjPknlkKBlFMVMMqx5Vwlf/MHg85DEfPMig=" rel="preload stylesheet" as=style><link rel=icon href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/cowboy.ico><link rel=apple-touch-icon href=https://wdd.js.org/cowboy.ico><link rel=mask-icon href=https://wdd.js.org/cowboy.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://wdd.js.org/opensips/ch7/big-udp-msg/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://wdd.js.org/opensips/ch7/big-udp-msg/"><meta property="og:site_name" content="洞香春"><meta property="og:title" content="UDP分片导致SIP消息丢失"><meta property="og:description" content="
现象 有了开源的框架，我们可以很方便的运行一个VOIP系统。但是维护一个VOIP系统并非那么简单。特别是如果经常出现一些偶发的问题，需要用经验丰富的运维人员来从不同层面分析。
其中UDP分片，也可能是原因之一。
简介 以太网的最大MTU一般是1500字节，减去20字节的IP首部，8字节的UDP首部，UDP能承载的数据最大是1472字节。
如果一个SIP消息的报文超过1472就会分片。（实际上，如果网络的MTU比1500更小，那么达到分片的尺寸也会变小）
如下图，发送方通过以太网发送了4个报文，ABCD。其中D报文太了，而被分割成了三个报文。在传输过程中，D的一个分片丢失，接收方由于无法重新组装D报文，所以就将D报文的所有分片都丢弃。
这将会导致一下问题
发送方因接收不到响应，所以产生了重传 丢弃的分片导致其他的分片浪费了带宽 IP分片是对发送者来说是简单的，但是对于接收者来说，分片的组装将会占用更多的资源 RFC 3261中给出建议，某些情况下可以使用TCP来传输。
当MTU是未知的情况下，如果消息超过1300字节，则选择使用TCP传输 当MTU是已知情况下，SIP的消息的大小如果大于MTU-200, 则需要使用TCP传输。留下200字节的余量，是因为SIP消息的响应可能大于SIP消息的请求，为了避免响应消息超过MTU，所以要留下200字节的余量。 If a request is within 200 bytes of the path MTU, or if it is larger than 1300 bytes and the path MTU is unknown, the request MUST be sent
using an RFC 2914 [43] congestion controlled transport protocol, such
as TCP. If this causes a change in the transport protocol from the"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="opensips"><meta property="article:published_time" content="2021-04-08T14:33:49+08:00"><meta property="article:modified_time" content="2021-04-08T14:33:49+08:00"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="UDP分片导致SIP消息丢失"><meta name=twitter:description content="
现象
有了开源的框架，我们可以很方便的运行一个VOIP系统。但是维护一个VOIP系统并非那么简单。特别是如果经常出现一些偶发的问题，需要用经验丰富的运维人员来从不同层面分析。
其中UDP分片，也可能是原因之一。
简介
以太网的最大MTU一般是1500字节，减去20字节的IP首部，8字节的UDP首部，UDP能承载的数据最大是1472字节。
如果一个SIP消息的报文超过1472就会分片。（实际上，如果网络的MTU比1500更小，那么达到分片的尺寸也会变小）
如下图，发送方通过以太网发送了4个报文，ABCD。其中D报文太了，而被分割成了三个报文。在传输过程中，D的一个分片丢失，接收方由于无法重新组装D报文，所以就将D报文的所有分片都丢弃。
这将会导致一下问题

发送方因接收不到响应，所以产生了重传
丢弃的分片导致其他的分片浪费了带宽
IP分片是对发送者来说是简单的，但是对于接收者来说，分片的组装将会占用更多的资源


RFC 3261中给出建议，某些情况下可以使用TCP来传输。

当MTU是未知的情况下，如果消息超过1300字节，则选择使用TCP传输
当MTU是已知情况下，SIP的消息的大小如果大于MTU-200, 则需要使用TCP传输。留下200字节的余量，是因为SIP消息的响应可能大于SIP消息的请求，为了避免响应消息超过MTU，所以要留下200字节的余量。


If a request is within 200 bytes of the path MTU, or if it is larger
  than 1300 bytes and the path MTU is unknown, the request MUST be sent

  using an RFC 2914 [43] congestion controlled transport protocol, such

  as TCP. If this causes a change in the transport protocol from the"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"OpenSIPS2.4.X 中文实战系列","item":"https://wdd.js.org/opensips/"},{"@type":"ListItem","position":2,"name":"UDP分片导致SIP消息丢失","item":"https://wdd.js.org/opensips/ch7/big-udp-msg/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"UDP分片导致SIP消息丢失","name":"UDP分片导致SIP消息丢失","description":"\n现象 有了开源的框架，我们可以很方便的运行一个VOIP系统。但是维护一个VOIP系统并非那么简单。特别是如果经常出现一些偶发的问题，需要用经验丰富的运维人员来从不同层面分析。\n其中UDP分片，也可能是原因之一。\n简介 以太网的最大MTU一般是1500字节，减去20字节的IP首部，8字节的UDP首部，UDP能承载的数据最大是1472字节。\n如果一个SIP消息的报文超过1472就会分片。（实际上，如果网络的MTU比1500更小，那么达到分片的尺寸也会变小）\n如下图，发送方通过以太网发送了4个报文，ABCD。其中D报文太了，而被分割成了三个报文。在传输过程中，D的一个分片丢失，接收方由于无法重新组装D报文，所以就将D报文的所有分片都丢弃。\n这将会导致一下问题\n发送方因接收不到响应，所以产生了重传 丢弃的分片导致其他的分片浪费了带宽 IP分片是对发送者来说是简单的，但是对于接收者来说，分片的组装将会占用更多的资源 RFC 3261中给出建议，某些情况下可以使用TCP来传输。\n当MTU是未知的情况下，如果消息超过1300字节，则选择使用TCP传输 当MTU是已知情况下，SIP的消息的大小如果大于MTU-200, 则需要使用TCP传输。留下200字节的余量，是因为SIP消息的响应可能大于SIP消息的请求，为了避免响应消息超过MTU，所以要留下200字节的余量。 If a request is within 200 bytes of the path MTU, or if it is larger than 1300 bytes and the path MTU is unknown, the request MUST be sent\nusing an RFC 2914 [43] congestion controlled transport protocol, such\nas TCP. If this causes a change in the transport protocol from the\n","keywords":[],"articleBody":"\n现象 有了开源的框架，我们可以很方便的运行一个VOIP系统。但是维护一个VOIP系统并非那么简单。特别是如果经常出现一些偶发的问题，需要用经验丰富的运维人员来从不同层面分析。\n其中UDP分片，也可能是原因之一。\n简介 以太网的最大MTU一般是1500字节，减去20字节的IP首部，8字节的UDP首部，UDP能承载的数据最大是1472字节。\n如果一个SIP消息的报文超过1472就会分片。（实际上，如果网络的MTU比1500更小，那么达到分片的尺寸也会变小）\n如下图，发送方通过以太网发送了4个报文，ABCD。其中D报文太了，而被分割成了三个报文。在传输过程中，D的一个分片丢失，接收方由于无法重新组装D报文，所以就将D报文的所有分片都丢弃。\n这将会导致一下问题\n发送方因接收不到响应，所以产生了重传 丢弃的分片导致其他的分片浪费了带宽 IP分片是对发送者来说是简单的，但是对于接收者来说，分片的组装将会占用更多的资源 RFC 3261中给出建议，某些情况下可以使用TCP来传输。\n当MTU是未知的情况下，如果消息超过1300字节，则选择使用TCP传输 当MTU是已知情况下，SIP的消息的大小如果大于MTU-200, 则需要使用TCP传输。留下200字节的余量，是因为SIP消息的响应可能大于SIP消息的请求，为了避免响应消息超过MTU，所以要留下200字节的余量。 If a request is within 200 bytes of the path MTU, or if it is larger than 1300 bytes and the path MTU is unknown, the request MUST be sent\nusing an RFC 2914 [43] congestion controlled transport protocol, such\nas TCP. If this causes a change in the transport protocol from the\none indicated in the top Via, the value in the top Via MUST be\nchanged. This prevents fragmentation of messages over UDP and\nprovides congestion control for larger messages. However,\nimplementations MUST be able to handle messages up to the maximum\ndatagram packet size. For UDP, this size is 65,535 bytes, including\nIP and UDP headers.\nThe 200 byte “buffer” between the message size and the MTU\naccommodates the fact that the response in SIP can be larger than\nthe request. This happens due to the addition of Record-Route\nheader field values to the responses to INVITE, for example. With\nthe extra buffer, the response can be about 170 bytes larger than\nthe request, and still not be fragmented on IPv4 (about 30 bytes is consumed by IP/UDP, assuming no IPSec). 1300 is chosen when\npath MTU is not known, based on the assumption of a 1500 byte\nEthernet MTU. RFC 3261 18.1.1\n但是使用TCP来传输也有缺点，就是比使用UDP更占用资源。\n如何发现问题 用tcpdump在路径中抓包，然后使用wireshark分析抓包文件的大小分布。\n如何减少包的尺寸 移除无用的SIP头或者无用的SDP信息, 以opensips脚本为例子 # 可以通过$ml来获取消息的长度 if ($ml \u003e 1300) { xlog(\"L_WARN\",\"$ci $rm $si $fu: message big then 1300: $ml\"); } if ($ml \u003e= 1500) { xlog(\"L_ERR\",\"$ci $rm $si $fu: message to big than 1500 $ml\"); sl_send_reply(\"513\",\"Message too big\"); } # 可以通过remove_hf和codec_delete来移除多余的消息 if(is_present_hf(\"User-Agent\")) { remove_hf(\"User-Agent\"); } if (codec_exists(\"Speex\")) { codec_delete(\"Speex\"); } 使用SIP头压缩技术，opensips中也有头压缩的模块 注意不要在脚本中随意使用append_hf去给SIP消息增加头 参考 https://www.yay.com/faq/voip-network/udp-maximum-mtu-size/ https://www.ibm.com/support/pages/sending-large-sip-request-exceeds-mtu-value-might-not-switch-udp-tcp http://www.rfcreader.com/#rfc3261_line6474 https://www.ecg.co/blog/125-sip-and-fragments-together-forever https://en.wikipedia.org/wiki/IP_fragmentation https://thomas.gelf.net/blog/archives/Smaller-SIP-packets-to-avoid-fragmentation,27.html http://www.evaristesys.com/blog/sip-udp-fragmentation-and-kamailio-the-sip-header-diet/ ","wordCount":"285","inLanguage":"en","image":"https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2021-04-08T14:33:49+08:00","dateModified":"2021-04-08T14:33:49+08:00","author":{"@type":"Person","name":"Eddie Wang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wdd.js.org/opensips/ch7/big-udp-msg/"},"publisher":{"@type":"Organization","name":"洞香春","logo":{"@type":"ImageObject","url":"https://wdd.js.org/cowboy.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org/ accesskey=h title="洞香春 (Alt + H)"><img src=https://wdd.js.org/cowboy.ico alt aria-label=logo height=35>洞香春</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wdd.js.org/books/ title=读书><span>读书</span></a></li><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/golang/ title=Golang><span>Golang</span></a></li><li><a href=https://wdd.js.org/kamailio/ title=Kamailio><span>Kamailio</span></a></li><li><a href=https://wdd.js.org/network/ title=Network><span>Network</span></a></li><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/categories/ title=分类><span>分类</span></a></li><li><a href=https://wdd.js.org/fe/ title=前端><span>前端</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wdd.js.org/>Home</a>&nbsp;»&nbsp;<a href=https://wdd.js.org/opensips/>OpenSIPS2.4.X 中文实战系列</a></div><h1 class="post-title entry-hint-parent">UDP分片导致SIP消息丢失</h1><div class=post-meta><span title='2021-04-08 14:33:49 +0800 CST'>2021-04-08 14:33:49</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;Eddie Wang&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/opensips/ch7/big-udp-msg/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e7%8e%b0%e8%b1%a1 aria-label=现象>现象</a></li><li><a href=#%e7%ae%80%e4%bb%8b aria-label=简介>简介</a></li><li><a href=#%e5%a6%82%e4%bd%95%e5%8f%91%e7%8e%b0%e9%97%ae%e9%a2%98 aria-label=如何发现问题>如何发现问题</a></li><li><a href=#%e5%a6%82%e4%bd%95%e5%87%8f%e5%b0%91%e5%8c%85%e7%9a%84%e5%b0%ba%e5%af%b8 aria-label=如何减少包的尺寸>如何减少包的尺寸</a></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考>参考</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p><img loading=lazy src=/opensips/ch7/big-udp-msg/2022-12-02-14-03-20.png></p><h1 id=现象>现象<a hidden class=anchor aria-hidden=true href=#现象>#</a></h1><p>有了开源的框架，我们可以很方便的运行一个VOIP系统。但是维护一个VOIP系统并非那么简单。特别是如果经常出现一些偶发的问题，需要用经验丰富的运维人员来从不同层面分析。</p><p>其中UDP分片，也可能是原因之一。</p><h1 id=简介>简介<a hidden class=anchor aria-hidden=true href=#简介>#</a></h1><p>以太网的最大MTU一般是1500字节，减去20字节的IP首部，8字节的UDP首部，UDP能承载的数据最大是1472字节。</p><p>如果一个SIP消息的报文超过1472就会分片。（实际上，如果网络的MTU比1500更小，那么达到分片的尺寸也会变小）</p><p>如下图，发送方通过以太网发送了4个报文，ABCD。其中D报文太了，而被分割成了三个报文。在传输过程中，D的一个分片丢失，接收方由于无法重新组装D报文，所以就将D报文的所有分片都丢弃。</p><p>这将会导致一下问题</p><ol><li>发送方因接收不到响应，所以产生了重传</li><li>丢弃的分片导致其他的分片浪费了带宽</li><li>IP分片是对发送者来说是简单的，但是对于接收者来说，分片的组装将会占用更多的资源
<img loading=lazy src=/opensips/ch7/big-udp-msg/2022-12-02-14-03-34.png></li></ol><p>RFC 3261中给出建议，某些情况下可以使用TCP来传输。</p><ol><li>当MTU是未知的情况下，如果消息超过1300字节，则选择使用TCP传输</li><li>当MTU是已知情况下，SIP的消息的大小如果大于MTU-200, 则需要使用TCP传输。留下200字节的余量，是因为SIP消息的响应可能大于SIP消息的请求，为了避免响应消息超过MTU，所以要留下200字节的余量。</li></ol><blockquote><p>If a request is within 200 bytes of the path MTU, or if it is larger
  than 1300 bytes and the path MTU is unknown, the request MUST be sent</p></blockquote><blockquote><p>  using an RFC 2914 [43] congestion controlled transport protocol, such</p></blockquote><blockquote><p>  as TCP. If this causes a change in the transport protocol from the</p></blockquote><blockquote><p>  one indicated in the top Via, the value in the top Via MUST be</p></blockquote><blockquote><p>  changed.  This prevents fragmentation of messages over UDP and</p></blockquote><blockquote><p>  provides congestion control for larger messages.  However,</p></blockquote><blockquote><p>  implementations MUST be able to handle messages up to the maximum</p></blockquote><blockquote><p>  datagram packet size.  For UDP, this size is 65,535 bytes, including</p></blockquote><blockquote><p>  IP and UDP headers.</p></blockquote><blockquote></blockquote><blockquote><p>  The 200 byte &ldquo;buffer&rdquo; between the message size and the MTU</p></blockquote><blockquote><p>     accommodates the fact that the response in SIP can be larger than</p></blockquote><blockquote><p>     the request.  This happens due to the addition of Record-Route</p></blockquote><blockquote><p>     header field values to the responses to INVITE, for example.  With</p></blockquote><blockquote><p>     the extra buffer, the response can be about 170 bytes larger than</p></blockquote><blockquote><p>     the request, and still not be fragmented on IPv4 (about 30 bytes
is consumed by IP/UDP, assuming no IPSec).  1300 is chosen when</p></blockquote><blockquote><p>     path MTU is not known, based on the assumption of a 1500 byte</p></blockquote><blockquote><p>     Ethernet MTU. RFC 3261 18.1.1</p></blockquote><p>但是使用TCP来传输也有缺点，就是比使用UDP更占用资源。</p><h1 id=如何发现问题>如何发现问题<a hidden class=anchor aria-hidden=true href=#如何发现问题>#</a></h1><p><img loading=lazy src=/opensips/ch7/big-udp-msg/2022-12-02-14-03-52.png></p><p>用tcpdump在路径中抓包，然后使用wireshark分析抓包文件的大小分布。</p><p><img loading=lazy src=/opensips/ch7/big-udp-msg/2022-12-02-14-04-10.png></p><h1 id=如何减少包的尺寸>如何减少包的尺寸<a hidden class=anchor aria-hidden=true href=#如何减少包的尺寸>#</a></h1><ol><li>移除无用的SIP头或者无用的SDP信息, 以opensips脚本为例子</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 可以通过$ml来获取消息的长度</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>$ml &gt; 1300<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	xlog<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;L_WARN&#34;</span>,<span style=color:#e6db74>&#34;</span>$ci<span style=color:#e6db74> </span>$rm<span style=color:#e6db74> </span>$si<span style=color:#e6db74> </span>$fu<span style=color:#e6db74>: message big then 1300: </span>$ml<span style=color:#e6db74>&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>$ml &gt;<span style=color:#f92672>=</span> 1500<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	xlog<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;L_ERR&#34;</span>,<span style=color:#e6db74>&#34;</span>$ci<span style=color:#e6db74> </span>$rm<span style=color:#e6db74> </span>$si<span style=color:#e6db74> </span>$fu<span style=color:#e6db74>: message to big than 1500 </span>$ml<span style=color:#e6db74>&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>  sl_send_reply<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;513&#34;</span>,<span style=color:#e6db74>&#34;Message too big&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 可以通过remove_hf和codec_delete来移除多余的消息</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>is_present_hf<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;User-Agent&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>  remove_hf<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;User-Agent&#34;</span><span style=color:#f92672>)</span>;  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>codec_exists<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Speex&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>  codec_delete<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Speex&#34;</span><span style=color:#f92672>)</span>;  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>  
</span></span></code></pre></div><ol start=2><li>使用SIP头压缩技术，opensips中也有头压缩的模块</li><li>注意不要在脚本中随意使用append_hf去给SIP消息增加头</li></ol><h1 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h1><ul><li><a href=https://www.yay.com/faq/voip-network/udp-maximum-mtu-size/>https://www.yay.com/faq/voip-network/udp-maximum-mtu-size/</a></li><li><a href=https://www.ibm.com/support/pages/sending-large-sip-request-exceeds-mtu-value-might-not-switch-udp-tcp>https://www.ibm.com/support/pages/sending-large-sip-request-exceeds-mtu-value-might-not-switch-udp-tcp</a></li><li><a href=http://www.rfcreader.com/#rfc3261_line6474>http://www.rfcreader.com/#rfc3261_line6474</a></li><li><a href=https://www.ecg.co/blog/125-sip-and-fragments-together-forever>https://www.ecg.co/blog/125-sip-and-fragments-together-forever</a></li><li><a href=https://en.wikipedia.org/wiki/IP_fragmentation>https://en.wikipedia.org/wiki/IP_fragmentation</a></li><li><a href=https://thomas.gelf.net/blog/archives/Smaller-SIP-packets-to-avoid-fragmentation,27.html>https://thomas.gelf.net/blog/archives/Smaller-SIP-packets-to-avoid-fragmentation,27.html</a></li><li><a href=http://www.evaristesys.com/blog/sip-udp-fragmentation-and-kamailio-the-sip-header-diet/>http://www.evaristesys.com/blog/sip-udp-fragmentation-and-kamailio-the-sip-header-diet/</a></li></ul></div><footer class=post-footer><ul class=post-tags></ul></footer><script src=https://giscus.app/client.js data-repo=wangduanduan/wangduanduan.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxMTkyMjMyNjA=" data-category=Announcements data-category-id=DIC_kwDOBxsz3M4CAjBq data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2025 <a href=https://wdd.js.org/>洞香春</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>