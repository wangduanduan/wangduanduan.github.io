<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>洞香春</title>
<meta name=keywords content><meta name=description content=" - 洞香春"><meta name=author content="Eddie Wang"><link rel=canonical href=https://wdd.js.org/opensips/module-dev/><link crossorigin=anonymous href=/assets/css/stylesheet.6d3944e058d85363bbe8a792a9b5f40002bca80be859dc19c466dd8de223973e.css integrity="sha256-bTlE4FjYU2O76KeSqbX0AAK8qAvoWdwZxGbdjeIjlz4=" rel="preload stylesheet" as=style><link rel=icon href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/cowboy.ico><link rel=apple-touch-icon href=https://wdd.js.org/cowboy.ico><link rel=mask-icon href=https://wdd.js.org/cowboy.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://wdd.js.org/opensips/module-dev/index.xml><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content><meta property="og:description" content="Eddie Wang的个人博客"><meta property="og:type" content="website"><meta property="og:url" content="https://wdd.js.org/opensips/module-dev/"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="og:site_name" content="洞香春"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content><meta name=twitter:description content="Eddie Wang的个人博客"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"OpenSIPS2.4.X 中文实战系列","item":"https://wdd.js.org/opensips/"},{"@type":"ListItem","position":3,"name":"","item":"https://wdd.js.org/opensips/module-dev/"}]}</script></head><body class="list dark" id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org accesskey=h title="洞香春 (Alt + H)"><img src=https://wdd.js.org/cowboy.ico alt aria-label=logo height=35>洞香春</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/fe/ title=Frontend><span>Frontend</span></a></li><li><a href=https://wdd.js.org/golang/ title=Golang><span>Golang</span></a></li><li><a href=https://wdd.js.org/container/ title=k8s/docker><span>k8s/docker</span></a></li><li><a href=https://wdd.js.org/network/ title=Network><span>Network</span></a></li><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/shell/ title=Shell><span>Shell</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/categories/ title=分类><span>分类</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><article class=post-entry><header class=entry-header><h2>ch4-3 $var() 类型的传参</h2></header><div class=entry-content><p>假如一个模块暴露了一个函数，叫做do_something(), 仅支持传递一个参数。这个函数在c文件中对应w_do_something()
// 在opensips.cfg文件中 route{ do_something("abc") } static int w_do_something(struct sip_msg* msg, char* str1){ // 在c文件中，我们打印str1的值，这个字符串就是abc } // 在opensips.cfg文件中 route{ $var(num)="abc"; do_something("$var(num)") } static int w_do_something(struct sip_msg* msg, char* str1){ // 在c文件中，我们打印str1的值，这个字符串就是$var(num) // 这时候就有问题了，其实我们想获取的是$var(num)的值abc, 而不是字符串$var(num) } 那怎么获取$var()的传参的值呢？这里就需要用到了函数的fixup_函数。
static cmd_export_t cmds[]={ {"find_zone_code", (cmd_function)w_do_something, 2, fixup_do_something, 0, REQUEST_ROUTE}, {0,0,0,0,0,0} }; // 调用fixup_spve， 只有在fixup函数中，对函数的参数执行了fixup, 在真正的执行函数中，才能得到真正的$var()的值 static int fixup_do_something(void** param, int param_no) { LM_INFO("fixup_find_zone_code: param: %s param_no: %d\n", (char *)*param, param_no); return fixup_spve(param); } static int w_do_something (struct sip_msg* msg, char* str1){ str zone; if (fixup_get_svalue(msg, (gparam_p)str1, &amp;zone) !...</p></div><footer class=entry-footer>&lt;span title='2021-04-25 09:10:28 +0800 CST'>2021-04-25 09:10:28&lt;/span>&amp;nbsp;·&amp;nbsp;1 min&amp;nbsp;·&amp;nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to ch4-3 $var() 类型的传参" href=https://wdd.js.org/opensips/module-dev/l4-3/></a></article><article class=post-entry><header class=entry-header><h2>ch4-2 flag获取</h2></header><div class=entry-content><p>flag的类型 enum flag_type { FLAG_TYPE_MSG=0, FLAG_TYPE_BRANCH, FLAG_LIST_COUNT, }; flag实际上是一种二进制的位 MAX_FLAG就是一个SIP消息最多可以有多少个flag
#include &lt;limits.h> typedef unsigned int flag_t; #define MAX_FLAG ((unsigned int)( sizeof(flag_t) * CHAR_BIT - 1 )) 这个值更具情况而定，我的机器上是最多32个。
#include &lt;stdio.h> #include &lt;limits.h> typedef unsigned int flag_t; #define MAX_FLAG ((unsigned int)( sizeof(flag_t) * CHAR_BIT - 1 )) int main() { printf("%zu\n", sizeof(unsigned int)); printf("%u\n", CHAR_BIT); printf("%u\n", MAX_FLAG); return 0; } $gcc -o main *.c $main 4 8 31 由字符串获取flag opensips 1.0时，flag都是整数，2.0才引入了字符串。
用数字容易傻傻分不清楚，字符串比较容易理解。...</p></div><footer class=entry-footer>&lt;span title='2021-04-24 11:26:21 +0800 CST'>2021-04-24 11:26:21&lt;/span>&amp;nbsp;·&amp;nbsp;1 min&amp;nbsp;·&amp;nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to ch4-2 flag获取" href=https://wdd.js.org/opensips/module-dev/l4-2/></a></article><article class=post-entry><header class=entry-header><h2>ch4-1 USE_FUNC_PARAM参数类型</h2></header><div class=entry-content><p>模块传参有两种类型
直接赋值传参 间接函数调用传参 str local_zone_code = {"",0}; int some_int_param = 0; static param_export_t params[]={ // 直接字符串赋值 {"local_zone_code", STR_PARAM, &amp;local_zone_code.s}, // 直接整数赋值 {"some_int_param", INT_PARAM, &amp;some_int_param}, // 函数调用 字符窜 {"zone_code_map", STR_PARAM|USE_FUNC_PARAM, (void *)&amp;set_code_zone_map}, // 函数调用 整数 {"zone_code_map_int", INT_PARAM|USE_FUNC_PARAM, (void *)&amp;set_code_zone_map_int}, {0,0,0} }; 使用函数处理参数的好处是，可以对参数做更复杂的处理。
例如：
某个参数可以多次传递 对参数进行校验，在启动前就可以判断传参是否有问题。 static int set_code_zone_map(unsigned int type, void *val) { LM_INFO("set_zone_code_map type:%d val:%s \n",type,(char *)val); return 1; }</p></div><footer class=entry-footer>&lt;span title='2021-04-21 14:02:28 +0800 CST'>2021-04-21 14:02:28&lt;/span>&amp;nbsp;·&amp;nbsp;1 min&amp;nbsp;·&amp;nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to ch4-1 USE_FUNC_PARAM参数类型" href=https://wdd.js.org/opensips/module-dev/l4-1/></a></article><article class=post-entry><header class=entry-header><h2>ch1 开发课程简介</h2></header><div class=entry-content><p>本章节，带领大家探索opensips模块开发。希望深入了解opensips的同学可以看看。
内容涵盖 章节的内容将会涵盖
opensips的启动流程 如何创建一个模块 如何给模块传递参数 模块的生命周期函数的处理 如何暴露自定义的函数 如何检查函数的传惨 如何获取$var或者$avp变量 如何获取相关的flag 如何修改SIP消息 如何编写mi接口 如何编写statistics统计数据 如何做数据库操作 OpenSIPS架构 参考 https://voipmagazine.files.wordpress.com/2014/09/opensips-arch.jpg</p></div><footer class=entry-footer>&lt;span title='2021-04-21 13:52:43 +0800 CST'>2021-04-21 13:52:43&lt;/span>&amp;nbsp;·&amp;nbsp;1 min&amp;nbsp;·&amp;nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to ch1 开发课程简介" href=https://wdd.js.org/opensips/module-dev/l1/></a></article><article class=post-entry><header class=entry-header><h2>ch4 配置模块的启动参数</h2></header><div class=entry-content><p>开始 我们需要给home_location模块增加一个参数，配置当地的号码区号
首先，我们删除maxfwd.c文件中开头的很多注释，我们先把注意力集中在代码上。
删除了30多行注释，代码还剩160多行。
首先我们一个变量，用来保存本地的区号。这个变量是个str类型。
str local_zone_code = {"",0}; str 关于str类型，可以参考opensips/str.h头文件。
struct __str { char* s; /**&lt; string as char array */ int len; /**&lt; string length, not including null-termination */ }; typedef struct __str str; 实际上，str是个指向__str结构体，可以看出这个结构体有指向字符串的char*类型的指针，以及一个代表字符串长度的len属性。这样做的好处是可以高效的获取字符串的长度，很多有名的开源项目都有类似的结构体。
opensips几乎所有的字符串都是用的str类型
param_export_t param_export_t这个结构体是用来通过脚本里面的modparam向模块传递参数的。这个数组最后一向是{0,0,0} 这最后一项其实是个标志，标志着数组的结束。
static param_export_t params[]={ {"max_limit", INT_PARAM, &amp;max_limit}, {"local_zone_code", STR_PARAM, &amp;local_zone_code.s}, {0,0,0} }; 在sr_module_deps.h和sr_module.h中有下面的代码
typedef struct param_export_ param_export_t; param_export_t实际上是指向param_export_这个结构体。
这个结构体有三个参数
name 表示参数的名称 modparam_t 表示参数的类型。参数类型有以下几种 STR_PARAM 字符串类型 INT_PARAM 整数类型 USE_FUNC_PARAM 函数类型 PARAM_TYPE_MASK 这个用到的时候再说 param_pointer 是一个指针，用到的时候再具体说明 struct param_export_ { char* name; /*!...</p></div><footer class=entry-footer>&lt;span title='2021-04-21 09:03:00 +0800 CST'>2021-04-21 09:03:00&lt;/span>&amp;nbsp;·&amp;nbsp;2 min&amp;nbsp;·&amp;nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to ch4 配置模块的启动参数" href=https://wdd.js.org/opensips/module-dev/l4/></a></article><article class=post-entry><header class=entry-header><h2>ch3 复制并裁剪一个模块</h2></header><div class=entry-content><p>从头写一个模块是比较麻烦的，我们可以基于一个简单的模块，然后在这个模块上进行一些修改。
我们基于maxfwd这个模块，复制一个模块，叫做home_location。
为什么叫做home_location呢？因为我想根据一个手机号，查出它的归属地，然后根据当地的归属地，判断号码前要不要加0
cd modules cp -R maxfwd home_location ➜ home_location git:(home_location) ✗ ll total 300K drwxr-xr-x 2 root root 4.0K Apr 20 13:56 doc -rw-r--r-- 1 root root 217 Apr 20 14:00 Makefile -rw-r--r-- 1 root root 4.7K Apr 20 14:00 maxfwd.c -rw-r--r-- 1 root root 2.0K Apr 20 13:56 maxfwd.d -rw-r--r-- 1 root root 77K Apr 20 13:56 maxfwd.o -rwxr-xr-x 1 root root 93K Apr 20 13:56 maxfwd.so -rw-r--r-- 1 root root 4....</p></div><footer class=entry-footer>&lt;span title='2021-04-20 13:53:41 +0800 CST'>2021-04-20 13:53:41&lt;/span>&amp;nbsp;·&amp;nbsp;2 min&amp;nbsp;·&amp;nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to ch3 复制并裁剪一个模块" href=https://wdd.js.org/opensips/module-dev/l3/></a></article><article class=post-entry><header class=entry-header><h2>ch2 初始化环境</h2></header><div class=entry-content><p>环境说明 ubuntu 20.04 opensips 2.4 克隆仓库 由于github官方的仓库clone太慢，最好选择从国内的gitee上克隆。
下面的gfo, gco, gl, gcb都是oh-my-zsh中git插件的快捷键。建议你要么安装oh-my-zsh, 或者也可以看看这些快捷方式对应的底层命令是什么 https://github.com/ohmyzsh/ohmyzsh/tree/master/plugins/git
git clone https://gitee.com/wangduanduan/opensips.git gfo 2.4:2.4 gco 2.4 gl gcb home_location #基于2.4分支创建home_location分支 安装依赖 apt update apt install -y build-essential bison flex m4 pkg-config libncurses5-dev \ rsyslog libmysqlclient-dev \ libssl-dev mysql-client libmicrohttpd-dev libcurl4-openssl-dev uuid-dev \ libpcre3-dev libconfuse-dev libxml2-dev libhiredis-dev 编译安装 make all -j4 include_modules="db_mysql" make install include_modules="db_mysql" 测试 ➜ opensips git:(home_location) opensips -V version: opensips 2.4.9 (x86_64/linux) flags: STATS: On, DISABLE_NAGLE, USE_MCAST, SHM_MMAP, PKG_MALLOC, F_MALLOC, FAST_LOCK-ADAPTIVE_WAIT ADAPTIVE_WAIT_LOOPS=1024, MAX_RECV_BUFFER_SIZE 262144, MAX_LISTEN 16, MAX_URI_SIZE 1024, BUF_SIZE 65535 poll method support: poll, epoll, sigio_rt, select....</p></div><footer class=entry-footer>&lt;span title='2021-04-20 13:29:47 +0800 CST'>2021-04-20 13:29:47&lt;/span>&amp;nbsp;·&amp;nbsp;1 min&amp;nbsp;·&amp;nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to ch2 初始化环境" href=https://wdd.js.org/opensips/module-dev/l2/></a></article><article class=post-entry><header class=entry-header><h2>概念理解 module_exports</h2></header><div class=entry-content><p>module_exports 这个结构在每个模块中都有，这个有点类似js的export或者说是node.js的module.export。
这是一个接口的规范。
重要讲解几个关键点：
local_zone_code是模块名字，这个是必需的 cmds表示在opensips脚本里可以有那些暴露的函数 params规定了模块的参数 mod_init在模块初始化的时候会被调用, 只会被调用一次 关于module_exports这个结构的定义，可以查阅：sr_module.h文件
struct module_exports exports= { "local_zone_code", MOD_TYPE_DEFAULT,/* class of this module */ MODULE_VERSION, DEFAULT_DLFLAGS, /* dlopen flags */ 0, /* load function */ NULL, /* OpenSIPS module dependencies */ cmds, 0, params, 0, /* exported statistics */ 0, /* exported MI functions */ 0, /* exported pseudo-variables */ 0, /* exported transformations */ 0, /* extra processes */ 0, /* pre-init function */ mod_init, (response_function) 0, (destroy_function) 0, 0 /* per-child init function */ }; cmds struct cmd_export_ { char* name; /* opensips脚本里的函数名 */ cmd_function function; /* 关联的C代码里的函数 */ int param_no; /* 参数的个数 */ fixup_function fixup; /* 修正参数 */ free_fixup_function free_fixup; /* 修正参数的 */ int flags; /* 函数flag，主要是用来标记函数可以在哪些路由中使用 */ }; cmd_function...</p></div><footer class=entry-footer>&lt;span title='2020-08-22 12:45:42 +0800 CST'>2020-08-22 12:45:42&lt;/span>&amp;nbsp;·&amp;nbsp;2 min&amp;nbsp;·&amp;nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to 概念理解 module_exports" href=https://wdd.js.org/opensips/module-dev/l5/></a></article></main><footer class=footer><span>&copy; 2023 <a href=https://wdd.js.org>洞香春</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>