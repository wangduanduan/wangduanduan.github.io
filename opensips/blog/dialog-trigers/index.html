<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Dialog triggers, or how to control the calls from script | 洞香春</title><meta name=keywords content><meta name=description content="原文：https://blog.opensips.org/2020/05/26/dialog-triggers-or-how-to-control-the-calls-from-script/
The OpenSIPS script is a very powerful tool, both in terms of capabilities (statements, variables, transformations) and in terms of integration (support for DB, REST, Events and more).So why not using the OpenSIPS script (or the script routes) to interact and control your call, in order to build more complex services on top of the dialog support?For this purpose, OpenSIPS 3.1 introduces three new per-dialog triggers:
on_answer route, triggered when the dialog is answered; on_timeout route, triggered when the dialog is about to timeout; on_hangup route, triggered after the dialog was terminated."><meta name=author content="Eddie Wang"><link rel=canonical href=https://wdd.js.org/opensips/blog/dialog-trigers/><link crossorigin=anonymous href=/assets/css/stylesheet.min.ceab085cbbf58c0ec96f6d415d51b3b44e204edfd71a45b4fa2d4aac13f119d0.css integrity="sha256-zqsIXLv1jA7Jb21BXVGztE4gTt/XGkW0+i1KrBPxGdA=" rel="preload stylesheet" as=style><link crossorigin=anonymous herf=/font-awesome/css/font-awesome.min.css rel=stylesheet type=text/css><link rel=preload href=/cowboy.ico as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/cowboy.ico><link rel=apple-touch-icon href=https://wdd.js.org/cowboy.ico><link rel=mask-icon href=https://wdd.js.org/cowboy.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.119.0"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Dialog triggers, or how to control the calls from script"><meta property="og:description" content="原文：https://blog.opensips.org/2020/05/26/dialog-triggers-or-how-to-control-the-calls-from-script/
The OpenSIPS script is a very powerful tool, both in terms of capabilities (statements, variables, transformations) and in terms of integration (support for DB, REST, Events and more).So why not using the OpenSIPS script (or the script routes) to interact and control your call, in order to build more complex services on top of the dialog support?For this purpose, OpenSIPS 3.1 introduces three new per-dialog triggers:
on_answer route, triggered when the dialog is answered; on_timeout route, triggered when the dialog is about to timeout; on_hangup route, triggered after the dialog was terminated."><meta property="og:type" content="article"><meta property="og:url" content="https://wdd.js.org/opensips/blog/dialog-trigers/"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="opensips"><meta property="article:published_time" content="2021-02-11T20:23:40+08:00"><meta property="article:modified_time" content="2021-02-11T20:23:40+08:00"><meta property="og:site_name" content="洞香春"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Dialog triggers, or how to control the calls from script"><meta name=twitter:description content="原文：https://blog.opensips.org/2020/05/26/dialog-triggers-or-how-to-control-the-calls-from-script/
The OpenSIPS script is a very powerful tool, both in terms of capabilities (statements, variables, transformations) and in terms of integration (support for DB, REST, Events and more).So why not using the OpenSIPS script (or the script routes) to interact and control your call, in order to build more complex services on top of the dialog support?For this purpose, OpenSIPS 3.1 introduces three new per-dialog triggers:
on_answer route, triggered when the dialog is answered; on_timeout route, triggered when the dialog is about to timeout; on_hangup route, triggered after the dialog was terminated."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"OpenSIPS2.4.X 中文实战系列","item":"https://wdd.js.org/opensips/"},{"@type":"ListItem","position":3,"name":"Dialog triggers, or how to control the calls from script","item":"https://wdd.js.org/opensips/blog/dialog-trigers/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Dialog triggers, or how to control the calls from script","name":"Dialog triggers, or how to control the calls from script","description":"原文：https://blog.opensips.org/2020/05/26/dialog-triggers-or-how-to-control-the-calls-from-script/\nThe OpenSIPS script is a very powerful tool, both in terms of capabilities (statements, variables, transformations) and in terms of integration (support for DB, REST, Events and more).So why not using the OpenSIPS script (or the script routes) to interact and control your call, in order to build more complex services on top of the dialog support?For this purpose, OpenSIPS 3.1 introduces three new per-dialog triggers:\non_answer route, triggered when the dialog is answered; on_timeout route, triggered when the dialog is about to timeout; on_hangup route, triggered after the dialog was terminated.","keywords":[],"articleBody":"原文：https://blog.opensips.org/2020/05/26/dialog-triggers-or-how-to-control-the-calls-from-script/\nThe OpenSIPS script is a very powerful tool, both in terms of capabilities (statements, variables, transformations) and in terms of integration (support for DB, REST, Events and more).So why not using the OpenSIPS script (or the script routes) to interact and control your call, in order to build more complex services on top of the dialog support?For this purpose, OpenSIPS 3.1 introduces three new per-dialog triggers:\non_answer route, triggered when the dialog is answered; on_timeout route, triggered when the dialog is about to timeout; on_hangup route, triggered after the dialog was terminated. The routes are optional and per-dialog and they give you the possibility to attach custom operations to the various critical milestones in a dialog life.While the on_answer and on_hangup routes are 100% data-manipulation oriented (you have full read/write access to the full data context of the dialog, but you cannot change anything about the dialog progress), the on_timeout route is a bit more versatile – by increasing the dialog’s timeout, you can dynamically increase the dialog lifetime (to postpone the dialog timeout, without waiting for any signalling to do it).But let’s talk example 🙂\nSimple PrePaid Using the on_timeout route, we can simulate the incremental check and charge behavior of a basic prepaid.For example, we set 5 seconds timeout for the dialog and when the on_timeout route is triggered (after the 5 secs), we can re-check if the caller still have credit to continue the call. If not, we leave the call to timeout, to be terminated by the OpenSIPS. If he still has credit, we deduct the cost for 5 secs more and we increase the dialog timeout is 5 more seconds. Simple, right ?\nroute { .... create_dialog(\"B\"); # remember some billing account id, to remember # where to check for credit $dlg_val(account_id) = \"...\"; # keep a running cost for the call also $dlg_val(total_cost) = 0; # start with an initial 5 seconds duration $DLG_tiemout = 5; t_on_timeout(\"call_recheck\"); t_on_hangup(\"call_terminated\"); .... } route[call_recheck] { # the dialog data (vars, flags, profiles) are accesible here. xlog(\"[$DLG_id] dialog timeout triggered\\n\"); # calculate the cost for the next 5 seconds $var(cost) = 5 * .... ; # use a critical/locked region to do test and update upon the credit get_dynamic_lock( \"$dlg_val(account_id)\" ); if (avp_db_query(\"select credit from accounts where credit\u003e=$var(cost) and id=$dlg_val(account_id)\")) { # credit is stil available avp_db_query(\"update accounts set credit=credit-$var(cost) where id=$dlg_val(account_id)\"); # give the dialog 5 more seconds $DLG_timeout = 5; # update the total cost $dlg_val(total_cost) = $(dlg_val(total_cost){s.int}) + $var(cost); } else { # query returned nothing, so no credit is available, allow the call # to timeout and terminate right away } release_dynamic_lock( \"$dlg_val(account_id)\" ); } route[call_terminated] { # the dialog data (vars, flags, profiles) are accesible here. xlog(\"[$DLG_id] call terminated after $DLG_lifetime seconds with a cost of $dlg_val(total_cost)\\n\"); # IMPROVEMENT - eventually ajust the call if the call didn't used # the whole span of the last 5 seconds } SHARE THIS: ","wordCount":"489","inLanguage":"en","datePublished":"2021-02-11T20:23:40+08:00","dateModified":"2021-02-11T20:23:40+08:00","author":{"@type":"Person","name":"Eddie Wang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wdd.js.org/opensips/blog/dialog-trigers/"},"publisher":{"@type":"Organization","name":"洞香春","logo":{"@type":"ImageObject","url":"https://wdd.js.org/cowboy.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org accesskey=h title="洞香春 (Alt + H)"><img src=/cowboy.ico alt=logo aria-label=logo height=35>洞香春</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/fe/ title=Frontend><span>Frontend</span></a></li><li><a href=https://wdd.js.org/golang/ title=Golang><span>Golang</span></a></li><li><a href=https://wdd.js.org/container/ title=k8s/docker><span>k8s/docker</span></a></li><li><a href=https://wdd.js.org/network/ title=Network><span>Network</span></a></li><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/shell/ title=Shell><span>Shell</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/categories/ title=分类><span>分类</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wdd.js.org>Home</a>&nbsp;»&nbsp;<a href=https://wdd.js.org/opensips/>OpenSIPS2.4.X 中文实战系列</a></div><h1 class=post-title>Dialog triggers, or how to control the calls from script</h1><div class=post-meta><span title='2021-02-11 20:23:40 +0800 CST'>2021-02-11 20:23:40</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;Eddie Wang</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#simple-prepaid aria-label="Simple PrePaid">Simple PrePaid</a></li><li><a href=#share-this aria-label="SHARE THIS:">SHARE THIS:</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>原文：<a href=https://blog.opensips.org/2020/05/26/dialog-triggers-or-how-to-control-the-calls-from-script/>https://blog.opensips.org/2020/05/26/dialog-triggers-or-how-to-control-the-calls-from-script/</a></p><p>The OpenSIPS script is a very powerful tool, both in terms of capabilities (statements, variables, transformations) and in terms of integration (support for DB, REST, Events and more).So why not using the OpenSIPS script (or the script routes) to interact and control your call, in order to build more complex services on top of the dialog support?For this purpose, OpenSIPS 3.1 introduces three new per-dialog triggers:</p><ul><li><strong>on_answer</strong> route, triggered when the dialog is answered;</li><li><strong>on_timeout</strong> route, triggered when the dialog is about to timeout;</li><li><strong>on_hangup</strong> route, triggered after the dialog was terminated.</li></ul><p>The routes are optional and per-dialog and they give you the possibility to attach custom operations to the various critical milestones in a dialog life.While the <strong>on_answer</strong> and <strong>on_hangup</strong> routes are 100% data-manipulation oriented (you have full read/write access to the full data context of the dialog, but you cannot change anything about the dialog progress), the <strong>on_timeout</strong> route is a bit more versatile – by increasing the dialog’s timeout, you can dynamically increase the dialog lifetime (to postpone the dialog timeout, without waiting for any signalling to do it).But let’s talk example 🙂</p><h3 id=simple-prepaid>Simple PrePaid<a hidden class=anchor aria-hidden=true href=#simple-prepaid>#</a></h3><p>Using the <strong>on_timeout</strong> route, we can simulate the incremental check and charge behavior of a basic prepaid.For example, we set 5 seconds timeout for the dialog and when the <strong>on_timeout</strong> route is triggered (after the 5 secs), we can re-check if the caller still have credit to continue the call. If not, we leave the call to timeout, to be terminated by the OpenSIPS. If he still has credit, we deduct the cost for 5 secs more and we increase the dialog timeout is 5 more seconds. Simple, right ?</p><pre tabindex=0><code>route {
  ....
  create_dialog(&#34;B&#34;);
  # remember some billing account id, to remember
  # where to check for credit
  $dlg_val(account_id) = &#34;...&#34;;
  # keep a running cost for the call also
  $dlg_val(total_cost) = 0;
  # start with an initial 5 seconds duration
  $DLG_tiemout = 5;
  t_on_timeout(&#34;call_recheck&#34;);
  t_on_hangup(&#34;call_terminated&#34;);
  ....
}
route[call_recheck] 
{
  # the dialog data (vars, flags, profiles) are accesible here.
  xlog(&#34;[$DLG_id] dialog timeout triggered\n&#34;);
  # calculate the cost for the next 5 seconds
  $var(cost) = 5 * .... ;
  # use a critical/locked region to do test and update upon the credit
  get_dynamic_lock( &#34;$dlg_val(account_id)&#34; );
  if (avp_db_query(&#34;select credit from accounts where credit&gt;=$var(cost) and id=$dlg_val(account_id)&#34;)) {
    # credit is stil available
    avp_db_query(&#34;update accounts set credit=credit-$var(cost) where id=$dlg_val(account_id)&#34;);
    # give the dialog 5 more seconds
    $DLG_timeout = 5;
    # update the total cost
    $dlg_val(total_cost) = $(dlg_val(total_cost){s.int}) + $var(cost);
  } else {
    # query returned nothing, so no credit is available, allow the call
    # to timeout and terminate right away
  }
  release_dynamic_lock( &#34;$dlg_val(account_id)&#34; );
}
route[call_terminated]
{
  # the dialog data (vars, flags, profiles) are accesible here.
  xlog(&#34;[$DLG_id] call terminated after $DLG_lifetime seconds with a cost of $dlg_val(total_cost)\n&#34;);
  # IMPROVEMENT - eventually ajust the call if the call didn&#39;t used
  # the whole span of the last 5 seconds
}
</code></pre><h3 id=share-this>SHARE THIS:<a hidden class=anchor aria-hidden=true href=#share-this>#</a></h3></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://wdd.js.org>洞香春</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>