<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Troubleshooting OpenSIPS script | 洞香春</title><meta name=keywords content><meta name=description content="What makes OpenSIPS such an attractive and powerful SIP solutions is its high level of programmability, thanks to its C-like configuration script. But once you get into the “programming” area, you will automatically need tools and skills for troubleshooting.So here there are some some tips and tools you can use in OpenSIPS for “debugging” your configuration script.
Controlling the script logging The easiest way to troubleshoot your script is of course by using the xlog() core function and print your own messages."><meta name=author content="Eddie Wang"><link rel=canonical href=https://wdd.js.org/opensips/blog/troubleshooting-opensips-script/><link crossorigin=anonymous href=/assets/css/stylesheet.min.ceab085cbbf58c0ec96f6d415d51b3b44e204edfd71a45b4fa2d4aac13f119d0.css integrity="sha256-zqsIXLv1jA7Jb21BXVGztE4gTt/XGkW0+i1KrBPxGdA=" rel="preload stylesheet" as=style><link crossorigin=anonymous herf=/font-awesome/css/font-awesome.min.css rel=stylesheet type=text/css><link rel=preload href=/cowboy.ico as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/cowboy.ico><link rel=apple-touch-icon href=https://wdd.js.org/cowboy.ico><link rel=mask-icon href=https://wdd.js.org/cowboy.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.108.0"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Troubleshooting OpenSIPS script"><meta property="og:description" content="What makes OpenSIPS such an attractive and powerful SIP solutions is its high level of programmability, thanks to its C-like configuration script. But once you get into the “programming” area, you will automatically need tools and skills for troubleshooting.So here there are some some tips and tools you can use in OpenSIPS for “debugging” your configuration script.
Controlling the script logging The easiest way to troubleshoot your script is of course by using the xlog() core function and print your own messages."><meta property="og:type" content="article"><meta property="og:url" content="https://wdd.js.org/opensips/blog/troubleshooting-opensips-script/"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="opensips"><meta property="article:published_time" content="2019-07-31T13:43:05+08:00"><meta property="article:modified_time" content="2019-07-31T13:43:05+08:00"><meta property="og:site_name" content="洞香春"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Troubleshooting OpenSIPS script"><meta name=twitter:description content="What makes OpenSIPS such an attractive and powerful SIP solutions is its high level of programmability, thanks to its C-like configuration script. But once you get into the “programming” area, you will automatically need tools and skills for troubleshooting.So here there are some some tips and tools you can use in OpenSIPS for “debugging” your configuration script.
Controlling the script logging The easiest way to troubleshoot your script is of course by using the xlog() core function and print your own messages."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"OpenSIPS2.4.X 中文实战系列","item":"https://wdd.js.org/opensips/"},{"@type":"ListItem","position":3,"name":"Troubleshooting OpenSIPS script","item":"https://wdd.js.org/opensips/blog/troubleshooting-opensips-script/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Troubleshooting OpenSIPS script","name":"Troubleshooting OpenSIPS script","description":"What makes OpenSIPS such an attractive and powerful SIP solutions is its high level of programmability, thanks to its C-like configuration script. But once you get into the “programming” area, you will automatically need tools and skills for troubleshooting.So here there are some some tips and tools you can use in OpenSIPS for “debugging” your configuration script.\nControlling the script logging The easiest way to troubleshoot your script is of course by using the xlog() core function and print your own messages.","keywords":[],"articleBody":"What makes OpenSIPS such an attractive and powerful SIP solutions is its high level of programmability, thanks to its C-like configuration script. But once you get into the “programming” area, you will automatically need tools and skills for troubleshooting.So here there are some some tips and tools you can use in OpenSIPS for “debugging” your configuration script.\nControlling the script logging The easiest way to troubleshoot your script is of course by using the xlog() core function and print your own messages. Still the internal OpenSIPS logs (generated by the OpenSIPS code) do provide a lot of information about what OpenSIPS is doing.The challenge with the logging is to control the amount and content of messages you want to log. Otherwise you will end up with huge piles of logs, completely impossible to read and follow.By using the $log_level script variable you can dynamically change the logging level (to make it more or less verbose) from the script level. You can do this only for parts of the script:\nlog_level= -1 # errors only ….. { …… $log_level = 4; # set the debug level of the current process to DEBUG uac_replace_from(….); $log_level = NULL; # reset the log level of the current process to its default level ……. }\nor only for certain messages, based on source IP (you can use the permissions module for a more dynamic approach, controlled via DB)\nif ($si==”11.22.33.44″) $log_level = 4;\nor some parts of the message (you can use the dialplan module for the dynamic approach):\nif ($rU==”911″) $log_level = 4;\nIMPORTANT: do not forget to reset the log level back to default before terminating the script, otherwise that log level will be used by the current process for all the future messages it will handle.\nTracing the script execution Still, using the xlog() core function may not be the best option as it implies a high script pollution and many script changes (with restarts, of course).So, a better alternative is the script_trace() core function. Once you enabled the script tracing, OpenSIPS will start logging its steps though the script execution, printing each function that is called and its line in the script file.This script tracing is really helpful when you want to understand or troubleshoot your script execution, answering questions like “why does my script not get to this route” or “why is the script function not called” or “I do not understand how the SIP message flows through my script“….. and many other similar problems.The script_trace() function can help even more by allowing you to trace the value of certain variables (or parts of the message) during the script execution. Like “I do not understand where in script my RURI is changed“. So you simply attach to the function a log line (with variables, of course) that will be evaluated and printed for each function in the script:\nscript_trace( 1, “$rm from $si, ruri=$ru”, “me”);\nwill produce:\n[line 578][me][module consume_credentials] -\u003e (INVITE from 127.0.0.1 , ruri=sip:111211@opensips.org) [line 581][me][core setsflag] -\u003e (INVITE from 127.0.0.1 , ruri=sip:111211@opensips.org) [line 583][me][assign equal] -\u003e (INVITE from 127.0.0.1 , ruri=sip:111211@opensips.org) [line 592][me][core if] -\u003e (INVITE from 127.0.0.1 , ruri=sip:tester@opensips.org) [line 585][me][module is_avp_set] -\u003e (INVITE from 127.0.0.1 , ruri=sip:tester@opensips.org) [line 589][me][core if] -\u003e (INVITE from 127.0.0.1 , ruri=sip:tester@opensips.org) [line 586][me][module is_method] -\u003e (INVITE from 127.0.0.1 , ruri=sip:tester@opensips.org) [line 587][me][module trace_dialog] -\u003e (INVITE 127.0.0.1 , ruri=sip:tester@opensips.org) [line 590][me][core setflag] -\u003e (INVITE from 127.0.0.1 , ruri=sip:tester@opensips.org)\nAgain, you can enable the script tracing only for some cases (on demand). For example I want to trace only calls from a certain subscriber, so I can use the dialplan module and create in DB rules to match the subscribers I’m interested in tracing:\nif ( dp_translate(“1″,”$fU/$var(foo)”) )\ncaller must be traced according to dialplan 1 script_trace( 1, “$rm from $si, ruri=$ru”, “me”);\nBenchmarking the script Assuming that you get to a point where you managed to troubleshoot and fix your script in terms of the execution flow, you now may be interested in troubleshoot the script execution from the time perspective – how much time takes OpenSIPS to execute certain parts of the script.This is a mandatory step if you want to perform a performance analysis of your OpenSIPS setup.The benchmark module will help you to measure the time OpenSIPS took to execute different parts of the script:\nbm_start_timer(“lookup-timer”); lookup(“location”); bm_log_timer(“lookup-timer”);\nAn interesting capability of the module is to provide information about the current usage, but also aggregated information from the past, like how many times a certain timer was used or what was the total time spent in a timer (see the full provided information). And even more, such information can be pulled via Management Interface via the bm_poll_results command, for external usage:\nopensipsctl fifo bm_poll_results register-timer 3/40/12/14/13.333333 9/204/12/97/22.666667 lookup-timer 3/21/7/7/7.000000 9/98/7/41/10.888889\nIdentifying script bottlenecks But still you need to find the weak points of your script in terms on time to process. Or the bottlenecks of your script.OpenSIPS provides a very useful mechanism for this – the time thresholds. There are different thresholds, for different operations, that can be set in OpenSIPS core and modules. Whenever the execution takes longer than configured, OpenSIPS will report it to the log, together with additional useful information (such as operation details or script backtrace):\nexec_msg_threshold (core) – the maximum number of microseconds the processing of a SIP msg is expected to last. This is very useful to identify the “slow” functions in your overall script; exec_dns_threshold (core) – the maximum number of microseconds a DNS query is expected to last. This is very useful to identify what are the “slow” DNS queries in your routing (covering also SRV, NAPTR queries too);** tcp_threshold (core) – maximum number of microseconds sending a TCP request is expected to last. This is useful to identify the “slow” TCP connections (in terms of sending data). Note that this option will cover all TCP-based transports, like TCP plain, TLS, WS, WSS, BIN or HEP. exec_query_threshold (db_mysql module) – maximum number of microseconds for running a mysql query. This is useful to identify the “slow” query you may have. Note that this option covers all the mysql queries you may have in OpenSIPS – from script level or internally triggered by modules. A similar option is also in the db_postgres module too. An example for the output trigger by the exec_msg_threshold :\nopensips[17835]: WARNING:core:log_expiry: threshold exceeded : msg processing took too long – 223788 us.Source : BYE sip:………. opensips[17835]: WARNING:core:log_expiry: #1 is a module action : match_dialog – 220329us – line 1146 opensips[17835]: WARNING:core:log_expiry: #2 is a module action : t_relay – 3370us – line 1574 opensips[17835]: WARNING:core:log_expiry: #3 is a module action : unforce_rtp_proxy – 3297us – line 1625 opensips[17835]: WARNING:core:log_expiry: #4 is a core action : 78 – 24us – line 1188 opensips[17835]: WARNING:core:log_expiry: #5 is a module action : subst_uri – 8us – line 1201\nGood luck with the troubleshooting and be sure your OpenSIPS rocks !!\n","wordCount":"1151","inLanguage":"en","datePublished":"2019-07-31T13:43:05+08:00","dateModified":"2019-07-31T13:43:05+08:00","author":{"@type":"Person","name":"Eddie Wang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wdd.js.org/opensips/blog/troubleshooting-opensips-script/"},"publisher":{"@type":"Organization","name":"洞香春","logo":{"@type":"ImageObject","url":"https://wdd.js.org/cowboy.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org accesskey=h title="洞香春 (Alt + H)"><img src=/cowboy.ico alt=logo aria-label=logo height=35>洞香春</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/fe/ title=Frontend><span>Frontend</span></a></li><li><a href=https://wdd.js.org/golang/ title=Golang><span>Golang</span></a></li><li><a href=https://wdd.js.org/container/ title=k8s/docker><span>k8s/docker</span></a></li><li><a href=https://wdd.js.org/network/ title=Network><span>Network</span></a></li><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/shell/ title=Shell><span>Shell</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/categories/ title=分类><span>分类</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wdd.js.org>Home</a>&nbsp;»&nbsp;<a href=https://wdd.js.org/opensips/>OpenSIPS2.4.X 中文实战系列</a></div><h1 class=post-title>Troubleshooting OpenSIPS script</h1><div class=post-meta><span title='2019-07-31 13:43:05 +0800 CST'>2019-07-31 13:43:05</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Eddie Wang</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><ul><li><a href=#controlling-the-script-logging aria-label="Controlling the script logging">Controlling the script logging</a></li><li><a href=#tracing-the-script-execution aria-label="Tracing the script execution">Tracing the script execution</a></li></ul><li><a href=#caller-must-be-traced-according-to-dialplan-1 aria-label="caller must be traced according to dialplan 1">caller must be traced according to dialplan 1</a><ul><li><a href=#benchmarking-the-script aria-label="Benchmarking the script">Benchmarking the script</a></li><li><a href=#identifying-script-bottlenecks aria-label="Identifying script bottlenecks">Identifying script bottlenecks</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>What makes OpenSIPS such an attractive and powerful SIP solutions is its high level of programmability, thanks to its C-like configuration script. But once you get into the “programming” area, you will automatically need tools and skills for troubleshooting.So here there are some some tips and tools you can use in OpenSIPS for “debugging” your configuration script.</p><h2 id=controlling-the-script-logging>Controlling the script logging<a hidden class=anchor aria-hidden=true href=#controlling-the-script-logging>#</a></h2><p>The easiest way to troubleshoot your script is of course by using the <a href=http://www.opensips.org/Documentation/Script-CoreFunctions-2-3#toc57><strong>xlog()</strong></a> core function and print your own messages. Still the internal OpenSIPS logs (generated by the OpenSIPS code) do provide a lot of information about what OpenSIPS is doing.The challenge with the logging is to control the amount and content of messages you want to log. Otherwise you will end up with huge piles of logs, completely impossible to read and follow.By using the <a href=http://www.opensips.org/Documentation/Script-CoreVar-2-3#log_level><strong>$log_level</strong></a> script variable you can dynamically change the logging level (to make it more or less verbose) from the script level. You can do this only for parts of the script:</p><blockquote><p>log_level= -1 # errors only
…..
{
……
$log_level = 4; # set the debug level of the current process to DEBUG
uac_replace_from(….);
$log_level = NULL; # reset the log level of the current process to its default level
…….
}</p></blockquote><p>or only for certain messages, based on source IP (you can use the <a href=http://www.opensips.org/html/docs/modules/2.3.x/permissions.html><strong>permissions</strong></a> module for a more dynamic approach, controlled via DB)</p><blockquote><p>if ($si==”11.22.33.44″)
$log_level = 4;</p></blockquote><p>or some parts of the message (you can use the <a href=http://www.opensips.org/html/docs/modules/2.3.x/dialplan.html><strong>dialplan</strong></a> module for the dynamic approach):</p><blockquote><p>if ($rU==”911″)
$log_level = 4;</p></blockquote><p><strong>IMPORTANT</strong>: do not forget to reset the log level back to default before terminating the script, otherwise that log level will be used by the current process for all the future messages it will handle.</p><h2 id=tracing-the-script-execution>Tracing the script execution<a hidden class=anchor aria-hidden=true href=#tracing-the-script-execution>#</a></h2><p>Still, using the <strong>xlog()</strong> core function may not be the best option as it implies a high script pollution and many script changes (with restarts, of course).So, a better alternative is the <a href=http://www.opensips.org/Documentation/Script-CoreFunctions-2-3#toc43><strong>script_trace()</strong></a> core function. Once you enabled the script tracing, OpenSIPS will start logging its steps though the script execution, printing each function that is called and its line in the script file.This script tracing is really helpful when you want to understand or troubleshoot your script execution, answering questions like “<em>why does my script not get to this route</em>” or “<em>why is the script function not called</em>” or “<em>I do not understand how the SIP message flows through my script</em>“….. and many other similar problems.The <strong><a href=http://www.opensips.org/Documentation/Script-CoreFunctions-2-3#toc43>script_trace()</a></strong> function can help even more by allowing you to trace the value of certain variables (or parts of the message) during the script execution. Like “<em>I do not understand where in script my RURI is changed</em>“. So you simply attach to the function a log line (with variables, of course) that will be evaluated and printed for each function in the script:</p><blockquote><p>script_trace( 1, “$rm from $si, ruri=$ru”, “me”);</p></blockquote><p>will produce:</p><blockquote><p>[line 578][me][module consume_credentials] -> (INVITE from 127.0.0.1 , ruri=sip:111211@opensips.org)
[line 581][me][core setsflag] -> (INVITE from 127.0.0.1 , ruri=sip:111211@opensips.org)
[line 583][me][assign equal] -> (INVITE from 127.0.0.1 , ruri=sip:111211@opensips.org)
[line 592][me][core if] -> (INVITE from 127.0.0.1 , ruri=sip:tester@opensips.org)
[line 585][me][module is_avp_set] -> (INVITE from 127.0.0.1 , ruri=sip:tester@opensips.org)
[line 589][me][core if] -> (INVITE from 127.0.0.1 , ruri=sip:tester@opensips.org)
[line 586][me][module is_method] -> (INVITE from 127.0.0.1 , ruri=sip:tester@opensips.org)
[line 587][me][module trace_dialog] -> (INVITE 127.0.0.1 , ruri=sip:tester@opensips.org)
[line 590][me][core setflag] -> (INVITE from 127.0.0.1 , ruri=sip:tester@opensips.org)</p></blockquote><p>Again, you can enable the script tracing only for some cases (on demand). For example I want to trace only calls from a certain subscriber, so I can use the <strong>dialplan</strong> module and create in DB rules to match the subscribers I’m interested in tracing:</p><blockquote><p>if ( dp_translate(“1″,”$fU/$var(foo)”) )</p><h1 id=caller-must-be-traced-according-to-dialplan-1>caller must be traced according to dialplan 1<a hidden class=anchor aria-hidden=true href=#caller-must-be-traced-according-to-dialplan-1>#</a></h1><p>script_trace( 1, “$rm from $si, ruri=$ru”, “me”);</p></blockquote><h2 id=benchmarking-the-script>Benchmarking the script<a hidden class=anchor aria-hidden=true href=#benchmarking-the-script>#</a></h2><p>Assuming that you get to a point where you managed to troubleshoot and fix your script in terms of the execution flow, you now may be interested in troubleshoot the script execution from the time perspective – how much time takes OpenSIPS to execute certain parts of the script.This is a mandatory step if you want to perform a performance analysis of your OpenSIPS setup.The <a href=http://www.opensips.org/html/docs/modules/2.3.x/benchmark.html><strong>benchmark</strong></a> module will help you to measure the time OpenSIPS took to execute different parts of the script:</p><blockquote><p>bm_start_timer(“lookup-timer”);
lookup(“location”);
bm_log_timer(“lookup-timer”);</p></blockquote><p>An interesting capability of the module is to provide information about the current usage, but also aggregated information from the past, like how many times a certain timer was used or what was the total time spent in a timer (see the full provided <a href=http://www.opensips.org/html/docs/modules/2.3.x/benchmark.html#idp30688656>information</a>). And even more, such information can be pulled via Management Interface via the <a href=http://www.opensips.org/html/docs/modules/2.3.x/benchmark.html#idp30718592><strong>bm_poll_results</strong></a> command, for external usage:</p><blockquote><p>opensipsctl fifo bm_poll_results
register-timer
3/40/12/14/13.333333
9/204/12/97/22.666667
lookup-timer
3/21/7/7/7.000000
9/98/7/41/10.888889</p></blockquote><h2 id=identifying-script-bottlenecks>Identifying script bottlenecks<a hidden class=anchor aria-hidden=true href=#identifying-script-bottlenecks>#</a></h2><p>But still you need to find the weak points of your script in terms on time to process. Or the bottlenecks of your script.OpenSIPS provides a very useful mechanism for this – the <strong>time thresholds</strong>. There are different thresholds, for different operations, that can be set in OpenSIPS core and modules. Whenever the execution takes longer than configured, OpenSIPS will report it to the log, together with additional useful information (such as operation details or script backtrace):</p><ul><li><a href=http://www.opensips.org/Documentation/Script-CoreParameters-2-3#toc60><strong>exec_msg_threshold</strong></a> (core) – the maximum number of microseconds the processing of a SIP msg is expected to last. This is very useful to identify the “slow” functions in your overall script;</li><li><strong><a href=http://www.opensips.org/Documentation/Script-CoreParameters-2-3#toc59>exec_dns_threshold</a></strong> (core) – the maximum number of microseconds a DNS query is expected to last. This is very useful to identify what are the “slow” DNS queries in your routing (covering also SRV, NAPTR queries too);**</li><li><a href=http://www.opensips.org/Documentation/Script-CoreParameters-2-3#toc102><strong>tcp_threshold</strong></a> (core) – maximum number of microseconds sending a TCP request is expected to last. This is useful to identify the “slow” TCP connections (in terms of sending data). Note that this option will cover all TCP-based transports, like TCP plain, TLS, WS, WSS, BIN or HEP.</li><li><a href=http://www.opensips.org/html/docs/modules/2.3.x/db_mysql.html#idp5412736><strong>exec_query_threshold</strong></a> (db_mysql module) – maximum number of microseconds for running a mysql query. This is useful to identify the “slow” query you may have. Note that this option covers all the mysql queries you may have in OpenSIPS – from script level or internally triggered by modules. A similar option is also in the <a href=http://www.opensips.org/html/docs/modules/2.3.x/db_postgres.html#idp78720><strong>db_postgres</strong></a> module too.</li></ul><p>An example for the output trigger by the <strong>exec_msg_threshold</strong> :</p><blockquote><p>opensips[17835]: WARNING:core:log_expiry: threshold exceeded : msg processing took too long – 223788 us.Source : BYE sip:……….
opensips[17835]: WARNING:core:log_expiry: #1 is a module action : match_dialog – 220329us – line 1146
opensips[17835]: WARNING:core:log_expiry: #2 is a module action : t_relay – 3370us – line 1574
opensips[17835]: WARNING:core:log_expiry: #3 is a module action : unforce_rtp_proxy – 3297us – line 1625
opensips[17835]: WARNING:core:log_expiry: #4 is a core action : 78 – 24us – line 1188
opensips[17835]: WARNING:core:log_expiry: #5 is a module action : subst_uri – 8us – line 1201</p></blockquote><p> Good luck with the troubleshooting  and be sure <strong>your OpenSIPS rocks</strong> !!</p></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://wdd.js.org>洞香春</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>