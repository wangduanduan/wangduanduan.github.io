<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>深入OpenSIPS统计引擎 | 洞香春</title><meta name=keywords content><meta name=description content="无论你是经验丰富的OpenSIPS管理员，或者你仅仅想找到为什么ACK消息在你的网络中循环发送，唯一可以确定的是：我们或早或晚会需要OpenSIPS提供数据来回答以下问题
OpenSIPS运行了多久？ 我们是否被恶意流量攻击了？ 我们的平台处理了多少个来自运营商的无效SIP包 在流量峰值时，OpenSIPS是否拥有足够的内存来支撑运行 &mldr; 幸运的是，OpenSIPS提供内置的统计支持，来方便我们快速解决以上问题。详情可以查看OpenSIPS统计接口。在本篇文章中，我们将会了解统计引擎，但是，什么是引擎？
统计引擎 总的来说，下图就是OpenSIPS引擎的样子。
统计引擎内置于OpenSIPS。它管理所有的统计数据，并且暴露一个标准的CRUD操作接口给所有的模块，让模块可以推送或者管理他们自己的统计数据。
一下有三种方式来和统计引擎进行交互
直接通过脚本访问。如通过$script(my-stat)变量 使用HTTP请求来访问 使用opensipsctl fifo命令 统计引擎是非常灵活并且可以通过不同方式与其交互，那么它怎么能让我们的使用变得方便呢？下面的一些建议，能够让你全面的发挥静态统计引擎的能力，来增强某些重要的层面。
系统开发维护 当你处理OpenSIPS的DevOps时，你经常需要监控OpenSIPS的一些运行参数。你的关注点不同，那么你就需要监控不同的方面，例如SIP事务、对话、内存使用、系统负载等等
下面是OpenSIPS统计分组的一个概要，以及组内的每一个统计值，详情可以参考wiki。
统计简介 假如我们想通过sipp对我们的平台进行流量测试，我们想压测期间观测当前的事务、对话、共享内存的值变化。或者我们我们有了一个新的SIP提供商，他们每天早上9点会开始向我们平台推送数据，我们需要监控他们的推送会对我们系统产生的影响。
你可以在OpenSIPS实例中输入以下指令：
watch -n0.2 'opensipsctl fifo get_statistics inuse_transactions dialog: shmem:' 注意 get_statistics命令即可以接受一个统计值项，也可以接受一个统计组的项。统计组都是以冒号(:)结尾。
与递增的统计指标进行交互 统计指标看起来相同，实际上分为两类
累计值。累计是一般是随着时间增长，例如rcv_requests, processed_dialogs，表示从某个时间点开始累计收到或者处理了多少个任务 计算值。计算值一般和系统运行负载有关，和时间无关。例如active_dialogs, real_used_size, 这些值都是由内部函数计算出来的计算值 一般来说，脚本中定义的统计值都是递增的，OpenSIPS无法重新计算它，只能我们自己来计算或者维护它的值。
以下方式可以快速查看计算值类的统计项
opensipsctl fifo list_statistics 某些场景，你可能需要周期性的重置累计值类的统计项。例如你可以只需要统计当天的processed_dialogs，daily_routed_minutes，那么你只需要设置一个定时任务，每天0点，重置这些统计值。
opensipsctl fifo reset_statistics processed_dialogs 在脚本中自定义统计项 在脚本中自定义统计项是非常简单的，只需要做两步
加载statistics.so模块 在某些位置调用函数, update_stat(&#34;daily_routed_minutes&#34;, &#34;+1&#34;) 实战：脚本中有许多的自定义统计项 统计每天收到的SIP消息的请求方式, 以及处理的消息长度 每隔24小时，以JSON的形式，将消息写到SIP服务器 # 设置统计组 modparam(&#34;statistics&#34;, &#34;stat_groups&#34;, &#34;method, packet&#34;) # 请求路由 route { ... update_stat(&#34;method:$rm&#34;, &#34;+1&#34;); update_stat(&#34;packet:count&#34;, &#34;+1&#34;); update_stat(&#34;packet:total_size&#34;, &#34;$ml&#34;) # message length ."><meta name=author content="Eddie Wang"><link rel=canonical href=https://wdd.js.org/opensips/blog/deepin-stat-engine/><link crossorigin=anonymous href=/assets/css/stylesheet.min.ceab085cbbf58c0ec96f6d415d51b3b44e204edfd71a45b4fa2d4aac13f119d0.css integrity="sha256-zqsIXLv1jA7Jb21BXVGztE4gTt/XGkW0+i1KrBPxGdA=" rel="preload stylesheet" as=style><link crossorigin=anonymous herf=/font-awesome/css/font-awesome.min.css rel=stylesheet type=text/css><link rel=preload href=/cowboy.ico as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/cowboy.ico><link rel=apple-touch-icon href=https://wdd.js.org/cowboy.ico><link rel=mask-icon href=https://wdd.js.org/cowboy.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.111.3"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="深入OpenSIPS统计引擎"><meta property="og:description" content="无论你是经验丰富的OpenSIPS管理员，或者你仅仅想找到为什么ACK消息在你的网络中循环发送，唯一可以确定的是：我们或早或晚会需要OpenSIPS提供数据来回答以下问题
OpenSIPS运行了多久？ 我们是否被恶意流量攻击了？ 我们的平台处理了多少个来自运营商的无效SIP包 在流量峰值时，OpenSIPS是否拥有足够的内存来支撑运行 &mldr; 幸运的是，OpenSIPS提供内置的统计支持，来方便我们快速解决以上问题。详情可以查看OpenSIPS统计接口。在本篇文章中，我们将会了解统计引擎，但是，什么是引擎？
统计引擎 总的来说，下图就是OpenSIPS引擎的样子。
统计引擎内置于OpenSIPS。它管理所有的统计数据，并且暴露一个标准的CRUD操作接口给所有的模块，让模块可以推送或者管理他们自己的统计数据。
一下有三种方式来和统计引擎进行交互
直接通过脚本访问。如通过$script(my-stat)变量 使用HTTP请求来访问 使用opensipsctl fifo命令 统计引擎是非常灵活并且可以通过不同方式与其交互，那么它怎么能让我们的使用变得方便呢？下面的一些建议，能够让你全面的发挥静态统计引擎的能力，来增强某些重要的层面。
系统开发维护 当你处理OpenSIPS的DevOps时，你经常需要监控OpenSIPS的一些运行参数。你的关注点不同，那么你就需要监控不同的方面，例如SIP事务、对话、内存使用、系统负载等等
下面是OpenSIPS统计分组的一个概要，以及组内的每一个统计值，详情可以参考wiki。
统计简介 假如我们想通过sipp对我们的平台进行流量测试，我们想压测期间观测当前的事务、对话、共享内存的值变化。或者我们我们有了一个新的SIP提供商，他们每天早上9点会开始向我们平台推送数据，我们需要监控他们的推送会对我们系统产生的影响。
你可以在OpenSIPS实例中输入以下指令：
watch -n0.2 'opensipsctl fifo get_statistics inuse_transactions dialog: shmem:' 注意 get_statistics命令即可以接受一个统计值项，也可以接受一个统计组的项。统计组都是以冒号(:)结尾。
与递增的统计指标进行交互 统计指标看起来相同，实际上分为两类
累计值。累计是一般是随着时间增长，例如rcv_requests, processed_dialogs，表示从某个时间点开始累计收到或者处理了多少个任务 计算值。计算值一般和系统运行负载有关，和时间无关。例如active_dialogs, real_used_size, 这些值都是由内部函数计算出来的计算值 一般来说，脚本中定义的统计值都是递增的，OpenSIPS无法重新计算它，只能我们自己来计算或者维护它的值。
以下方式可以快速查看计算值类的统计项
opensipsctl fifo list_statistics 某些场景，你可能需要周期性的重置累计值类的统计项。例如你可以只需要统计当天的processed_dialogs，daily_routed_minutes，那么你只需要设置一个定时任务，每天0点，重置这些统计值。
opensipsctl fifo reset_statistics processed_dialogs 在脚本中自定义统计项 在脚本中自定义统计项是非常简单的，只需要做两步
加载statistics.so模块 在某些位置调用函数, update_stat(&#34;daily_routed_minutes&#34;, &#34;+1&#34;) 实战：脚本中有许多的自定义统计项 统计每天收到的SIP消息的请求方式, 以及处理的消息长度 每隔24小时，以JSON的形式，将消息写到SIP服务器 # 设置统计组 modparam(&#34;statistics&#34;, &#34;stat_groups&#34;, &#34;method, packet&#34;) # 请求路由 route { ... update_stat(&#34;method:$rm&#34;, &#34;+1&#34;); update_stat(&#34;packet:count&#34;, &#34;+1&#34;); update_stat(&#34;packet:total_size&#34;, &#34;$ml&#34;) # message length ."><meta property="og:type" content="article"><meta property="og:url" content="https://wdd.js.org/opensips/blog/deepin-stat-engine/"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="opensips"><meta property="article:published_time" content="2019-07-31T13:40:00+08:00"><meta property="article:modified_time" content="2019-07-31T13:40:00+08:00"><meta property="og:site_name" content="洞香春"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="深入OpenSIPS统计引擎"><meta name=twitter:description content="无论你是经验丰富的OpenSIPS管理员，或者你仅仅想找到为什么ACK消息在你的网络中循环发送，唯一可以确定的是：我们或早或晚会需要OpenSIPS提供数据来回答以下问题
OpenSIPS运行了多久？ 我们是否被恶意流量攻击了？ 我们的平台处理了多少个来自运营商的无效SIP包 在流量峰值时，OpenSIPS是否拥有足够的内存来支撑运行 &mldr; 幸运的是，OpenSIPS提供内置的统计支持，来方便我们快速解决以上问题。详情可以查看OpenSIPS统计接口。在本篇文章中，我们将会了解统计引擎，但是，什么是引擎？
统计引擎 总的来说，下图就是OpenSIPS引擎的样子。
统计引擎内置于OpenSIPS。它管理所有的统计数据，并且暴露一个标准的CRUD操作接口给所有的模块，让模块可以推送或者管理他们自己的统计数据。
一下有三种方式来和统计引擎进行交互
直接通过脚本访问。如通过$script(my-stat)变量 使用HTTP请求来访问 使用opensipsctl fifo命令 统计引擎是非常灵活并且可以通过不同方式与其交互，那么它怎么能让我们的使用变得方便呢？下面的一些建议，能够让你全面的发挥静态统计引擎的能力，来增强某些重要的层面。
系统开发维护 当你处理OpenSIPS的DevOps时，你经常需要监控OpenSIPS的一些运行参数。你的关注点不同，那么你就需要监控不同的方面，例如SIP事务、对话、内存使用、系统负载等等
下面是OpenSIPS统计分组的一个概要，以及组内的每一个统计值，详情可以参考wiki。
统计简介 假如我们想通过sipp对我们的平台进行流量测试，我们想压测期间观测当前的事务、对话、共享内存的值变化。或者我们我们有了一个新的SIP提供商，他们每天早上9点会开始向我们平台推送数据，我们需要监控他们的推送会对我们系统产生的影响。
你可以在OpenSIPS实例中输入以下指令：
watch -n0.2 'opensipsctl fifo get_statistics inuse_transactions dialog: shmem:' 注意 get_statistics命令即可以接受一个统计值项，也可以接受一个统计组的项。统计组都是以冒号(:)结尾。
与递增的统计指标进行交互 统计指标看起来相同，实际上分为两类
累计值。累计是一般是随着时间增长，例如rcv_requests, processed_dialogs，表示从某个时间点开始累计收到或者处理了多少个任务 计算值。计算值一般和系统运行负载有关，和时间无关。例如active_dialogs, real_used_size, 这些值都是由内部函数计算出来的计算值 一般来说，脚本中定义的统计值都是递增的，OpenSIPS无法重新计算它，只能我们自己来计算或者维护它的值。
以下方式可以快速查看计算值类的统计项
opensipsctl fifo list_statistics 某些场景，你可能需要周期性的重置累计值类的统计项。例如你可以只需要统计当天的processed_dialogs，daily_routed_minutes，那么你只需要设置一个定时任务，每天0点，重置这些统计值。
opensipsctl fifo reset_statistics processed_dialogs 在脚本中自定义统计项 在脚本中自定义统计项是非常简单的，只需要做两步
加载statistics.so模块 在某些位置调用函数, update_stat(&#34;daily_routed_minutes&#34;, &#34;+1&#34;) 实战：脚本中有许多的自定义统计项 统计每天收到的SIP消息的请求方式, 以及处理的消息长度 每隔24小时，以JSON的形式，将消息写到SIP服务器 # 设置统计组 modparam(&#34;statistics&#34;, &#34;stat_groups&#34;, &#34;method, packet&#34;) # 请求路由 route { ... update_stat(&#34;method:$rm&#34;, &#34;+1&#34;); update_stat(&#34;packet:count&#34;, &#34;+1&#34;); update_stat(&#34;packet:total_size&#34;, &#34;$ml&#34;) # message length ."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"OpenSIPS2.4.X 中文实战系列","item":"https://wdd.js.org/opensips/"},{"@type":"ListItem","position":3,"name":"深入OpenSIPS统计引擎","item":"https://wdd.js.org/opensips/blog/deepin-stat-engine/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"深入OpenSIPS统计引擎","name":"深入OpenSIPS统计引擎","description":"无论你是经验丰富的OpenSIPS管理员，或者你仅仅想找到为什么ACK消息在你的网络中循环发送，唯一可以确定的是：我们或早或晚会需要OpenSIPS提供数据来回答以下问题\nOpenSIPS运行了多久？ 我们是否被恶意流量攻击了？ 我们的平台处理了多少个来自运营商的无效SIP包 在流量峰值时，OpenSIPS是否拥有足够的内存来支撑运行 \u0026hellip; 幸运的是，OpenSIPS提供内置的统计支持，来方便我们快速解决以上问题。详情可以查看OpenSIPS统计接口。在本篇文章中，我们将会了解统计引擎，但是，什么是引擎？\n统计引擎 总的来说，下图就是OpenSIPS引擎的样子。\n统计引擎内置于OpenSIPS。它管理所有的统计数据，并且暴露一个标准的CRUD操作接口给所有的模块，让模块可以推送或者管理他们自己的统计数据。\n一下有三种方式来和统计引擎进行交互\n直接通过脚本访问。如通过$script(my-stat)变量 使用HTTP请求来访问 使用opensipsctl fifo命令 统计引擎是非常灵活并且可以通过不同方式与其交互，那么它怎么能让我们的使用变得方便呢？下面的一些建议，能够让你全面的发挥静态统计引擎的能力，来增强某些重要的层面。\n系统开发维护 当你处理OpenSIPS的DevOps时，你经常需要监控OpenSIPS的一些运行参数。你的关注点不同，那么你就需要监控不同的方面，例如SIP事务、对话、内存使用、系统负载等等\n下面是OpenSIPS统计分组的一个概要，以及组内的每一个统计值，详情可以参考wiki。\n统计简介 假如我们想通过sipp对我们的平台进行流量测试，我们想压测期间观测当前的事务、对话、共享内存的值变化。或者我们我们有了一个新的SIP提供商，他们每天早上9点会开始向我们平台推送数据，我们需要监控他们的推送会对我们系统产生的影响。\n你可以在OpenSIPS实例中输入以下指令：\nwatch -n0.2 \u0026#39;opensipsctl fifo get_statistics inuse_transactions dialog: shmem:\u0026#39; 注意 get_statistics命令即可以接受一个统计值项，也可以接受一个统计组的项。统计组都是以冒号(:)结尾。\n与递增的统计指标进行交互 统计指标看起来相同，实际上分为两类\n累计值。累计是一般是随着时间增长，例如rcv_requests, processed_dialogs，表示从某个时间点开始累计收到或者处理了多少个任务 计算值。计算值一般和系统运行负载有关，和时间无关。例如active_dialogs, real_used_size, 这些值都是由内部函数计算出来的计算值 一般来说，脚本中定义的统计值都是递增的，OpenSIPS无法重新计算它，只能我们自己来计算或者维护它的值。\n以下方式可以快速查看计算值类的统计项\nopensipsctl fifo list_statistics 某些场景，你可能需要周期性的重置累计值类的统计项。例如你可以只需要统计当天的processed_dialogs，daily_routed_minutes，那么你只需要设置一个定时任务，每天0点，重置这些统计值。\nopensipsctl fifo reset_statistics processed_dialogs 在脚本中自定义统计项 在脚本中自定义统计项是非常简单的，只需要做两步\n加载statistics.so模块 在某些位置调用函数, update_stat(\u0026quot;daily_routed_minutes\u0026quot;, \u0026quot;+1\u0026quot;) 实战：脚本中有许多的自定义统计项 统计每天收到的SIP消息的请求方式, 以及处理的消息长度 每隔24小时，以JSON的形式，将消息写到SIP服务器 # 设置统计组 modparam(\u0026#34;statistics\u0026#34;, \u0026#34;stat_groups\u0026#34;, \u0026#34;method, packet\u0026#34;) # 请求路由 route { ... update_stat(\u0026#34;method:$rm\u0026#34;, \u0026#34;+1\u0026#34;); update_stat(\u0026#34;packet:count\u0026#34;, \u0026#34;+1\u0026#34;); update_stat(\u0026#34;packet:total_size\u0026#34;, \u0026#34;$ml\u0026#34;) # message length .","keywords":[],"articleBody":"无论你是经验丰富的OpenSIPS管理员，或者你仅仅想找到为什么ACK消息在你的网络中循环发送，唯一可以确定的是：我们或早或晚会需要OpenSIPS提供数据来回答以下问题\nOpenSIPS运行了多久？ 我们是否被恶意流量攻击了？ 我们的平台处理了多少个来自运营商的无效SIP包 在流量峰值时，OpenSIPS是否拥有足够的内存来支撑运行 … 幸运的是，OpenSIPS提供内置的统计支持，来方便我们快速解决以上问题。详情可以查看OpenSIPS统计接口。在本篇文章中，我们将会了解统计引擎，但是，什么是引擎？\n统计引擎 总的来说，下图就是OpenSIPS引擎的样子。\n统计引擎内置于OpenSIPS。它管理所有的统计数据，并且暴露一个标准的CRUD操作接口给所有的模块，让模块可以推送或者管理他们自己的统计数据。\n一下有三种方式来和统计引擎进行交互\n直接通过脚本访问。如通过$script(my-stat)变量 使用HTTP请求来访问 使用opensipsctl fifo命令 统计引擎是非常灵活并且可以通过不同方式与其交互，那么它怎么能让我们的使用变得方便呢？下面的一些建议，能够让你全面的发挥静态统计引擎的能力，来增强某些重要的层面。\n系统开发维护 当你处理OpenSIPS的DevOps时，你经常需要监控OpenSIPS的一些运行参数。你的关注点不同，那么你就需要监控不同的方面，例如SIP事务、对话、内存使用、系统负载等等\n下面是OpenSIPS统计分组的一个概要，以及组内的每一个统计值，详情可以参考wiki。\n统计简介 假如我们想通过sipp对我们的平台进行流量测试，我们想压测期间观测当前的事务、对话、共享内存的值变化。或者我们我们有了一个新的SIP提供商，他们每天早上9点会开始向我们平台推送数据，我们需要监控他们的推送会对我们系统产生的影响。\n你可以在OpenSIPS实例中输入以下指令：\nwatch -n0.2 'opensipsctl fifo get_statistics inuse_transactions dialog: shmem:' 注意 get_statistics命令即可以接受一个统计值项，也可以接受一个统计组的项。统计组都是以冒号(:)结尾。\n与递增的统计指标进行交互 统计指标看起来相同，实际上分为两类\n累计值。累计是一般是随着时间增长，例如rcv_requests, processed_dialogs，表示从某个时间点开始累计收到或者处理了多少个任务 计算值。计算值一般和系统运行负载有关，和时间无关。例如active_dialogs, real_used_size, 这些值都是由内部函数计算出来的计算值 一般来说，脚本中定义的统计值都是递增的，OpenSIPS无法重新计算它，只能我们自己来计算或者维护它的值。\n以下方式可以快速查看计算值类的统计项\nopensipsctl fifo list_statistics 某些场景，你可能需要周期性的重置累计值类的统计项。例如你可以只需要统计当天的processed_dialogs，daily_routed_minutes，那么你只需要设置一个定时任务，每天0点，重置这些统计值。\nopensipsctl fifo reset_statistics processed_dialogs 在脚本中自定义统计项 在脚本中自定义统计项是非常简单的，只需要做两步\n加载statistics.so模块 在某些位置调用函数, update_stat(\"daily_routed_minutes\", \"+1\") 实战：脚本中有许多的自定义统计项 统计每天收到的SIP消息的请求方式, 以及处理的消息长度 每隔24小时，以JSON的形式，将消息写到SIP服务器 # 设置统计组 modparam(\"statistics\", \"stat_groups\", \"method, packet\") # 请求路由 route { ... update_stat(\"method:$rm\", \"+1\"); update_stat(\"packet:count\", \"+1\"); update_stat(\"packet:total_size\", \"$ml\") # message length ... } # 响应路由 onreply_route { update_stat(\"packet:count\", \"+1\"); update_stat(\"packet:total_size\", \"$ml\") } # 定时器路由，定时通过HTTP发请求 timer_route [daily_stat_push, 86400] { $json(all_stats) := \"{\\\"method\\\": {}, \\\"packet\\\": {}}\"; # pack and clear all method-related statistics stat_iter_init(\"method\", \"iter\"); while (stat_iter_next(\"$var(key)\", \"$var(val)\", \"iter\")) { $json(all_stats/method/$var(key)) = $var(val); reset_stat(\"$var(key)\"); } # pack and clear all packet-related statistics stat_iter_init(\"packet\", \"iter\"); while (stat_iter_next(\"$var(key)\", \"$var(val)\", \"iter\")) { $json(all_stats/packet/$var(key)) = $var(val); reset_stat(\"$var(key)\"); } # push the data to our web server if (!rest_post(\"https://WEB_SERVER\", \"$json(all_stats)\", , \"$var(out_body)\", , \"$var(status)\")) xlog(\"ERROR: during HTTP POST, $json(all_stats)\\n\"); if ($var(status) != 200) xlog(\"ERROR: web server returned $var(status), $json(all_stats)\\n\"); } ","wordCount":"171","inLanguage":"en","datePublished":"2019-07-31T13:40:00+08:00","dateModified":"2019-07-31T13:40:00+08:00","author":{"@type":"Person","name":"Eddie Wang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wdd.js.org/opensips/blog/deepin-stat-engine/"},"publisher":{"@type":"Organization","name":"洞香春","logo":{"@type":"ImageObject","url":"https://wdd.js.org/cowboy.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org accesskey=h title="洞香春 (Alt + H)"><img src=/cowboy.ico alt=logo aria-label=logo height=35>洞香春</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/fe/ title=Frontend><span>Frontend</span></a></li><li><a href=https://wdd.js.org/golang/ title=Golang><span>Golang</span></a></li><li><a href=https://wdd.js.org/container/ title=k8s/docker><span>k8s/docker</span></a></li><li><a href=https://wdd.js.org/network/ title=Network><span>Network</span></a></li><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/shell/ title=Shell><span>Shell</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/categories/ title=分类><span>分类</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wdd.js.org>Home</a>&nbsp;»&nbsp;<a href=https://wdd.js.org/opensips/>OpenSIPS2.4.X 中文实战系列</a></div><h1 class=post-title>深入OpenSIPS统计引擎</h1><div class=post-meta><span title='2019-07-31 13:40:00 +0800 CST'>2019-07-31 13:40:00</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e7%bb%9f%e8%ae%a1%e5%bc%95%e6%93%8e aria-label=统计引擎>统计引擎</a></li><li><a href=#%e7%b3%bb%e7%bb%9f%e5%bc%80%e5%8f%91%e7%bb%b4%e6%8a%a4 aria-label=系统开发维护>系统开发维护</a></li><li><a href=#%e7%bb%9f%e8%ae%a1%e7%ae%80%e4%bb%8b aria-label=统计简介>统计简介</a></li><li><a href=#%e4%b8%8e%e9%80%92%e5%a2%9e%e7%9a%84%e7%bb%9f%e8%ae%a1%e6%8c%87%e6%a0%87%e8%bf%9b%e8%a1%8c%e4%ba%a4%e4%ba%92 aria-label=与递增的统计指标进行交互>与递增的统计指标进行交互</a></li><li><a href=#%e5%9c%a8%e8%84%9a%e6%9c%ac%e4%b8%ad%e8%87%aa%e5%ae%9a%e4%b9%89%e7%bb%9f%e8%ae%a1%e9%a1%b9 aria-label=在脚本中自定义统计项>在脚本中自定义统计项</a></li><li><a href=#%e5%ae%9e%e6%88%98%e8%84%9a%e6%9c%ac%e4%b8%ad%e6%9c%89%e8%ae%b8%e5%a4%9a%e7%9a%84%e8%87%aa%e5%ae%9a%e4%b9%89%e7%bb%9f%e8%ae%a1%e9%a1%b9 aria-label=实战：脚本中有许多的自定义统计项>实战：脚本中有许多的自定义统计项</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>无论你是经验丰富的OpenSIPS管理员，或者你仅仅想找到为什么ACK消息在你的网络中循环发送，唯一可以确定的是：我们或早或晚会需要OpenSIPS提供数据来回答以下问题</p><ul><li>OpenSIPS运行了多久？</li><li>我们是否被恶意流量攻击了？</li><li>我们的平台处理了多少个来自运营商的无效SIP包</li><li>在流量峰值时，OpenSIPS是否拥有足够的内存来支撑运行</li><li>&mldr;</li></ul><p>幸运的是，OpenSIPS提供内置的统计支持，来方便我们快速解决以上问题。详情可以查看<a href=https://opensips.org/Documentation/Interface-Statistics-2-4>OpenSIPS统计接口</a>。在本篇文章中，我们将会了解统计引擎，但是，什么是引擎？</p><h1 id=统计引擎>统计引擎<a hidden class=anchor aria-hidden=true href=#统计引擎>#</a></h1><p>总的来说，下图就是OpenSIPS引擎的样子。</p><p><img loading=lazy src=2022-12-03-15-23-32.png alt></p><p>统计引擎内置于OpenSIPS。它管理所有的统计数据，并且暴露一个标准的CRUD操作接口给所有的模块，让模块可以推送或者管理他们自己的统计数据。</p><p>一下有三种方式来和统计引擎进行交互</p><ul><li>直接通过脚本访问。如通过$script(my-stat)变量</li><li>使用HTTP请求来访问</li><li>使用opensipsctl fifo命令</li></ul><p>统计引擎是非常灵活并且可以通过不同方式与其交互，那么它怎么能让我们的使用变得方便呢？下面的一些建议，能够让你全面的发挥静态统计引擎的能力，来增强某些重要的层面。</p><h1 id=系统开发维护>系统开发维护<a hidden class=anchor aria-hidden=true href=#系统开发维护>#</a></h1><p>当你处理OpenSIPS的DevOps时，你经常需要监控OpenSIPS的一些运行参数。你的关注点不同，那么你就需要监控不同的方面，例如SIP事务、对话、内存使用、系统负载等等</p><p>下面是OpenSIPS统计分组的一个概要，以及组内的每一个统计值，详情可以参考<a href=https://opensips.org/Documentation/Interface-CoreStatistics-2-4>wiki</a>。</p><p><img loading=lazy src=2022-12-03-15-23-44.png alt></p><h1 id=统计简介>统计简介<a hidden class=anchor aria-hidden=true href=#统计简介>#</a></h1><p>假如我们想通过sipp对我们的平台进行流量测试，我们想压测期间观测当前的事务、对话、共享内存的值变化。或者我们我们有了一个新的SIP提供商，他们每天早上9点会开始向我们平台推送数据，我们需要监控他们的推送会对我们系统产生的影响。</p><p>你可以在OpenSIPS实例中输入以下指令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>watch -n0.2 <span style=color:#e6db74>&#39;opensipsctl fifo get_statistics inuse_transactions dialog: shmem:&#39;</span>
</span></span></code></pre></div><p>注意 get_statistics命令即可以接受一个统计值项，也可以接受一个统计组的项。统计组都是以冒号(:)结尾。</p><h1 id=与递增的统计指标进行交互>与递增的统计指标进行交互<a hidden class=anchor aria-hidden=true href=#与递增的统计指标进行交互>#</a></h1><p>统计指标看起来相同，实际上分为两类</p><ul><li><strong>累计值</strong>。累计是一般是随着时间增长，例如<code>rcv_requests</code>, <code>processed_dialogs</code>，表示从某个时间点开始累计收到或者处理了多少个任务</li><li><strong>计算值</strong>。计算值一般和系统运行负载有关，和时间无关。例如<code>active_dialogs</code>, <code>real_used_size</code>, 这些值都是由内部函数计算出来的计算值</li></ul><p>一般来说，脚本中定义的统计值都是递增的，OpenSIPS无法重新计算它，只能我们自己来计算或者维护它的值。</p><p>以下方式可以快速查看计算值类的统计项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>opensipsctl fifo list_statistics
</span></span></code></pre></div><p>某些场景，你可能需要周期性的重置累计值类的统计项。例如你可以只需要统计当天的<code>processed_dialogs</code>，<code>daily_routed_minutes</code>，那么你只需要设置一个定时任务，每天0点，重置这些统计值。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>opensipsctl fifo reset_statistics processed_dialogs
</span></span></code></pre></div><h1 id=在脚本中自定义统计项>在脚本中自定义统计项<a hidden class=anchor aria-hidden=true href=#在脚本中自定义统计项>#</a></h1><p>在脚本中自定义统计项是非常简单的，只需要做两步</p><ol><li>加载<code>statistics.so</code>模块</li><li>在某些位置调用函数, <code>update_stat("daily_routed_minutes", "+1")</code></li></ol><h1 id=实战脚本中有许多的自定义统计项>实战：脚本中有许多的自定义统计项<a hidden class=anchor aria-hidden=true href=#实战脚本中有许多的自定义统计项>#</a></h1><ul><li>统计每天收到的SIP消息的请求方式, 以及处理的消息长度</li><li>每隔24小时，以JSON的形式，将消息写到SIP服务器</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 设置统计组</span>
</span></span><span style=display:flex><span>modparam<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;statistics&#34;</span>, <span style=color:#e6db74>&#34;stat_groups&#34;</span>, <span style=color:#e6db74>&#34;method, packet&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 请求路由</span>
</span></span><span style=display:flex><span>route <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    update_stat<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;method:</span>$rm<span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;+1&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>    update_stat<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;packet:count&#34;</span>, <span style=color:#e6db74>&#34;+1&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>    update_stat<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;packet:total_size&#34;</span>, <span style=color:#e6db74>&#34;</span>$ml<span style=color:#e6db74>&#34;</span><span style=color:#f92672>)</span> <span style=color:#75715e># message length</span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 响应路由</span>
</span></span><span style=display:flex><span>onreply_route <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    update_stat<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;packet:count&#34;</span>, <span style=color:#e6db74>&#34;+1&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>    update_stat<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;packet:total_size&#34;</span>, <span style=color:#e6db74>&#34;</span>$ml<span style=color:#e6db74>&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 定时器路由，定时通过HTTP发请求</span>
</span></span><span style=display:flex><span>timer_route <span style=color:#f92672>[</span>daily_stat_push, 86400<span style=color:#f92672>]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    $json<span style=color:#f92672>(</span>all_stats<span style=color:#f92672>)</span> :<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;{\&#34;method\&#34;: {}, \&#34;packet\&#34;: {}}&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e># pack and clear all method-related statistics</span>
</span></span><span style=display:flex><span>    stat_iter_init<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;method&#34;</span>, <span style=color:#e6db74>&#34;iter&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>stat_iter_next<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;</span>$var<span style=color:#e6db74>(key)&#34;</span>, <span style=color:#e6db74>&#34;</span>$var<span style=color:#e6db74>(val)&#34;</span>, <span style=color:#e6db74>&#34;iter&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        $json<span style=color:#f92672>(</span>all_stats/method/$var<span style=color:#f92672>(</span>key<span style=color:#f92672>))</span> <span style=color:#f92672>=</span> $var<span style=color:#f92672>(</span>val<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>        reset_stat<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;</span>$var<span style=color:#e6db74>(key)&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># pack and clear all packet-related statistics</span>
</span></span><span style=display:flex><span>    stat_iter_init<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;packet&#34;</span>, <span style=color:#e6db74>&#34;iter&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>stat_iter_next<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;</span>$var<span style=color:#e6db74>(key)&#34;</span>, <span style=color:#e6db74>&#34;</span>$var<span style=color:#e6db74>(val)&#34;</span>, <span style=color:#e6db74>&#34;iter&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        $json<span style=color:#f92672>(</span>all_stats/packet/$var<span style=color:#f92672>(</span>key<span style=color:#f92672>))</span> <span style=color:#f92672>=</span> $var<span style=color:#f92672>(</span>val<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>        reset_stat<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;</span>$var<span style=color:#e6db74>(key)&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># push the data to our web server</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>!rest_post<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;https://WEB_SERVER&#34;</span>, <span style=color:#e6db74>&#34;</span>$json<span style=color:#e6db74>(all_stats)&#34;</span>, , <span style=color:#e6db74>&#34;</span>$var<span style=color:#e6db74>(out_body)&#34;</span>, , <span style=color:#e6db74>&#34;</span>$var<span style=color:#e6db74>(status)&#34;</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>        xlog<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ERROR: during HTTP POST, </span>$json<span style=color:#e6db74>(all_stats)\n&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>$var<span style=color:#f92672>(</span>status<span style=color:#f92672>)</span> !<span style=color:#f92672>=</span> 200<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        xlog<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ERROR: web server returned </span>$var<span style=color:#e6db74>(status), </span>$json<span style=color:#e6db74>(all_stats)\n&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://wdd.js.org>洞香春</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>