<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Load Balancing in OpenSIPS | 洞香春</title><meta name=keywords content><meta name=description content="https://opensips.org/Documentation/Tutorials-LoadBalancing-1-9
1. Load Balancing in OpenSIPS The &ldquo;load-balancing&rdquo; module comes to provide traffic routing based on load. Shortly, when OpenSIPS routes calls to a set of destinations, it is able to keep the load status (as number of ongoing calls) of each destination and to choose to route to the less loaded destination (at that moment). OpenSIPS is aware of the capacity of each destination - it is pre-configured with the maximum load accepted by the destinations."><meta name=author content="王端端"><link rel=canonical href=https://wdd.js.org/opensips/blog/load-balance/><link crossorigin=anonymous href=/assets/css/stylesheet.min.ceab085cbbf58c0ec96f6d415d51b3b44e204edfd71a45b4fa2d4aac13f119d0.css integrity="sha256-zqsIXLv1jA7Jb21BXVGztE4gTt/XGkW0+i1KrBPxGdA=" rel="preload stylesheet" as=style><link crossorigin=anonymous herf=/font-awesome/css/font-awesome.min.css rel=stylesheet type=text/css><link rel=preload href=/cowboy.ico as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/cowboy.ico><link rel=apple-touch-icon href=https://wdd.js.org/cowboy.ico><link rel=mask-icon href=https://wdd.js.org/cowboy.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.107.0"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Load Balancing in OpenSIPS"><meta property="og:description" content="https://opensips.org/Documentation/Tutorials-LoadBalancing-1-9
1. Load Balancing in OpenSIPS The &ldquo;load-balancing&rdquo; module comes to provide traffic routing based on load. Shortly, when OpenSIPS routes calls to a set of destinations, it is able to keep the load status (as number of ongoing calls) of each destination and to choose to route to the less loaded destination (at that moment). OpenSIPS is aware of the capacity of each destination - it is pre-configured with the maximum load accepted by the destinations."><meta property="og:type" content="article"><meta property="og:url" content="https://wdd.js.org/opensips/blog/load-balance/"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="opensips"><meta property="article:published_time" content="2021-03-09T17:52:04+08:00"><meta property="article:modified_time" content="2021-03-09T17:52:04+08:00"><meta property="og:site_name" content="洞香春"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Load Balancing in OpenSIPS"><meta name=twitter:description content="https://opensips.org/Documentation/Tutorials-LoadBalancing-1-9
1. Load Balancing in OpenSIPS The &ldquo;load-balancing&rdquo; module comes to provide traffic routing based on load. Shortly, when OpenSIPS routes calls to a set of destinations, it is able to keep the load status (as number of ongoing calls) of each destination and to choose to route to the less loaded destination (at that moment). OpenSIPS is aware of the capacity of each destination - it is pre-configured with the maximum load accepted by the destinations."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"OpenSIPS2.4.X 中文实战系列","item":"https://wdd.js.org/opensips/"},{"@type":"ListItem","position":3,"name":"Load Balancing in OpenSIPS","item":"https://wdd.js.org/opensips/blog/load-balance/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Load Balancing in OpenSIPS","name":"Load Balancing in OpenSIPS","description":"https://opensips.org/Documentation/Tutorials-LoadBalancing-1-9\n1. Load Balancing in OpenSIPS The \u0026ldquo;load-balancing\u0026rdquo; module comes to provide traffic routing based on load. Shortly, when OpenSIPS routes calls to a set of destinations, it is able to keep the load status (as number of ongoing calls) of each destination and to choose to route to the less loaded destination (at that moment). OpenSIPS is aware of the capacity of each destination - it is pre-configured with the maximum load accepted by the destinations.","keywords":[],"articleBody":"https://opensips.org/Documentation/Tutorials-LoadBalancing-1-9\n1. Load Balancing in OpenSIPS The “load-balancing” module comes to provide traffic routing based on load. Shortly, when OpenSIPS routes calls to a set of destinations, it is able to keep the load status (as number of ongoing calls) of each destination and to choose to route to the less loaded destination (at that moment). OpenSIPS is aware of the capacity of each destination - it is pre-configured with the maximum load accepted by the destinations. To be more precise, when routing, OpenSIPS will consider the less loaded destination not the destination with the smallest number of ongoing calls, but the destination with the largest available slot.\nAlso, the “load-balancing” (LB) module is able to receive feedback from the destinations (if they are capable of). This mechanism is used for notifying OpenSIPS when the maximum capacity of a destination changed (like a GW with more or less E1 cards).\nThe “load-balancing” functionality comes to enhance the “dispatcher” one. The difference comes in having or not load information about the destinations where you are routing to:\nDispatcher has no load information - it just blindly forwards calls to the destinations based on a probabilistic dispersion logic. It gets no feedback about the load of the destination (like how many calls that were sent actually were established or how many are still going). Load-balancer is load driven - LB routing logic is based primary on the load information. The LB module is using the DIALOG module in order to keep trace of the load (ongoing calls). 2. Load Balancing - how it works When looking at the LB implementation in OpenSIPS, we have 3 aspects:\n2.1 Destination set A destination is defined by its address (a SIP URI) and its description as capacity.\nForm the LB module perspective, the destinations are not homogeneous - they are not alike; and not only from capacity point of view, but also from what kind of services/resources they offer. For example, you may have a set of Yate/Asterisk boxes for media-related services -some of them are doing transcoding, other voicemail or conference, other simple announcement , other PSTN termination. But you may have mixed boxes - one box may do PSTN and voicemail in the same time. So each destination from the set may offer a different set of services/resources.\nSo, for each destination, the LB module defines the offered resources, and for each resource, it defines the capacity / maximum load as number of concurrent calls the destination can handle for that resource.\nExample: 4 destinations/boxes in the LB set\noffers 30 channels for transcoding and 32 for PSTN offers 100 voicemail channels and 10 for transcoding offers 50 voicemail channels and 300 for conference offers 10 voicemail, 10 conference, 10 transcoding and 32 PSTN id group_id dst_uri resources 1 1 sip:yate1.mycluster.net transc=30; pstn=32 2 1 sip:yate2.mycluster.net vm=100; transc=10 3 1 sip:yate3.mycluster.net vm=50; conf=300 4 1 sip:yate4.mycluster.net vm=10;conf=10;transc=10;pstn=32 For runtime, the LB module provides MI commands for:\nreloading the definition of destination sets changing the capacity for a resource for a destination 2.2 Invoking Load-balancing Using the LB functionality is very simple - you just have to pass to the LB module what kind of resources the call requires.\nThe resource detection is done in the OpenSIPS routing script, based on whatever information is appropriated. For example, looking at the RURI (dialed number) you can see if the call must go to PSTN or if it a voicemail or conference number; also, by looking at the codecs advertised in the SDP, you can figure out if transcoding is or not also required.\nif (!load_balance(\"1\",\"transc;pstn\")) { sl_send_reply(\"500\",\"Service full\"); exit; } The first parameter of the function identifies the LB set to be used (see the group_id column in the above DB snapshot). Second parameter is list of the required resource for the call. A third optional parameter my be passed to instruct the LB engine on how to estimate the load - in absolute value (how many channels are used) or in relative value (how many percentages are used).\nThe load_balance() will automatically create the dialog state for the call (in order to monitor it) and will also allocate the requested resources for it (from the selected box).\nThe function will set as destination URI ($du) the address of the selected destination/box.\nThe resources will be automatically released when the call terminates.The LB module provides an MI function that allows the admin to inspect the current load over the destinations.\n2.3 The LB logic The logic used by the LB module to select the destination is:\ngets the destination set based on the group_id (first parameter of the load_balance() function) selects from the set only the destinations that are able to provide the requested resources (second parameter of the load_balance() function) for the selected destinations, it evaluated the current load for each requested resource the winning destination is the one with the biggest value for the minimum available load per resources. Example:\n4 destinations/boxes in the LB set\noffers 30 channels for transcoding and 32 for PSTN offers 100 voicemail channels and 10 for transcoding offers 50 voicemail channels and 300 for conference offers 10 voicemail, 10 conference, 10 transcoding and 32 PSTN when calling load_balance(“1”,“transc;pstn”) -\u003e\nonly boxes (1) and (4) will be selected at as they offer both transcoding and pstn evaluating the load : (1) transcoding - 10 channels used; PSTN - 18 used (4) transcoding - 9 channels used; PSTN - 16 used evaluating available load (capacity-load) : - (1) transcoding - 20 channels used; PSTN - 14 used - (4) transcoding - 1 channels used; PSTN - 16 used for each box, the minimum available load (through all resources) (1) 14 (PSTN) (2) 1 (transcoding) final selected box in (1) as it has the the biggest (=14) available load for the most loaded resource.\nThe selection algorithm tries to avoid the intensive usage of a resource per box.\n2.4 Disabling and Pinging The Load Balancer modules provides couple of functionalities to help in dealing with failures of the destinations. The actual detection of a failed destination (based on the SIP traffic) is done in the OpenSIPS routing script by looking at the codes of the replies you receive back from the destinations (see the example at the end of tutorial).Once a destination is detected at failed, in script, you can mark it as disabled via the lb_disable() function - once marked as disabled, the destination will not be used anymore in the LB process (it will not be considered a possible destination when routing calls).For a destination to be set back as enabled, there are two options:\nuse the MI command lb_status to do it manually, from outside OpenSIPS based on probing - the destination must have the SIP probing/pinging enabled - once the destination starts replying with 200 OK replies to the SIP pings (see the probing_reply_codes option. To enable pinging, you need first to set probing_interval to a non zero value - how often the pinging should be done. The pinging will be done by periodically sending a OPTIONS SIP request to the destination - see probing_method option.To control which and when a destination is pinged, there is the probe_mode column in the load_balancer table - see table definition. Possible options are:\n0 no pinging at any time 1 ping only if in disabled state (used for auto re-enabling of destinations) 2 ping all the time - it will disable destination if fails to answer to pings and enable it back when starts answering again. 2.5 RealTime Control over the Load Balancer The Load Balancer module provides several MI functions to allow you to do runtime changes and to get realtime information from it.Pushing changes at runtime:\nlb_reload - force reloading the entire configuration data from DB - see more.. lb_resize - change the capacity of a resource for a destination - see more.. lb_status - change the status of a destination (enable/disable) - see more.. For fetching realtime information :\nlb_list - list the load on all destinations (per resource) - see more.. lb_status - see the status of a destination (enable/disable) - see more.. 3. Study Case: routing the media gateways Here is the full configuration and script for performing LB between media peers.\n3.1 Configuration Let’s consider the following case: a cluster of media servers providing voicemail service and PSTN (in and out) service. So the boxes will be able to receive calls for Voicemail or for PSTN termination, but they will be able to send back calls only for PSTN inbound.\nWe also want the destinations to be disabled from script (when a failure is detected); The re-enabling of the destinations will be done based on pinging - we do pinging only when the destination is in “failed” status.\n4 destinations/boxes in the LB set\noffers 50 channels for voicemail and 32 for PSTN offers 100 voicemail channels offers 50 voicemail channels offers 10 voicemail and 64 PSTN This translated into the following setup:\nid group_id dst_uri resources prob_mode 1 1 sip:yate1.mycluster.net vm=50; pstn=32 1 2 1 sip:yate2.mycluster.net vm=100 1 3 1 sip:yate3.mycluster.net vm=50 1 4 1 sip:yate4.mycluster.net vm=10;pstn=64 1 3.2 OpenSIPS Scripting debug=1 memlog=1 fork=yes children=2 log_stderror=no log_facility=LOG_LOCAL0 disable_tcp=yes disable_dns_blacklist = yes auto_aliases=no check_via=no dns=off rev_dns=off listen=udp:xxx.xxx.xxx.xxx:5060 # REPLACE here with right values loadmodule \"modules/maxfwd/maxfwd.so\" loadmodule \"modules/sl/sl.so\" loadmodule \"modules/db_mysql/db_mysql.so\" loadmodule \"modules/tm/tm.so\" loadmodule \"modules/uri/uri.so\" loadmodule \"modules/rr/rr.so\" loadmodule \"modules/dialog/dialog.so\" loadmodule \"modules/mi_fifo/mi_fifo.so\" loadmodule \"modules/mi_xmlrpc/mi_xmlrpc.so\" loadmodule \"modules/signaling/signaling.so\" loadmodule \"modules/textops/textops.so\" loadmodule \"modules/sipmsgops/sipmsgops.so\" loadmodule \"modules/load_balancer/load_balancer.so\" modparam(\"mi_fifo\", \"fifo_name\", \"/tmp/opensips_fifo\") modparam(\"dialog\", \"db_mode\", 1) modparam(\"dialog\", \"db_url\", \"mysql://opensips:opensipsrw@localhost/opensips\") modparam(\"rr\",\"enable_double_rr\",1) modparam(\"rr\",\"append_fromtag\",1) modparam(\"load_balancer\", \"db_url\",\"mysql://opensips:opensipsrw@localhost/opensips\") # ping every 30 secs the failed destinations modparam(\"load_balancer\", \"probing_interval\", 30) modparam(\"load_balancer\", \"probing_from\", \"sip:pinger@LB_IP:LB_PORT\") # consider positive ping reply the 404 modparam(\"load_balancer\", \"probing_reply_codes\", \"404\") route{ if (!mf_process_maxfwd_header(\"3\")) { send_reply(\"483\",\"looping\"); exit; } if ( has_totag() ) { # sequential request -\u003e obey Route indication loose_route(); t_relay(); exit; } # handle cancel and re-transmissions if ( is_method(\"CANCEL\") ) { if ( t_check_trans() ) t_relay(); exit; } # from now on we have only the initial requests if (!is_method(\"INVITE\")) { send_reply(\"405\",\"Method Not Allowed\"); exit; } # initial request record_route(); # not really necessary to create the dialog from script (as the # LB functions will do this for us automatically), but we do it # if we want to pass some flags to dialog (pinging, bye, etc) create_dialog(\"B\"); # check the direction of call if ( lb_is_destination(\"$si\",\"$sp\",\"1\") ) { # call comes from our cluster, so it is an PSNT inbound call # mark it as load on the corresponding destination lb_count_call(\"$si\",\"$sp\",\"1\", \"pstn\"); # and route is to our main sip server to send call to end user $du = \"sip:PROXY_IP:PORXY_PORT\"; # REPLACE here with right values t_relay(); exit; } # detect resources and store in an AVP if ( $rU=~\"^VM_\" ) { # looks like a VoiceMail call $avp(lb_res) = \"vm\"; } else if ( $rU=~\"^[0-9]+$\" ) { # PSTN call $avp(lb_res) = \"pstn\"; } else { send_reply(\"404\",\"Destination not found\"); exit; } # LB function returns negative if no suitable destination (for requested resources) is found, # or if all destinations are full if ( !load_balance(\"1\",\"$avp(lb_res)\") ) { send_reply(\"500\",\"Service full\"); exit; } xlog(\"Selected destination is: $du\\n\"); # arm a failure route for be able to catch a failure event and to do # failover to the next available destination t_on_failure(\"LB_failed\"); # send it out if (!t_relay()) { sl_reply_error(); } } failure_route[LB_failed] { # skip if call was canceled if (t_was_cancelled()) { exit; } # was a destination failure ? (we do not want to do failover # if it was a call setup failure, so we look for 500 and 600 # class replied and for local timeouts) if ( t_check_status(\"[56][0-9][0-9]\") || (t_check_status(\"408\") \u0026\u0026 t_local_replied(\"all\") ) ) { # this is a case for failover xlog(\"REPORT: LB destination $du failed with code $T_reply_code\\n\"); # mark failed destination as disabled lb_disable(); # try to re-route to next available destination if ( !load_balance(\"1\",\"$avp(lb_res)\") ) { send_reply(\"500\",\"Service full\"); exit; } xlog(\"REPORT: re-routing call to $du \\n\"); t_relay(); } } ","wordCount":"1993","inLanguage":"en","datePublished":"2021-03-09T17:52:04+08:00","dateModified":"2021-03-09T17:52:04+08:00","author":{"@type":"Person","name":"王端端"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wdd.js.org/opensips/blog/load-balance/"},"publisher":{"@type":"Organization","name":"洞香春","logo":{"@type":"ImageObject","url":"https://wdd.js.org/cowboy.ico"}}}</script></head><body class=dark id=top><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org accesskey=h title="洞香春 (Alt + H)"><img src=/cowboy.ico alt=logo aria-label=logo height=35>洞香春</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/fe/ title=Frontend><span>Frontend</span></a></li><li><a href=https://wdd.js.org/golang/ title=Golang><span>Golang</span></a></li><li><a href=https://wdd.js.org/container/ title=k8s/docker><span>k8s/docker</span></a></li><li><a href=https://wdd.js.org/network/ title=Network><span>Network</span></a></li><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/shell/ title=Shell><span>Shell</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/categories/ title=分类><span>分类</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wdd.js.org>Home</a>&nbsp;»&nbsp;<a href=https://wdd.js.org/opensips/>OpenSIPS2.4.X 中文实战系列</a></div><h1 class=post-title>Load Balancing in OpenSIPS</h1><div class=post-meta><span title='2021-03-09 17:52:04 +0800 CST'>2021-03-09 17:52:04</span>&nbsp;·&nbsp;10 min&nbsp;·&nbsp;王端端&nbsp;&nbsp;| 本文总阅读量<span id=busuanzi_value_page_pv></span>次</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#1-load-balancing-in-opensips aria-label="1. Load Balancing in OpenSIPS">1.  Load Balancing in <strong>OpenSIPS</strong></a></li><li><a href=#2-load-balancing---how-it-works aria-label="2.  Load Balancing - how it works">2.  Load Balancing - how it works</a><ul><li><a href=#21-destination-set aria-label="2.1  Destination set">2.1  Destination set</a></li><li><a href=#22-invoking-load-balancing aria-label="2.2  Invoking Load-balancing">2.2  Invoking Load-balancing</a></li><li><a href=#23-the-lb-logic aria-label="2.3  The LB logic">2.3  The LB logic</a></li><li><a href=#24-disabling-and-pinging aria-label="2.4  Disabling and Pinging">2.4  Disabling and Pinging</a></li><li><a href=#25-realtime-control-over-the-load-balancer aria-label="2.5  RealTime Control over the Load Balancer">2.5  RealTime Control over the Load Balancer</a></li></ul></li><li><a href=#3-study-case-routing-the-media-gateways aria-label="3.  Study Case: routing the media gateways">3.  Study Case: routing the media gateways</a><ul><li><a href=#31-configuration aria-label="3.1  Configuration">3.1  Configuration</a></li><li><a href=#32-opensips-scripting aria-label="3.2  OpenSIPS Scripting">3.2  OpenSIPS Scripting</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p><a href=https://opensips.org/Documentation/Tutorials-LoadBalancing-1-9>https://opensips.org/Documentation/Tutorials-LoadBalancing-1-9</a></p><h3 id=1-load-balancing-in-opensips>1.  Load Balancing in <strong>OpenSIPS</strong><a hidden class=anchor aria-hidden=true href=#1-load-balancing-in-opensips>#</a></h3><p>The &ldquo;load-balancing&rdquo; module comes to provide traffic routing based on load. Shortly, when <strong>OpenSIPS</strong> routes calls to a set of destinations, it is able to keep the load status (as number of ongoing calls) of each destination and to choose to route to the less loaded destination (at that moment). <strong>OpenSIPS</strong> is aware of the capacity of each destination - it is pre-configured with the maximum load accepted by the destinations. To be more precise, when routing, <strong>OpenSIPS</strong> will consider the less loaded destination not the destination with the smallest number of ongoing calls, but the destination with the largest available slot.</p><p>Also, the &ldquo;load-balancing&rdquo; (LB) module is able to receive feedback from the destinations (if they are capable of). This mechanism is used for notifying <strong>OpenSIPS</strong> when the maximum capacity of a destination changed (like a GW with more or less E1 cards).</p><p>The &ldquo;load-balancing&rdquo; functionality comes to enhance the &ldquo;dispatcher&rdquo; one. The difference comes in having or not load information about the destinations where you are routing to:</p><ul><li><strong>Dispatcher has no load information</strong> - it just blindly forwards calls to the destinations based on a probabilistic dispersion logic. It gets no feedback about the load of the destination (like how many calls that were sent actually were established or how many are still going).</li><li><strong>Load-balancer is load driven</strong> - LB routing logic is based primary on the load information. The LB module is using the DIALOG module in order to keep trace of the load (ongoing calls).</li></ul><hr><h3 id=2-load-balancing---how-it-works>2.  Load Balancing - how it works<a hidden class=anchor aria-hidden=true href=#2-load-balancing---how-it-works>#</a></h3><p>When looking at the LB implementation in <strong>OpenSIPS</strong>, we have 3 aspects:</p><h4 id=21-destination-set>2.1  Destination set<a hidden class=anchor aria-hidden=true href=#21-destination-set>#</a></h4><p>A destination is defined by its address (a SIP URI) and its description as capacity.</p><p>Form the LB module perspective, the <strong>destinations are not homogeneous</strong> - they are not alike; and not only from capacity point of view, but also from what kind of <strong>services/resources</strong> they offer. For example, you may have a set of Yate/Asterisk boxes for media-related services -some of them are doing transcoding, other voicemail or conference, other simple announcement , other PSTN termination. But you may have mixed boxes - one box may do PSTN and voicemail in the same time. So each destination from the set may offer a different set of services/resources.</p><p>So, for each destination, the LB module defines the offered resources, and for each resource, it defines the <strong>capacity / maximum load</strong> as number of concurrent calls the destination can handle for that resource.</p><p>Example:
4 destinations/boxes in the LB set</p><ul><li><ol><li>offers 30 channels for transcoding and 32 for PSTN</li></ol></li><li><ol start=2><li>offers 100 voicemail channels and 10 for transcoding</li></ol></li><li><ol start=3><li>offers 50 voicemail channels and 300 for conference</li></ol></li><li><ol start=4><li>offers 10 voicemail, 10 conference, 10 transcoding and 32 PSTN</li></ol></li></ul><table><thead><tr><th>id</th><th>group_id</th><th>dst_uri</th><th>resources</th></tr></thead><tbody><tr><td> 1</td><td>1</td><td>sip:yate1.mycluster.net</td><td>transc=30; pstn=32</td></tr><tr><td> 2</td><td>1</td><td>sip:yate2.mycluster.net</td><td>vm=100; transc=10  </td></tr><tr><td> 3</td><td> 1</td><td>sip:yate3.mycluster.net</td><td>vm=50; conf=300</td></tr><tr><td> 4</td><td> 1</td><td>sip:yate4.mycluster.net</td><td>vm=10;conf=10;transc=10;pstn=32</td></tr></tbody></table><p>For runtime, the LB module provides MI commands for:</p><ul><li>reloading the definition of destination sets</li><li>changing the capacity for a resource for a destination</li></ul><h4 id=22-invoking-load-balancing>2.2  Invoking Load-balancing<a hidden class=anchor aria-hidden=true href=#22-invoking-load-balancing>#</a></h4><p>Using the LB functionality is very simple - you just have to pass to the LB module what kind of resources the call requires.</p><p>The resource detection is done in the <strong>OpenSIPS</strong> routing script, based on whatever information is appropriated. For example, looking at the RURI (dialed number) you can see if the call must go to PSTN or if it a voicemail or conference number; also, by looking at the codecs advertised in the SDP, you can figure out if transcoding is or not also required.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>!load_balance<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;1&#34;</span>,<span style=color:#e6db74>&#34;transc;pstn&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    sl_send_reply<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;500&#34;</span>,<span style=color:#e6db74>&#34;Service full&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>    exit;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>The first parameter of the function identifies the LB set to be used (see the group_id column in the above DB snapshot). Second parameter is list of the required resource for the call. A third optional parameter my be passed to instruct the LB engine on how to estimate the load - in absolute value (how many channels are used) or in relative value (how many percentages are used).</p><p>The <strong>load_balance()</strong> will automatically create the dialog state for the call (in order to monitor it) and will also allocate the requested resources for it (from the selected box).</p><p>The function will set as destination URI ($du) the address of the selected destination/box.</p><p>The resources will be automatically released when the call terminates.The LB module provides an MI function that allows the admin to inspect the current load over the destinations.</p><h4 id=23-the-lb-logic>2.3  The LB logic<a hidden class=anchor aria-hidden=true href=#23-the-lb-logic>#</a></h4><p>The logic used by the LB module to select the destination is:</p><ol><li>gets the <strong>destination set based on the group_id</strong> (first parameter of the <em>load_balance()</em> function)</li><li>selects from the set only the <strong>destinations that are able to provide the requested resources</strong> (second parameter of the <em>load_balance()</em> function)</li><li>for the selected destinations, it <strong>evaluated the current load</strong> for each requested resource</li><li>the winning destination is the one with <strong>the biggest value for the minimum available load</strong> per resources.</li></ol><p>Example:</p><p>4 destinations/boxes in the LB set</p><ul><li><ol><li>offers 30 channels for transcoding and 32 for PSTN</li></ol></li><li><ol start=2><li>offers 100 voicemail channels and 10 for transcoding</li></ol></li><li><ol start=3><li>offers 50 voicemail channels and 300 for conference</li></ol></li><li><ol start=4><li>offers 10 voicemail, 10 conference, 10 transcoding and 32 PSTN</li></ol></li></ul><p>when calling load_balance(&ldquo;1&rdquo;,&ldquo;transc;pstn&rdquo;) -></p><ul><li><ol><li>only boxes (1) and (4) will be selected at as they offer both transcoding and pstn</li></ol></li><li><ol start=2><li>evaluating the load  :</li></ol><ul><li>(1) transcoding - 10 channels used; PSTN - 18 used</li><li>(4) transcoding - 9 channels used; PSTN - 16 used </li></ul></li></ul><p>   evaluating available load (capacity-load) :
- (1) transcoding - 20 channels used; PSTN - 14 used 
- (4) transcoding - 1 channels used; PSTN - 16 used </p><ol start=3><li><p>for each box, the minimum available load (through all resources)
(1) 14 (PSTN)
(2) 1 (transcoding) </p></li><li><p>final selected box in (1) as it has the the biggest (=14) available load for the most loaded resource.</p></li></ol><p>The selection algorithm tries to avoid the intensive usage of a resource per box.</p><h4 id=24-disabling-and-pinging>2.4  Disabling and Pinging<a hidden class=anchor aria-hidden=true href=#24-disabling-and-pinging>#</a></h4><p>The Load Balancer modules provides couple of functionalities to help in dealing with failures of the destinations. The actual detection of a failed destination (based on the SIP traffic) is done in the OpenSIPS routing script by looking at the codes of the replies you receive back from the destinations (see the example at the end of tutorial).Once a destination is detected at failed, in script, you can mark it as disabled via the <strong>lb_disable()</strong> function - once marked as disabled, the destination will not be used anymore in the LB process (it will not be considered a possible destination when routing calls).For a destination to be set back as enabled, there are two options:</p><ul><li>use the MI command <a href=http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id248919>lb_status</a> to do it manually, from outside OpenSIPS</li><li>based on probing - the destination must have the SIP probing/pinging enabled - once the destination starts replying with 200 OK replies to the SIP pings (see the <a href=http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id250116>probing_reply_codes</a> option.</li></ul><p>To enable pinging, you need first to set <a href=http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id249996>probing_interval</a> to a non zero value - how often the pinging should be done. The pinging will be done by periodically sending a <strong>OPTIONS</strong> SIP request to the destination - see <a href=http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id250037>probing_method</a> option.To control which and when a destination is pinged, there is the <strong>probe_mode</strong> column in the <strong>load_balancer</strong> table - see <a href=http://www.opensips.org/html/docs/db/db-schema-1.9.x.html#AEN3971>table definition</a>. Possible options are:</p><ul><li><strong>0</strong> no pinging at any time</li><li><strong>1</strong> ping only if in disabled state (used for auto re-enabling of destinations)</li><li><strong>2</strong> ping all the time - it will disable destination if fails to answer to pings and enable it back when starts answering again.</li></ul><h4 id=25-realtime-control-over-the-load-balancer>2.5  RealTime Control over the Load Balancer<a hidden class=anchor aria-hidden=true href=#25-realtime-control-over-the-load-balancer>#</a></h4><p>The Load Balancer module provides several MI functions to allow you to do runtime changes and to get realtime information from it.Pushing changes at runtime:</p><ul><li><strong>lb_reload</strong> - force reloading the entire configuration data from DB - see <a href=http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id292737>more..</a></li><li><strong>lb_resize</strong> - change the capacity of a resource for a destination - see <a href=http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id292759>more..</a></li><li><strong>lb_status</strong> - change the status of a destination (enable/disable) - see <a href=http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id248919>more..</a></li></ul><p>For fetching realtime information :</p><ul><li><strong>lb_list</strong> - list the load on all destinations (per resource) - see <a href=http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id292782>more..</a></li><li><strong>lb_status</strong> - see the status of a destination (enable/disable) - see <a href=http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id248919>more..</a></li></ul><hr><p></p><h3 id=3-study-case-routing-the-media-gateways>3.  Study Case: routing the media gateways<a hidden class=anchor aria-hidden=true href=#3-study-case-routing-the-media-gateways>#</a></h3><p>Here is the full configuration and script for performing LB between media peers.</p><p></p><h4 id=31-configuration>3.1  Configuration<a hidden class=anchor aria-hidden=true href=#31-configuration>#</a></h4><p>Let&rsquo;s consider the following case: a cluster of media servers providing voicemail service and PSTN (in and out) service. So the boxes will be able to receive calls for Voicemail or for PSTN termination, but they will be able to send back calls only for PSTN inbound.</p><p>We also want the destinations to be disabled from script (when a failure is detected); The re-enabling of the destinations will be done based on pinging - we do pinging only when the destination is in &ldquo;failed&rdquo; status.</p><p>4 destinations/boxes in the LB set</p><ul><li><ol><li>offers 50 channels for voicemail and 32 for PSTN</li></ol></li><li><ol start=2><li>offers 100 voicemail channels</li></ol></li><li><ol start=3><li>offers 50 voicemail channels</li></ol></li><li><ol start=4><li>offers 10 voicemail and 64 PSTN</li></ol></li></ul><p>This translated into the following setup:</p><table><thead><tr><th>id</th><th>group_id</th><th>dst_uri</th><th>resources        </th><th>prob_mode</th></tr></thead><tbody><tr><td> 1</td><td>1</td><td>sip:yate1.mycluster.net</td><td>vm=50; pstn=32    </td><td>        1</td></tr><tr><td> 2</td><td>1</td><td>sip:yate2.mycluster.net</td><td>vm=100            </td><td>        1</td></tr><tr><td> 3</td><td> 1</td><td>sip:yate3.mycluster.net</td><td>vm=50            </td><td>        1</td></tr><tr><td> 4</td><td> 1</td><td>sip:yate4.mycluster.net</td><td>vm=10;pstn=64    </td><td>        1</td></tr></tbody></table><h4 id=32-opensips-scripting>3.2  OpenSIPS Scripting<a hidden class=anchor aria-hidden=true href=#32-opensips-scripting>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debug<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>memlog<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>fork<span style=color:#f92672>=</span>yes
</span></span><span style=display:flex><span>children<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>log_stderror<span style=color:#f92672>=</span>no
</span></span><span style=display:flex><span>log_facility<span style=color:#f92672>=</span>LOG_LOCAL0
</span></span><span style=display:flex><span>disable_tcp<span style=color:#f92672>=</span>yes
</span></span><span style=display:flex><span>disable_dns_blacklist <span style=color:#f92672>=</span> yes
</span></span><span style=display:flex><span>auto_aliases<span style=color:#f92672>=</span>no
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>check_via<span style=color:#f92672>=</span>no
</span></span><span style=display:flex><span>dns<span style=color:#f92672>=</span>off
</span></span><span style=display:flex><span>rev_dns<span style=color:#f92672>=</span>off
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>listen<span style=color:#f92672>=</span>udp:xxx.xxx.xxx.xxx:5060 <span style=color:#75715e># REPLACE here with right values </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>loadmodule <span style=color:#e6db74>&#34;modules/maxfwd/maxfwd.so&#34;</span>
</span></span><span style=display:flex><span>loadmodule <span style=color:#e6db74>&#34;modules/sl/sl.so&#34;</span>
</span></span><span style=display:flex><span>loadmodule <span style=color:#e6db74>&#34;modules/db_mysql/db_mysql.so&#34;</span>
</span></span><span style=display:flex><span>loadmodule <span style=color:#e6db74>&#34;modules/tm/tm.so&#34;</span>
</span></span><span style=display:flex><span>loadmodule <span style=color:#e6db74>&#34;modules/uri/uri.so&#34;</span>
</span></span><span style=display:flex><span>loadmodule <span style=color:#e6db74>&#34;modules/rr/rr.so&#34;</span>
</span></span><span style=display:flex><span>loadmodule <span style=color:#e6db74>&#34;modules/dialog/dialog.so&#34;</span>
</span></span><span style=display:flex><span>loadmodule <span style=color:#e6db74>&#34;modules/mi_fifo/mi_fifo.so&#34;</span>
</span></span><span style=display:flex><span>loadmodule <span style=color:#e6db74>&#34;modules/mi_xmlrpc/mi_xmlrpc.so&#34;</span>
</span></span><span style=display:flex><span>loadmodule <span style=color:#e6db74>&#34;modules/signaling/signaling.so&#34;</span>
</span></span><span style=display:flex><span>loadmodule <span style=color:#e6db74>&#34;modules/textops/textops.so&#34;</span>
</span></span><span style=display:flex><span>loadmodule <span style=color:#e6db74>&#34;modules/sipmsgops/sipmsgops.so&#34;</span>
</span></span><span style=display:flex><span>loadmodule <span style=color:#e6db74>&#34;modules/load_balancer/load_balancer.so&#34;</span>
</span></span><span style=display:flex><span>modparam<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;mi_fifo&#34;</span>, <span style=color:#e6db74>&#34;fifo_name&#34;</span>, <span style=color:#e6db74>&#34;/tmp/opensips_fifo&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>modparam<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;dialog&#34;</span>, <span style=color:#e6db74>&#34;db_mode&#34;</span>, 1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>modparam<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;dialog&#34;</span>, <span style=color:#e6db74>&#34;db_url&#34;</span>, <span style=color:#e6db74>&#34;mysql://opensips:opensipsrw@localhost/opensips&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>modparam<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;rr&#34;</span>,<span style=color:#e6db74>&#34;enable_double_rr&#34;</span>,1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>modparam<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;rr&#34;</span>,<span style=color:#e6db74>&#34;append_fromtag&#34;</span>,1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>modparam<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;load_balancer&#34;</span>, <span style=color:#e6db74>&#34;db_url&#34;</span>,<span style=color:#e6db74>&#34;mysql://opensips:opensipsrw@localhost/opensips&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ping every 30 secs the failed destinations</span>
</span></span><span style=display:flex><span>modparam<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;load_balancer&#34;</span>, <span style=color:#e6db74>&#34;probing_interval&#34;</span>, 30<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>modparam<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;load_balancer&#34;</span>, <span style=color:#e6db74>&#34;probing_from&#34;</span>, <span style=color:#e6db74>&#34;sip:pinger@LB_IP:LB_PORT&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># consider positive ping reply the 404 </span>
</span></span><span style=display:flex><span>modparam<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;load_balancer&#34;</span>, <span style=color:#e6db74>&#34;probing_reply_codes&#34;</span>, <span style=color:#e6db74>&#34;404&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>route<span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>!mf_process_maxfwd_header<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;3&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		send_reply<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;483&#34;</span>,<span style=color:#e6db74>&#34;looping&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>		exit;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span> has_totag<span style=color:#f92672>()</span> <span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># sequential request -&gt; obey Route indication</span>
</span></span><span style=display:flex><span>		loose_route<span style=color:#f92672>()</span>;
</span></span><span style=display:flex><span>                t_relay<span style=color:#f92672>()</span>;
</span></span><span style=display:flex><span>                exit;
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># handle cancel and re-transmissions</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span> is_method<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;CANCEL&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span> t_check_trans<span style=color:#f92672>()</span> <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>			t_relay<span style=color:#f92672>()</span>;
</span></span><span style=display:flex><span>		exit;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># from now on we have only the initial requests</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>!is_method<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;INVITE&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                send_reply<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;405&#34;</span>,<span style=color:#e6db74>&#34;Method Not Allowed&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>                exit;
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># initial request</span>
</span></span><span style=display:flex><span>	record_route<span style=color:#f92672>()</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># not really necessary to create the dialog from script (as the</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># LB functions will do this for us automatically), but we do it</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># if we want to pass some flags to dialog (pinging, bye, etc)</span>
</span></span><span style=display:flex><span>        create_dialog<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;B&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># check the direction of call</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span> lb_is_destination<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;</span>$si<span style=color:#e6db74>&#34;</span>,<span style=color:#e6db74>&#34;</span>$sp<span style=color:#e6db74>&#34;</span>,<span style=color:#e6db74>&#34;1&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e># call comes from our cluster, so it is an PSNT inbound call</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e># mark it as load on the corresponding destination</span>
</span></span><span style=display:flex><span>                lb_count_call<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;</span>$si<span style=color:#e6db74>&#34;</span>,<span style=color:#e6db74>&#34;</span>$sp<span style=color:#e6db74>&#34;</span>,<span style=color:#e6db74>&#34;1&#34;</span>, <span style=color:#e6db74>&#34;pstn&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>                <span style=color:#75715e># and route is to our main sip server to send call to end user</span>
</span></span><span style=display:flex><span>                $du <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sip:PROXY_IP:PORXY_PORT&#34;</span>; <span style=color:#75715e># REPLACE here with right values </span>
</span></span><span style=display:flex><span>                t_relay<span style=color:#f92672>()</span>;
</span></span><span style=display:flex><span>                exit;
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># detect resources and store in an AVP</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span> $rU<span style=color:#f92672>=</span>~<span style=color:#e6db74>&#34;^VM_&#34;</span> <span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e># looks like a VoiceMail call</span>
</span></span><span style=display:flex><span>                $avp<span style=color:#f92672>(</span>lb_res<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;vm&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span> $rU<span style=color:#f92672>=</span>~<span style=color:#e6db74>&#34;^[0-9]+</span>$<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e># PSTN call</span>
</span></span><span style=display:flex><span>                $avp<span style=color:#f92672>(</span>lb_res<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pstn&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                send_reply<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;404&#34;</span>,<span style=color:#e6db74>&#34;Destination not found&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>                exit;
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># LB function returns negative if no suitable destination (for requested resources) is found,</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># or if all destinations are full</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span> !load_balance<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;1&#34;</span>,<span style=color:#e6db74>&#34;</span>$avp<span style=color:#e6db74>(lb_res)&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>             send_reply<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;500&#34;</span>,<span style=color:#e6db74>&#34;Service full&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>             exit;
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	xlog<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Selected destination is: </span>$du<span style=color:#e6db74>\n&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># arm a failure route for be able to catch a failure event and to do </span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># failover to the next available destination</span>
</span></span><span style=display:flex><span>        t_on_failure<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;LB_failed&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># send it out</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>!t_relay<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		sl_reply_error<span style=color:#f92672>()</span>;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>failure_route<span style=color:#f92672>[</span>LB_failed<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># skip if call was canceled </span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>t_was_cancelled<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		exit;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># was a destination failure ? (we do not want to do failover</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># if it was a call setup failure, so we look for 500 and 600</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># class replied and for local timeouts)</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span> t_check_status<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;[56][0-9][0-9]&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>(</span>t_check_status<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;408&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> t_local_replied<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;all&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>)</span> <span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e># this is a case for failover</span>
</span></span><span style=display:flex><span>                xlog<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;REPORT: LB destination </span>$du<span style=color:#e6db74> failed with code </span>$T_reply_code<span style=color:#e6db74>\n&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>                <span style=color:#75715e># mark failed destination as disabled </span>
</span></span><span style=display:flex><span>                lb_disable<span style=color:#f92672>()</span>;
</span></span><span style=display:flex><span>                <span style=color:#75715e># try to re-route to next available destination</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span> !load_balance<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;1&#34;</span>,<span style=color:#e6db74>&#34;</span>$avp<span style=color:#e6db74>(lb_res)&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                      send_reply<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;500&#34;</span>,<span style=color:#e6db74>&#34;Service full&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>                      exit;
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                xlog<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;REPORT: re-routing call to </span>$du<span style=color:#e6db74> \n&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>                t_relay<span style=color:#f92672>()</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://wdd.js.org>洞香春</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span>
<span id=busuanzi_container_site_pv>本站访问量：<span id=busuanzi_value_site_pv></span>次</span>
&nbsp;
<span id=busuanzi_container_site_uv>您是本站第 <span id=busuanzi_value_site_uv></span> 位访问者</span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>