<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>核心变量解读-100% | 洞香春</title><meta name=keywords content><meta name=description content="简介 OpenSIPS的路由脚本提供了几种不同类型的变量。不同类型的变量有以下几个方面的差异。
变量的可见性 变量引用的值 变量的读写性质：有些变量是只读的，有些变量可读可写 变量是否有多个值：有些变量只有一个值，有些变量有多个值 语法 $(<context>name(subname)[index]{tramsformation}) 除了name以外 ，其他都是可选的值。
name(必传)：变量名的类型，例如pvar, avp, ru, DLG_status等等 subname: 变量名称，例如hdr(From), avp(name) index: 索引，某些变量可以有多个值，类似于数组。可以用索引去引用对应的元素。从0开始，也可以是负值如-1, 表示倒数第一个。 transformation: 转换。做一些格式转换，字符串截取等等操作 context: 上下文。OpenSIP有两个上下午，请求request、相应reply。想想一个场景，你在一个相应路由里如何拿到请求路由的某个值呢？ 可以使用$(ru). 或者在一个失败路由里获取一个Concact的信息$(hdr(Contact)) 举例：
仅仅通过类型来引用：$ru 通过类型和名称来引用：$hrd(Contact), 引用某个SIP header的值 通过类型和索引来引用：$(ct[0]) 通过类型、名称、索引来引用：$(avp(addr)[0]) 变量的类型 脚本变量 脚本变量只有一个值 脚本变量可读可写 脚本变量在路由及其子路由中都是可见的 脚本变量使用前务必先初始化，否则可能会引用到之前的值 脚本变量的值可以是字符串，也可以是整数类型 脚本变量读写比avp变量快 脚本变量会持久存在一个OpenSIPS进程中 将脚本变量设置为NULL, 实际上是将变量的值设置为'0&rsquo;, 脚本变量没有NULL值。 脚本变量之存在与一个路由中 使用举例
route{ $var(a) = 19 $var(a) = &#34;wdd&#34; $var(a) = &#34;wdd&#34; + &#34;@&#34; + $td; if(route(check_out, 1)){ xlog(&#34;check error&#34;); } } route[check_out]{ # 注意，这里$var(a)的值就不存在了 xlog(&#34;$var(a)&#34;); if ($param(1) > 1) { return (-1); } return(1); } avp变量 avp变量一般会关联到一个sip消息或者SIP事务上."><meta name=author content="Eddie Wang"><link rel=canonical href=https://wdd.js.org/opensips/ch5/core-var-2/><link crossorigin=anonymous href=/assets/css/stylesheet.6d3944e058d85363bbe8a792a9b5f40002bca80be859dc19c466dd8de223973e.css integrity="sha256-bTlE4FjYU2O76KeSqbX0AAK8qAvoWdwZxGbdjeIjlz4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/cowboy.ico><link rel=apple-touch-icon href=https://wdd.js.org/cowboy.ico><link rel=mask-icon href=https://wdd.js.org/cowboy.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="核心变量解读-100%"><meta property="og:description" content="简介 OpenSIPS的路由脚本提供了几种不同类型的变量。不同类型的变量有以下几个方面的差异。
变量的可见性 变量引用的值 变量的读写性质：有些变量是只读的，有些变量可读可写 变量是否有多个值：有些变量只有一个值，有些变量有多个值 语法 $(<context>name(subname)[index]{tramsformation}) 除了name以外 ，其他都是可选的值。
name(必传)：变量名的类型，例如pvar, avp, ru, DLG_status等等 subname: 变量名称，例如hdr(From), avp(name) index: 索引，某些变量可以有多个值，类似于数组。可以用索引去引用对应的元素。从0开始，也可以是负值如-1, 表示倒数第一个。 transformation: 转换。做一些格式转换，字符串截取等等操作 context: 上下文。OpenSIP有两个上下午，请求request、相应reply。想想一个场景，你在一个相应路由里如何拿到请求路由的某个值呢？ 可以使用$(ru). 或者在一个失败路由里获取一个Concact的信息$(hdr(Contact)) 举例：
仅仅通过类型来引用：$ru 通过类型和名称来引用：$hrd(Contact), 引用某个SIP header的值 通过类型和索引来引用：$(ct[0]) 通过类型、名称、索引来引用：$(avp(addr)[0]) 变量的类型 脚本变量 脚本变量只有一个值 脚本变量可读可写 脚本变量在路由及其子路由中都是可见的 脚本变量使用前务必先初始化，否则可能会引用到之前的值 脚本变量的值可以是字符串，也可以是整数类型 脚本变量读写比avp变量快 脚本变量会持久存在一个OpenSIPS进程中 将脚本变量设置为NULL, 实际上是将变量的值设置为'0&rsquo;, 脚本变量没有NULL值。 脚本变量之存在与一个路由中 使用举例
route{ $var(a) = 19 $var(a) = &#34;wdd&#34; $var(a) = &#34;wdd&#34; + &#34;@&#34; + $td; if(route(check_out, 1)){ xlog(&#34;check error&#34;); } } route[check_out]{ # 注意，这里$var(a)的值就不存在了 xlog(&#34;$var(a)&#34;); if ($param(1) > 1) { return (-1); } return(1); } avp变量 avp变量一般会关联到一个sip消息或者SIP事务上."><meta property="og:type" content="article"><meta property="og:url" content="https://wdd.js.org/opensips/ch5/core-var-2/"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="opensips"><meta property="article:published_time" content="2021-09-09T09:04:21+08:00"><meta property="article:modified_time" content="2021-09-09T09:04:21+08:00"><meta property="og:site_name" content="洞香春"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="核心变量解读-100%"><meta name=twitter:description content="简介 OpenSIPS的路由脚本提供了几种不同类型的变量。不同类型的变量有以下几个方面的差异。
变量的可见性 变量引用的值 变量的读写性质：有些变量是只读的，有些变量可读可写 变量是否有多个值：有些变量只有一个值，有些变量有多个值 语法 $(<context>name(subname)[index]{tramsformation}) 除了name以外 ，其他都是可选的值。
name(必传)：变量名的类型，例如pvar, avp, ru, DLG_status等等 subname: 变量名称，例如hdr(From), avp(name) index: 索引，某些变量可以有多个值，类似于数组。可以用索引去引用对应的元素。从0开始，也可以是负值如-1, 表示倒数第一个。 transformation: 转换。做一些格式转换，字符串截取等等操作 context: 上下文。OpenSIP有两个上下午，请求request、相应reply。想想一个场景，你在一个相应路由里如何拿到请求路由的某个值呢？ 可以使用$(ru). 或者在一个失败路由里获取一个Concact的信息$(hdr(Contact)) 举例：
仅仅通过类型来引用：$ru 通过类型和名称来引用：$hrd(Contact), 引用某个SIP header的值 通过类型和索引来引用：$(ct[0]) 通过类型、名称、索引来引用：$(avp(addr)[0]) 变量的类型 脚本变量 脚本变量只有一个值 脚本变量可读可写 脚本变量在路由及其子路由中都是可见的 脚本变量使用前务必先初始化，否则可能会引用到之前的值 脚本变量的值可以是字符串，也可以是整数类型 脚本变量读写比avp变量快 脚本变量会持久存在一个OpenSIPS进程中 将脚本变量设置为NULL, 实际上是将变量的值设置为'0&rsquo;, 脚本变量没有NULL值。 脚本变量之存在与一个路由中 使用举例
route{ $var(a) = 19 $var(a) = &#34;wdd&#34; $var(a) = &#34;wdd&#34; + &#34;@&#34; + $td; if(route(check_out, 1)){ xlog(&#34;check error&#34;); } } route[check_out]{ # 注意，这里$var(a)的值就不存在了 xlog(&#34;$var(a)&#34;); if ($param(1) > 1) { return (-1); } return(1); } avp变量 avp变量一般会关联到一个sip消息或者SIP事务上."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"OpenSIPS2.4.X 中文实战系列","item":"https://wdd.js.org/opensips/"},{"@type":"ListItem","position":3,"name":"核心变量解读-100%","item":"https://wdd.js.org/opensips/ch5/core-var-2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"核心变量解读-100%","name":"核心变量解读-100%","description":"简介 OpenSIPS的路由脚本提供了几种不同类型的变量。不同类型的变量有以下几个方面的差异。\n变量的可见性 变量引用的值 变量的读写性质：有些变量是只读的，有些变量可读可写 变量是否有多个值：有些变量只有一个值，有些变量有多个值 语法 $(\u0026lt;context\u0026gt;name(subname)[index]{tramsformation}) 除了name以外 ，其他都是可选的值。\nname(必传)：变量名的类型，例如pvar, avp, ru, DLG_status等等 subname: 变量名称，例如hdr(From), avp(name) index: 索引，某些变量可以有多个值，类似于数组。可以用索引去引用对应的元素。从0开始，也可以是负值如-1, 表示倒数第一个。 transformation: 转换。做一些格式转换，字符串截取等等操作 context: 上下文。OpenSIP有两个上下午，请求request、相应reply。想想一个场景，你在一个相应路由里如何拿到请求路由的某个值呢？ 可以使用$(ru). 或者在一个失败路由里获取一个Concact的信息$(hdr(Contact)) 举例：\n仅仅通过类型来引用：$ru 通过类型和名称来引用：$hrd(Contact), 引用某个SIP header的值 通过类型和索引来引用：$(ct[0]) 通过类型、名称、索引来引用：$(avp(addr)[0]) 变量的类型 脚本变量 脚本变量只有一个值 脚本变量可读可写 脚本变量在路由及其子路由中都是可见的 脚本变量使用前务必先初始化，否则可能会引用到之前的值 脚本变量的值可以是字符串，也可以是整数类型 脚本变量读写比avp变量快 脚本变量会持久存在一个OpenSIPS进程中 将脚本变量设置为NULL, 实际上是将变量的值设置为'0\u0026rsquo;, 脚本变量没有NULL值。 脚本变量之存在与一个路由中 使用举例\nroute{ $var(a) = 19 $var(a) = \u0026#34;wdd\u0026#34; $var(a) = \u0026#34;wdd\u0026#34; + \u0026#34;@\u0026#34; + $td; if(route(check_out, 1)){ xlog(\u0026#34;check error\u0026#34;); } } route[check_out]{ # 注意，这里$var(a)的值就不存在了 xlog(\u0026#34;$var(a)\u0026#34;); if ($param(1) \u0026gt; 1) { return (-1); } return(1); } avp变量 avp变量一般会关联到一个sip消息或者SIP事务上.","keywords":[],"articleBody":"简介 OpenSIPS的路由脚本提供了几种不同类型的变量。不同类型的变量有以下几个方面的差异。\n变量的可见性 变量引用的值 变量的读写性质：有些变量是只读的，有些变量可读可写 变量是否有多个值：有些变量只有一个值，有些变量有多个值 语法 $(name(subname)[index]{tramsformation}) 除了name以外 ，其他都是可选的值。\nname(必传)：变量名的类型，例如pvar, avp, ru, DLG_status等等 subname: 变量名称，例如hdr(From), avp(name) index: 索引，某些变量可以有多个值，类似于数组。可以用索引去引用对应的元素。从0开始，也可以是负值如-1, 表示倒数第一个。 transformation: 转换。做一些格式转换，字符串截取等等操作 context: 上下文。OpenSIP有两个上下午，请求request、相应reply。想想一个场景，你在一个相应路由里如何拿到请求路由的某个值呢？ 可以使用$(ru). 或者在一个失败路由里获取一个Concact的信息$(hdr(Contact)) 举例：\n仅仅通过类型来引用：$ru 通过类型和名称来引用：$hrd(Contact), 引用某个SIP header的值 通过类型和索引来引用：$(ct[0]) 通过类型、名称、索引来引用：$(avp(addr)[0]) 变量的类型 脚本变量 脚本变量只有一个值 脚本变量可读可写 脚本变量在路由及其子路由中都是可见的 脚本变量使用前务必先初始化，否则可能会引用到之前的值 脚本变量的值可以是字符串，也可以是整数类型 脚本变量读写比avp变量快 脚本变量会持久存在一个OpenSIPS进程中 将脚本变量设置为NULL, 实际上是将变量的值设置为'0’, 脚本变量没有NULL值。 脚本变量之存在与一个路由中 使用举例\nroute{ $var(a) = 19 $var(a) = \"wdd\" $var(a) = \"wdd\" + \"@\" + $td; if(route(check_out, 1)){ xlog(\"check error\"); } } route[check_out]{ # 注意，这里$var(a)的值就不存在了 xlog(\"$var(a)\"); if ($param(1) \u003e 1) { return (-1); } return(1); } avp变量 avp变量一般会关联到一个sip消息或者SIP事务上. avp变量可以有多个值 可以avp变量理解成一个后进先出的栈 所有处理这个消息的子路由都可以获得avp的变量。但是如果想在响应路由中想获取请求路由中的avp变量，则需要设置TM模块的onreply_avp_mode参数：modparam(\"tm\",\"onreply_avp_mode\", 1) $avp(trunk)=\"hello\"; $avp(trunk)=\"duan\"; $avp(trunk)=\"hi\"; # 可以把trunk的值理解成下面的样子 # hi -\u003e duan -\u003e hello xlog(\"$avp(trunk)\"); 这里只能打印出hi xlog(\"$(avp(trunk)[2])\"); 这里能打印hello $avp(trunk)=NULL; 这里能删除最后的一个值，如果只有一个值，那么整个avp会被删除 avp_delete(\"$avp(trunk)/g\"); # 删除avp所有的值，包括这个avp自身。 $(avp(trunk)[1])=\"heihei\"; 重新赋值 $(avp(trunk)[1])=NULL; 删除某一个值 伪变量 伪变量主要是对SIP消息的各个部分进行引用的\n大部分伪变量很好接，都是缩写的单词的首字母。\n伪变量以$开头，加sip消息字段的缩写，例如$ci, 代表sip callID 序号 名称 是否可修改 含义 1 $ai 引用P-Asserted-Identify头的url 2 $adu Authentication Digest URI 3 $ar Authentication realm 4 $au Auth username user 5 $ad Auth username domain 6 $an Auth nonce 7 $auth.resp Auth response 8 $auth.nonce Auth nonce 9 $auth.opaque the opaque 字符串 10 $auth.alg 认证算法 11 $auth.qop qop参数的值 12 $auth.nc nonce count参数 13 $aU 整个username 14 $Au 计费用的账户名，主要是acc会用 15 $argv 获取通过命令行参数设置参数-o。例如在启动opensips时```bash opensips -o maxsiplength=1200 在脚本里就可以通过$argv(maxsiplength)\n```bash xlog(\"maxsiplength: is $argv(maxsiplength)\") | | 16 | $af | | ip协议，可能是INET(ipv4), 或者是INET6(ipv6) | | 17 | $branch | | 用来创建新的分支```bash $branch=“sip:new#domain”;\n| | 18 | $branch() | | - $branch(uri)\n- $branch(duri)\n- $branch(q)\n- $branch(path)\n- $branch(flags)\n- $branch(socket)\n| | 19 | **$ci** | | 引用sip call-id。 (call-id) | | 20 | **$cl** | | 引用sip body部分的长度。(content-length) | | 21 | $cs | | 引用 cseq number | | 22 | $ct | | 引用Contact\n- $ci\n- $(ct[n])\n- $(ct[-n])\n| | 23 | $ct.fields() | | - $ct.fields(name)\n- $ct.fields(uri)\n- $ct.fields(q)\n- $ct.fields(expires)\n- $ct.fields(methods)\n- $ct.fields(received)\n- $ct.fields(params) 所有的参数\n| | 24 | $cT | | - $cT Content-Type\n- $(cT[n])\n- $(cT[-n])\n- $(cT[*])\n| | 25 | **$dd** | | 引用目标url里面的domain部分 | | 26 | $di | | diversion header | | 27 | $dip | | diversion privacy prameter | | 29 | $dir | | diversion reason parameter | | 30 | $dp | | 目标url的端口号部分 (destionation port) | | 31 | $dP | | 目标url的传输协议部分 (destionation protocol) | | 32 | $ds | | destionation set | | 33 | **$du** | | 引用 destionation url | | 34 | $err.class | | 错误的类别\n- 1 解析错误\n| | 35 | $err.level | | 错误的级别 | | 36 | $err.info | | 错误信息的描述 | | 37 | $err.rcode | | error reply code | | 38 | $err.rreason | | error reply reason | | 39 | **$fd** | | From URI domain | | 40 | **$fn** | | From display name | | 41 | **$fs** | | 强制使用某个地址发送消息。 (forced socket)\n格式：proto:ip:port | | 42 | $ft | | From tag | | 43 | **$fu** | | From URL | | 44 | **$fU** | | username in From URL | | 45 | **$log_level** | | 可以用来动态修改日志级别\n$log_level=4;\n$log_level=NULL; 恢复默认值 | | 46 | $mb | | sip message buffer | | 47 | $mf | | message flags | | 48 | $mi | | sip message id | | 49 | **$ml** | | sip message length | | 50 | $od | | domain in original R-URI | | 51 | $op | | port in original R-URI | | 52 | $oP | | transport protocol of original R-URI | | 53 | $ou | | original URI | | 54 | $oU | | username in original URI | | 55 | **$param(idx)** | | 引用路由参数，从1开始\n```bash route{ route(R_NAME, $var(debug), \"pp\"); } route[R_NAME]{ $param(1); #引用第一个参数 $var(debug) $param(2); #引用第二个参数 pp } | | 56 | $pd | | domain in sip P-Prefered-Identify header | | 57 | $pn | | display name in sip P-Prefered-Identify header | | 58 | $pp | | process id | | 59 | $pr $proto | | 接受消息的协议 UDP, TCP, TLS, SCTP, WS | | 60 | $pu | | URL in sip P-Prefered-Identify header | | 61 | $rd | | domain in request url | | 62 | $rb | | body of request/replay- $rb- $(rb[*])- $(rb[n])- $(rb[-n])- $rb(application/sdp)- $rb(application/isup) | | 63 | $rc $retcode | | 上个函数的返回结果 | | 64 | $re | | remote-party-id | | 65 | $rm | | sip method | | 66 | $rp | | port of R-RUI | | 67 | $rP | | transport protocol pf R-URI | | 68 | $rr | | reply reason | | 69 | $rs | | reply status | | 70 | $ru | | request url | | 71 | $rU | | | | 72 | $ru_q | | | | 73 | $Ri | | | | 74 | $Rp | | | | 75 | $sf | | | | 76 | $si | | | | 77 | $sp | | | | 78 | $tt | | | | 79 | $tu | | | | 80 | $tU | | | | 81 | $time(format) | | | | 82 | $T_branch_idx | | | | 83 | $Tf | | | | 84 | $Ts | | | | 85 | $Tsm | | | | 86 | $TS | | | | 87 | $ua | | | | 88 | $(hdr(name)[N]) | | | | 89 | $rT | | | | 90 | $cfg_line $cfg_file | | | | 91 | $xlog_level | | |\n","wordCount":"937","inLanguage":"en","datePublished":"2021-09-09T09:04:21+08:00","dateModified":"2021-09-09T09:04:21+08:00","author":{"@type":"Person","name":"Eddie Wang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wdd.js.org/opensips/ch5/core-var-2/"},"publisher":{"@type":"Organization","name":"洞香春","logo":{"@type":"ImageObject","url":"https://wdd.js.org/cowboy.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org accesskey=h title="洞香春 (Alt + H)"><img src=https://wdd.js.org/cowboy.ico alt aria-label=logo height=35>洞香春</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/fe/ title=Frontend><span>Frontend</span></a></li><li><a href=https://wdd.js.org/golang/ title=Golang><span>Golang</span></a></li><li><a href=https://wdd.js.org/container/ title=k8s/docker><span>k8s/docker</span></a></li><li><a href=https://wdd.js.org/network/ title=Network><span>Network</span></a></li><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/shell/ title=Shell><span>Shell</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/categories/ title=分类><span>分类</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wdd.js.org>Home</a>&nbsp;»&nbsp;<a href=https://wdd.js.org/opensips/>OpenSIPS2.4.X 中文实战系列</a></div><h1 class=post-title>核心变量解读-100%</h1><div class=post-meta><span title='2021-09-09 09:04:21 +0800 CST'>2021-09-09 09:04:21</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Eddie Wang&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/opensips/ch5/core-var-2/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e7%ae%80%e4%bb%8b aria-label=简介>简介</a></li><li><a href=#%e8%af%ad%e6%b3%95 aria-label=语法>语法</a></li><li><a href=#%e5%8f%98%e9%87%8f%e7%9a%84%e7%b1%bb%e5%9e%8b aria-label=变量的类型>变量的类型</a><ul><li><a href=#%e8%84%9a%e6%9c%ac%e5%8f%98%e9%87%8f aria-label=脚本变量>脚本变量</a></li><li><a href=#avp%e5%8f%98%e9%87%8f aria-label=avp变量>avp变量</a></li><li><a href=#%e4%bc%aa%e5%8f%98%e9%87%8f aria-label=伪变量>伪变量</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=简介>简介<a hidden class=anchor aria-hidden=true href=#简介>#</a></h1><p>OpenSIPS的路由脚本提供了几种不同类型的变量。不同类型的变量有以下几个方面的差异。</p><ol><li>变量的可见性</li><li>变量引用的值</li><li>变量的读写性质：有些变量是只读的，有些变量可读可写</li><li>变量是否有多个值：有些变量只有一个值，有些变量有多个值</li></ol><h1 id=语法>语法<a hidden class=anchor aria-hidden=true href=#语法>#</a></h1><pre tabindex=0><code>$(&lt;context&gt;name(subname)[index]{tramsformation})
</code></pre><p>除了name以外 ，其他都是可选的值。</p><ul><li>name(必传)：变量名的类型，例如pvar, avp, ru, DLG_status等等</li><li>subname: 变量名称，例如hdr(From), avp(name)</li><li>index: 索引，某些变量可以有多个值，类似于数组。可以用索引去引用对应的元素。从0开始，也可以是负值如-1, 表示倒数第一个。</li><li>transformation: 转换。做一些格式转换，字符串截取等等操作</li><li>context: 上下文。OpenSIP有两个上下午，请求<code>request</code>、相应<code>reply</code>。想想一个场景，你在一个相应路由里如何拿到请求路由的某个值呢？ 可以使用$(ru). 或者在一个失败路由里获取一个Concact的信息$(hdr(Contact))</li></ul><p>举例：</p><ul><li>仅仅通过类型来引用：$ru</li><li>通过类型和名称来引用：$hrd(Contact), 引用某个SIP header的值</li><li>通过类型和索引来引用：$(ct[0])</li><li>通过类型、名称、索引来引用：$(avp(addr)[0])</li></ul><h1 id=变量的类型>变量的类型<a hidden class=anchor aria-hidden=true href=#变量的类型>#</a></h1><h2 id=脚本变量>脚本变量<a hidden class=anchor aria-hidden=true href=#脚本变量>#</a></h2><p><img loading=lazy src=2022-12-02-17-32-09.png alt></p><ul><li>脚本变量只有一个值</li><li>脚本变量可读可写</li><li>脚本变量在路由及其子路由中都是可见的</li><li>脚本变量使用前务必先初始化，否则可能会引用到之前的值</li><li>脚本变量的值可以是字符串，也可以是整数类型</li><li>脚本变量读写比avp变量快</li><li>脚本变量会持久存在一个OpenSIPS进程中</li><li>将脚本变量设置为NULL, 实际上是将变量的值设置为'0&rsquo;, 脚本变量没有NULL值。</li><li>脚本变量之存在与一个路由中</li></ul><p>使用举例</p><pre tabindex=0><code>route{
	$var(a) = 19
	$var(a) = &#34;wdd&#34;
	$var(a) =  &#34;wdd&#34; + &#34;@&#34; + $td;
  
  if(route(check_out, 1)){
  	xlog(&#34;check error&#34;);
  }
  
}

route[check_out]{
  # 注意，这里$var(a)的值就不存在了
	xlog(&#34;$var(a)&#34;);
  
  if ($param(1) &gt; 1) {
  	return (-1);
  }
  return(1);
}
</code></pre><h2 id=avp变量>avp变量<a hidden class=anchor aria-hidden=true href=#avp变量>#</a></h2><p><img loading=lazy src=2022-12-02-17-32-26.png alt></p><ul><li>avp变量一般会关联到一个sip消息或者SIP事务上.</li><li>avp变量可以有多个值</li><li>可以avp变量理解成一个后进先出的栈</li><li>所有处理这个消息的子路由都可以获得avp的变量。但是如果想在响应路由中想获取请求路由中的avp变量，则需要设置TM模块的onreply_avp_mode参数：<code>modparam("tm","onreply_avp_mode", 1)</code></li></ul><pre tabindex=0><code>$avp(trunk)=&#34;hello&#34;;
$avp(trunk)=&#34;duan&#34;;
$avp(trunk)=&#34;hi&#34;;

# 可以把trunk的值理解成下面的样子
# hi -&gt; duan -&gt; hello

xlog(&#34;$avp(trunk)&#34;); 这里只能打印出hi
xlog(&#34;$(avp(trunk)[2])&#34;); 这里能打印hello

$avp(trunk)=NULL; 这里能删除最后的一个值，如果只有一个值，那么整个avp会被删除

avp_delete(&#34;$avp(trunk)/g&#34;); # 删除avp所有的值，包括这个avp自身。

$(avp(trunk)[1])=&#34;heihei&#34;; 重新赋值

$(avp(trunk)[1])=NULL; 删除某一个值
</code></pre><h2 id=伪变量>伪变量<a hidden class=anchor aria-hidden=true href=#伪变量>#</a></h2><p>伪变量主要是对SIP消息的各个部分进行引用的</p><p>大部分伪变量很好接，都是缩写的单词的首字母。</p><ul><li>伪变量以$开头，加sip消息字段的缩写，例如$ci, 代表sip callID</li></ul><table><thead><tr><th>序号</th><th>名称</th><th>是否可修改</th><th>含义</th></tr></thead><tbody><tr><td>1</td><td>$ai</td><td></td><td>引用P-Asserted-Identify头的url</td></tr><tr><td>2</td><td>$adu</td><td></td><td>Authentication Digest URI</td></tr><tr><td>3</td><td>$ar</td><td></td><td>Authentication realm</td></tr><tr><td>4</td><td>$au</td><td></td><td>Auth username user</td></tr><tr><td>5</td><td>$ad</td><td></td><td>Auth username domain</td></tr><tr><td>6</td><td>$an</td><td></td><td>Auth nonce</td></tr><tr><td>7</td><td>$auth.resp</td><td></td><td>Auth response</td></tr><tr><td>8</td><td>$auth.nonce</td><td></td><td>Auth nonce</td></tr><tr><td>9</td><td>$auth.opaque</td><td></td><td>the opaque 字符串</td></tr><tr><td>10</td><td>$auth.alg</td><td></td><td>认证算法</td></tr><tr><td>11</td><td>$auth.qop</td><td></td><td>qop参数的值</td></tr><tr><td>12</td><td>$auth.nc</td><td></td><td>nonce count参数</td></tr><tr><td>13</td><td>$aU</td><td></td><td>整个username</td></tr><tr><td>14</td><td>$Au</td><td></td><td>计费用的账户名，主要是acc会用</td></tr><tr><td>15</td><td><strong>$argv</strong></td><td></td><td>获取通过命令行参数设置参数-o。例如在启动opensips时```bash</td></tr><tr><td>opensips -o maxsiplength=1200</td><td></td><td></td><td></td></tr></tbody></table><pre tabindex=0><code>&lt;br /&gt;&lt;br /&gt;在脚本里就可以通过$argv(maxsiplength)&lt;br /&gt;```bash
xlog(&#34;maxsiplength: is $argv(maxsiplength)&#34;)
</code></pre><p>|
| 16 | $af | | ip协议，可能是INET(ipv4), 或者是INET6(ipv6) |
| 17 | $branch | | 用来创建新的分支```bash
$branch=&ldquo;sip:new#domain&rdquo;;</p><pre tabindex=0><code> |
| 18 | $branch() |  | &lt;br /&gt;- $branch(uri)&lt;br /&gt;- $branch(duri)&lt;br /&gt;- $branch(q)&lt;br /&gt;- $branch(path)&lt;br /&gt;- $branch(flags)&lt;br /&gt;- $branch(socket)&lt;br /&gt; |
| 19 | **$ci** |  | 引用sip call-id。 (call-id) |
| 20 | **$cl** |  | 引用sip body部分的长度。(content-length) |
| 21 | $cs |  | 引用 cseq number |
| 22 | $ct |  | 引用Contact&lt;br /&gt;- $ci&lt;br /&gt;- $(ct[n])&lt;br /&gt;- $(ct[-n])&lt;br /&gt; |
| 23 | $ct.fields() | &lt;br /&gt; | &lt;br /&gt;- $ct.fields(name)&lt;br /&gt;- $ct.fields(uri)&lt;br /&gt;- $ct.fields(q)&lt;br /&gt;- $ct.fields(expires)&lt;br /&gt;- $ct.fields(methods)&lt;br /&gt;- $ct.fields(received)&lt;br /&gt;- $ct.fields(params) 所有的参数&lt;br /&gt; |
| 24 | $cT |  | &lt;br /&gt;- $cT   Content-Type&lt;br /&gt;- $(cT[n])&lt;br /&gt;- $(cT[-n])&lt;br /&gt;- $(cT[*])&lt;br /&gt; |
| 25 | **$dd** |  | 引用目标url里面的domain部分 |
| 26 | $di |  | diversion header |
| 27 | $dip |  | diversion privacy prameter |
| 29 | $dir |  | diversion reason parameter |
| 30 | $dp |  | 目标url的端口号部分 (destionation port) |
| 31 | $dP |  | 目标url的传输协议部分 (destionation protocol) |
| 32 | $ds |  | destionation set |
| 33 | **$du** |  | 引用 destionation url |
| 34 | $err.class |  | 错误的类别&lt;br /&gt;- 1 解析错误&lt;br /&gt; |
| 35 | $err.level |  | 错误的级别 |
| 36 | $err.info |  | 错误信息的描述 |
| 37 | $err.rcode |  | error reply code |
| 38 | $err.rreason |  | error reply reason |
| 39 | **$fd** |  | From URI domain |
| 40 | **$fn** |  | From display name |
| 41 | **$fs** |  | 强制使用某个地址发送消息。 (forced socket)&lt;br /&gt;格式：proto:ip:port |
| 42 | $ft |  | From tag |
| 43 | **$fu** |  | From URL |
| 44 | **$fU** |  | username in From URL |
| 45 | **$log_level** |  | 可以用来动态修改日志级别&lt;br /&gt;$log_level=4;&lt;br /&gt;&lt;br /&gt;$log_level=NULL; 恢复默认值 |
| 46 | $mb |  | sip message buffer |
| 47 | $mf |  | message flags |
| 48 | $mi |  | sip message id |
| 49 | **$ml** |  | sip message length |
| 50 | $od |  |  domain in original R-URI |
| 51 | $op |  |  port in original R-URI |
| 52 | $oP |  | transport protocol of original R-URI |
| 53 | $ou |  | original URI |
| 54 | $oU |  | username in original URI |
| 55 | **$param(idx)** |  | 引用路由参数，从1开始&lt;br /&gt;```bash
route{
	route(R_NAME, $var(debug), &#34;pp&#34;);
}

route[R_NAME]{
	$param(1); #引用第一个参数 $var(debug)
  $param(2); #引用第二个参数 pp
}
</code></pre><p>|
| 56 | $pd | | domain in sip P-Prefered-Identify header |
| 57 | $pn | | display name in sip P-Prefered-Identify header |
| 58 | $pp | | process id |
| 59 | $pr $proto | | 接受消息的协议 UDP, TCP, TLS, SCTP, WS |
| 60 | $pu | | URL in sip P-Prefered-Identify header |
| 61 | <strong>$rd</strong> | | domain in request url |
| 62 | $rb | | body of request/replay- $rb- $(rb[*])- $(rb[n])- $(rb[-n])- $rb(application/sdp)- $rb(application/isup) |
| 63 | <strong>$rc $retcode</strong> | | 上个函数的返回结果 |
| 64 | $re | | remote-party-id |
| 65 | <strong>$rm</strong> | | sip method |
| 66 | <strong>$rp</strong> | | port of R-RUI |
| 67 | $rP | | transport protocol pf R-URI |
| 68 | $rr | | reply reason |
| 69 | <strong>$rs</strong> | | reply status |
| 70 | <strong>$ru</strong> | | request url |
| 71 | <strong>$rU</strong> | | |
| 72 | $ru_q | | |
| 73 | <strong>$Ri</strong> | | |
| 74 | <strong>$Rp</strong> | | |
| 75 | $sf | | |
| 76 | <strong>$si</strong> | | |
| 77 | <strong>$sp</strong> | | |
| 78 | $tt | | |
| 79 | <strong>$tu</strong> | | |
| 80 | <strong>$tU</strong> | | |
| 81 | $time(format) | | |
| 82 | $T_branch_idx | | |
| 83 | $Tf | | |
| 84 | $Ts | | |
| 85 | $Tsm | | |
| 86 | $TS | | |
| 87 | <strong>$ua</strong> | | |
| 88 | <strong>$(hdr(name)[N])</strong> | | |
| 89 | $rT | | |
| 90 | $cfg_line $cfg_file | | |
| 91 | $xlog_level | | |</p></div><footer class=post-footer><ul class=post-tags></ul></footer><script src=https://giscus.app/client.js data-repo=wangduanduan/wangduanduan.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxMTkyMjMyNjA=" data-category=Announcements data-category-id=DIC_kwDOBxsz3M4CAjBq data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://wdd.js.org>洞香春</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>