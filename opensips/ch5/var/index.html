<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>变量的使用 | 洞香春</title><meta name=keywords content><meta name=description content="变量的使用方式 $(<context>type(name)[index]{transformation}) 变量都以$符号开头 type表示变量的类型：核心变量，自定义变量，键值对变量 name表示变量名：如$var(name), $avp(age) index表示需要，有些变量类似于数组，可以使用需要来指定。需要可以用正数和负数，如-1表示最后一个元素 transformations表示类型转换，如获取一个字符串值的长度，大小写转换等操作 context表示变量存在的作用域，opensips有请求的作用域和响应的作用域 # by type $ru # type type and name $hdr(Contact) # bye type and index $(ct[0]) # by type name and index $(avp(gw_ip)[2]) # by context $(<request>ru) $(<reply>hdr(Contact)) 引用变量 所有的引用变量都是可读的，但是只有部分变量可以修改。引用变量一般都是英文含义的首字母缩写，刚开始接触opensips的同学可能很不习惯。实际上通过首字母大概是可以猜出变量的含义的。
必须记住变量的用黄色标记。
变量名 英文含义 中文解释 是否可修改 $ru request url 请求url 是 $rU Username in SIP Request&rsquo;s URI 是 $ci call id callId $hdr(from) request headers from 请求头中的from字段 是 $Ts current time unix Timestamp 当前时间的unix时间戳 $branch Branch $cl Content-Length $cs CSeq number $cT Content-Type $dd Domain of destination URI 目标地址的域名 是 $di Diversion header URI $dp Port of destination URI 目标地址的端口 是 $dP Transport protocol of destination URI 传输协议 $du Destination URI 目标地址 是 $fd From URI domain $fn From display name $ft From tag $fu From URI $fU From URI username $mb SIP message buffer $mf Message Flags $mi SIP message ID $ml SIP message length $od Domain in SIP Request&rsquo;s original URI $op Port of SIP request&rsquo;s original URI $oP Transport protocol of SIP request original URI $ou SIP Request&rsquo;s original URI $oU Username in SIP Request&rsquo;s original URI $param(idx) Route parameter $pp Process id $rd Domain in SIP Request&rsquo;s URI $rb Body of request/reply 是 $rc Returned code $re Remote-Party-ID header URI $rm SIP request&rsquo;s method $rp SIP request&rsquo;s port 是 $rP Transport protocol of SIP request URI $rr SIP reply&rsquo;s reason $rs SIP reply&rsquo;s status $rt reference to URI of refer-to header $Ri Received IP address $Rp Received port $sf Script flags $si IP source address $sp Source port $td To URI Domain $tn To display name $tt To tag $tu To URI $tU To URI Username $TF String formatted time $TS Startup unix time stamp $ua User agent header 更多变量可以参考：https://www."><meta name=author content="王端端"><link rel=canonical href=https://wdd.js.org/opensips/ch5/var/><link crossorigin=anonymous href=/assets/css/stylesheet.min.ceab085cbbf58c0ec96f6d415d51b3b44e204edfd71a45b4fa2d4aac13f119d0.css integrity="sha256-zqsIXLv1jA7Jb21BXVGztE4gTt/XGkW0+i1KrBPxGdA=" rel="preload stylesheet" as=style><link crossorigin=anonymous herf=/font-awesome/css/font-awesome.min.css rel=stylesheet type=text/css><link rel=preload href=/cowboy.ico as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/cowboy.ico><link rel=apple-touch-icon href=https://wdd.js.org/cowboy.ico><link rel=mask-icon href=https://wdd.js.org/cowboy.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.108.0"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="变量的使用"><meta property="og:description" content="变量的使用方式 $(<context>type(name)[index]{transformation}) 变量都以$符号开头 type表示变量的类型：核心变量，自定义变量，键值对变量 name表示变量名：如$var(name), $avp(age) index表示需要，有些变量类似于数组，可以使用需要来指定。需要可以用正数和负数，如-1表示最后一个元素 transformations表示类型转换，如获取一个字符串值的长度，大小写转换等操作 context表示变量存在的作用域，opensips有请求的作用域和响应的作用域 # by type $ru # type type and name $hdr(Contact) # bye type and index $(ct[0]) # by type name and index $(avp(gw_ip)[2]) # by context $(<request>ru) $(<reply>hdr(Contact)) 引用变量 所有的引用变量都是可读的，但是只有部分变量可以修改。引用变量一般都是英文含义的首字母缩写，刚开始接触opensips的同学可能很不习惯。实际上通过首字母大概是可以猜出变量的含义的。
必须记住变量的用黄色标记。
变量名 英文含义 中文解释 是否可修改 $ru request url 请求url 是 $rU Username in SIP Request&rsquo;s URI 是 $ci call id callId $hdr(from) request headers from 请求头中的from字段 是 $Ts current time unix Timestamp 当前时间的unix时间戳 $branch Branch $cl Content-Length $cs CSeq number $cT Content-Type $dd Domain of destination URI 目标地址的域名 是 $di Diversion header URI $dp Port of destination URI 目标地址的端口 是 $dP Transport protocol of destination URI 传输协议 $du Destination URI 目标地址 是 $fd From URI domain $fn From display name $ft From tag $fu From URI $fU From URI username $mb SIP message buffer $mf Message Flags $mi SIP message ID $ml SIP message length $od Domain in SIP Request&rsquo;s original URI $op Port of SIP request&rsquo;s original URI $oP Transport protocol of SIP request original URI $ou SIP Request&rsquo;s original URI $oU Username in SIP Request&rsquo;s original URI $param(idx) Route parameter $pp Process id $rd Domain in SIP Request&rsquo;s URI $rb Body of request/reply 是 $rc Returned code $re Remote-Party-ID header URI $rm SIP request&rsquo;s method $rp SIP request&rsquo;s port 是 $rP Transport protocol of SIP request URI $rr SIP reply&rsquo;s reason $rs SIP reply&rsquo;s status $rt reference to URI of refer-to header $Ri Received IP address $Rp Received port $sf Script flags $si IP source address $sp Source port $td To URI Domain $tn To display name $tt To tag $tu To URI $tU To URI Username $TF String formatted time $TS Startup unix time stamp $ua User agent header 更多变量可以参考：https://www."><meta property="og:type" content="article"><meta property="og:url" content="https://wdd.js.org/opensips/ch5/var/"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="opensips"><meta property="article:published_time" content="2019-06-16T17:18:55+08:00"><meta property="article:modified_time" content="2019-06-16T17:18:55+08:00"><meta property="og:site_name" content="洞香春"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="变量的使用"><meta name=twitter:description content="变量的使用方式 $(<context>type(name)[index]{transformation}) 变量都以$符号开头 type表示变量的类型：核心变量，自定义变量，键值对变量 name表示变量名：如$var(name), $avp(age) index表示需要，有些变量类似于数组，可以使用需要来指定。需要可以用正数和负数，如-1表示最后一个元素 transformations表示类型转换，如获取一个字符串值的长度，大小写转换等操作 context表示变量存在的作用域，opensips有请求的作用域和响应的作用域 # by type $ru # type type and name $hdr(Contact) # bye type and index $(ct[0]) # by type name and index $(avp(gw_ip)[2]) # by context $(<request>ru) $(<reply>hdr(Contact)) 引用变量 所有的引用变量都是可读的，但是只有部分变量可以修改。引用变量一般都是英文含义的首字母缩写，刚开始接触opensips的同学可能很不习惯。实际上通过首字母大概是可以猜出变量的含义的。
必须记住变量的用黄色标记。
变量名 英文含义 中文解释 是否可修改 $ru request url 请求url 是 $rU Username in SIP Request&rsquo;s URI 是 $ci call id callId $hdr(from) request headers from 请求头中的from字段 是 $Ts current time unix Timestamp 当前时间的unix时间戳 $branch Branch $cl Content-Length $cs CSeq number $cT Content-Type $dd Domain of destination URI 目标地址的域名 是 $di Diversion header URI $dp Port of destination URI 目标地址的端口 是 $dP Transport protocol of destination URI 传输协议 $du Destination URI 目标地址 是 $fd From URI domain $fn From display name $ft From tag $fu From URI $fU From URI username $mb SIP message buffer $mf Message Flags $mi SIP message ID $ml SIP message length $od Domain in SIP Request&rsquo;s original URI $op Port of SIP request&rsquo;s original URI $oP Transport protocol of SIP request original URI $ou SIP Request&rsquo;s original URI $oU Username in SIP Request&rsquo;s original URI $param(idx) Route parameter $pp Process id $rd Domain in SIP Request&rsquo;s URI $rb Body of request/reply 是 $rc Returned code $re Remote-Party-ID header URI $rm SIP request&rsquo;s method $rp SIP request&rsquo;s port 是 $rP Transport protocol of SIP request URI $rr SIP reply&rsquo;s reason $rs SIP reply&rsquo;s status $rt reference to URI of refer-to header $Ri Received IP address $Rp Received port $sf Script flags $si IP source address $sp Source port $td To URI Domain $tn To display name $tt To tag $tu To URI $tU To URI Username $TF String formatted time $TS Startup unix time stamp $ua User agent header 更多变量可以参考：https://www."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"OpenSIPS2.4.X 中文实战系列","item":"https://wdd.js.org/opensips/"},{"@type":"ListItem","position":3,"name":"变量的使用","item":"https://wdd.js.org/opensips/ch5/var/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"变量的使用","name":"变量的使用","description":"变量的使用方式 $(\u0026lt;context\u0026gt;type(name)[index]{transformation}) 变量都以$符号开头 type表示变量的类型：核心变量，自定义变量，键值对变量 name表示变量名：如$var(name), $avp(age) index表示需要，有些变量类似于数组，可以使用需要来指定。需要可以用正数和负数，如-1表示最后一个元素 transformations表示类型转换，如获取一个字符串值的长度，大小写转换等操作 context表示变量存在的作用域，opensips有请求的作用域和响应的作用域 # by type $ru # type type and name $hdr(Contact) # bye type and index $(ct[0]) # by type name and index $(avp(gw_ip)[2]) # by context $(\u0026lt;request\u0026gt;ru) $(\u0026lt;reply\u0026gt;hdr(Contact)) 引用变量 所有的引用变量都是可读的，但是只有部分变量可以修改。引用变量一般都是英文含义的首字母缩写，刚开始接触opensips的同学可能很不习惯。实际上通过首字母大概是可以猜出变量的含义的。\n必须记住变量的用黄色标记。\n变量名 英文含义 中文解释 是否可修改 $ru request url 请求url 是 $rU Username in SIP Request\u0026rsquo;s URI 是 $ci call id callId $hdr(from) request headers from 请求头中的from字段 是 $Ts current time unix Timestamp 当前时间的unix时间戳 $branch Branch $cl Content-Length $cs CSeq number $cT Content-Type $dd Domain of destination URI 目标地址的域名 是 $di Diversion header URI $dp Port of destination URI 目标地址的端口 是 $dP Transport protocol of destination URI 传输协议 $du Destination URI 目标地址 是 $fd From URI domain $fn From display name $ft From tag $fu From URI $fU From URI username $mb SIP message buffer $mf Message Flags $mi SIP message ID $ml SIP message length $od Domain in SIP Request\u0026rsquo;s original URI $op Port of SIP request\u0026rsquo;s original URI $oP Transport protocol of SIP request original URI $ou SIP Request\u0026rsquo;s original URI $oU Username in SIP Request\u0026rsquo;s original URI $param(idx) Route parameter $pp Process id $rd Domain in SIP Request\u0026rsquo;s URI $rb Body of request/reply 是 $rc Returned code $re Remote-Party-ID header URI $rm SIP request\u0026rsquo;s method $rp SIP request\u0026rsquo;s port 是 $rP Transport protocol of SIP request URI $rr SIP reply\u0026rsquo;s reason $rs SIP reply\u0026rsquo;s status $rt reference to URI of refer-to header $Ri Received IP address $Rp Received port $sf Script flags $si IP source address $sp Source port $td To URI Domain $tn To display name $tt To tag $tu To URI $tU To URI Username $TF String formatted time $TS Startup unix time stamp $ua User agent header 更多变量可以参考：https://www.","keywords":[],"articleBody":"变量的使用方式 $(type(name)[index]{transformation}) 变量都以$符号开头 type表示变量的类型：核心变量，自定义变量，键值对变量 name表示变量名：如$var(name), $avp(age) index表示需要，有些变量类似于数组，可以使用需要来指定。需要可以用正数和负数，如-1表示最后一个元素 transformations表示类型转换，如获取一个字符串值的长度，大小写转换等操作 context表示变量存在的作用域，opensips有请求的作用域和响应的作用域 # by type $ru # type type and name $hdr(Contact) # bye type and index $(ct[0]) # by type name and index $(avp(gw_ip)[2]) # by context $(ru) $(hdr(Contact)) 引用变量 所有的引用变量都是可读的，但是只有部分变量可以修改。引用变量一般都是英文含义的首字母缩写，刚开始接触opensips的同学可能很不习惯。实际上通过首字母大概是可以猜出变量的含义的。\n必须记住变量的用黄色标记。\n变量名 英文含义 中文解释 是否可修改 $ru request url 请求url 是 $rU Username in SIP Request’s URI 是 $ci call id callId $hdr(from) request headers from 请求头中的from字段 是 $Ts current time unix Timestamp 当前时间的unix时间戳 $branch Branch $cl Content-Length $cs CSeq number $cT Content-Type $dd Domain of destination URI 目标地址的域名 是 $di Diversion header URI $dp Port of destination URI 目标地址的端口 是 $dP Transport protocol of destination URI 传输协议 $du Destination URI 目标地址 是 $fd From URI domain $fn From display name $ft From tag $fu From URI $fU From URI username $mb SIP message buffer $mf Message Flags $mi SIP message ID $ml SIP message length $od Domain in SIP Request’s original URI $op Port of SIP request’s original URI $oP Transport protocol of SIP request original URI $ou SIP Request’s original URI $oU Username in SIP Request’s original URI $param(idx) Route parameter $pp Process id $rd Domain in SIP Request’s URI $rb Body of request/reply 是 $rc Returned code $re Remote-Party-ID header URI $rm SIP request’s method $rp SIP request’s port 是 $rP Transport protocol of SIP request URI $rr SIP reply’s reason $rs SIP reply’s status $rt reference to URI of refer-to header $Ri Received IP address $Rp Received port $sf Script flags $si IP source address $sp Source port $td To URI Domain $tn To display name $tt To tag $tu To URI $tU To URI Username $TF String formatted time $TS Startup unix time stamp $ua User agent header 更多变量可以参考：https://www.opensips.org/Documentation/Script-CoreVar-2-4\n键值对变量 键值对变量是按需创建的 键值对只能用于有状态的路由处理中 键值对会绑定到指定的消息或者事务上 键值对初始化时是空值 键值对可以在所有的路由中读写 在响应路由中使用键值对，需要加载tm模块，并且设置onreply_avp_ mode参数 键值对可以读写，也可以删除 可以把键值对理解为key为hash, 值为堆栈的数据结构 $avp(my_name) = \"wang\" $avp(my_name) = \"duan\" xlog(\"$avp(my_name)\") # duan xlog(\"$avp(my_name)[0]\") # wang xlog(\"$avp(my_name)[*]\") # wang duanduan 脚本变量 脚本变量只存在于当前主路由及其子路由中。路由结束，脚本变量将回收。 脚本变量需要指定初始化值，否则变量的值将不确定。 脚本变量只能有一个值 脚本变量读取要比键值对变量快，脚本变量直接引用内存的位置 如果需要变量，可以优先考虑使用脚本变量 $var(my_name) = \"wangduanduan\" $var(log_msg) = $var(my_name) + $ci + $fu xlog(\"$var(log_msg)\") 脚本翻译 脚本翻译可以理解为一种工具函数，可以用来获取字符串长度，获取字符串的子字符等等操作。\n获取字符串长度 $(fu{s.len}) 字符串截取子串 $(var(x){s.substr,5,2}) 获取字符串的某部分 $(avp(my_uri){uri.user}) 将字符串值转为整数 $(var(x){s.int}) 翻译也可以链式调用 $(hdr(Test){s.escape.common}{s.len}) ","wordCount":"338","inLanguage":"en","datePublished":"2019-06-16T17:18:55+08:00","dateModified":"2019-06-16T17:18:55+08:00","author":{"@type":"Person","name":"王端端"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wdd.js.org/opensips/ch5/var/"},"publisher":{"@type":"Organization","name":"洞香春","logo":{"@type":"ImageObject","url":"https://wdd.js.org/cowboy.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org accesskey=h title="洞香春 (Alt + H)"><img src=/cowboy.ico alt=logo aria-label=logo height=35>洞香春</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/fe/ title=Frontend><span>Frontend</span></a></li><li><a href=https://wdd.js.org/golang/ title=Golang><span>Golang</span></a></li><li><a href=https://wdd.js.org/container/ title=k8s/docker><span>k8s/docker</span></a></li><li><a href=https://wdd.js.org/network/ title=Network><span>Network</span></a></li><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/shell/ title=Shell><span>Shell</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/categories/ title=分类><span>分类</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wdd.js.org>Home</a>&nbsp;»&nbsp;<a href=https://wdd.js.org/opensips/>OpenSIPS2.4.X 中文实战系列</a></div><h1 class=post-title>变量的使用</h1><div class=post-meta><span title='2019-06-16 17:18:55 +0800 CST'>2019-06-16 17:18:55</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;王端端</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%8f%98%e9%87%8f%e7%9a%84%e4%bd%bf%e7%94%a8%e6%96%b9%e5%bc%8f aria-label=变量的使用方式>变量的使用方式</a></li><li><a href=#%e5%bc%95%e7%94%a8%e5%8f%98%e9%87%8f aria-label=引用变量>引用变量</a></li><li><a href=#%e9%94%ae%e5%80%bc%e5%af%b9%e5%8f%98%e9%87%8f aria-label=键值对变量>键值对变量</a></li><li><a href=#%e8%84%9a%e6%9c%ac%e5%8f%98%e9%87%8f aria-label=脚本变量>脚本变量</a></li><li><a href=#%e8%84%9a%e6%9c%ac%e7%bf%bb%e8%af%91 aria-label=脚本翻译>脚本翻译</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=变量的使用方式>变量的使用方式<a hidden class=anchor aria-hidden=true href=#变量的使用方式>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#66d9ef>$(</span>&lt;context&gt;type<span style=color:#f92672>(</span>name<span style=color:#66d9ef>)</span><span style=color:#f92672>[</span>index<span style=color:#f92672>]{</span>transformation<span style=color:#f92672>})</span>
</span></span></code></pre></div><ol><li>变量都以$符号开头</li><li>type表示变量的类型：核心变量，自定义变量，键值对变量</li><li>name表示变量名：如$var(name), $avp(age)</li><li>index表示需要，有些变量类似于数组，可以使用需要来指定。需要可以用正数和负数，如-1表示最后一个元素</li><li>transformations表示类型转换，如获取一个字符串值的长度，大小写转换等操作</li><li>context表示变量存在的作用域，opensips有请求的作用域和响应的作用域</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># by type</span>
</span></span><span style=display:flex><span>$ru
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># type type and name</span>
</span></span><span style=display:flex><span>$hdr<span style=color:#f92672>(</span>Contact<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># bye type and index</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>$(</span>ct<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># by type name and index</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>$(</span>avp<span style=color:#f92672>(</span>gw_ip<span style=color:#66d9ef>)</span><span style=color:#f92672>[</span>2<span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># by context</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>$(</span>&lt;request&gt;ru<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>$(</span>&lt;reply&gt;hdr<span style=color:#f92672>(</span>Contact<span style=color:#66d9ef>)</span><span style=color:#f92672>)</span>
</span></span></code></pre></div><h1 id=引用变量>引用变量<a hidden class=anchor aria-hidden=true href=#引用变量>#</a></h1><p>所有的引用变量都是可读的，但是只有部分变量可以修改。引用变量一般都是英文含义的首字母缩写，刚开始接触opensips的同学可能很不习惯。实际上通过首字母大概是可以猜出变量的含义的。</p><p>必须记住变量的用黄色标记。</p><table><thead><tr><th>变量名</th><th>英文含义</th><th>中文解释</th><th>是否可修改</th></tr></thead><tbody><tr><td>$ru</td><td>request url</td><td>请求url</td><td>是</td></tr><tr><td>$rU</td><td>Username in SIP Request&rsquo;s URI</td><td></td><td>是</td></tr><tr><td>$ci</td><td>call id</td><td>callId</td><td></td></tr><tr><td>$hdr(from)</td><td>request headers from </td><td>请求头中的from字段</td><td>是</td></tr><tr><td>$Ts</td><td>current time unix Timestamp</td><td>当前时间的unix时间戳</td><td></td></tr><tr><td>$branch</td><td>Branch</td><td></td><td></td></tr><tr><td>$cl</td><td>Content-Length</td><td></td><td></td></tr><tr><td>$cs</td><td>CSeq number</td><td></td><td></td></tr><tr><td>$cT</td><td>Content-Type</td><td></td><td></td></tr><tr><td>$dd</td><td>Domain of destination URI</td><td>目标地址的域名</td><td>是</td></tr><tr><td>$di</td><td>Diversion header URI</td><td></td><td></td></tr><tr><td>$dp</td><td>Port of destination URI</td><td>目标地址的端口</td><td>是</td></tr><tr><td>$dP</td><td>Transport protocol of destination URI</td><td>传输协议</td><td></td></tr><tr><td>$du</td><td>Destination URI</td><td>目标地址</td><td>是</td></tr><tr><td>$fd</td><td>From URI domain</td><td></td><td></td></tr><tr><td>$fn</td><td>From display name</td><td></td><td></td></tr><tr><td>$ft</td><td>From tag</td><td></td><td></td></tr><tr><td>$fu</td><td>From URI</td><td></td><td></td></tr><tr><td>$fU</td><td>From URI username</td><td></td><td></td></tr><tr><td>$mb</td><td>SIP message buffer</td><td></td><td></td></tr><tr><td>$mf</td><td>Message Flags</td><td></td><td></td></tr><tr><td>$mi</td><td>SIP message ID</td><td></td><td></td></tr><tr><td>$ml</td><td>SIP message length</td><td></td><td></td></tr><tr><td>$od</td><td>Domain in SIP Request&rsquo;s original URI</td><td></td><td></td></tr><tr><td>$op</td><td>Port of SIP request&rsquo;s original URI</td><td></td><td></td></tr><tr><td>$oP</td><td>Transport protocol of SIP request original URI</td><td></td><td></td></tr><tr><td>$ou</td><td>SIP Request&rsquo;s original URI</td><td></td><td></td></tr><tr><td>$oU</td><td>Username in SIP Request&rsquo;s original URI</td><td></td><td></td></tr><tr><td>$param(idx) </td><td>Route parameter</td><td></td><td></td></tr><tr><td>$pp</td><td>Process id</td><td></td><td></td></tr><tr><td>$rd</td><td> Domain in SIP Request&rsquo;s URI</td><td></td><td></td></tr><tr><td>$rb</td><td>Body of request/reply</td><td></td><td>是</td></tr><tr><td>$rc</td><td>Returned code</td><td></td><td></td></tr><tr><td>$re</td><td>Remote-Party-ID header URI</td><td></td><td></td></tr><tr><td>$rm</td><td>SIP request&rsquo;s method</td><td></td><td></td></tr><tr><td>$rp</td><td>SIP request&rsquo;s port</td><td></td><td>是</td></tr><tr><td>$rP</td><td> Transport protocol of SIP request URI</td><td></td><td></td></tr><tr><td>$rr</td><td> SIP reply&rsquo;s reason</td><td></td><td></td></tr><tr><td>$rs</td><td>SIP reply&rsquo;s status</td><td></td><td></td></tr><tr><td>$rt</td><td>reference to URI of refer-to header</td><td></td><td></td></tr><tr><td>$Ri </td><td>Received IP address</td><td></td><td></td></tr><tr><td>$Rp</td><td> Received port</td><td></td><td></td></tr><tr><td>$sf</td><td> Script flags</td><td></td><td></td></tr><tr><td>$si</td><td> IP source address</td><td></td><td></td></tr><tr><td>$sp</td><td>Source port</td><td></td><td></td></tr><tr><td>$td</td><td>To URI Domain</td><td></td><td></td></tr><tr><td>$tn</td><td>To display name</td><td></td><td></td></tr><tr><td>$tt</td><td>To tag</td><td></td><td></td></tr><tr><td>$tu</td><td>To URI</td><td></td><td></td></tr><tr><td>$tU</td><td>To URI Username</td><td></td><td></td></tr><tr><td>$TF</td><td> String formatted time</td><td></td><td></td></tr><tr><td>$TS</td><td> Startup unix time stamp</td><td></td><td></td></tr><tr><td>$ua</td><td>User agent header</td><td></td><td></td></tr></tbody></table><p>更多变量可以参考：<a href=https://www.opensips.org/Documentation/Script-CoreVar-2-4>https://www.opensips.org/Documentation/Script-CoreVar-2-4</a></p><h1 id=键值对变量>键值对变量<a hidden class=anchor aria-hidden=true href=#键值对变量>#</a></h1><ol><li>键值对变量是按需创建的</li><li>键值对只能用于有状态的路由处理中</li><li>键值对会绑定到指定的消息或者事务上</li><li>键值对初始化时是空值</li><li>键值对可以在所有的路由中读写</li><li>在响应路由中使用键值对，需要加载tm模块，并且设置onreply_avp_ mode参数</li><li>键值对可以读写，也可以删除</li><li>可以把键值对理解为key为hash, 值为堆栈的数据结构</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$avp<span style=color:#f92672>(</span>my_name<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;wang&#34;</span>
</span></span><span style=display:flex><span>$avp<span style=color:#f92672>(</span>my_name<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;duan&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>xlog<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;</span>$avp<span style=color:#e6db74>(my_name)&#34;</span><span style=color:#f92672>)</span> <span style=color:#75715e># duan</span>
</span></span><span style=display:flex><span>xlog<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;</span>$avp<span style=color:#e6db74>(my_name)[0]&#34;</span><span style=color:#f92672>)</span> <span style=color:#75715e># wang</span>
</span></span><span style=display:flex><span>xlog<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;</span>$avp<span style=color:#e6db74>(my_name)[*]&#34;</span><span style=color:#f92672>)</span> <span style=color:#75715e># wang duanduan</span>
</span></span></code></pre></div><h1 id=脚本变量>脚本变量<a hidden class=anchor aria-hidden=true href=#脚本变量>#</a></h1><ol><li>脚本变量只存在于当前主路由及其子路由中。路由结束，脚本变量将回收。</li><li>脚本变量需要指定初始化值，否则变量的值将不确定。</li><li>脚本变量只能有一个值</li><li>脚本变量读取要比键值对变量快，脚本变量直接引用内存的位置</li><li>如果需要变量，可以优先考虑使用脚本变量</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$var<span style=color:#f92672>(</span>my_name<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;wangduanduan&#34;</span>
</span></span><span style=display:flex><span>$var<span style=color:#f92672>(</span>log_msg<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> $var<span style=color:#f92672>(</span>my_name<span style=color:#f92672>)</span> + $ci + $fu
</span></span><span style=display:flex><span>xlog<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;</span>$var<span style=color:#e6db74>(log_msg)&#34;</span><span style=color:#f92672>)</span>
</span></span></code></pre></div><h1 id=脚本翻译>脚本翻译<a hidden class=anchor aria-hidden=true href=#脚本翻译>#</a></h1><p>脚本翻译可以理解为一种工具函数，可以用来获取字符串长度，获取字符串的子字符等等操作。</p><table><thead><tr><th>获取字符串长度</th><th>$(fu{s.len})</th><th></th></tr></thead><tbody><tr><td>字符串截取子串</td><td>$(var(x){s.substr,5,2})</td><td></td></tr><tr><td>获取字符串的某部分</td><td>$(avp(my_uri){uri.user})</td><td></td></tr><tr><td>将字符串值转为整数</td><td>$(var(x){s.int})</td><td></td></tr><tr><td>翻译也可以链式调用</td><td>$(hdr(Test){s.escape.common}{s.len})</td><td></td></tr></tbody></table></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://wdd.js.org>洞香春</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>