<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>OpenSIPS2.4.X 中文实战系列 | 洞香春</title><meta name=keywords content><meta name=description content="OpenSIPS VOIP"><meta name=author content="Eddie Wang"><link rel=canonical href=https://wdd.js.org/opensips/><link crossorigin=anonymous href=/assets/css/stylesheet.a2acda249b8eac62938bb2d2f1c562c5f74d5728640d2a1a7d6aeaec5c50ef24.css integrity="sha256-oqzaJJuOrGKTi7LS8cVixfdNVyhkDSoafWrq7FxQ7yQ=" rel="preload stylesheet" as=style><link rel=icon href=https://wdd.js.org/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/favicon.ico><link rel=apple-touch-icon href=https://wdd.js.org/favicon.ico><link rel=mask-icon href=https://wdd.js.org/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://wdd.js.org/opensips/index.xml title=rss><link rel=alternate hreflang=en href=https://wdd.js.org/opensips/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/firacode@6.2.0/distr/fira_code.css><style>body{font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,helvetica neue,Arial,noto sans,sans-serif,apple color emoji,segoe ui emoji;font-size:16px;line-height:1.6;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}h1,h2,h3,h4,h5,h6{font-weight:600;letter-spacing:-.02em}code,pre{font-family:fira code,jetbrains mono,Consolas,monospace;font-variant-ligatures:normal;font-size:.95em}</style><meta property="og:url" content="https://wdd.js.org/opensips/"><meta property="og:site_name" content="洞香春"><meta property="og:title" content="OpenSIPS2.4.X 中文实战系列"><meta property="og:description" content="OpenSIPS VOIP"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta name=twitter:card content="summary"><meta name=twitter:title content="OpenSIPS2.4.X 中文实战系列"><meta name=twitter:description content="OpenSIPS VOIP"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"OpenSIPS2.4.X 中文实战系列","item":"https://wdd.js.org/opensips/"}]}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org/ accesskey=h title="洞香春 (Alt + H)"><img src=https://wdd.js.org/favicon.ico alt aria-label=logo height=35>洞香春</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span class=active>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/kamailio/ title=Kamailio><span>Kamailio</span></a></li><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/books/ title=读书><span>读书</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/fe/ title=前端><span>前端</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://wdd.js.org/>Home</a></div><h1>OpenSIPS2.4.X 中文实战系列</h1><div class=post-description>OpenSIPS VOIP</div></header><div class=post-content><p>本系列文章是我在学习 OpenSIPS 过程中，慢慢总结出来的。虽说是实战，但是笔记的成分可能会多点，我也无法保证里面的内容是否完全正确。</p><p>VOIP 对我来说是个比较陌生的领域。进入这个领域可以说是一个意外。在学习过程和实战过程中，我发现了 VOIP 有很大的复杂性。生产环境也会有常常有怪异棘手的各种问题。在解决这些问题的过程中，有种升级打怪的感觉。</p><p>本知识库重点在于讲解 OpenSIPS，当然其中也涵盖了 SIP 协议，FreeSWITCH, rtpproxy, rtpengine，以及一些排查问题的工具。</p><p>推荐在学习的过程中，一定要啃一遍 RFC 3261 协议，这是 VOIP 的基石。</p><h1 id=opensips交流微信群>OpenSIPS交流微信群<a hidden class=anchor aria-hidden=true href=#opensips交流微信群>#</a></h1><p>加微信 <strong>suguswang177</strong>, 备注 opensips, 拉你进 opensips 交流群。</p><h1 id=关于作者>关于作者<a hidden class=anchor aria-hidden=true href=#关于作者>#</a></h1><p>7年VoIP工作经验，前端/软交换开发。持续在SIP、OpenSIPS、Kamailio、WebRTC方向深耕。</p><p>热爱开源，热爱分享， 也对能够交流技术或探索契合方向的工作机会保持开放态度。微信ID：suguswang177</p><h1 id=文章目录>文章目录<a hidden class=anchor aria-hidden=true href=#文章目录>#</a></h1><ul><li><p>1: SIP 协议</p><ul><li><a href=/opensips/ch1/study-tips>1.1 学习建议</a></li><li><a href=/opensips/ch1/sip-overview>1.2 SIP 协议简介</a></li><li><a href=ch1/via-route-record-route>1.3 Via route Record-Route 的区别</a></li><li><a href=/opensips/ch1/sip-path>1.4 SIP Path 头</a></li><li><a href=/opensips/ch1/trunk-pbx-gateway>1.5 Trunk PBX Gateway</a></li><li><a href=/opensips/ch1/sip-notes>1.6 SIP 协议拾遗补缺</a></li><li><a href=/opensips/ch1/sip-with-sdp>1.7 SIP 与 SDP 的关系</a></li><li><a href=/opensips/ch1/nat-sip-rtp>1.8 SIP 信令和媒体都绕不开的 NAT 问题</a></li><li><a href=/opensips/ch1/stun-notes>1.9 STUN 协议笔记</a></li><li><a href=/opensips/ch1/sip-register>1.10 SIP 注册调研</a></li><li><a href=/opensips/ch1/sip-ack>1.11 深入 SIP ACK 消息</a></li><li><a href=/opensips/ch1/ua-answer-mode>1.12 UA 应答模式</a></li><li><a href=/opensips/ch1/deep-in-nat>1.13 NAT 深入学习</a></li><li><a href=/opensips/ch1/fix-nat>1.14 解决 NAT 问题</a></li><li><a href=/opensips/ch1/from-to-request-url>1.15 From To Request URL 之间的关系</a></li><li><a href=/opensips/ch1/sip-rfcs>1.16 SIP 相关 RFC 协议</a></li><li><a href=/opensips/ch1/story-of-nat>1.17 漫话 NAT 的历史</a></li><li><a href=/opensips/ch1/offer-answer>1.18 媒体协商 offer/answer 模型</a></li><li><a href=/opensips/ch1/sip-rtp-path>1.19 媒体路径与信令路径</a></li><li><a href=/opensips/ch1/csta-call-model>1.20 CSTA 呼叫模型简介</a></li></ul></li><li><ol start=2><li>常识</li></ol><ul><li><a href=/opensips/ch2/early-media-type>2.1 几种常用电话信号音的含义</a></li><li><a href=/opensips/ch2/early-media>2.2 回铃音</a></li><li><a href=/opensips/ch2/axb>2.3 AXB的玩法说明</a></li></ul></li><li><ol start=3><li>OpenSIPS安装与管理</li></ol><ul><li><a href=/opensips/ch3/about-opensips>3.1 opensips介绍</a></li><li><a href=/opensips/ch3/install-opensips>3.2 debian jessie opensips 2.4.7 安装</a></li><li><a href=/opensips/ch3/centos-install>3.3 centos7 安装opensips</a></li><li><a href=/opensips/ch3/log>3.4 设置独立日志文件</a></li><li><a href=/opensips/ch3/core-mi>3.5 核心MI命令</a></li><li><a href=/opensips/ch3/opensipsctl>3.6 opensips管理命令</a></li><li><a href=/opensips/ch3/centos7-2.4/>3.7 centos7 2.2 升级到2.4.6</a></li><li><a href=/opensips/ch3/opensips-monitor/>3.8 OpenSIPS监控</a></li><li><a href=/opensips/ch3/cache-reload/>3.9 模块缓存策略与reload方法</a></li><li><a href=/opensips/ch3/sip-crlf/>3.10 SIP消息格式CRLF</a></li><li><a href=/opensips/ch3/elk/>3.10 opensips日志写入elasticsearch</a></li><li><a href=/opensips/ch3/prd-warning/>3.10 生产环境监控告警</a></li></ul></li><li><ol start=4><li>媒体相关</li></ol><ul><li><a href=/opensips/ch4/rtp-timestamp/>4.1 RTP 不连续的timestamp和SSRC</a></li><li><a href=/opensips/ch4/media-codec/>4.2 常见媒体流编码及其特点</a></li><li><a href=/opensips/ch4/rtp-record/>4.2 rtpproxy录音</a></li><li><a href=/opensips/ch4/codec-table/>4.2 rtp编码表</a></li></ul></li><li><ol start=5><li>配置文件和路由脚本</li></ol><ul><li><a href=/opensips/ch5/routing-script/>5.1 配置文件</a></li><li><a href=/opensips/ch5/global-params/>5.2 全局参数配置</a></li><li><a href=/opensips/ch5/routing-type/>5.3 路由分类</a></li><li><a href=/opensips/ch5/triger-time/>5.4 路由的触发时机</a></li><li><a href=/opensipsch5/strict-loose-routing/>5.5 严格路由和松散路由</a></li><li><a href=/opensips/ch5/function/>5.6 函数特点</a></li><li><a href=/opensips/ch5/return/>5.7 使用return语句减少逻辑嵌套</a></li><li><a href=/opensips/ch5/condition/>5.8 条件语句特点</a></li><li><a href=/opensips/ch5/statement/>5.9 常用语句</a></li><li><a href=/opensips/ch5/var/>5.10 变量的使用</a></li><li><a href=/opensips/ch5/core-var/>5.11 核心变量说明</a></li><li><a href=/opensips/ch5/xlog/>5.12 优雅的使用xlog输出日志行</a></li><li><a href=/opensips/ch5/module/>5.13 脚本路由模块化</a></li><li><a href=/opensips/ch5/stateful-stateless/>5.14 有状态和无状态路由</a></li><li><a href=/opensips/ch5/init-seque/>5.15 【重点】初始化请求和序列化请求</a></li><li><a href=/opensips/ch5/via-route/>5.16 SIP路由头</a></li><li><a href=/opensips/ch5/avp-db-query/>5.17 avp_db_query数值null值比较</a></li><li><a href=/opensips/ch5/xlog-level/>5.18 日志xlog</a></li><li><a href=/opensips/ch5/homer6/>5.19 opensips 集成 homer6</a></li><li><a href=/opensips/ch5/adv-address/>5.20 【必读】深入对外公布地址</a></li><li><a href=/opensips/ch5/m4/>5.21 使用m4增强opensips.cfg脚本预处理能力</a></li><li><a href=/opensips/ch5/db-mode/>5.22 db_mode调优</a></li><li><a href=/opensips/ch5/sql-table/>5.23 mysql建表语句</a></li><li><a href=/opensips/ch5/core-var-2/>5.24 核心变量解读2-100%</a></li></ul></li><li><ol start=6><li>模块使用教程</li></ol><ul><li><a href=/opensips/ch6/acc/>6.1 acc呼叫记录模块</a></li><li><a href=/opensips/ch6/cachedb/>6.2 cachedb的相关问题</a></li><li><a href=/opensips/ch6/load-balance/>6.3 负载均衡模块load_balance</a></li><li><a href=/opensips/ch6/dispatcher/>6.4 sip消息分发之dispatcher模块</a></li></ul></li><li><ol start=7><li>常见问题</li></ol><ul><li><a href=/opensips/ch7/tm-send-failed/>7.1 opensips 477 Send failed (477/TM)</a></li><li><a href=/opensips/ch7/sendmsg-failed/>7.2 sendmsg failed on 0: Socket operation on non-socket</a></li><li><a href=/opensips/ch7/escape-msg/>7.3 信令路径逃逸分析</a></li><li><a href=/opensips/ch7/crash/>7.4 opensips崩溃分析</a></li><li><a href=/opensips/ch7/can-not-run/>7.5 opensips无法启动</a></li><li><a href=/opensips/ch7/big-udp-msg/>7.6 UDP分片导致SIP消息丢失</a></li><li><a href=/opensips/ch7/rtp-broken-connection>7.7 奥科网关 Rtp Broken Connection</a></li><li><a href=/opensips/ch7/miss-ack/>7.8 ACK 无法正常送到FS</a></li><li><a href=/opensips/ch7/30-seconds-drop/>7.9 30秒自动挂断</a></li><li><a href=/opensips/ch7/cfg-trace/>7.10 script_trace 打印opensips的脚本执行过程</a></li><li><a href=/opensips/ch7/one-leg-audio/>7.11 一方听不到另外一方的声音</a></li><li><a href=/opensips/ch7/echo-back/>7.12 回音问题调研</a></li><li><a href=/opensips/ch7/without-log/>7.13 opensips启动失败没有任何报错日志</a></li><li><a href=/opensips/ch7/poor-quality/>7.14 通话质量差</a></li><li><a href=/opensips/ch7/without-default-carrier/>7.15 ERROR:carrierroute:carrier_tree_fixup: default_carrier not found</a></li></ul></li><li><ol start=8><li>脚本学习</li></ol><ul><li><a href=/opensips/ch8/topology-hiding/>8.1 拓扑隐藏学习以及实践</a></li><li><a href=/opensips/ch8/serial-183/>8.2 serial_183</a></li><li><a href=/opensips/ch8/replicate/>8.3 replicate</a></li><li><a href=/opensips/ch8/redirect/>8.4 redirect</a></li><li><a href=/opensips/ch8/pstn/>8.5 pstn</a></li><li><a href=/opensips/ch8/nathelper/>8.6 nathelper</a></li><li><a href=/opensips/ch8/msilo/>8.7 msilo</a></li><li><a href=/opensips/ch8/logging/>8.8 logging</a></li><li><a href=/opensips/ch8/httpd/>8.9 httpd</a></li><li><a href=/opensips/ch8/fork/>8.10 fork</a></li><li><a href=/opensips/ch8/flag-reply/>8.11 flag reply</a></li><li><a href=/opensips/ch8/exec/>8.12 exec</a></li><li><a href=/opensips/ch8/acc/>8.13 acc</a></li><li><a href=/opensips/ch8/acc-mysql/>8.14 acc-mysql</a></li><li><a href=/opensips/ch8/default/>8.15 default</a></li><li><a href=/opensips/ch8/mid-register/>8.16 mid register</a></li><li><a href=/opensips/ch8/fs-loadbalance/>8.17 fs loadbalance</a></li><li><a href=/opensips/ch8/fraud/>8.18 fraud</a></li><li><a href=/opensips/ch8/dtmf-lan/>8.19 dtmf</a></li><li><a href=/opensips/ch8/siprec/>8.20 siprec</a></li></ul></li><li><ol start=9><li>扩展</li></ol><ul><li><a href=/opensips/ch9/webrtc-ref/>9.1 WebRTC学习资料分享</a></li><li><a href=/opensips/ch9/notes/>9.2 WebRTC简介</a></li><li><a href=/opensips/ch9/webrtc-pdf/>9.3 opensips with webrtc</a></li><li><a href=/opensips/ch9/blf/>9.4 BLF指示灯</a></li><li><a href=/opensips/ch9/isup-sip-isdn/>9.5 ISUP SIP ISDN对照码表</a></li><li><a href=/opensips/ch9/rtpengine-manu/>9.6 rtpengine cli</a></li><li><a href=/opensips/ch9/rtpengine-ilbc/>9.7 rtpengine 增加对ilbc编解码的支持</a></li><li><a href=/opensips/ch9/sdp/>9.8 sdp协议简介</a></li><li><a href=/opensips/ch9/rtpproxy/>9.9 rtpproxy学习</a></li><li><a href=/opensips/ch9/feature-code/>9.10 SIP feature codes SIP功能码</a></li><li><a href=/opensips/ch9/100-rel/>9.11 sbc 100rel</a></li><li><a href=/opensips/ch9/blf-note/>9.12 blf 功能笔记</a></li><li><a href=/opensips/ch9/nat-single-interface/>9.13 NAT场景下的信令处理 - 单网卡</a></li><li><a href=/opensips/ch9/cluster-share-location/>9.14 集群共享分机注册信息</a></li><li><a href=/opensips/ch9/books/>9.15 参考资料与书籍</a></li></ul></li><li><ol start=10><li>相关工具</li></ol><ul><li><a href=/opensips/tools/tshark/>10.1 tshark 快速分析语音流问题</a></li><li><a href=/opensips/tools/heplify/>10.2 heplify SIP信令抓包客户端</a></li><li><a href=/opensips/tools/baresip/>10.3 baresip 非常好用的终端SIP UA</a></li><li><a href=/opensips/tools/sipsak/>10.4 sipsak</a></li><li><a href=/opensips/tools/wireshark-player-pcap/>10.5 wireshark 播放抓包文件</a></li><li><a href=/opensips/tools/sngrep/>10.6 sngrep: 最好用的sip可视化抓包工具</a></li><li><a href=/opensips/tools/homer/>10.7 homer: 统一的sip包集中处理工具</a></li><li><a href=/opensips/tools/siphub/>10.8 siphub 轻量级实时SIP信令收包的服务</a></li><li><a href=/opensips/tools/sipp/>10.9 SIPp：sip压测模拟ua工具</a></li><li><a href=/opensips/tools/sipp-subscriber/>10.10 SIPP subscriber 测试</a></li><li><a href=/opensips/tools/tcp-dump/>10.11 tcpdump</a></li><li><a href=/opensips/tools/pjsip/>10.12 pjsip</a></li><li><a href=/opensips/tools/wireshark-sip/>10.13 Wireshark SIP 抓包</a></li><li><a href=/opensips/tools/kamailio/>10.14 另一个功能强大的sip server: kamailio</a></li></ul></li><li><ol start=11><li>官方博客</li></ol><ul><li><a href=/opensips/blog/load-balance/>Load Balancing in OpenSIPS</a></li><li><a href=/opensips/blog/dialog-trigers/>Dialog triggers, or how to control the calls from script</a></li><li><a href=/opensips/blog/cross-dialog-data/>Cross-dialog data accessing</a></li><li><a href=/opensips/blog/calls-manager/>Calls management using the new Call API tool</a></li><li><a href=/opensips/blog/call-stat/>Improved series-based call statistics using OpenSIPS 3.2</a></li><li><a href=/opensips/blog/opensips3-tls/>Exploring SSL/TLS libraries for OpenSIPS 3.2</a></li><li><a href=/opensips/blog/openssl-opensips/>The OpenSIPS and OpenSSL journey</a></li><li><a href=/opensips/blog/mutltiple-interface/>SIP bridging over multiple interfaces</a></li><li><a href=/opensips/blog/cancel-reason/>CANCEL请求和Reason头</a></li><li><a href=/opensips/blog/opensips3x/>Introducing OpenSIPS 3.0</a></li><li><a href=/opensips/blog/cluster-location/>Clustered SIP User Location: The Full Sharing Topology</a></li><li><a href=/opensips/blog/cluster-call/>Clustering ongoing calls with OpenSIPS 2.4</a></li><li><a href=/opensips/blog/full-anycast/>Full Anycast support in OpenSIPS 2.4</a></li><li><a href=/opensips/blog/deepin-stat-engine/>深入OpenSIPS统计引擎</a></li><li><a href=/opensips/blog/runing-opensips-in-cloud/>Running OpenSIPS in the Cloud</a></li><li><a href=/opensips/blog/troubleshooting-opensips-script/>Troubleshooting OpenSIPS script</a></li><li><a href=/opensips/blog/miss-ack/>Troubleshooting missing ACK in SIP</a></li><li><a href=/opensips/blog/memory-usage/>理解并测量OpenSIPS的内存资源</a></li></ul></li><li><p>问题列表</p><ul><li><a href=/opensips/ch1/utime-task-scheduled>utimer task already scheduled</a></li></ul></li><li><p>OpenSIPS 3X</p><ul><li><a href=/opensips/3x/module-args/>模块传参的重构</a></li></ul></li><li><p><a href=/opensips/module-dev/>模块开发实战</a></p></li><li><p><a href=/opensips/pdf/>OpenSIPS Summit PDF学习资料</a></p></li><li><p><a href=/opensips/dev-audio/>源码学习视频教程</a></p></li></ul><h1 id=文章列表>文章列表<a hidden class=anchor aria-hidden=true href=#文章列表>#</a></h1></div><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>mid-registrar</h2></header><div class=entry-content><p># # $Id$ # # OpenSIPS residential configuration script # by OpenSIPS Solutions &lt;team@opensips-solutions.com> # # This script was generated via "make menuconfig", from # the "Residential" scenario. # You can enable / disable more features / functionalities by # re-generating the scenario with different options.# # # Please refer to the Core CookBook at: # http://www.opensips.org/Resources/DocsCookbooks # for a explanation of possible statements, functions and parameters. # ####### Global Parameters ######### log_level=4 log_stderror=yes log_facility=LOG_LOCAL0 children=4 /* uncomment the following line to enable debugging */ #debug_mode=yes /* uncomment the next line to enable the auto temporary blacklisting of not available destinations (default disabled) */ #disable_dns_blacklist=no /* uncomment the next line to enable IPv6 lookup after IPv4 dns lookup failures (default disabled) */ #dns_try_ipv6=yes /* comment the next line to enable the auto discovery of local aliases based on revers DNS on IPs */ auto_aliases=no listen=udp:10.0.0.3:5060 # CUSTOMIZE ME ####### Modules Section ######## #set module path mpath="/usr/local/lib/opensips/modules/" loadmodule "mid_registrar.so" modparam("mid_registrar", "mode", 2) /* 0 = mirror / 1 = ct / 2 = AoR */ modparam("mid_registrar", "outgoing_expires", 7200) modparam("mid_registrar", "insertion_mode", 0) /* 0 = contact; 1 = path */ #### SIGNALING module loadmodule "signaling.so" #### StateLess module loadmodule "sl.so" #### Transaction Module loadmodule "tm.so" modparam("tm", "fr_timeout", 5) modparam("tm", "fr_inv_timeout", 30) modparam("tm", "restart_fr_on_each_reply", 0) modparam("tm", "onreply_avp_mode", 1) #### Record Route Module loadmodule "rr.so" /* do not append from tag to the RR (no need for this script) */ modparam("rr", "append_fromtag", 0) #### MAX ForWarD module loadmodule "maxfwd.so" #### SIP MSG OPerationS module loadmodule "sipmsgops.so" #### FIFO Management Interface loadmodule "mi_fifo.so" modparam("mi_fifo", "fifo_name", "/tmp/opensips_fifo") modparam("mi_fifo", "fifo_mode", 0666) #### URI module loadmodule "uri.so" modparam("uri", "use_uri_table", 0) #### USeR LOCation module loadmodule "usrloc.so" modparam("usrloc", "nat_bflag", "NAT") modparam("usrloc", "db_mode", 0) #### REGISTRAR module loadmodule "registrar.so" /* uncomment the next line not to allow more than 10 contacts per AOR */ #modparam("registrar", "max_contacts", 10) #### ACCounting module loadmodule "acc.so" /* what special events should be accounted ? */ modparam("acc", "early_media", 0) modparam("acc", "report_cancels", 0) /* by default we do not adjust the direct of the sequential requests. if you enable this parameter, be sure the enable "append_fromtag" in "rr" module */ modparam("acc", "detect_direction", 0) #### UDP protocol loadmodule "proto_udp.so" ####### Routing Logic ######## # main request routing logic route{ if (!mf_process_maxfwd_header("10")) { sl_send_reply("483","Too Many Hops"); exit; } if (has_totag()) { # sequential requests within a dialog should # take the path determined by record-routing if (loose_route()) { if (is_method("BYE")) { # do accunting, even if the transaction fails do_accounting("log","failed"); } else if (is_method("INVITE")) { # even if in most of the cases is useless, do RR for # re-INVITEs alos, as some buggy clients do change route set # during the dialog. record_route(); } # route it out to whatever destination was set by loose_route() # in $du (destination URI). route(relay); } else { if ( is_method("ACK") ) { if ( t_check_trans() ) { # non loose-route, but stateful ACK; must be an ACK after # a 487 or e.g. 404 from upstream server t_relay(); exit; } else { # ACK without matching transaction -> # ignore and discard exit; } } sl_send_reply("404","Not here"); } exit; } # CANCEL processing if (is_method("CANCEL")) { if (t_check_trans()) t_relay(); exit; } t_check_trans(); if (is_method("REGISTER")) { mid_registrar_save("location"); switch ($retcode) { case 1: xlog("forwarding REGISTER to main registrar ($$ci=$ci)\n"); $ru = "sip:10.0.0.3:5070"; t_relay(); break; case 2: xlog("absorbing REGISTER! ($$ci=$ci)\n"); break; default: xlog("failed to save registration! ($$ci=$ci)\n"); } exit; } # preloaded route checking if (loose_route()) { xlog("L_ERR", "Attempt to route with preloaded Route's [$fu/$tu/$ru/$ci]"); if (!is_method("ACK")) sl_send_reply("403","Preload Route denied"); exit; } # record routing if (!is_method("REGISTER|MESSAGE")) record_route(); # account only INVITEs if (is_method("INVITE")) { do_accounting("log"); } if (!uri==myself) { append_hf("P-hint: outbound\r\n"); route(relay); } # requests for my domain if (is_method("PUBLISH|SUBSCRIBE")) { sl_send_reply("503", "Service Unavailable"); exit; } if ($rU==NULL) { # request with no Username in RURI sl_send_reply("484","Address Incomplete"); exit; } # initial requests from main registrar, need to look them up! if (is_method("INVITE|MESSAGE") && $si == "10.0.0.3" && $sp == 5070) { xlog("looking up $ru!\n"); if (!mid_registrar_lookup("location")) { t_reply("404", "Not Found"); exit; } t_relay(); exit; } # when routing via usrloc, log the missed calls also do_accounting("log","missed"); route(relay); } route[relay] { # for INVITEs enable some additional helper routes if (is_method("INVITE")) { t_on_branch("per_branch_ops"); t_on_reply("handle_nat"); t_on_failure("missed_call"); } if (!t_relay()) { send_reply("500","Internal Error"); }; exit; } branch_route[per_branch_ops] { xlog("new branch at $ru\n"); } onreply_route[handle_nat] { xlog("incoming reply\n"); } failure_route[missed_call] { if (t_was_cancelled()) { exit; } # uncomment the following lines if you want to block client # redirect based on 3xx replies. ##if (t_check_status("3[0-9][0-9]")) { ##t_reply("404","Not found"); ## exit; ##} }</p></div><footer class=entry-footer><span title='2019-07-02 22:32:02 +0800 CST'>2019-07-02 22:32:02</span>&nbsp;·&nbsp;<span>4 min</span>&nbsp;·&nbsp;<span>Eddie Wang</span></footer><a class=entry-link aria-label="post link to mid-registrar" href=https://wdd.js.org/opensips/ch8/mid-register/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>siprec</h2></header><div class=entry-content><p># # OpenSIPS residential configuration script # by OpenSIPS Solutions &lt;team@opensips-solutions.com> # # This script was generated via "make menuconfig", from # the "Residential" scenario. # You can enable / disable more features / functionalities by # re-generating the scenario with different options.# # # Please refer to the Core CookBook at: # http://www.opensips.org/Resources/DocsCookbooks # for a explanation of possible statements, functions and parameters. # ####### Global Parameters ######### log_level=3 log_stderror=no log_facility=LOG_LOCAL0 children=4 /* uncomment the following lines to enable debugging */ #debug_mode=yes /* uncomment the next line to enable the auto temporary blacklisting of not available destinations (default disabled) */ #disable_dns_blacklist=no /* uncomment the next line to enable IPv6 lookup after IPv4 dns lookup failures (default disabled) */ #dns_try_ipv6=yes /* comment the next line to enable the auto discovery of local aliases based on revers DNS on IPs */ auto_aliases=no listen=udp:127.0.0.1:5060 ####### Modules Section ######## #set module path mpath="modules/" #### SIGNALING module loadmodule "signaling.so" #### StateLess module loadmodule "sl.so" #### Transaction Module loadmodule "tm.so" modparam("tm", "fr_timeout", 5) modparam("tm", "fr_inv_timeout", 30) modparam("tm", "restart_fr_on_each_reply", 0) modparam("tm", "onreply_avp_mode", 1) #### Record Route Module loadmodule "rr.so" /* do not append from tag to the RR (no need for this script) */ modparam("rr", "append_fromtag", 0) #### MAX ForWarD module loadmodule "maxfwd.so" #### SIP MSG OPerationS module loadmodule "sipmsgops.so" #### FIFO Management Interface loadmodule "mi_fifo.so" modparam("mi_fifo", "fifo_name", "/tmp/opensips_fifo") modparam("mi_fifo", "fifo_mode", 0666) #### URI module loadmodule "uri.so" modparam("uri", "use_uri_table", 0) #### USeR LOCation module loadmodule "usrloc.so" modparam("usrloc", "nat_bflag", "NAT") modparam("usrloc", "db_mode", 0) #### REGISTRAR module loadmodule "registrar.so" modparam("registrar", "tcp_persistent_flag", "TCP_PERSISTENT") /* uncomment the next line not to allow more than 10 contacts per AOR */ #modparam("registrar", "max_contacts", 10) #### ACCounting module loadmodule "acc.so" /* what special events should be accounted ? */ modparam("acc", "early_media", 0) modparam("acc", "report_cancels", 0) /* by default we do not adjust the direct of the sequential requests. if you enable this parameter, be sure the enable "append_fromtag" in "rr" module */ modparam("acc", "detect_direction", 0) loadmodule "proto_udp.so" loadmodule "dialog.so" loadmodule "b2b_entities.so" loadmodule "siprec.so" loadmodule "rtpproxy.so" modparam("rtpproxy", "rtpproxy_sock", "udp:127.0.0.1:7899") ####### Routing Logic ######## # main request routing logic route{ if (!mf_process_maxfwd_header("10")) { sl_send_reply("483","Too Many Hops"); exit; } if (has_totag()) { # handle hop-by-hop ACK (no routing required) if ( is_method("ACK") && t_check_trans() ) { t_relay(); exit; } # sequential request within a dialog should # take the path determined by record-routing if ( !loose_route() ) { # we do record-routing for all our traffic, so we should not # receive any sequential requests without Route hdr. sl_send_reply("404","Not here"); exit; } if (is_method("BYE")) { # do accounting even if the transaction fails do_accounting("log","failed"); } # route it out to whatever destination was set by loose_route() # in $du (destination URI). route(relay); exit; } # CANCEL processing if (is_method("CANCEL")) { if (t_check_trans()) t_relay(); exit; } t_check_trans(); if ( !(is_method("REGISTER") ) ) { if (is_myself("$fd")) { } else { # if caller is not local, then called number must be local if (!is_myself("$rd")) { send_reply("403","Rely forbidden"); exit; } } } # preloaded route checking if (loose_route()) { xlog("L_ERR", "Attempt to route with preloaded Route's [$fu/$tu/$ru/$ci]"); if (!is_method("ACK")) sl_send_reply("403","Preload Route denied"); exit; } # record routing if (!is_method("REGISTER|MESSAGE")) record_route(); # account only INVITEs if (is_method("INVITE")) { create_dialog(); rtpproxy_engage(); siprec_start_recording("sip:127.0.0.1:5090"); do_accounting("log"); } if (!is_myself("$rd")) { append_hf("P-hint: outbound\r\n"); route(relay); } # requests for my domain if (is_method("PUBLISH|SUBSCRIBE")) { sl_send_reply("503", "Service Unavailable"); exit; } if (is_method("REGISTER")) { if (!save("location")) sl_reply_error(); exit; } if ($rU==NULL) { # request with no Username in RURI sl_send_reply("484","Address Incomplete"); exit; } # do lookup with method filtering if (!lookup("location","m")) { t_reply("404", "Not Found"); exit; } # when routing via usrloc, log the missed calls also do_accounting("log","missed"); route(relay); } route[relay] { # for INVITEs enable some additional helper routes if (is_method("INVITE")) { t_on_branch("per_branch_ops"); t_on_reply("handle_nat"); t_on_failure("missed_call"); } if (!t_relay()) { send_reply("500","Internal Error"); }; exit; } branch_route[per_branch_ops] { xlog("new branch at $ru\n"); } onreply_route[handle_nat] { xlog("incoming reply\n"); } failure_route[missed_call] { if (t_was_cancelled()) { exit; } # uncomment the following lines if you want to block client # redirect based on 3xx replies. ##if (t_check_status("3[0-9][0-9]")) { ##t_reply("404","Not found"); ## exit; ##} }</p></div><footer class=entry-footer><span title='2019-07-02 22:31:18 +0800 CST'>2019-07-02 22:31:18</span>&nbsp;·&nbsp;<span>4 min</span>&nbsp;·&nbsp;<span>Eddie Wang</span></footer><a class=entry-link aria-label="post link to siprec" href=https://wdd.js.org/opensips/ch8/siprec/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>sngrep: 最好用的sip可视化抓包工具</h2></header><div class=entry-content><p>1. 安装 1.1. centos vim /etc/yum.repos.d/irontec.repo
[irontec] name=Irontec RPMs repository baseurl=http://packages.irontec.com/centos/$releasever/$basearch/ rpm –import http://packages.irontec.com/public.keyyum install sngrep
1.2 debian/ubuntu # debian 安装sngrep echo "deb http://packages.irontec.com/debian jessie main" >> /etc/apt/sources.list wget http://packages.irontec.com/public.key -q -O - | apt-key add - apt-get install sngrep -y debian buster 即 debian10以上可以直接 apt-get install sngrep 1.3 arch/manjaro yay -Syu sngrep 参考： https://aur.archlinux.org/packages/sngrep/
如果报错，编辑 /etc/makepkg.conf文件，删除其中的-Werror=format-security
CFLAGS="-march=x86-64 -mtune=generic -O2 -pipe -fno-plt -fexceptions \ -Wp,-D_FORTIFY_SOURCE=2 -Wformat -Werror=format-security \ -fstack-clash-protection -fcf-protection" 1.4 macOS brew install sngrep 2. 命令行参数 Usage: sngrep [-hVcivNqrD] [-IO pcap_dump] [-d dev] [-l limit] [-B buffer] [-LHE capture_url] [&lt;match expression>] [&lt;bpf filter>] -h --help This usage -V --version Version information -d --device Use this capture device instead of default -I --input Read captured data from pcap file -O --output Write captured data to pcap file -B --buffer Set pcap buffer size in MB (default: 2) -c --calls Only display dialogs starting with INVITE -r --rtp Capture RTP packets payload -l --limit Set capture limit to N dialogs -i --icase Make &lt;match expression> case insensitive -v --invert Invert &lt;match expression> -N --no-interface Don't display sngrep interface, just capture -q --quiet Don't print captured dialogs in no interface mode -D --dump-config Print active configuration settings and exit -f --config Read configuration from file -F --no-config Do not read configuration from default config file -T --text Save pcap to text file -R --rotate Rotate calls when capture limit have been reached -H --eep-send Homer sipcapture url (udp:X.X.X.X:XXXX) -L --eep-listen Listen for encapsulated packets (udp:X.X.X.X:XXXX) -E --eep-parse Enable EEP parsing in captured packets -h --help: 显示帮助信息 -V --version: 显示版本信息 -d --device: 指定抓包的网卡 -I --input: 从pacp文件中解析sip包 -O --output: 输出捕获的包到pacp文件中 -c --calls: 仅显示invite消息 -r --rtp: Capture RTP packets payload 捕获rtp包 -l --limit: 限制捕获对话的数量 -i --icase: 使大小写不敏感 -v --invert: 颠倒（不太明白） -N --no-interface: Don’t display sngrep interface, just capture -q --quiet: Don’t print captured dialogs in no interface mode -D --dump-config: Print active configuration settings and exit -f --config: Read configuration from file -R --rotate: Rotate calls when capture limit have been reached. -H --eep-send: Homer sipcapture url (udp:X.X.X.X:XXXX) -L --eep-listen: Listen for encapsulated packets (udp:X.X.X.X:XXXX) -k --keyfile: RSA private keyfile to decrypt captured packets 3. 页面 sngrep有四个页面，每个页面都有一些不同的快捷键。
...</p></div><footer class=entry-footer><span title='2019-07-02 22:19:09 +0800 CST'>2019-07-02 22:19:09</span>&nbsp;·&nbsp;<span>4 min</span>&nbsp;·&nbsp;<span>Eddie Wang</span></footer><a class=entry-link aria-label="post link to sngrep: 最好用的sip可视化抓包工具" href=https://wdd.js.org/opensips/tools/sngrep/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>opensips监控</h2></header><div class=entry-content><p>**opensipsctl fifo get_statistics all **命令可以获取所有统计数据，在所有统计数据中，我们只关心内存，事务和回话的数量。然后将数据使用curl工具写入到influxdb中。
opensipsctl fifo reset_statistics all 重置统计数据
常用指令 命令 描述 opensipsctl fifo which 显示所有可用命令 opensipsctl fifo ps 显示所有进程 opensipsctl fifo get_statistics all 获取所有统计信息 opensipsctl fifo get_statistics core: 获取内核统计信息 opensipsctl fifo get_statistics net: 获取网路统计信息 opensipsctl fifo get_statistics pkmem: 获取私有内存相关信息 opensipsctl fifo get_statistics tm: 获取事务模块统计信息 opensipsctl fifo get_statistics sl: 获取sl模块统计信息 opensipsctl fifo get statistics shmem: 获取共享内存相关信息 opensipsctl fifo get statistics usrloc: 获取 opensipsctl fifo get statistics registrar: 获取注册统计信息 opensipsctl fifo get statistics uri: 获取uri统计信息 opensipsctl fifo get statistics load: 获取负载信息 opensipsctl fifo reset_statistics all 重置所有统计信息 shmem:total_size:: 6467616768 shmem:used_size:: 4578374040 shmem:real_used_size:: 4728909408 shmem:max_used_size:: 4728909408 shmem:free_size:: 1738707360 shmem:fragments:: 1 # 事务 tm:UAS_transactions:: 296337 tm:UAC_transactions:: 30 tm:2xx_transactions:: 174737 tm:3xx_transactions:: 0 tm:4xx_transactions:: 110571 tm:5xx_transactions:: 2170 tm:6xx_transactions:: 0 tm:inuse_transactions:: 289651 dialog:active_dialogs:: 156 dialog:early_dialogs:: 680 dialog:processed_dialogs:: 104061 dialog:expired_dialogs:: 964 dialog:failed_dialogs:: 78457 dialog:create_sent:: 0 dialog:update_sent:: 0 dialog:delete_sent:: 0 dialog:create_recv:: 0 dialog:update_recv:: 0 dialog:delete_recv:: 0 CONF_DB_URL="ip:port" # influxdb地址 CONF_DB_NAME="dbname" # influxdb数据库名 CONF_OPENSIPS_ROLE="a" # 角色，随便写个字符串 PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin" LOCAL_IP=`ip route get 8.8.8.8 | head -n +1 | tr -s " " | cut -d " " -f 7` MSG=`opensipsctl fifo get_statistics all | grep -E "tm:|shmem:|dialog" | awk -F ':: ' 'BEGIN{OFS="=";ORS=","} {print $1,$2}' | sed 's/[-:.]/_/g'` MSG=${MSG:0:${#MSG}-1} echo $MSG influxdb="http://$CONF_DB_URL/write?db=$CONF_DB_NAME" curl -i -XPOST $influxdb --data-binary "opensips,type=$CONF_OPENSIPS_ROLE,ip=$LOCAL_IP $MSG" shmem:total_size:: 33554432shmem:used_size:: 2910624shmem:real_used_size:: 3722856shmem:max_used_size:: 21963544shmem:free_size:: 29831576shmem:fragments:: 30761core:rcv_requests:: 1625972core:rcv_replies:: 580098core:fwd_requests:: 26146core:fwd_replies:: 0core:drop_requests:: 27core:drop_replies:: 0core:err_requests:: 0core:err_replies:: 0core:bad_URIs_rcvd:: 0core:unsupported_methods:: 0core:bad_msg_hdr:: 0core:timestamp:: 179429net:waiting_udp:: 0net:waiting_tcp:: 0sl:1xx_replies:: 0sl:2xx_replies:: 930643sl:3xx_replies:: 0sl:4xx_replies:: 265459sl:5xx_replies:: 168472sl:6xx_replies:: 0sl:sent_replies:: 1364574sl:sent_err_replies:: 0sl:received_ACKs:: 27tm:received_replies:: 570374tm:relayed_replies:: 402332tm:local_replies:: 155868tm:UAS_transactions:: 181106tm:UAC_transactions:: 71770tm:2xx_transactions:: 117167tm:3xx_transactions:: 0tm:4xx_transactions:: 138052tm:5xx_transactions:: 29tm:6xx_transactions:: 0tm:inuse_transactions:: 2uri:positive checks:: 195024uri:negative_checks:: 0usrloc:registered_users:: 0usrloc:location-users:: 0usrloc:location-contacts:: 0usrloc:location-expires:: 0registrar:max_expires:: 180registrar:max_contacts:: 1registrar:default_expire:: 150registrar:accepted_regs:: 110781registrar:rejected_regs:: 84236dialog:active_dialogs:: 0dialog:early_dialogs:: 0dialog:processed_dialogs:: 150397dialog:expired_dialogs:: 0dialog:failed_dialogs:: 137297dialog:create_sent:: 0dialog:update_sent:: 0dialog:delete_sent:: 0dialog:create_recv:: 0dialog:update_recv:: 0dialog:delete_recv:: 0</p></div><footer class=entry-footer><span title='2019-07-02 22:09:10 +0800 CST'>2019-07-02 22:09:10</span>&nbsp;·&nbsp;<span>2 min</span>&nbsp;·&nbsp;<span>Eddie Wang</span></footer><a class=entry-link aria-label="post link to opensips监控" href=https://wdd.js.org/opensips/ch3/opensips-monitor/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>opensips centos7 安装与升级</h2></header><div class=entry-content><p>环境声明 系统 centos7 已经安装opensips 2.2 需要升级目标 opensips 2.4.6 要求：当前系统上没有部署mysql服务端程序 升级步骤 升级分为两步
opensips 应用升级，包括源码的下载，编译等等 opensips 数据库升级，使用opensipsdbctl工具迁移老的数据 Edge: opensips应用升级 升级过程以Makefile交付，可以先新建一个空的目录，如 /root/opensips-update/
# file: /root/opensips-update/Makefile VERSION=2.4.6 download: wget https://opensips.org/pub/opensips/$(VERSION)/opensips-$(VERSION).tar.gz; tar -zxvf opensips-$(VERSION).tar.gz; build: cd opensips-$(VERSION); make all -j4 include_modules="db_mysql httpd db_http siprec"; # siprec是可选的 make install include_modules="db_mysql httpd db_http siprec"; # siprec是可选的 新建空目录/root/opensips-update/ 在新目录中创建名为 Makefile的文件, 内容如上面所示 执行 make download 执行 make build Core: opensips应用升级 make all -j4 include_modules="db_mysql httpd" make install include_modules="db_mysql httpd" 可能遇到的报错以及解决方案 主要的问题可能是某些包冲突，或者某些库没有安装依赖。在解决问题后，需要重新编译。
...</p></div><footer class=entry-footer><span title='2019-07-02 19:42:05 +0800 CST'>2019-07-02 19:42:05</span>&nbsp;·&nbsp;<span>5 min</span>&nbsp;·&nbsp;<span>Eddie Wang</span></footer><a class=entry-link aria-label="post link to opensips centos7 安装与升级" href=https://wdd.js.org/opensips/ch3/centos7-2.4/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>rtpproxy学习</h2></header><div class=entry-content><p>rtppoxy能提供什么功能？ VoIP NAT穿透 传输声音、视频等任何RTP流 播放预先设置的呼入放音 RTP包重新分片 包传输优化 VoIP VPN 穿透 实时流复制 rtpproxy一般和那些软件集成？ opensips Kamailio Sippy B2BUA freeswitch reSIProcate B2BUA rtpporxy的工作原理 启动参数介绍 参数 功能说明 例子 -l ipv4监听的地址 -l 192.168.3.47 -6 ipv6监听的地址 -s 控制Socket, 通过这个socket来修改，创建或者删除rtp session -s udp:192.168.3.49:6890 -F 默认情况下，rtpproxy会警告用户以超级用户的身份运行rtpproxy并且不允许远程控制。使用-F可以关闭这个限制 -m 最小使用的端口号，默认35000 -m 20000 -M 最大使用的端口号，默认65000 -M 50000 -L 单个进程最多可以使用的文件描述符。rtpproxy要求每个session使用4个文件描述符。 -L 20000 -d 日志级别，可选DBUG, INFO, WARN, ERR and CRIT, 默认DBUG -d ERR -A 广播地址，用于rtpprxy在NAT防火墙内部时使用 -A 171.16.200.13 -f 让rtpproxy前台运行，在做rtpproxy容器化时，启动脚本必须带有-f，否则容器运行后会立即退出 -V 输出rtpproxy的版本 参考 https://www.rtpproxy.org/ https://www.rtpproxy.org/doc/master/user_manual.html https://github.com/sippy/rtpproxy</p></div><footer class=entry-footer><span title='2019-06-20 21:24:10 +0800 CST'>2019-06-20 21:24:10</span>&nbsp;·&nbsp;<span>1 min</span>&nbsp;·&nbsp;<span>Eddie Wang</span></footer><a class=entry-link aria-label="post link to rtpproxy学习" href=https://wdd.js.org/opensips/ch9/rtpproxy/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>sdp协议简介</h2></header><div class=entry-content><p>sdp栗子 v=0 o=- 7158718066157017333 2 IN IP4 127.0.0.1 s=- t=0 0 a=group:BUNDLE 0 a=msid-semantic: WMS byn72RFJBCUzdSPhnaBU4vSz7LFwfwNaF2Sy m=audio 64030 UDP/TLS/RTP/SAVPF 111 103 104 9 0 8 106 105 13 110 112 113 126 c=IN IP4 192.168.2.180 Session描述 **
v= (protocol version number, currently only 0) o= (originator and session identifier : username, id, version number, network address) s= (session name : mandatory with at least one UTF-8-encoded character) i=* (session title or short information) u=* (URI of description) e=* (zero or more email address with optional name of contacts) p=* (zero or more phone number with optional name of contacts) c=* (connection information—not required if included in all media) b=* (zero or more bandwidth information lines) One or more Time descriptions ("t=" and "r=" lines; see below) z=* (time zone adjustments) k=* (encryption key) a=* (zero or more session attribute lines) Zero or more Media descriptions (each one starting by an "m=" line; see below) 时间描述(必须) t= (time the session is active) r=* (zero or more repeat times) 媒体描述(可选) m= (media name and transport address) i=* (media title or information field) c=* (connection information — optional if included at session level) b=* (zero or more bandwidth information lines) k=* (encryption key) a=* (zero or more media attribute lines — overriding the Session attribute lines)</p></div><footer class=entry-footer><span title='2019-06-20 15:29:36 +0800 CST'>2019-06-20 15:29:36</span>&nbsp;·&nbsp;<span>1 min</span>&nbsp;·&nbsp;<span>Eddie Wang</span></footer><a class=entry-link aria-label="post link to sdp协议简介" href=https://wdd.js.org/opensips/ch9/sdp/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>参考资料与书籍</h2></header><div class=entry-content><p>Building Telephony Systems with OpenSIPS Second Edition SIP: Session Initiation Protocol Session Initiation Protocol (SIP) Basic Call Flow Examples Re-INVITE and Target-Refresh Request Handling in the Session Initiation Protocol (SIP) SDP: Session Description Protocol freeswitch权威指南 SIP: Understanding the Session Initiation Protocol, Third Edition (Artech House Telecommunications) https://tools.ietf.org/html/rfc4028 Hacking VoIP: Protocols, Attacks, and Countermeasures</p></div><footer class=entry-footer><span title='2019-06-20 10:59:17 +0800 CST'>2019-06-20 10:59:17</span>&nbsp;·&nbsp;<span>1 min</span>&nbsp;·&nbsp;<span>Eddie Wang</span></footer><a class=entry-link aria-label="post link to 参考资料与书籍" href=https://wdd.js.org/opensips/ch9/books/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>有状态和无状态路由</h2></header><div class=entry-content><p>操作 无状态 有状态 SIP forward forward() t_relay() SIP replying sl_send_reply() t_reply() Create transaction t_newtran() Match transcation t_check_trans()</p></div><footer class=entry-footer><span title='2019-06-19 23:40:08 +0800 CST'>2019-06-19 23:40:08</span>&nbsp;·&nbsp;<span>1 min</span>&nbsp;·&nbsp;<span>Eddie Wang</span></footer><a class=entry-link aria-label="post link to 有状态和无状态路由" href=https://wdd.js.org/opensips/ch5/stateful-stateless/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>严格路由和松散路由</h2></header><div class=entry-content><p>松散路由是sip 2版本的新的路由方法。严格路由是老的路由方法。
如何从sip消息中区分严格路由和松散路由 下图sip消息中Route字段中带有**lr, **则说明这是松散路由。
REGISTER sip:127.0.0.1 SIP/2.0 Via: SIP/2.0/UDP 127.0.0.1:58979;rport;branch=z9hG4bKPjMRzNdeTKn9rHNDtyJuVoyrDb84.cPtL8 Route: &lt;sip:127.0.0.1;lr> Max-Forwards: 70 From: "1001" &lt;sip:1001@172.17.0.2>;tag=oqkOzbQYd9cx5vXFjUnB1WufgWUZZxtZ To: "1001" &lt;sip:1001@172.17.0.2> 功能上的区别 严格路由，sip请求经过uas后，invite url每次都会被重写。
松散路由，sip请求经过uas后，invite url不变。
#1 invite INVITE sip:callee@domain.com SIP/2.0 Contact: sip:caller@u1.example.com #2 invite INVITE sip:callee@domain.com SIP/2.0 Contact: sip:caller@u1.example.com Record-Route: &lt;sip:p1.example.com;lr> #3 invite INVITE sip:callee@u2.domain.com SIP/2.0 Contact: sip:caller@u1.example.com Record-Route: &lt;sip:p2.domain.com;lr> Record-Route: &lt;sip:p1.example.com;lr> #4 200 ok SIP/2.0 200 OK Contact: sip:callee@u2.domain.com Record-Route: &lt;sip:p2.domain.com;lr> Record-Route: &lt;sip:p1.example.com;lr> #7 bye BYE sip:callee@u2.domain.com SIP/2.0 Route: &lt;sip:p1.example.com;lr>,&lt;sip:p2.domain.com;lr> #8 bye BYE sip:callee@u2.domain.com SIP/2.0 Route: &lt;sip:p2.domain.com;lr> #9 bye BYE sip:callee@u2.domain.com SIP/2.0 Traversing a Strict-Routing Proxy</p></div><footer class=entry-footer><span title='2019-06-18 11:11:12 +0800 CST'>2019-06-18 11:11:12</span>&nbsp;·&nbsp;<span>1 min</span>&nbsp;·&nbsp;<span>Eddie Wang</span></footer><a class=entry-link aria-label="post link to 严格路由和松散路由" href=https://wdd.js.org/opensips/ch5/strict-loose-routing/></a></article><footer class=page-footer><nav class=pagination><a class=prev href=https://wdd.js.org/opensips/page/13/>«&nbsp;Prev&nbsp;
</a><a class=next href=https://wdd.js.org/opensips/page/15/>Next&nbsp;&nbsp;»</a></nav></footer></main><footer class=footer><span>&copy; 2026 <a href=https://wdd.js.org/>洞香春</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>