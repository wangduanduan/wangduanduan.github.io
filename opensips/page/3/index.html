<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>OpenSIPS2.4.X 中文实战系列 | 洞香春</title><meta name=keywords content><meta name=description content="OpenSIPS VOIP"><meta name=author content="Eddie Wang"><link rel=canonical href=https://wdd.js.org/opensips/><link crossorigin=anonymous href=/assets/css/stylesheet.min.ceab085cbbf58c0ec96f6d415d51b3b44e204edfd71a45b4fa2d4aac13f119d0.css integrity="sha256-zqsIXLv1jA7Jb21BXVGztE4gTt/XGkW0+i1KrBPxGdA=" rel="preload stylesheet" as=style><link crossorigin=anonymous herf=/font-awesome/css/font-awesome.min.css rel=stylesheet type=text/css><link rel=preload href=/cowboy.ico as=image><link rel=icon href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/cowboy.ico><link rel=apple-touch-icon href=https://wdd.js.org/cowboy.ico><link rel=mask-icon href=https://wdd.js.org/cowboy.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.112.5"><link rel=alternate type=application/rss+xml href=https://wdd.js.org/opensips/index.xml><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="OpenSIPS2.4.X 中文实战系列"><meta property="og:description" content="OpenSIPS VOIP"><meta property="og:type" content="website"><meta property="og:url" content="https://wdd.js.org/opensips/"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="og:site_name" content="洞香春"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="OpenSIPS2.4.X 中文实战系列"><meta name=twitter:description content="OpenSIPS VOIP"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"OpenSIPS2.4.X 中文实战系列","item":"https://wdd.js.org/opensips/"}]}</script></head><body class="list dark" id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org accesskey=h title="洞香春 (Alt + H)"><img src=/cowboy.ico alt=logo aria-label=logo height=35>洞香春</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/fe/ title=Frontend><span>Frontend</span></a></li><li><a href=https://wdd.js.org/golang/ title=Golang><span>Golang</span></a></li><li><a href=https://wdd.js.org/container/ title=k8s/docker><span>k8s/docker</span></a></li><li><a href=https://wdd.js.org/network/ title=Network><span>Network</span></a></li><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span class=active>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/shell/ title=Shell><span>Shell</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/categories/ title=分类><span>分类</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://wdd.js.org>Home</a></div><h1>OpenSIPS2.4.X 中文实战系列</h1><div class=post-description>OpenSIPS VOIP</div></header><div class=post-content><p>本系列文章是我在学习 OpenSIPS 过程中，慢慢总结出来的。虽说是实战，但是笔记的成分可能会多点，我也无法保证里面的内容是否完全正确。</p><p>VOIP 对我来说是个比较陌生的领域。进入这个领域可以说是一个意外。在学习过程和实战过程中，我发现了 VOIP 有很大的复杂性。生产环境也会有常常有怪异棘手的各种问题。在解决这些问题的过程中，有种升级打怪的感觉。</p><p>本知识库重点在于讲解 OpenSIPS，当然其中也涵盖了 SIP 协议，FreeSWITCH, rtpproxy, rtpengine，以及一些排查问题的工具。</p><p>推荐在学习的过程中，一定要啃一遍 RFC 3261 协议，这是 VOIP 的基石。</p><p>QQ学习交流群：
<img loading=lazy src=2022-12-03-20-58-09.png alt></p><h1 id=文章目录>文章目录<a hidden class=anchor aria-hidden=true href=#文章目录>#</a></h1><ul><li><p>1: SIP 协议</p><ul><li><a href=/opensips/ch1/study-tips>1.1 学习建议</a></li><li><a href=/opensips/ch1/sip-overview>1.2 SIP 协议简介</a></li><li><a href=ch1/via-route-record-route>1.3 Via route Record-Route 的区别</a></li><li><a href=/opensips/ch1/sip-path>1.4 SIP Path 头</a></li><li><a href=/opensips/ch1/trunk-pbx-gateway>1.5 Trunk PBX Gateway</a></li><li><a href=/opensips/ch1/sip-notes>1.6 SIP 协议拾遗补缺</a></li><li><a href=/opensips/ch1/sip-with-sdp>1.7 SIP 与 SDP 的关系</a></li><li><a href=/opensips/ch1/nat-sip-rtp>1.8 SIP 信令和媒体都绕不开的 NAT 问题</a></li><li><a href=/opensips/ch1/stun-notes>1.9 STUN 协议笔记</a></li><li><a href=/opensips/ch1/sip-register>1.10 SIP 注册调研</a></li><li><a href=/opensips/ch1/sip-ack>1.11 深入 SIP ACK 消息</a></li><li><a href=/opensips/ch1/ua-answer-mode>1.12 UA 应答模式</a></li><li><a href=/opensips/ch1/deep-in-nat>1.13 NAT 深入学习</a></li><li><a href=/opensips/ch1/fix-nat>1.14 解决 NAT 问题</a></li><li><a href=/opensips/ch1/from-to-request-url>1.15 From To Request URL 之间的关系</a></li><li><a href=/opensips/ch1/sip-rfcs>1.16 SIP 相关 RFC 协议</a></li><li><a href=/opensips/ch1/story-of-nat>1.17 漫话 NAT 的历史</a></li><li><a href=/opensips/ch1/offer-answer>1.18 媒体协商 offer/answer 模型</a></li><li><a href=/opensips/ch1/sip-rtp-path>1.19 媒体路径与信令路径</a></li><li><a href=/opensips/ch1/csta-call-model>1.20 CSTA 呼叫模型简介</a></li></ul></li><li><ol start=2><li>常识</li></ol><ul><li><a href=/opensips/ch2/early-media-type>2.1 几种常用电话信号音的含义</a></li><li><a href=/opensips/ch2/early-media>2.2 回铃音</a></li></ul></li><li><ol start=3><li>OpenSIPS安装与管理</li></ol><ul><li><a href=/opensips/ch3/about-opensips>3.1 opensips介绍</a></li><li><a href=/opensips/ch3/install-opensips>3.2 debian jessie opensips 2.4.7 安装</a></li><li><a href=/opensips/ch3/centos-install>3.3 centos7 安装opensips</a></li><li><a href=/opensips/ch3/log>3.4 设置独立日志文件</a></li><li><a href=/opensips/ch3/core-mi>3.5 核心MI命令</a></li><li><a href=/opensips/ch3/opensipsctl>3.6 opensips管理命令</a></li><li><a href=/opensips/ch3/centos7-2.4/>3.7 centos7 2.2 升级到2.4.6</a></li><li><a href=/opensips/ch3/opensips-monitor/>3.8 OpenSIPS监控</a></li><li><a href=/opensips/ch3/cache-reload/>3.9 模块缓存策略与reload方法</a></li><li><a href=/opensips/ch3/sip-crlf/>3.10 SIP消息格式CRLF</a></li><li><a href=/opensips/ch3/elk/>3.10 opensips日志写入elasticsearch</a></li><li><a href=/opensips/ch3/prd-warning/>3.10 生产环境监控告警</a></li></ul></li><li><ol start=4><li>媒体相关</li></ol><ul><li><a href=/opensips/ch4/rtp-timestamp/>4.1 RTP 不连续的timestamp和SSRC</a></li><li><a href=/opensips/ch4/media-codec/>4.2 常见媒体流编码及其特点</a></li><li><a href=/opensips/ch4/rtp-record/>4.2 rtpproxy录音</a></li><li><a href=/opensips/ch4/codec-table/>4.2 rtp编码表</a></li></ul></li><li><ol start=5><li>配置文件和路由脚本</li></ol><ul><li><a href=/opensips/ch5/routing-script/>5.1 配置文件</a></li><li><a href=/opensips/ch5/global-params/>5.2 全局参数配置</a></li><li><a href=/opensips/ch5/routing-type/>5.3 路由分类</a></li><li><a href=/opensips/ch5/triger-time/>5.4 路由的触发时机</a></li><li><a href=/opensipsch5/strict-loose-routing/>5.5 严格路由和松散路由</a></li><li><a href=/opensips/ch5/function/>5.6 函数特点</a></li><li><a href=/opensips/ch5/return/>5.7 使用return语句减少逻辑嵌套</a></li><li><a href=/opensips/ch5/condition/>5.8 条件语句特点</a></li><li><a href=/opensips/ch5/statement/>5.9 常用语句</a></li><li><a href=/opensips/ch5/var/>5.10 变量的使用</a></li><li><a href=/opensips/ch5/core-var/>5.11 核心变量说明</a></li><li><a href=/opensips/ch5/xlog/>5.12 优雅的使用xlog输出日志行</a></li><li><a href=/opensips/ch5/module/>5.13 脚本路由模块化</a></li><li><a href=/opensips/ch5/stateful-stateless/>5.14 有状态和无状态路由</a></li><li><a href=/opensips/ch5/init-seque/>5.15 【重点】初始化请求和序列化请求</a></li><li><a href=/opensips/ch5/via-route/>5.16 SIP路由头</a></li><li><a href=/opensips/ch5/avp-db-query/>5.17 avp_db_query数值null值比较</a></li><li><a href=/opensips/ch5/xlog-level/>5.18 日志xlog</a></li><li><a href=/opensips/ch5/homer6/>5.19 opensips 集成 homer6</a></li><li><a href=/opensips/ch5/adv-address/>5.20 【必读】深入对外公布地址</a></li><li><a href=/opensips/ch5/m4/>5.21 使用m4增强opensips.cfg脚本预处理能力</a></li><li><a href=/opensips/ch5/db-mode/>5.22 db_mode调优</a></li><li><a href=/opensips/ch5/sql-table/>5.23 mysql建表语句</a></li><li><a href=/opensips/ch5/core-var-2/>5.24 核心变量解读2-100%</a></li></ul></li><li><ol start=6><li>模块使用教程</li></ol><ul><li><a href=/opensips/ch6/acc/>6.1 acc呼叫记录模块</a></li><li><a href=/opensips/ch6/cachedb/>6.2 cachedb的相关问题</a></li><li><a href=/opensips/ch6/load-balance/>6.3 负载均衡模块load_balance</a></li><li><a href=/opensips/ch6/dispatcher/>6.4 sip消息分发之dispatcher模块</a></li></ul></li><li><ol start=7><li>常见问题</li></ol><ul><li><a href=/opensips/ch7/tm-send-failed/>7.1 opensips 477 Send failed (477/TM)</a></li><li><a href=/opensips/ch7/sendmsg-failed/>7.2 sendmsg failed on 0: Socket operation on non-socket</a></li><li><a href=/opensips/ch7/escape-msg/>7.3 信令路径逃逸分析</a></li><li><a href=/opensips/ch7/crash/>7.4 opensips崩溃分析</a></li><li><a href=/opensips/ch7/can-not-run/>7.5 opensips无法启动</a></li><li><a href=/opensips/ch7/big-udp-msg/>7.6 UDP分片导致SIP消息丢失</a></li><li><a href=/opensips/ch7/rtp-broken-connection>7.7 奥科网关 Rtp Broken Connection</a></li><li><a href=/opensips/ch7/miss-ack/>7.8 ACK 无法正常送到FS</a></li><li><a href=/opensips/ch7/30-seconds-drop/>7.9 30秒自动挂断</a></li><li><a href=/opensips/ch7/cfg-trace/>7.10 script_trace 打印opensips的脚本执行过程</a></li><li><a href=/opensips/ch7/one-leg-audio/>7.11 一方听不到另外一方的声音</a></li><li><a href=/opensips/ch7/echo-back/>7.12 回音问题调研</a></li><li><a href=/opensips/ch7/without-log/>7.13 opensips启动失败没有任何报错日志</a></li><li><a href=/opensips/ch7/poor-quality/>7.14 通话质量差</a></li><li><a href=/opensips/ch7/without-default-carrier/>7.15 ERROR:carrierroute:carrier_tree_fixup: default_carrier not found</a></li></ul></li><li><ol start=8><li>脚本学习</li></ol><ul><li><a href=/opensips/ch8/topology-hiding/>8.1 拓扑隐藏学习以及实践</a></li><li><a href=/opensips/ch8/serial-183/>8.2 serial_183</a></li><li><a href=/opensips/ch8/replicate/>8.3 replicate</a></li><li><a href=/opensips/ch8/redirect/>8.4 redirect</a></li><li><a href=/opensips/ch8/pstn/>8.5 pstn</a></li><li><a href=/opensips/ch8/nathelper/>8.6 nathelper</a></li><li><a href=/opensips/ch8/msilo/>8.7 msilo</a></li><li><a href=/opensips/ch8/logging/>8.8 logging</a></li><li><a href=/opensips/ch8/httpd/>8.9 httpd</a></li><li><a href=/opensips/ch8/fork/>8.10 fork</a></li><li><a href=/opensips/ch8/flag-reply/>8.11 flag reply</a></li><li><a href=/opensips/ch8/exec/>8.12 exec</a></li><li><a href=/opensips/ch8/acc/>8.13 acc</a></li><li><a href=/opensips/ch8/acc-mysql/>8.14 acc-mysql</a></li><li><a href=/opensips/ch8/default/>8.15 default</a></li><li><a href=/opensips/ch8/mid-register/>8.16 mid register</a></li><li><a href=/opensips/ch8/fs-loadbalance/>8.17 fs loadbalance</a></li><li><a href=/opensips/ch8/fraud/>8.18 fraud</a></li><li><a href=/opensips/ch8/dtmf-lan/>8.19 dtmf</a></li><li><a href=/opensips/ch8/siprec/>8.20 siprec</a></li></ul></li><li><ol start=9><li>扩展</li></ol><ul><li><a href=/opensips/ch9/webrtc-ref/>9.1 WebRTC学习资料分享</a></li><li><a href=/opensips/ch9/notes/>9.2 WebRTC简介</a></li><li><a href=/opensips/ch9/webrtc-pdf/>9.3 opensips with webrtc</a></li><li><a href=/opensips/ch9/blf/>9.4 BLF指示灯</a></li><li><a href=/opensips/ch9/isup-sip-isdn/>9.5 ISUP SIP ISDN对照码表</a></li><li><a href=/opensips/ch9/rtpengine-manu/>9.6 rtpengine cli</a></li><li><a href=/opensips/ch9/rtpengine-ilbc/>9.7 rtpengine 增加对ilbc编解码的支持</a></li><li><a href=/opensips/ch9/sdp/>9.8 sdp协议简介</a></li><li><a href=/opensips/ch9/rtpproxy/>9.9 rtpproxy学习</a></li><li><a href=/opensips/ch9/feature-code/>9.10 SIP feature codes SIP功能码</a></li><li><a href=/opensips/ch9/100-rel/>9.11 sbc 100rel</a></li><li><a href=/opensips/ch9/blf-note/>9.12 blf 功能笔记</a></li><li><a href=/opensips/ch9/nat-single-interface/>9.13 NAT场景下的信令处理 - 单网卡</a></li><li><a href=/opensips/ch9/cluster-share-location/>9.14 集群共享分机注册信息</a></li><li><a href=/opensips/ch9/books/>9.15 参考资料与书籍</a></li></ul></li><li><ol start=10><li>相关工具</li></ol><ul><li><a href=/opensips/tools/tshark/>10.1 tshark 快速分析语音流问题</a></li><li><a href=/opensips/tools/heplify/>10.2 heplify SIP信令抓包客户端</a></li><li><a href=/opensips/tools/baresip/>10.3 baresip 非常好用的终端SIP UA</a></li><li><a href=/opensips/tools/sipsak/>10.4 sipsak</a></li><li><a href=/opensips/tools/wireshark-player-pcap/>10.5 wireshark 播放抓包文件</a></li><li><a href=/opensips/tools/sngrep/>10.6 sngrep: 最好用的sip可视化抓包工具</a></li><li><a href=/opensips/tools/homer/>10.7 homer: 统一的sip包集中处理工具</a></li><li><a href=/opensips/tools/siphub/>10.8 siphub 轻量级实时SIP信令收包的服务</a></li><li><a href=/opensips/tools/sipp/>10.9 SIPp：sip压测模拟ua工具</a></li><li><a href=/opensips/tools/sipp-subscriber/>10.10 SIPP subscriber 测试</a></li><li><a href=/opensips/tools/tcp-dump/>10.11 tcpdump</a></li><li><a href=/opensips/tools/pjsip/>10.12 pjsip</a></li><li><a href=/opensips/tools/wireshark-sip/>10.13 Wireshark SIP 抓包</a></li><li><a href=/opensips/tools/kamailio/>10.14 另一个功能强大的sip server: kamailio</a></li></ul></li><li><ol start=11><li>官方博客</li></ol><ul><li><a href=/opensips/blog/load-balance/>Load Balancing in OpenSIPS</a></li><li><a href=/opensips/blog/dialog-trigers/>Dialog triggers, or how to control the calls from script</a></li><li><a href=/opensips/blog/cross-dialog-data/>Cross-dialog data accessing</a></li><li><a href=/opensips/blog/calls-manager/>Calls management using the new Call API tool</a></li><li><a href=/opensips/blog/call-stat/>Improved series-based call statistics using OpenSIPS 3.2</a></li><li><a href=/opensips/blog/opensips3-tls/>Exploring SSL/TLS libraries for OpenSIPS 3.2</a></li><li><a href=/opensips/blog/openssl-opensips/>The OpenSIPS and OpenSSL journey</a></li><li><a href=/opensips/blog/mutltiple-interface/>SIP bridging over multiple interfaces</a></li><li><a href=/opensips/blog/cancel-reason/>CANCEL请求和Reason头</a></li><li><a href=/opensips/blog/opensips3x/>Introducing OpenSIPS 3.0</a></li><li><a href=/opensips/blog/cluster-location/>Clustered SIP User Location: The Full Sharing Topology</a></li><li><a href=/opensips/blog/cluster-call/>Clustering ongoing calls with OpenSIPS 2.4</a></li><li><a href=/opensips/blog/full-anycast/>Full Anycast support in OpenSIPS 2.4</a></li><li><a href=/opensips/blog/deepin-stat-engine/>深入OpenSIPS统计引擎</a></li><li><a href=/opensips/blog/runing-opensips-in-cloud/>Running OpenSIPS in the Cloud</a></li><li><a href=/opensips/blog/troubleshooting-opensips-script/>Troubleshooting OpenSIPS script</a></li><li><a href=/opensips/blog/miss-ack/>Troubleshooting missing ACK in SIP</a></li><li><a href=/opensips/blog/memory-usage/>理解并测量OpenSIPS的内存资源</a></li></ul></li><li><p>问题列表</p><ul><li><a href=/opensips/ch1/utime-task-scheduled>utimer task already scheduled</a></li></ul></li><li><p>OpenSIPS 3X</p><ul><li><a href=/opensips/3x/module-args/>模块传参的重构</a></li></ul></li><li><p><a href=/opensips/module-dev/>模块开发实战</a></p></li><li><p><a href=/opensips/pdf/>OpenSIPS Summit PDF学习资料</a></p></li><li><p><a href=/opensips/dev-audio/>源码学习视频教程</a></p></li></ul><h1 id=文章列表>文章列表<a hidden class=anchor aria-hidden=true href=#文章列表>#</a></h1></div><article class=post-entry><header class=entry-header><h2>RTP 不连续的timestamp和SSRC</h2></header><section class=entry-content><p>最近遇到一些和媒体流相关的问题，使用wireshark分析之后，总算有些眉目。然而我深感对RTP协议的理解，还是趋于表面。所以我决定，深入的学习一下RTP协议。
和rtp相关的协议有两个rfc, 分别是
1996的的 RFC 1889 2003年的 RFC 3550 RFC 3550是对RFC 1889的稍微改进，然而大体上是没什么改变的。所以我们可以直接看RFC 3550。
RTP 底层用的是UDP协议 RTP 的使用场景是传输实时数据，例如语音，视频，模拟数据等等 RTP 并不保证QoS Synchronization source (SSRC): The source of a stream of RTP packets, identified by a 32-bit numeric SSRC identifier carried in the RTP header so as not to be dependent upon the network address. All packets from a synchronization source form part of the same timing and sequence number space, so a receiver groups packets by synchronization source for playback....</p></section><footer class=entry-footer><span title='2022-01-10 22:05:10 +0800 CST'>2022-01-10 22:05:10</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to RTP 不连续的timestamp和SSRC" href=https://wdd.js.org/opensips/ch4/rtp-timestamp/></a></article><article class=post-entry><header class=entry-header><h2>avp_db_query数值null值比较</h2></header><section class=entry-content><p>avp_db_query是用来做数据库查询的，如果查到某列的值是NULL, 那么对应到脚本里应该如何比较呢？
可以用avp的值与""， 进行比较
if ($avp(status) == "&lt;null>") 参考 https://stackoverflow.com/questions/52675803/opensips-avp-db-query-cant-compare-null-value</p></section><footer class=entry-footer><span title='2021-09-29 19:13:26 +0800 CST'>2021-09-29 19:13:26</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to avp_db_query数值null值比较" href=https://wdd.js.org/opensips/ch5/avp-db-query/></a></article><article class=post-entry><header class=entry-header><h2>sendmsg failed on 0: Socket operation on non-socket</h2></header><section class=entry-content><p>ERROR:core:tcp_init_listener: could not get TCP protocol number CRITICAL:core:send_fd: sendmsg failed on 0: Socket operation on non-socket ERROR:core:send2child: send_fd failed 不要将tcp_child设置为0</p></section><footer class=entry-footer><span title='2021-09-16 10:04:16 +0800 CST'>2021-09-16 10:04:16</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to sendmsg failed on 0: Socket operation on non-socket" href=https://wdd.js.org/opensips/ch7/sendmsg-failed/></a></article><article class=post-entry><header class=entry-header><h2>信令路径逃逸分析</h2></header><section class=entry-content><p>问题表现 在经过初始化请求之后，路径发现完成。在这个dialog中所有的请求，正常来ua1和ua2之间的所有请求，都应该经过us1和us2。
如下图所示：
某些时候，ua1可能直接把BYE消息直接发送给ua2, 但是一般ua1和ua2是存在uat网络的，所以这个BYE消息，ua2很可能收不到。
问题的表现就是电话无法正常挂断。
问题分析 可能原因1: us1和us2没有做record-route, 导致请求直接根据某个请求的响应消息的Contact头，直接发送了。 可能原因2: 某些请求的拓扑隐藏没有做好 拓扑隐藏问题具体分析 假如我们在us1上正确的做了拓扑隐藏，那么ua1的所有收到的响应，它的Contact头的地址都会改成us1的地址。那么ua1是无论如何都获取不到ua2的直接地址的。
但是，假如某个消息处理的不对呢？
注意180响应5到6, 其中us1正确的修改了Contact头 ua1收到180后，立即发送了notify消息 如果us1没有正确处理notify的响应的Contact头，us1就会把ua2的Contact信息发送给ua1。有些notify的响应带有Contact头，有些没带有。 但是这里会出现一个竞争条件，invite的200ok和notify的200ok，消息到达的顺序，将影响ua2的Contact信息 如果ua1后收到invite的200ok, 此时ua1获取ua2的地址是us1 如果ua2后收到notify的200ok, 此时ua2获取的ua2的地址就是ua2 所以问题的表现可能是有偶现的，这种问题处理其实是比较棘手的 当然也是有解决方案的 方案1， us1对notify正确处理响应消息Contact, 将其修改成us1 方案2，us1直接删除notify响应消息的Contact头</p></section><footer class=entry-footer><span title='2021-09-15 19:18:55 +0800 CST'>2021-09-15 19:18:55</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to 信令路径逃逸分析" href=https://wdd.js.org/opensips/ch7/escape-msg/></a></article><article class=post-entry><header class=entry-header><h2>heplify SIP信令抓包客户端</h2></header><section class=entry-content><p>hepfily是个独立的抓包程序，类似于tcpdump之类的，网络抓包程序，可以把抓到的sip包，编码为hep格式。然后送到hep server上，由hepserver负责包的整理和存储。
heplify安装非常简单，在仓库的release页面，可以下载二进程程序。二进程程序赋予可执行权限后，可以直接在x86架构的机器上运行。
因为heplify是go语言写的，你也可以基于源码，编译其他架构的二进制程序。
https://github.com/sipcapture/heplify
-i 设定抓包的网卡 -m 设置抓包模式为SIP -hs 设置hep server的地址 -p 设置日志文件的日志 -dim 设置过滤一些不关心的sip包 -pr 设置抓包的端口范围 nohup ./heplify \ -i eno1 \ -m SIP \ -hs 192.168.1.2:9060 \ -p "/var/log/" \ -dim OPTIONS,REGISTER \ -pr "18627-18628" & opensips模块本身就有proto_hep模块支持hep抓包，为什么我还要用heplify来抓包呢？
低于2.2版本的opensips不支持hep抓包 opensips的hep抓包还是不太稳定。我曾遇到过因为hep抓包导致opensips崩溃的事故。如果用外部的抓包程序，即使抓包有问题，还是不会影响到opensips。</p></section><footer class=entry-footer><span title='2021-09-12 20:49:51 +0800 CST'>2021-09-12 20:49:51</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to heplify SIP信令抓包客户端" href=https://wdd.js.org/opensips/tools/heplify/></a></article><article class=post-entry><header class=entry-header><h2>核心变量解读-100%</h2></header><section class=entry-content><p>简介 OpenSIPS的路由脚本提供了几种不同类型的变量。不同类型的变量有以下几个方面的差异。
变量的可见性 变量引用的值 变量的读写性质：有些变量是只读的，有些变量可读可写 变量是否有多个值：有些变量只有一个值，有些变量有多个值 语法 $(&lt;context>name(subname)[index]{tramsformation}) 除了name以外 ，其他都是可选的值。
name(必传)：变量名的类型，例如pvar, avp, ru, DLG_status等等 subname: 变量名称，例如hdr(From), avp(name) index: 索引，某些变量可以有多个值，类似于数组。可以用索引去引用对应的元素。从0开始，也可以是负值如-1, 表示倒数第一个。 transformation: 转换。做一些格式转换，字符串截取等等操作 context: 上下文。OpenSIP有两个上下午，请求request、相应reply。想想一个场景，你在一个相应路由里如何拿到请求路由的某个值呢？ 可以使用$(ru). 或者在一个失败路由里获取一个Concact的信息$(hdr(Contact)) 举例：
仅仅通过类型来引用：$ru 通过类型和名称来引用：$hrd(Contact), 引用某个SIP header的值 通过类型和索引来引用：$(ct[0]) 通过类型、名称、索引来引用：$(avp(addr)[0]) 变量的类型 脚本变量 脚本变量只有一个值 脚本变量可读可写 脚本变量在路由及其子路由中都是可见的 脚本变量使用前务必先初始化，否则可能会引用到之前的值 脚本变量的值可以是字符串，也可以是整数类型 脚本变量读写比avp变量快 脚本变量会持久存在一个OpenSIPS进程中 将脚本变量设置为NULL, 实际上是将变量的值设置为'0’, 脚本变量没有NULL值。 脚本变量之存在与一个路由中 使用举例
route{ $var(a) = 19 $var(a) = "wdd" $var(a) = "wdd" + "@" + $td; if(route(check_out, 1)){ xlog("check error"); } } route[check_out]{ # 注意，这里$var(a)的值就不存在了 xlog("$var(a)"); if ($param(1) > 1) { return (-1); } return(1); } avp变量 avp变量一般会关联到一个sip消息或者SIP事务上....</p></section><footer class=entry-footer><span title='2021-09-09 09:04:21 +0800 CST'>2021-09-09 09:04:21</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to 核心变量解读-100%" href=https://wdd.js.org/opensips/ch5/core-var-2/></a></article><article class=post-entry><header class=entry-header><h2>生产环境监控告警</h2></header><section class=entry-content><p>日志监控 务必监控opensips日志，如果其中出现了CRITICAL关键字, 很可能马上opensips就要崩溃。
第一要发出告警信息。第二要有主动的自动重启策略，例如使用systemd启动的话，服务崩溃会会立马被重启。或者用docker或者k8s，这些虚拟化技术，可以让容器崩溃后自动重启。
指标监控 opensips有内部的统计模块，可以很方便的通过opensipsctl或者相关的http的mi接口获取到内部的统计数据。
以下给出几个关键的统计指标：
’total_size’, 全部内存 ‘used_size’, 使用的内存 ‘real_used_size’, 真是使用的内存 ‘max_used_size’, 最大使用的内存 ‘free_size’, 空闲内存 ‘fragments’, ‘active_dialogs’, 接通状态的通话 ’early_dialogs’, 振铃状态的通话 ‘inuse_transactions’, 正在使用的事务 ‘waiting_udp’, 堆积的udp消息 ‘waiting_tcp’ 堆积的tcp消息 当然还有很多的一些指标，可以使用：opensipsctl fifo get_statistics all来获取。</p></section><footer class=entry-footer><span title='2021-08-19 20:08:28 +0800 CST'>2021-08-19 20:08:28</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to 生产环境监控告警" href=https://wdd.js.org/opensips/ch3/prd-warning/></a></article><article class=post-entry><header class=entry-header><h2>opensips崩溃分析</h2></header><section class=entry-content><p>core dump文件在哪里？ 一般情况下，opensips在崩溃的时候，会产生core dump文件。这个文件一般位于跟目录下，名字如core.xxxx等的。
core dump文件一般大约有1G左右，所以当产生core dump的时候，要保证系统的磁盘空间是否足够。
如何开启core dump？ 第一，opensips脚本中有个参数叫做disable_core_dump， 这个参数默认为no, 也就是启用core dump, 可以将这个参数设置为no, 来禁用core dump。但是生产环境一般建议还是开启core dump, 否则服务崩溃了，就只能看日志，无法定位到具体的崩溃代码的位置。
disable_core_dump=yes 第二，还需要在opensips启动之前，运行：ulimit -c unlimited, 这个命令会让opensips core dump的时候，不会限制core dump文件的大小。一般来说core dump文件的大小是共享内存 + 私有内存。
第三，opensips进程的用户如果不是root, 那么可能没有权限将core dump文件写到/目录下。有两个解决办法，
用root用户启动opensips进程 使用-w 参数配置opensips的工作目录，core dump文件将会写到对应的目录中。例如：opensips -w /var/log 如果core dump失败是因为权限的问题， opensips的日志文件中将会打印：
Can't open 'core.xxxx' at '/': Permission denied 如何分析core dump文件？ 使用gdb
gdb $(which opensips) core.12333 # 进入gdb调试之后, 输入bt full, 会打印详细的错误栈信息 bt full 没有产生core dump文件，如何分析崩溃原因？ 使用objdump。
一般来说opensips崩溃后，日志文件中一般会出现下面的信息
kernel: opensips[8954]: segfault at 1ea72b5 ip 00000000004be532 sp 00007ffe9e1e6df0 error 4 in opensips[400000+203000] 我们从中取出几个关键词...</p></section><footer class=entry-footer><span title='2021-08-19 19:30:14 +0800 CST'>2021-08-19 19:30:14</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to opensips崩溃分析" href=https://wdd.js.org/opensips/ch7/crash/></a></article><article class=post-entry><header class=entry-header><h2>opensips无法启动</h2></header><section class=entry-content><p>排查日志 opensips的log_stderror参数决定写日志的位置，
yes 写日志到标准错误 no 写日志到syslog服务(默认) 如果使用默认的syslog服务，那么日志将会可能写到以下两个文件中。
/var/log/messages /var/log/syslog 一般情况下，分析/var/log/messages日志，可以定位到无法启动的原因。
如果日志文件中无法定位到具体原因，那么就可以将log_stderror设置为yes。
注意：往标准错误中打印的日志，往往比网日志文件中打印的更详细。而且有些时候，我发现这个错误在标准错误中打印了，但是却不会输出到日志文件中。
所以，看标准错误的日志，往往更容易定位到问题。</p></section><footer class=entry-footer><span title='2021-08-19 19:19:52 +0800 CST'>2021-08-19 19:19:52</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to opensips无法启动" href=https://wdd.js.org/opensips/ch7/can-not-run/></a></article><article class=post-entry><header class=entry-header><h2>baresip 非常好用的终端SIP UA</h2></header><section class=entry-content><p>安装 安装前要先安装依赖
https://github.com/baresip/re https://github.com/baresip/rem openssl git clone https://github.com/baresip/baresip cd baresip make sudo make install 指令 /about About box/accept Accept incoming call/answermode Set answer mode/apistate User Agent state/auloop Start audio-loop /auloop_stop Stop audio-loop/auplay Switch audio player/ausrc Switch audio source/callstat Call status/conf_reload Reload config file/config Print configuration/contact_next Set next contact/contact_prev Set previous contact/contacts List contacts/dial .. Dial/dialcontact Dial current contact/hangup Hangup call/help Help menu/insmod Load module/listcalls List active calls/loglevel Log level toggle/main Main loop debug/memstat Memory status/message Message current contact/modules Module debug/netstat Network debug/options Options/play Play audio file/quit Quit/reginfo Registration info/rmmod Unload module/sipstat SIP debug/sysinfo System info/timers Timer debug/uadel Delete User-Agent/uafind Find User-Agent /uanew Create User-Agent/uanext Toggle UAs/uastat UA debug/uuid Print UUID/vidloop Start video-loop /vidloop stop Stop video-loop/vidsrc Switch video source...</p></section><footer class=entry-footer><span title='2021-06-08 16:27:36 +0800 CST'>2021-06-08 16:27:36</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to baresip 非常好用的终端SIP UA" href=https://wdd.js.org/opensips/tools/baresip/></a></article><footer class=page-footer><nav class=pagination><a class=prev href=https://wdd.js.org/opensips/page/2/>« Prev Page</a>
<a class=next href=https://wdd.js.org/opensips/page/4/>Next Page »</a></nav></footer></main><footer class=footer><span>&copy; 2023 <a href=https://wdd.js.org>洞香春</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>