<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>OpenSIPS2.4.X 中文实战系列 | 洞香春</title><meta name=keywords content><meta name=description content="OpenSIPS VOIP"><meta name=author content="王端端"><link rel=canonical href=https://wdd.js.org/opensips/><meta name=google-site-verification content="G-SGW660ZWKM"><link crossorigin=anonymous href=/assets/css/stylesheet.min.ceab085cbbf58c0ec96f6d415d51b3b44e204edfd71a45b4fa2d4aac13f119d0.css integrity="sha256-zqsIXLv1jA7Jb21BXVGztE4gTt/XGkW0+i1KrBPxGdA=" rel="preload stylesheet" as=style><link crossorigin=anonymous herf=/font-awesome/css/font-awesome.min.css rel=stylesheet type=text/css><link rel=preload href=/cowboy.ico as=image><link rel=icon href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/cowboy.ico><link rel=apple-touch-icon href=https://wdd.js.org/cowboy.ico><link rel=mask-icon href=https://wdd.js.org/cowboy.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.106.0"><link rel=alternate type=application/rss+xml href=https://wdd.js.org/opensips/index.xml><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-SGW660ZWKM"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SGW660ZWKM",{anonymize_ip:!1})}</script><meta property="og:title" content="OpenSIPS2.4.X 中文实战系列"><meta property="og:description" content="OpenSIPS VOIP"><meta property="og:type" content="website"><meta property="og:url" content="https://wdd.js.org/opensips/"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="og:site_name" content="洞香春"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="OpenSIPS2.4.X 中文实战系列"><meta name=twitter:description content="OpenSIPS VOIP"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"OpenSIPS2.4.X 中文实战系列","item":"https://wdd.js.org/opensips/"}]}</script></head><body class="list dark" id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org accesskey=h title="洞香春 (Alt + H)"><img src=/cowboy.ico alt=logo aria-label=logo height=35>洞香春</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/fe/ title=Frontend><span>Frontend</span></a></li><li><a href=https://wdd.js.org/golang/ title=Golang><span>Golang</span></a></li><li><a href=https://wdd.js.org/container/ title=k8s/docker><span>k8s/docker</span></a></li><li><a href=https://wdd.js.org/network/ title=Network><span>Network</span></a></li><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span class=active>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/shell/ title=Shell><span>Shell</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/categories/ title=分类><span>分类</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://wdd.js.org>Home</a></div><h1>OpenSIPS2.4.X 中文实战系列</h1><div class=post-description>OpenSIPS VOIP</div></header><div class=post-content><p>本系列文章是我在学习 OpenSIPS 过程中，慢慢总结出来的。虽说是实战，但是笔记的成分可能会多点，我也无法保证里面的内容是否完全正确。</p><p>VOIP 对我来说是个比较陌生的领域。进入这个领域可以说是一个意外。在学习过程和实战过程中，我发现了 VOIP 有很大的复杂性。生产环境也会有常常有怪异棘手的各种问题。在解决这些问题的过程中，有种升级打怪的感觉。</p><p>本知识库重点在于讲解 OpenSIPS，当然其中也涵盖了 SIP 协议，FreeSWITCH, rtpproxy, rtpengine，以及一些排查问题的工具。</p><p>推荐在学习的过程中，一定要啃一遍 RFC 3261 协议，这是 VOIP 的基石。</p><h1 id=文章目录>文章目录<a hidden class=anchor aria-hidden=true href=#文章目录>#</a></h1><ul><li><p>1: SIP 协议</p><ul><li><a href=ch1/study-tips>1.1 学习建议</a></li><li><a href=ch1/sip-overview>1.2 SIP 协议简介</a></li><li><a href=ch1/via-route-record-route>1.3 Via route Record-Route 的区别</a></li><li><a href=ch1/sip-path>1.4 SIP Path 头</a></li><li><a href=ch1/trunk-pbx-gateway>1.5 Trunk PBX Gateway</a></li><li><a href=ch1/sip-notes>1.6 SIP 协议拾遗补缺</a></li><li><a href=ch1/sip-with-sdp>1.7 SIP 与 SDP 的关系</a></li><li><a href=ch1/nat-sip-rtp>1.8 SIP 信令和媒体都绕不开的 NAT 问题</a></li><li><a href=ch1/stun-notes>1.9 STUN 协议笔记</a></li><li><a href=ch1/sip-register>1.10 SIP 注册调研</a></li><li><a href=ch1/sip-ack>1.11 深入 SIP ACK 消息</a></li><li><a href=ch1/ua-answer-mode>1.12 UA 应答模式</a></li><li><a href=ch1/deep-in-nat>1.13 NAT 深入学习</a></li><li><a href=ch1/fix-nat>1.14 解决 NAT 问题</a></li><li><a href=ch1/from-to-request-url>1.15 From To Request URL 之间的关系</a></li><li><a href=ch1/sip-rfcs>1.16 SIP 相关 RFC 协议</a></li><li><a href=ch1/story-of-nat>1.17 漫话 NAT 的历史</a></li><li><a href=ch1/offer-answer>1.18 媒体协商 offer/answer 模型</a></li><li><a href=ch1/sip-rtp-path>1.19 媒体路径与信令路径</a></li><li><a href=ch1/csta-call-model>1.20 CSTA 呼叫模型简介</a></li></ul></li><li><p>问题列表</p><ul><li><a href=utime-task-scheduled>utimer task already scheduled</a></li><li><a href=rtp-broken-connection>奥科网关 Rtp Broken Connection</a></li></ul></li></ul><h1 id=文章列表>文章列表<a hidden class=anchor aria-hidden=true href=#文章列表>#</a></h1></div><article class=post-entry><header class=entry-header><h2>SIP注册调研</h2></header><section class=entry-content><p>sequenceDiagram autonumber participant a as 192.168.0.123:55647 participant b as 1.2.3.4:5060 participant c as 172.10.10.3:49543 a->>b: register cseq=1, callId=1 b-->>a: 401 Unauthorized a->>b: register cseq=2, callid=1 b-->>a: 200 a->>b: register cseq=3, callId=1 b-->>a: 401 Unauthorized a->>b: register cseq=4, callid=1 b-->>a: 200 c->>b: register cseq=5, callid=1 b-->>c: 401 Unauthorized c->>b: register cseq=6, callid=1 b-->>c: 500 Service Unavailable c->>b: register cseq=7, callid=2 b-->>c: 401 Unauthorized c->>b: register cseq=8, callid=2 b-->>c: 200 c->>b: register cseq=9, callid=2 b-->>c: 401 Unauthorized c->>b: register cseq=10, callid=2 b-->>c: 200 c->>b: register cseq=11, callid=2 b-->>c: 401 Unauthorized c->>b: register cseq=12, callid=2 b-->>c: 500 Service Unavailable a->>b: register cseq=13, callId=3 b-->>a: 401 Unauthorized a->>b: register cseq=14, callid=3 b-->>a: 200 a->>b: register cseq=15, callId=3 b-->>a: 401 Unauthorized a->>b: register cseq=16, callid=3 b-->>a: 200 a->>b: register cseq=17, callId=3 b-->>a: 401 Unauthorized a->>b: register cseq=18, callid=3 b-->>a: 200 a->>b: register cseq=19, callId=3 b-->>a: 401 Unauthorized a->>b: register cseq=20, callid=3 b-->>a: 200 服务端设置的过期时间是120s 客户端每隔115s注册一次, callid和之前的保持不变 当网络变了之后，由于ip地址改变，客户端的在115秒注册，此时服务端还未超时，所以给客户端响应报错500 客户端在等了8秒之后，等待服务端超时，然后再次注册，再次注册时，callid改变 因为服务端已经超时，所以能够注册成功 需要注意的是，在一个注册周期内，客户端的注册信息包括IP、端口、协议、CallID都不能变，一旦改变了。如果服务端的记录还没有失效，新的注册就会失败。...</p></section><footer class=entry-footer><span title='2019-08-19 21:30:52 +0800 CST'>2019-08-19 21:30:52</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;王端端</footer><a class=entry-link aria-label="post link to SIP注册调研" href=https://wdd.js.org/opensips/ch1/sip-register/></a></article><article class=post-entry><header class=entry-header><h2>from vs to vs request-url之间的关系</h2></header><section class=entry-content><p>from字段用来标记请求的发起者ID to字段用来标记请求接受者的ID to字段并不能用于路由，request-url可以用来路由 一般情况下，sip消息再传输过程中，from和to字段都不会改，而request-url很可能会因为路由而改变 对于最初的请求，除了注册请求之外，request-url和to字段中的url一致 from字段：The From header field is a required header field that indicates the originator of the request. It is one of two addresses used to identify the dialog. The From header field contains a URI, but it may not contain the transport, maddr, or ttl URI parameters. A From header field may contain a tag used to identify a particular call. A From header field may contain a display name, in which case the URI is enclosed in &lt; >....</p></section><footer class=entry-footer><span title='2019-07-11 07:38:53 +0800 CST'>2019-07-11 07:38:53</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;王端端</footer><a class=entry-link aria-label="post link to from vs to vs request-url之间的关系" href=https://wdd.js.org/opensips/ch1/from-to-request-url/></a></article><footer class=page-footer><nav class=pagination><a class=prev href=https://wdd.js.org/opensips/page/2/>« Prev Page</a></nav></footer></main><footer class=footer><span>&copy; 2022 <a href=https://wdd.js.org>洞香春</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>