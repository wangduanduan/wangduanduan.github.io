<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>OpenSIPS2.4.X 中文实战系列 | 洞香春</title>
<meta name=keywords content><meta name=description content="OpenSIPS VOIP"><meta name=author content="Eddie Wang"><link rel=canonical href=https://wdd.js.org/opensips/><link crossorigin=anonymous href=/assets/css/stylesheet.821c51435cba3e33e49e590a06514c54c32ac7957095ffcc1e0f390c47cf3228.css integrity="sha256-ghxRQ1y6PjPknlkKBlFMVMMqx5Vwlf/MHg85DEfPMig=" rel="preload stylesheet" as=style><link rel=icon href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/cowboy.ico><link rel=apple-touch-icon href=https://wdd.js.org/cowboy.ico><link rel=mask-icon href=https://wdd.js.org/cowboy.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://wdd.js.org/opensips/index.xml><link rel=alternate hreflang=en href=https://wdd.js.org/opensips/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://wdd.js.org/opensips/"><meta property="og:site_name" content="洞香春"><meta property="og:title" content="OpenSIPS2.4.X 中文实战系列"><meta property="og:description" content="OpenSIPS VOIP"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="OpenSIPS2.4.X 中文实战系列"><meta name=twitter:description content="OpenSIPS VOIP"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"OpenSIPS2.4.X 中文实战系列","item":"https://wdd.js.org/opensips/"}]}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org/ accesskey=h title="洞香春 (Alt + H)"><img src=https://wdd.js.org/cowboy.ico alt aria-label=logo height=35>洞香春</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wdd.js.org/books/ title=读书><span>读书</span></a></li><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/kamailio/ title=Kamailio><span>Kamailio</span></a></li><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span class=active>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/categories/ title=分类><span>分类</span></a></li><li><a href=https://wdd.js.org/fe/ title=前端><span>前端</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://wdd.js.org/>Home</a></div><h1>OpenSIPS2.4.X 中文实战系列</h1><div class=post-description>OpenSIPS VOIP</div></header><div class=post-content><p>本系列文章是我在学习 OpenSIPS 过程中，慢慢总结出来的。虽说是实战，但是笔记的成分可能会多点，我也无法保证里面的内容是否完全正确。</p><p>VOIP 对我来说是个比较陌生的领域。进入这个领域可以说是一个意外。在学习过程和实战过程中，我发现了 VOIP 有很大的复杂性。生产环境也会有常常有怪异棘手的各种问题。在解决这些问题的过程中，有种升级打怪的感觉。</p><p>本知识库重点在于讲解 OpenSIPS，当然其中也涵盖了 SIP 协议，FreeSWITCH, rtpproxy, rtpengine，以及一些排查问题的工具。</p><p>推荐在学习的过程中，一定要啃一遍 RFC 3261 协议，这是 VOIP 的基石。</p><p>QQ学习交流群：983873052</p><h1 id=文章目录>文章目录<a hidden class=anchor aria-hidden=true href=#文章目录>#</a></h1><ul><li><p>1: SIP 协议</p><ul><li><a href=/opensips/ch1/study-tips>1.1 学习建议</a></li><li><a href=/opensips/ch1/sip-overview>1.2 SIP 协议简介</a></li><li><a href=ch1/via-route-record-route>1.3 Via route Record-Route 的区别</a></li><li><a href=/opensips/ch1/sip-path>1.4 SIP Path 头</a></li><li><a href=/opensips/ch1/trunk-pbx-gateway>1.5 Trunk PBX Gateway</a></li><li><a href=/opensips/ch1/sip-notes>1.6 SIP 协议拾遗补缺</a></li><li><a href=/opensips/ch1/sip-with-sdp>1.7 SIP 与 SDP 的关系</a></li><li><a href=/opensips/ch1/nat-sip-rtp>1.8 SIP 信令和媒体都绕不开的 NAT 问题</a></li><li><a href=/opensips/ch1/stun-notes>1.9 STUN 协议笔记</a></li><li><a href=/opensips/ch1/sip-register>1.10 SIP 注册调研</a></li><li><a href=/opensips/ch1/sip-ack>1.11 深入 SIP ACK 消息</a></li><li><a href=/opensips/ch1/ua-answer-mode>1.12 UA 应答模式</a></li><li><a href=/opensips/ch1/deep-in-nat>1.13 NAT 深入学习</a></li><li><a href=/opensips/ch1/fix-nat>1.14 解决 NAT 问题</a></li><li><a href=/opensips/ch1/from-to-request-url>1.15 From To Request URL 之间的关系</a></li><li><a href=/opensips/ch1/sip-rfcs>1.16 SIP 相关 RFC 协议</a></li><li><a href=/opensips/ch1/story-of-nat>1.17 漫话 NAT 的历史</a></li><li><a href=/opensips/ch1/offer-answer>1.18 媒体协商 offer/answer 模型</a></li><li><a href=/opensips/ch1/sip-rtp-path>1.19 媒体路径与信令路径</a></li><li><a href=/opensips/ch1/csta-call-model>1.20 CSTA 呼叫模型简介</a></li></ul></li><li><ol start=2><li>常识</li></ol><ul><li><a href=/opensips/ch2/early-media-type>2.1 几种常用电话信号音的含义</a></li><li><a href=/opensips/ch2/early-media>2.2 回铃音</a></li><li><a href=/opensips/ch2/axb>2.3 AXB的玩法说明</a></li></ul></li><li><ol start=3><li>OpenSIPS安装与管理</li></ol><ul><li><a href=/opensips/ch3/about-opensips>3.1 opensips介绍</a></li><li><a href=/opensips/ch3/install-opensips>3.2 debian jessie opensips 2.4.7 安装</a></li><li><a href=/opensips/ch3/centos-install>3.3 centos7 安装opensips</a></li><li><a href=/opensips/ch3/log>3.4 设置独立日志文件</a></li><li><a href=/opensips/ch3/core-mi>3.5 核心MI命令</a></li><li><a href=/opensips/ch3/opensipsctl>3.6 opensips管理命令</a></li><li><a href=/opensips/ch3/centos7-2.4/>3.7 centos7 2.2 升级到2.4.6</a></li><li><a href=/opensips/ch3/opensips-monitor/>3.8 OpenSIPS监控</a></li><li><a href=/opensips/ch3/cache-reload/>3.9 模块缓存策略与reload方法</a></li><li><a href=/opensips/ch3/sip-crlf/>3.10 SIP消息格式CRLF</a></li><li><a href=/opensips/ch3/elk/>3.10 opensips日志写入elasticsearch</a></li><li><a href=/opensips/ch3/prd-warning/>3.10 生产环境监控告警</a></li></ul></li><li><ol start=4><li>媒体相关</li></ol><ul><li><a href=/opensips/ch4/rtp-timestamp/>4.1 RTP 不连续的timestamp和SSRC</a></li><li><a href=/opensips/ch4/media-codec/>4.2 常见媒体流编码及其特点</a></li><li><a href=/opensips/ch4/rtp-record/>4.2 rtpproxy录音</a></li><li><a href=/opensips/ch4/codec-table/>4.2 rtp编码表</a></li></ul></li><li><ol start=5><li>配置文件和路由脚本</li></ol><ul><li><a href=/opensips/ch5/routing-script/>5.1 配置文件</a></li><li><a href=/opensips/ch5/global-params/>5.2 全局参数配置</a></li><li><a href=/opensips/ch5/routing-type/>5.3 路由分类</a></li><li><a href=/opensips/ch5/triger-time/>5.4 路由的触发时机</a></li><li><a href=/opensipsch5/strict-loose-routing/>5.5 严格路由和松散路由</a></li><li><a href=/opensips/ch5/function/>5.6 函数特点</a></li><li><a href=/opensips/ch5/return/>5.7 使用return语句减少逻辑嵌套</a></li><li><a href=/opensips/ch5/condition/>5.8 条件语句特点</a></li><li><a href=/opensips/ch5/statement/>5.9 常用语句</a></li><li><a href=/opensips/ch5/var/>5.10 变量的使用</a></li><li><a href=/opensips/ch5/core-var/>5.11 核心变量说明</a></li><li><a href=/opensips/ch5/xlog/>5.12 优雅的使用xlog输出日志行</a></li><li><a href=/opensips/ch5/module/>5.13 脚本路由模块化</a></li><li><a href=/opensips/ch5/stateful-stateless/>5.14 有状态和无状态路由</a></li><li><a href=/opensips/ch5/init-seque/>5.15 【重点】初始化请求和序列化请求</a></li><li><a href=/opensips/ch5/via-route/>5.16 SIP路由头</a></li><li><a href=/opensips/ch5/avp-db-query/>5.17 avp_db_query数值null值比较</a></li><li><a href=/opensips/ch5/xlog-level/>5.18 日志xlog</a></li><li><a href=/opensips/ch5/homer6/>5.19 opensips 集成 homer6</a></li><li><a href=/opensips/ch5/adv-address/>5.20 【必读】深入对外公布地址</a></li><li><a href=/opensips/ch5/m4/>5.21 使用m4增强opensips.cfg脚本预处理能力</a></li><li><a href=/opensips/ch5/db-mode/>5.22 db_mode调优</a></li><li><a href=/opensips/ch5/sql-table/>5.23 mysql建表语句</a></li><li><a href=/opensips/ch5/core-var-2/>5.24 核心变量解读2-100%</a></li></ul></li><li><ol start=6><li>模块使用教程</li></ol><ul><li><a href=/opensips/ch6/acc/>6.1 acc呼叫记录模块</a></li><li><a href=/opensips/ch6/cachedb/>6.2 cachedb的相关问题</a></li><li><a href=/opensips/ch6/load-balance/>6.3 负载均衡模块load_balance</a></li><li><a href=/opensips/ch6/dispatcher/>6.4 sip消息分发之dispatcher模块</a></li></ul></li><li><ol start=7><li>常见问题</li></ol><ul><li><a href=/opensips/ch7/tm-send-failed/>7.1 opensips 477 Send failed (477/TM)</a></li><li><a href=/opensips/ch7/sendmsg-failed/>7.2 sendmsg failed on 0: Socket operation on non-socket</a></li><li><a href=/opensips/ch7/escape-msg/>7.3 信令路径逃逸分析</a></li><li><a href=/opensips/ch7/crash/>7.4 opensips崩溃分析</a></li><li><a href=/opensips/ch7/can-not-run/>7.5 opensips无法启动</a></li><li><a href=/opensips/ch7/big-udp-msg/>7.6 UDP分片导致SIP消息丢失</a></li><li><a href=/opensips/ch7/rtp-broken-connection>7.7 奥科网关 Rtp Broken Connection</a></li><li><a href=/opensips/ch7/miss-ack/>7.8 ACK 无法正常送到FS</a></li><li><a href=/opensips/ch7/30-seconds-drop/>7.9 30秒自动挂断</a></li><li><a href=/opensips/ch7/cfg-trace/>7.10 script_trace 打印opensips的脚本执行过程</a></li><li><a href=/opensips/ch7/one-leg-audio/>7.11 一方听不到另外一方的声音</a></li><li><a href=/opensips/ch7/echo-back/>7.12 回音问题调研</a></li><li><a href=/opensips/ch7/without-log/>7.13 opensips启动失败没有任何报错日志</a></li><li><a href=/opensips/ch7/poor-quality/>7.14 通话质量差</a></li><li><a href=/opensips/ch7/without-default-carrier/>7.15 ERROR:carrierroute:carrier_tree_fixup: default_carrier not found</a></li></ul></li><li><ol start=8><li>脚本学习</li></ol><ul><li><a href=/opensips/ch8/topology-hiding/>8.1 拓扑隐藏学习以及实践</a></li><li><a href=/opensips/ch8/serial-183/>8.2 serial_183</a></li><li><a href=/opensips/ch8/replicate/>8.3 replicate</a></li><li><a href=/opensips/ch8/redirect/>8.4 redirect</a></li><li><a href=/opensips/ch8/pstn/>8.5 pstn</a></li><li><a href=/opensips/ch8/nathelper/>8.6 nathelper</a></li><li><a href=/opensips/ch8/msilo/>8.7 msilo</a></li><li><a href=/opensips/ch8/logging/>8.8 logging</a></li><li><a href=/opensips/ch8/httpd/>8.9 httpd</a></li><li><a href=/opensips/ch8/fork/>8.10 fork</a></li><li><a href=/opensips/ch8/flag-reply/>8.11 flag reply</a></li><li><a href=/opensips/ch8/exec/>8.12 exec</a></li><li><a href=/opensips/ch8/acc/>8.13 acc</a></li><li><a href=/opensips/ch8/acc-mysql/>8.14 acc-mysql</a></li><li><a href=/opensips/ch8/default/>8.15 default</a></li><li><a href=/opensips/ch8/mid-register/>8.16 mid register</a></li><li><a href=/opensips/ch8/fs-loadbalance/>8.17 fs loadbalance</a></li><li><a href=/opensips/ch8/fraud/>8.18 fraud</a></li><li><a href=/opensips/ch8/dtmf-lan/>8.19 dtmf</a></li><li><a href=/opensips/ch8/siprec/>8.20 siprec</a></li></ul></li><li><ol start=9><li>扩展</li></ol><ul><li><a href=/opensips/ch9/webrtc-ref/>9.1 WebRTC学习资料分享</a></li><li><a href=/opensips/ch9/notes/>9.2 WebRTC简介</a></li><li><a href=/opensips/ch9/webrtc-pdf/>9.3 opensips with webrtc</a></li><li><a href=/opensips/ch9/blf/>9.4 BLF指示灯</a></li><li><a href=/opensips/ch9/isup-sip-isdn/>9.5 ISUP SIP ISDN对照码表</a></li><li><a href=/opensips/ch9/rtpengine-manu/>9.6 rtpengine cli</a></li><li><a href=/opensips/ch9/rtpengine-ilbc/>9.7 rtpengine 增加对ilbc编解码的支持</a></li><li><a href=/opensips/ch9/sdp/>9.8 sdp协议简介</a></li><li><a href=/opensips/ch9/rtpproxy/>9.9 rtpproxy学习</a></li><li><a href=/opensips/ch9/feature-code/>9.10 SIP feature codes SIP功能码</a></li><li><a href=/opensips/ch9/100-rel/>9.11 sbc 100rel</a></li><li><a href=/opensips/ch9/blf-note/>9.12 blf 功能笔记</a></li><li><a href=/opensips/ch9/nat-single-interface/>9.13 NAT场景下的信令处理 - 单网卡</a></li><li><a href=/opensips/ch9/cluster-share-location/>9.14 集群共享分机注册信息</a></li><li><a href=/opensips/ch9/books/>9.15 参考资料与书籍</a></li></ul></li><li><ol start=10><li>相关工具</li></ol><ul><li><a href=/opensips/tools/tshark/>10.1 tshark 快速分析语音流问题</a></li><li><a href=/opensips/tools/heplify/>10.2 heplify SIP信令抓包客户端</a></li><li><a href=/opensips/tools/baresip/>10.3 baresip 非常好用的终端SIP UA</a></li><li><a href=/opensips/tools/sipsak/>10.4 sipsak</a></li><li><a href=/opensips/tools/wireshark-player-pcap/>10.5 wireshark 播放抓包文件</a></li><li><a href=/opensips/tools/sngrep/>10.6 sngrep: 最好用的sip可视化抓包工具</a></li><li><a href=/opensips/tools/homer/>10.7 homer: 统一的sip包集中处理工具</a></li><li><a href=/opensips/tools/siphub/>10.8 siphub 轻量级实时SIP信令收包的服务</a></li><li><a href=/opensips/tools/sipp/>10.9 SIPp：sip压测模拟ua工具</a></li><li><a href=/opensips/tools/sipp-subscriber/>10.10 SIPP subscriber 测试</a></li><li><a href=/opensips/tools/tcp-dump/>10.11 tcpdump</a></li><li><a href=/opensips/tools/pjsip/>10.12 pjsip</a></li><li><a href=/opensips/tools/wireshark-sip/>10.13 Wireshark SIP 抓包</a></li><li><a href=/opensips/tools/kamailio/>10.14 另一个功能强大的sip server: kamailio</a></li></ul></li><li><ol start=11><li>官方博客</li></ol><ul><li><a href=/opensips/blog/load-balance/>Load Balancing in OpenSIPS</a></li><li><a href=/opensips/blog/dialog-trigers/>Dialog triggers, or how to control the calls from script</a></li><li><a href=/opensips/blog/cross-dialog-data/>Cross-dialog data accessing</a></li><li><a href=/opensips/blog/calls-manager/>Calls management using the new Call API tool</a></li><li><a href=/opensips/blog/call-stat/>Improved series-based call statistics using OpenSIPS 3.2</a></li><li><a href=/opensips/blog/opensips3-tls/>Exploring SSL/TLS libraries for OpenSIPS 3.2</a></li><li><a href=/opensips/blog/openssl-opensips/>The OpenSIPS and OpenSSL journey</a></li><li><a href=/opensips/blog/mutltiple-interface/>SIP bridging over multiple interfaces</a></li><li><a href=/opensips/blog/cancel-reason/>CANCEL请求和Reason头</a></li><li><a href=/opensips/blog/opensips3x/>Introducing OpenSIPS 3.0</a></li><li><a href=/opensips/blog/cluster-location/>Clustered SIP User Location: The Full Sharing Topology</a></li><li><a href=/opensips/blog/cluster-call/>Clustering ongoing calls with OpenSIPS 2.4</a></li><li><a href=/opensips/blog/full-anycast/>Full Anycast support in OpenSIPS 2.4</a></li><li><a href=/opensips/blog/deepin-stat-engine/>深入OpenSIPS统计引擎</a></li><li><a href=/opensips/blog/runing-opensips-in-cloud/>Running OpenSIPS in the Cloud</a></li><li><a href=/opensips/blog/troubleshooting-opensips-script/>Troubleshooting OpenSIPS script</a></li><li><a href=/opensips/blog/miss-ack/>Troubleshooting missing ACK in SIP</a></li><li><a href=/opensips/blog/memory-usage/>理解并测量OpenSIPS的内存资源</a></li></ul></li><li><p>问题列表</p><ul><li><a href=/opensips/ch1/utime-task-scheduled>utimer task already scheduled</a></li></ul></li><li><p>OpenSIPS 3X</p><ul><li><a href=/opensips/3x/module-args/>模块传参的重构</a></li></ul></li><li><p><a href=/opensips/module-dev/>模块开发实战</a></p></li><li><p><a href=/opensips/pdf/>OpenSIPS Summit PDF学习资料</a></p></li><li><p><a href=/opensips/dev-audio/>源码学习视频教程</a></p></li></ul><h1 id=文章列表>文章列表<a hidden class=anchor aria-hidden=true href=#文章列表>#</a></h1></div><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>SIP消息格式CRLF</h2></header><div class=entry-content><p>generic-message = start-line *message-header CRLF [ message-body ] start-line = Request-Line / Status-Line 其中在rfc2543中规定
CR = %d13 ; US-ASCII CR, carriage return character LF = %d10 ; US-ASCII LF, line feed character 项目 十进制 字符串表示 CR 13 \r LF 10 \n 也就是说在一个SIP消息中
headline\r\n key:v\r\n \r\n some_body\r\n 所以CRLF就是 \r\n 参考 https://tools.ietf.org/html/rfc3261 https://tools.ietf.org/html/rfc2543</p></div><footer class=entry-footer><span title='2020-12-25 17:44:31 +0800 CST'>2020-12-25 17:44:31</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to SIP消息格式CRLF" href=https://wdd.js.org/opensips/ch3/sip-crlf/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>The OpenSIPS and OpenSSL journey</h2></header><div class=entry-content><p>In order to provide secure SIP communication over TLS connections, OpenSIPS uses the OpenSSL library, probably the most widely used open-source TLS & SSL library across the Internet. The fact that it is so popular and largely used makes it more robust, therefore a great choice to enforce security in a system! That was the reason it was chosen to be used in OpenSIPS in the first place. However, being designed as a multi-threaded library, while OpenSIPS is a multi-process application, integrating it was not an easy task. Furthermore, maintaining it was not trivial either. And the major changes in the OpenSSL library within the last couple of years have proven that. Once the library maintainers decided to have a more robust thread-safe approach, things started to break in OpenSIPS. Hence the numerous issues reported withing the last couple of years related to SSL bugs and crashes. The purpose of this post is to present you the challenges we faced, and how we dealt with them. This article describes the way OpenSSL, a multi-threaded designed library, was designed to work in OpenSIPS, a multi-process application, and what was the journey of maintaining the code by adapting to the changes throughout the years in the OpenSSL library.
...</p></div><footer class=entry-footer><span title='2020-12-21 15:44:33 +0800 CST'>2020-12-21 15:44:33</span>&nbsp;·&nbsp;10 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to The OpenSIPS and OpenSSL journey" href=https://wdd.js.org/opensips/blog/openssl-opensips/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>BLF指示灯</h2></header><div class=entry-content><p>What Is a Busy Lamp Field (BLF) and Why Do You Need It? Busy lamp field is a presence indicator that allows you to see who in your organization is available (or not) for a phone call at any given time.
The term “busy lamp field” sounds a bit more involved than it really is. Put simply, it just means the ability to see who in your organization is available or not for a phone call at any given time.
...</p></div><footer class=entry-footer><span title='2020-11-20 15:45:56 +0800 CST'>2020-11-20 15:45:56</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to BLF指示灯" href=https://wdd.js.org/opensips/ch9/blf/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>siphub 轻量级实时SIP信令收包的服务</h2></header><div class=entry-content><p>o我写siphub的原因是homer太难用了！！经常查不到想查的数据，查询的速度也很慢。
项目地址：https://github.com/wangduanduan/siphub
架构 SIP服务器例如OpenSIPS或者FS可以通过hep协议将数据写到siphub, siphub将数据规整之后写入MySql, siphub同时也提供Web页面来查询和展示SIP消息。 功能介绍 sip-hub是一个专注sip信令的搜索以及时序图可视化展示的服务。
相比于Homer, sip-hub做了大量的功能简化。同时也提供了一些个性化的查询，例如被叫后缀查询，仅域名查询等。
sip-hub服务仅有3个页面
sip消息搜索页面，用于按照主被叫、域名和时间范围搜索呼叫记录 时序图展示页面，用于展示SIP时序图和原始SIP消息 可以导入导出SIP消息 可以查找A-Leg 监控功能 大量简化搜索结果页面。siphub的搜索结果页面，每个callId相同的消息，只展示一条。 相关截图 搜索页面 siphub的搜索结果仅仅展示callId相同的最早的一条记录，这样就避免了像homer那种，看起来很多个消息，实际上都是属于一个INVITE的。 From字段和To字段都支持域名查询：@test.cc From字段也支持后缀查询，例如1234这种号码，可以只输入234就能查到，但是后缀要写完整，只查23是查不到的。 To字段仅仅支持精确查询 信令展示页面 点击对应的消息，详情也会自动跳转出来。 安装 首先需要安装MySql数据库，并在其中建立一个名为siphub的数据库 运行 dbHost 数据库地址 dbUser 数据库用户 dbName 数据库名 dataKeepDays 抓包保存天数 3000端口是web页面端口 9060是hep消息收取端口 docker run -d -p 3000:3000 -p 9060:9060/udp \ --env NODE_ENV=production \ --env dbHost=1.2.3.4 \ --env dbUser=root \ --env dbPwd=123456 \ --env dbName=siphub \ --env dataKeepDays=3 \ --name siphub wangduanduan/siphub 集成 OpenSIPS集成 test witch OpenSIPS 2.4
# add hep listen listen=hep_udp:your_ip:9061 loadmodule "proto_hep.so" # replace SIP_HUB_IP_PORT with siphub‘s ip:port modparam("proto_hep", "hep_id","[hep_dst] SIP_HUB_IP_PORT;transport=udp;version=3") loadmodule "siptrace.so" modparam("siptrace", "trace_id","[tid]uri=hep:hep_dst") # add ite in request route(); if(!is_method("REGISTER") && !has_totag()){ sip_trace("tid", "d", "sip"); } FreeSWITCH集成 fs version 版本要高于 1.6.8+
...</p></div><footer class=entry-footer><span title='2020-08-06 11:19:01 +0800 CST'>2020-08-06 11:19:01</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to siphub 轻量级实时SIP信令收包的服务" href=https://wdd.js.org/opensips/tools/siphub/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>sipsak</h2></header><div class=entry-content><p>sipsak is a command line tool which can send simple requests to a SIP server. It can run additional tests on a SIP server which are usefull for admins and developers of SIP enviroments.
https://github.com/nils-ohlmeier/sipsak
安装 apt-get install sipsak 发送options sipsak -vv -p 192.168.2.63:5060 -s sip:8001@test.cc man SIPSAK(1) User Manuals SIPSAK(1) NAME sipsak - a utility for various tests on sip servers and user agents SYNOPSIS sipsak [-dFGhiILnNMRSTUVvwz] [-a PASSWORD ] [-b NUMBER ] [-c SIPURI ] [-C SIPURI ] [-D NUMBER ] [-e NUMBER ] [-E STRING ] [-f FILE ] [-g STRING ] [-H HOSTNAME ] [-j STRING ] [-J STRING ] [-l PORT ] [-m NUMBER ] [-o NUMBER ] [-p HOSTNAME ] [-P NUMBER ] [-q REGEXP ] [-r PORT ] [-t NUMBER ] [-u STRING ] [-W NUMBER ] [-x NUMBER ] -s SIPURI DESCRIPTION sipsak is a SIP stress and diagnostics utility. It sends SIP requests to the server within the sip-uri and examines received responses. It runs in one of the following modes: - default mode A SIP message is sent to destination in sip-uri and reply status is displayed. The request is either taken from filename or generated as a new OPTIONS message. - traceroute mode (-T) This mode is useful for learning request's path. It operates similarly to IP-layer utility traceroute(8). - message mode (-M) Sends a short message (similar to SMS from the mobile phones) to a given target. With the option -B the content of the MESSAGE can be set. Useful might be the options -c and -O in this mode. - usrloc mode (-U) Stress mode for SIP registrar. sipsak keeps registering to a SIP server at high pace. Additionally the registrar can be stressed with the -I or the -M option. If -I and -M are omitted sipsak can be used to register any given contact (with the -C option) for an account at a registrar and to query the current bindings for an account at a registrar. - randtrash mode (-R) Parser torture mode. sipsak keeps sending randomly corrupted messages to torture a SIP server's parser. - flood mode (-F) Stress mode for SIP servers. sipsak keeps sending requests to a SIP server at high pace. If libruli (http://www.nongnu.org/ruli/) or c-ares (http://daniel.haxx.se/projects/c-ares/) support is compiled into the sipsak binary, then first a SRV lookup for _sip._tcp.hostname is made. If that fails a SRV lookup for _sip._udp.hostname is made. And if this lookup fails a normal A lookup is made. If a port was given in the target URI the SRV lookup is omitted. Failover, load distribution and other transports are not supported yet. OPTIONS -a, --password PASSWORD With the given PASSWORD an authentication will be tryed on received '401 Unauthorized'. Authorization will be tryed on time. If this option is omitted an authorization with an empty password ("") will be tryed. If the password is equal to - the password will be read from the standard input (e.g. the keyboard). This prevents other users on the same host from seeing the password the password in the process list. NOTE: the password still can be read from the memory if other users have access to it. -A, --timing prints only the timing values of the test run if verbosity is zero because no -v was given. If one or more -v were given this option will be ignored. -b, --apendix-begin NUMBER The starting number which is appended to the user name in the usrloc mode. This NUMBER is increased until it reaches the value given by the -e parameter. If omitted the starting number will be one. -B, --message-body STRING The given STRING will be used as the body for outgoing MESSAGE requests. -c, --from SIPURI The given SIPURI will be used in the From header if sipsak runs in the message mode (initiated with the -M option). This is helpful to present the receiver of a MESSAGE a meaningfull and usable address to where maybe even responses can be send. -C, --contact SIPURI This is the content of the Contact header in the usrloc mode. This allows to insert forwards like for mail. For example you can insert the uri of your first SIP account at a second account, thus all calls to the second account will be for‐ warded to the first account. As the argument to this option will not be enclosed in brackets you can give also multiple contacts in the raw format as comma separated list. The special words empty or none will result in no contact header in the REGISTER request and thus the server should answer with the current bindings for the account at the registrar. The special words * or star will result in Contact header containing just a star, e.g. to remove all bindings by using expires value 0 together with this Contact. -d, --ignore-redirects If this option is set all redirects will be ignored. By default without this option received redirects will be respected. This option is automatically activated in the randtrash mode and in the flood mode. -D, --timeout-factor NUMBER The SIP_T1 timer is getting multiplied with the given NUMBER. After receiving a provisional response for an INVITE request, or when a reliable transport like TCP or TLS is used sipsak waits for the resulting amount of time for a final response until it gives up. -e, --appendix-end NUMBER The ending number which is appended to the user name in the usrloc mode. This number is increased until it reaches this ending number. In the flood mode this is the maximum number of messages which will be send. If omitted the default value is 2^31 (2147483647) in the flood mode. -E, --transport STRING The value of STRING will be used as IP transport for sending and receiving requests and responses. This option over‐ writes any result from the URI evaluation and SRV lookup. Currently only 'udp' and 'tcp' are accepted as value for STRING. -f, --filename FILE The content of FILE will be read in in binary mode and will be used as replacement for the alternatively created sip mes‐ sage. This can used in the default mode to make other requests than OPTIONS requests (e.g. INVITE). By default missing carriage returns in front of line feeds will be inserted (use -L to de-activate this function). If the filename is equal to - the file is read from standard input, e.g. from the keyboard or a pipe. Please note that the manipulation functions (e.g. inserting Via header) are only tested with RFC conform requests. Additionally special strings within the file can be replaced with some local or given values (see -g and -G for details). -F, --flood-mode This options activates the flood mode. In this mode OPTIONS requests with increasing CSeq numbers are sent to the server. Replies are ignored -- source port 9 (discard) of localhost is advertised in topmost Via. -h, --help Prints out a simple usage help message. If the long option --help is available it will print out a help message with the available long options. -g, --replace-string STRING Activates the replacement of $replace$ within the request (usually read in from a file) with the STRING. Alternatively you can also specify a list of attribute and values. This list has to start and end with a non alpha-numeric character. The same character has to be used also as separator between the attribute and the value and between new further attribute value pairs. The string "$attribute$" will be replaced with the value string in the message. -G, --replace Activates the automatic replacement of the following variables in the request (usually read in from a file): $dsthost$ will be replaced by with the host or domainname which is given by the -s parameter. $srchost$ will be replaced by the hostname of the local machine. $port$ will be replaced by the local listening port of sipsak. $user$ will be replaced by the username which is given by the -s parameter. -H, --hostname HOSTNAME Overwrites the automatic detection of the hostname with the given parameter. Warning: use this with caution (preferable only if the automatic detection fails). -i, --no-via Deactivates the insertion of the Via line of the localhost. Warning: this probably disables the receiving of the responses from the server. -I, --invite-mode Activates the Invites cycles within the usrloc mode. It should be combined with -U. In this combination sipsak first registeres a user, and then simulates an invitation to this user. First an Invite is sent, this is replied with 200 OK and finally an ACK is sent. This option can also be used without -U , but you should be sure to NOT invite real UAs with this option. In the case of a missing -U the -l PORT is required because only if you made a -U run with a fixed local port before, a run with -I and the same fixed local port can be successful. Warning: sipsak is no real UA and invita‐ tions to real UAs can result in unexpected behaivior. -j, --headers STRING The string will be added as one or more additional headers to the request. The string "\n" (note: two characters) will be replaced with CRLF and thus result in two separate headers. That way more then one header can be added. -J, --autohash STRING The string will be used as the H(A1) input to the digest authentication response calculation. Thus no password from the -a option is required if this option is provided. The given string is expected to be a hex string with the length of the used hash function. -k, --local-ip STRING The local ip address to be used -l, --local-port PORT The receiving UDP socket will use the local network port. Useful if a file is given by -f which contains a correct Via line. Check the -S option for details how sipsak sends and receives messages. -L, --no-crlf De-activates the insertion of carriage returns (\r) before all line feeds (\n) (which is not already proceeded by car‐ raige return) if the input is coming from a file ( -f ). Without this option also an empty line will be appended to the request if required. -m, --max-forwards NUMBER This sets the value of the Max-Forward header field. If omitted no Max-Forward field will be inserted. If omitted in the traceroute mode number will be 255. -M, --message-mode This activates the Messages cycles within the usrloc mode (known from sipsak versions pre 0.8.0 within the normal usrloc test). This option should be combined with -U so that a successful registration will be tested with a test message to the user and replied with 200 OK. But this option can also be used without the -U option. Warning: using without -U can cause unexpected behaivor. -n, --numeric Instead of the full qualified domain name in the Via line the IP of the local host will be used. This option is now on by default. -N, --nagios-code Use Nagios comliant return codes instead of the normal sipsak ones. This means sipsak will return 0 if everything was ok and 2 in case of any error (local or remote). -o, --sleep NUMBER sipsak will sleep for NUMBER ms before it starts the next cycle in the usrloc mode. This will slow down the whole test process to be more realistic. Each cycle will be still completed as fast as possible, but the whole test will be slowed down. -O, --disposition STRING The given STRING will be used as the content for the Content-Disposition header. Without this option there will be no Content-Disposition header in the request. -p, --outbound-proxy HOSTNAME[:PORT] the address of the hostname is the target where the request will be sent to (outgoing proxy). Use this if the destination host is different then the host part of the request uri. The hostname is resolved via DNS SRV if supported (see descrip‐ tion for SRV resolving) and no port is given. -P, --processes NUMBER Start NUMBER of processes in parallel to do the send and reply checking. Only makes sense if a higher number for -e is given in the usrloc, message or invite mode. -q, --search REGEXP match replies against REGEXP and return false if no match occurred. Useful for example to detect server name in Server header field. -r, --remote-port PORT Instead of the default sip port 5060 the PORT will be used. Alternatively the remote port can be given within the sip uri of the -s parameter. -R, --random-mode This activates the randtrash mode. In this mode OPTIONS requests will be send to server with increasing numbers of ran‐ domly crashed characters within this request. The position within the request and the replacing character are randomly chosen. Any other response than Bad request (4xx) will stop this mode. Also three unresponded sends will stop this mode. With the -t parameter the maximum of trashed characters can be given. -s, --sip-uri SIPURI This mandatory option sets the destination of the request. It depends on the mode if only the server name or also an user name is mandatory. Example for a full SIPURI : sip:test@foo.bar:123 See the note in the description part about SRV lookups for details how the hostname of this URI is converted into an IP and port. -S, --symmetric With this option sipsak will use only one port for sending and receiving messages. With this option the local port for sending will be the value from the -l option. In the default mode sipsak sends from a random port and listens on the given port from the -l option. Note: With this option sipsak will not be able to receive replies from servers with asym‐ metric signaling (and broken rport implementation) like the Cisco proxy. If you run sipsak as root and with raw socket support (check the output from the -V option) then this option is not required because in this case sipsak already uses only one port for sending and receiving messages. -t, --trash-chars NUMBER This parameter specifies the maximum of trashed characters in the randtrash mode. If omitted NUMBER will be set to the length of the request. -T, --traceroute-mode This activates the traceroute mode. This mode works like the well known traceroute(8) command expect that not the number of network hops are counted rather the number of server on the way to the destination user. Also the round trip time of each request is printed out, but due to a limitation within the sip protocol the identity (IP or name) can only deter‐ mined and printed out if the response from the server contains a warning header field. In this mode on each outgoing request the value of the Max-Forwards header field is increased, starting with one. The maximum of the Max-Forwards header will 255 if no other value is given by the -m parameter. Any other response than 483 or 1xx are treated as a final response and will terminate this mode. -u, --auth-username STRING Use the given STRING as username value for the authentication (different account and authentication username). -U, --usrloc-mode This activates the usrloc mode. Without the -I or the -M option, this only registers users at a registrar. With one of the above options the previous registered user will also be probed ether with a simulated call flow (invite, 200, ack) or with an instant message (message, 200). One password for all users accounts within the usrloc test can be given with the -a option. An user name is mandatory for this mode in the -s parameter. The number starting from the -b parameter to the -e parameter is appended the user name. If the -b and the -e parameter are omitted, only one runs with the given user‐ name, but without append number to the usernames is done. -v, --verbose This parameter increases the output verbosity. No -v means nearly no output except in traceroute and error messages. The maximum of three v's prints out the content of all packets received and sent. -V, --version Prints out the name and version number of sipsak and the options which were compiled into the binary. -w, --extract-ip Activates the extraction of the IP or hostname from the Warning header field. -W, --nagios-warn NUMBER Return Nagios warn exit code (1) if the number of retransmissions before success was above the given number. -x, --expires NUMBER Sets the value of the Expires header to the given number. -z, --remove-bindings Activates the randomly removing of old bindings in the usrloc mode. How many per cent of the bindings will be removed, is determined by the USRLOC_REMOVE_PERCENT define within the code (set it before compilation). Multiple removing of bind‐ ings is possible, and cannot be prevented. -Z, --timer-t1 Sets the amount of milliseconds for the SIP timer T1. It determines the length of the gaps between two retransmissions of a request on a unreliable transport. Default value is 500 if not changed via the configure option --enable-timeout. RETURN VALUES The return value 0 means that a 200 was received. 1 means something else then 1xx or 2xx was received. 2 will be returned on local errors like non resolvable names or wrong options combination. 3 will be returned on remote errors like socket errors (e.g. icmp error), redirects without a contact header or simply no answer (timeout). If the -N option was given the return code will be 2 in case of any (local or remote) error. 1 in case there have been retrans‐ missions from sipsak to the server. And 0 if there was no error at all. CAUTION Use sipsak responsibly. Running it in any of the stress modes puts substantial burden on network and server under test. EXAMPLES sipsak -vv -s sip:nobody@foo.bar displays received replies. sipsak -T -s sip:nobody@foo.bar traces SIP path to nobody. sipsak -U -C sip:me@home -x 3600 -a password -s sip:myself@company inserts forwarding from work to home for one hour. sipsak -f bye.sip -g '!FTAG!345.af23!TTAG!1208.12!' -s sip:myproxy reads the file bye.sip, replaces $FTAG$ with 345.af23 and $TTAG$ with 1208.12 and finally send this message to myproxy LIMITATIONS / NOT IMPLEMENTED Many servers may decide NOT to include SIP "Warning" header fields. Unfortunately, this makes displaying IP addresses of SIP servers in traceroute mode impossible. IPv6 is not supported. Missing support for the Record-Route and Route header. BUGS sipsak is only tested against the SIP Express Router (ser) though their could be various bugs. Please feel free to mail them to the author. AUTHOR Nils Ohlmeier &lt;nils at sipsak dot org> SEE ALSO traceroute(8)</p></div><footer class=entry-footer><span title='2020-07-31 19:16:36 +0800 CST'>2020-07-31 19:16:36</span>&nbsp;·&nbsp;15 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to sipsak" href=https://wdd.js.org/opensips/tools/sipsak/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>[todo] db_mode调优</h2></header><div class=entry-content><p>opensips在多实例时，会有一些数据同步策略的问题。
～</p></div><footer class=entry-footer><span title='2020-07-22 14:25:16 +0800 CST'>2020-07-22 14:25:16</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to [todo] db_mode调优" href=https://wdd.js.org/opensips/ch5/db-mode/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>使用m4增强opensips.cfg脚本预处理能力</h2></header><div class=entry-content><p>相比于kamailo的脚本的预处理能力，opensips的脚本略显单薄。OpenSIPS官方也认识到了这一点，但是也并未准备如何提高这部分能力。因为OpenSIPS是想将预处理交给这方面的专家，也就是大名鼎鼎的m4(当然，你可能根本不知道m4是啥)。
举例来说 我们看一下opensips自带脚本的中的一小块。 里面就有三个要配置的地方
这个listen的地址： listen=udp:127.0.0.1:5060 数据库地址的配置：modparam(“usrloc”, “db_url”, “dbdriver://username:password@dbhost/dbname”) 数据库地址的配置：modparam(“acc”, “db_url”, “mysql://user:password@localhost/opensips”) auto_aliases=no listen=udp:127.0.0.1:5060 # CUSTOMIZE ME mpath="/usr/local//lib/opensips/modules/" loadmodule "usrloc.so" modparam("usrloc", "db_url", "dbdriver://username:password@dbhost/dbname") modparam("acc", "early_media", 0) modparam("acc", "report_cancels", 0) modparam("acc", "detect_direction", 0) modparam("acc", "db_url", "mysql://user:password@localhost/opensips") 随着脚本代码的增多，各种配置往往越来越多。真是脚本里，配置的地方远远不止三处！
你开发了OpenSIPS的脚本，但是真正部署的服务的可能是其他人。那么其他拿到你的脚本的时候，他们怎么知道要改哪些地方呢，难道要搜索一下，所有出现#CUSTOMIZE ME的地方就是需要配置的？ 难道他们每次部署一个服务，就要改一遍脚本的内容？ 改错了谁负责？
如果你不想被运维人员在背后骂娘，就不要把配置性的数据写死到脚本里！
如果你不想在打游戏的时候被运维人员点电话问这个配置出错应该怎么解决，就不要把配置型数据写死到脚本里！
** 那么，你就需要用到M4**
什么是M4？ M4是一种宏语言，如果你不清楚什么是宏，你就可以把M4想想成一种字符串替换的工具。
如何安装M4? 大部分Linux上都已经默认安装了m4, 你可以用m4 --version检查一下m4是否已经存在。
m4 --version Copyright © 2021 Free Software Foundation, Inc. GPLv3+ 许可证: GNU 通用公共许可证第三版或更高版本 &lt;https://gnu.org/licenses/gpl.html>。 这是自由软件: 您可自由更改并重新分发它。 在法律所允许的范围内，不附带任何担保条款。 如果不存在的话，可以用对应常用的包管理工具来安装，例如
...</p></div><footer class=entry-footer><span title='2020-07-22 14:16:17 +0800 CST'>2020-07-22 14:16:17</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to 使用m4增强opensips.cfg脚本预处理能力" href=https://wdd.js.org/opensips/ch5/m4/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>SIP bridging over multiple interfaces</h2></header><div class=entry-content><p>There are scenarios where you need OpenSIPS to route SIP traffic across more than one IP interface. Such a typical scenario is where OpenSIPS is required to perform bridging. The bridging may be between different IP networks (like public versus private, IPv4 versus IPv6) or between different transport protocols for SIP (like UDP versus TCP versus TLS).So, how do we switch to a different outbound interface in OpenSIPS ?
...</p></div><footer class=entry-footer><span title='2020-07-16 14:20:50 +0800 CST'>2020-07-16 14:20:50</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to SIP bridging over multiple interfaces" href=https://wdd.js.org/opensips/blog/mutltiple-interface/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>通话质量差</h2></header><div class=entry-content><p>通话质量差，一般可能以下因素有关。
媒体服务器或者媒体代理服务器CPU, 内存异常 通信网络差 中继或者网关送过来的本来音质就不好。 解决思路：
这个需要监控媒体服务器或者媒体代理CPU，内存是否正常 也可以在媒体代理上用tupdump抓包，然后用wireshark分析 调听服务端的录音，看看服务端录音是否也存在音质差的问题</p></div><footer class=entry-footer><span title='2020-07-08 18:50:35 +0800 CST'>2020-07-08 18:50:35</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to 通话质量差" href=https://wdd.js.org/opensips/ch7/poor-quality/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>一方听不到另外一方的声音</h2></header><div class=entry-content><p>这个问题很大可能和和SDP没有正确修改有关。需要排查SIP信令的sdp地址是否正确。 防火墙策略问题：有的网络允许udp出去，但是不允许udp进来。需要设置防火墙策略。 udp端口范围太小。一般一个通话需要占用4个udp端口。如果开放的udp端口太少，在通话达到一定数量后，就会出现一部分呼叫没有可用端口。 用户设备的问题。例如用户的电脑声卡或者扬声器出现问题。 由于网络的复杂性，还有很多可能 一般遇到这个问题，可以按照如下的思路排查：
服务端有录音功能的，可以先在服务端听录音，看看服务端录音里是否正常。一般来说有四种情况。 两方的录音都没有 主叫方有，被叫方没有 被叫方有，主叫方没有 主被叫都有。但是就是一方听不到另一方。 通过排查服务端的录音，就可以大致知道到底是AB两个leg, 每个leg上的语音流收发的情况。
从信令的的sdp中分析，这个需要一定的SIP协议的分析能力。有些时候，sdp里面的媒体地址不正确，也会导致媒体流无法正常首发。 NAT策略。NAT一般有四种，用的比较多的是端口限制型。这种NAT要求外网流量在进入NAT内部时，必需先有内部的流量出去。当内部流量出去之后，这个NAT洞才会出现，外部的流量才能从这个洞进入。如果NAT内部设备一直不发送rtp包，那么外部的流量即使进来，也会被防火墙拦截掉。 无论是运维人员还是开发人员，在遇到媒体流问题时，一定要先搞清楚整个软交换的网络拓扑架构。否则只能南辕北辙。 sngrep -cr, 加上r这个参数，可以实时观察媒体流的流动情况。是个非常好的功能。但是对于那种加密的媒体流，sngrep是抓不到的，这点要注意。常见的WebRTC的媒体流就是加密的。 最终如果还是解决不了，那么只能祭出最后的杀器：tcpdump + wireshark。服务端抓包的话，虽然sngrep可以抓包，但是比较浪费内存还可能会出现丢包。最好用tcpdump抓包成文件，然后在wireshark上分析。</p></div><footer class=entry-footer><span title='2020-07-08 18:49:58 +0800 CST'>2020-07-08 18:49:58</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to 一方听不到另外一方的声音" href=https://wdd.js.org/opensips/ch7/one-leg-audio/></a></article><footer class=page-footer><nav class=pagination><a class=prev href=https://wdd.js.org/opensips/page/5/>«&nbsp;Prev&nbsp;
</a><a class=next href=https://wdd.js.org/opensips/page/7/>Next&nbsp;&nbsp;»</a></nav></footer></main><footer class=footer><span>&copy; 2025 <a href=https://wdd.js.org/>洞香春</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>