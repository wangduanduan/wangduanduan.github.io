<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>OpenSIPS2.4.X 中文实战系列 | 洞香春</title><meta name=keywords content><meta name=description content="OpenSIPS VOIP"><meta name=author content="Eddie Wang"><link rel=canonical href=https://wdd.js.org/opensips/><link crossorigin=anonymous href=/assets/css/stylesheet.min.ceab085cbbf58c0ec96f6d415d51b3b44e204edfd71a45b4fa2d4aac13f119d0.css integrity="sha256-zqsIXLv1jA7Jb21BXVGztE4gTt/XGkW0+i1KrBPxGdA=" rel="preload stylesheet" as=style><link crossorigin=anonymous herf=/font-awesome/css/font-awesome.min.css rel=stylesheet type=text/css><link rel=preload href=/cowboy.ico as=image><link rel=icon href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/cowboy.ico><link rel=apple-touch-icon href=https://wdd.js.org/cowboy.ico><link rel=mask-icon href=https://wdd.js.org/cowboy.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.109.0"><link rel=alternate type=application/rss+xml href=https://wdd.js.org/opensips/index.xml><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="OpenSIPS2.4.X 中文实战系列"><meta property="og:description" content="OpenSIPS VOIP"><meta property="og:type" content="website"><meta property="og:url" content="https://wdd.js.org/opensips/"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="og:site_name" content="洞香春"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="OpenSIPS2.4.X 中文实战系列"><meta name=twitter:description content="OpenSIPS VOIP"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"OpenSIPS2.4.X 中文实战系列","item":"https://wdd.js.org/opensips/"}]}</script></head><body class="list dark" id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org accesskey=h title="洞香春 (Alt + H)"><img src=/cowboy.ico alt=logo aria-label=logo height=35>洞香春</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/fe/ title=Frontend><span>Frontend</span></a></li><li><a href=https://wdd.js.org/golang/ title=Golang><span>Golang</span></a></li><li><a href=https://wdd.js.org/container/ title=k8s/docker><span>k8s/docker</span></a></li><li><a href=https://wdd.js.org/network/ title=Network><span>Network</span></a></li><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span class=active>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/shell/ title=Shell><span>Shell</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/categories/ title=分类><span>分类</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://wdd.js.org>Home</a></div><h1>OpenSIPS2.4.X 中文实战系列</h1><div class=post-description>OpenSIPS VOIP</div></header><div class=post-content><p>本系列文章是我在学习 OpenSIPS 过程中，慢慢总结出来的。虽说是实战，但是笔记的成分可能会多点，我也无法保证里面的内容是否完全正确。</p><p>VOIP 对我来说是个比较陌生的领域。进入这个领域可以说是一个意外。在学习过程和实战过程中，我发现了 VOIP 有很大的复杂性。生产环境也会有常常有怪异棘手的各种问题。在解决这些问题的过程中，有种升级打怪的感觉。</p><p>本知识库重点在于讲解 OpenSIPS，当然其中也涵盖了 SIP 协议，FreeSWITCH, rtpproxy, rtpengine，以及一些排查问题的工具。</p><p>推荐在学习的过程中，一定要啃一遍 RFC 3261 协议，这是 VOIP 的基石。</p><p>QQ学习交流群：
<img loading=lazy src=2022-12-03-20-58-09.png alt></p><h1 id=文章目录>文章目录<a hidden class=anchor aria-hidden=true href=#文章目录>#</a></h1><ul><li><p>1: SIP 协议</p><ul><li><a href=/opensips/ch1/study-tips>1.1 学习建议</a></li><li><a href=/opensips/ch1/sip-overview>1.2 SIP 协议简介</a></li><li><a href=ch1/via-route-record-route>1.3 Via route Record-Route 的区别</a></li><li><a href=/opensips/ch1/sip-path>1.4 SIP Path 头</a></li><li><a href=/opensips/ch1/trunk-pbx-gateway>1.5 Trunk PBX Gateway</a></li><li><a href=/opensips/ch1/sip-notes>1.6 SIP 协议拾遗补缺</a></li><li><a href=/opensips/ch1/sip-with-sdp>1.7 SIP 与 SDP 的关系</a></li><li><a href=/opensips/ch1/nat-sip-rtp>1.8 SIP 信令和媒体都绕不开的 NAT 问题</a></li><li><a href=/opensips/ch1/stun-notes>1.9 STUN 协议笔记</a></li><li><a href=/opensips/ch1/sip-register>1.10 SIP 注册调研</a></li><li><a href=/opensips/ch1/sip-ack>1.11 深入 SIP ACK 消息</a></li><li><a href=/opensips/ch1/ua-answer-mode>1.12 UA 应答模式</a></li><li><a href=/opensips/ch1/deep-in-nat>1.13 NAT 深入学习</a></li><li><a href=/opensips/ch1/fix-nat>1.14 解决 NAT 问题</a></li><li><a href=/opensips/ch1/from-to-request-url>1.15 From To Request URL 之间的关系</a></li><li><a href=/opensips/ch1/sip-rfcs>1.16 SIP 相关 RFC 协议</a></li><li><a href=/opensips/ch1/story-of-nat>1.17 漫话 NAT 的历史</a></li><li><a href=/opensips/ch1/offer-answer>1.18 媒体协商 offer/answer 模型</a></li><li><a href=/opensips/ch1/sip-rtp-path>1.19 媒体路径与信令路径</a></li><li><a href=/opensips/ch1/csta-call-model>1.20 CSTA 呼叫模型简介</a></li></ul></li><li><ol start=2><li>常识</li></ol><ul><li><a href=/opensips/ch2/early-media-type>2.1 几种常用电话信号音的含义</a></li><li><a href=/opensips/ch2/early-media>2.2 回铃音</a></li></ul></li><li><ol start=3><li>OpenSIPS安装与管理</li></ol><ul><li><a href=/opensips/ch3/about-opensips>3.1 opensips介绍</a></li><li><a href=/opensips/ch3/install-opensips>3.2 debian jessie opensips 2.4.7 安装</a></li><li><a href=/opensips/ch3/centos-install>3.3 centos7 安装opensips</a></li><li><a href=/opensips/ch3/log>3.4 设置独立日志文件</a></li><li><a href=/opensips/ch3/core-mi>3.5 核心MI命令</a></li><li><a href=/opensips/ch3/opensipsctl>3.6 opensips管理命令</a></li><li><a href=/opensips/ch3/centos7-2.4/>3.7 centos7 2.2 升级到2.4.6</a></li><li><a href=/opensips/ch3/opensips-monitor/>3.8 OpenSIPS监控</a></li><li><a href=/opensips/ch3/cache-reload/>3.9 模块缓存策略与reload方法</a></li><li><a href=/opensips/ch3/sip-crlf/>3.10 SIP消息格式CRLF</a></li><li><a href=/opensips/ch3/elk/>3.10 opensips日志写入elasticsearch</a></li><li><a href=/opensips/ch3/prd-warning/>3.10 生产环境监控告警</a></li></ul></li><li><ol start=4><li>媒体相关</li></ol><ul><li><a href=/opensips/ch4/rtp-timestamp/>4.1 RTP 不连续的timestamp和SSRC</a></li><li><a href=/opensips/ch4/media-codec/>4.2 常见媒体流编码及其特点</a></li><li><a href=/opensips/ch4/rtp-record/>4.2 rtpproxy录音</a></li><li><a href=/opensips/ch4/codec-table/>4.2 rtp编码表</a></li></ul></li><li><ol start=5><li>配置文件和路由脚本</li></ol><ul><li><a href=/opensips/ch5/routing-script/>5.1 配置文件</a></li><li><a href=/opensips/ch5/global-params/>5.2 全局参数配置</a></li><li><a href=/opensips/ch5/routing-type/>5.3 路由分类</a></li><li><a href=/opensips/ch5/triger-time/>5.4 路由的触发时机</a></li><li><a href=/opensipsch5/strict-loose-routing/>5.5 严格路由和松散路由</a></li><li><a href=/opensips/ch5/function/>5.6 函数特点</a></li><li><a href=/opensips/ch5/return/>5.7 使用return语句减少逻辑嵌套</a></li><li><a href=/opensips/ch5/condition/>5.8 条件语句特点</a></li><li><a href=/opensips/ch5/statement/>5.9 常用语句</a></li><li><a href=/opensips/ch5/var/>5.10 变量的使用</a></li><li><a href=/opensips/ch5/core-var/>5.11 核心变量说明</a></li><li><a href=/opensips/ch5/xlog/>5.12 优雅的使用xlog输出日志行</a></li><li><a href=/opensips/ch5/module/>5.13 脚本路由模块化</a></li><li><a href=/opensips/ch5/stateful-stateless/>5.14 有状态和无状态路由</a></li><li><a href=/opensips/ch5/init-seque/>5.15 【重点】初始化请求和序列化请求</a></li><li><a href=/opensips/ch5/via-route/>5.16 SIP路由头</a></li><li><a href=/opensips/ch5/avp-db-query/>5.17 avp_db_query数值null值比较</a></li><li><a href=/opensips/ch5/xlog-level/>5.18 日志xlog</a></li><li><a href=/opensips/ch5/homer6/>5.19 opensips 集成 homer6</a></li><li><a href=/opensips/ch5/adv-address/>5.20 【必读】深入对外公布地址</a></li><li><a href=/opensips/ch5/m4/>5.21 使用m4增强opensips.cfg脚本预处理能力</a></li><li><a href=/opensips/ch5/db-mode/>5.22 db_mode调优</a></li><li><a href=/opensips/ch5/sql-table/>5.23 mysql建表语句</a></li><li><a href=/opensips/ch5/core-var-2/>5.24 核心变量解读2-100%</a></li></ul></li><li><ol start=6><li>模块使用教程</li></ol><ul><li><a href=/opensips/ch6/acc/>6.1 acc呼叫记录模块</a></li><li><a href=/opensips/ch6/cachedb/>6.2 cachedb的相关问题</a></li><li><a href=/opensips/ch6/load-balance/>6.3 负载均衡模块load_balance</a></li><li><a href=/opensips/ch6/dispatcher/>6.4 sip消息分发之dispatcher模块</a></li></ul></li><li><ol start=7><li>常见问题</li></ol><ul><li><a href=/opensips/ch7/tm-send-failed/>7.1 opensips 477 Send failed (477/TM)</a></li><li><a href=/opensips/ch7/sendmsg-failed/>7.2 sendmsg failed on 0: Socket operation on non-socket</a></li><li><a href=/opensips/ch7/escape-msg/>7.3 信令路径逃逸分析</a></li><li><a href=/opensips/ch7/crash/>7.4 opensips崩溃分析</a></li><li><a href=/opensips/ch7/can-not-run/>7.5 opensips无法启动</a></li><li><a href=/opensips/ch7/big-udp-msg/>7.6 UDP分片导致SIP消息丢失</a></li><li><a href=/opensips/ch7/rtp-broken-connection>7.7 奥科网关 Rtp Broken Connection</a></li><li><a href=/opensips/ch7/miss-ack/>7.8 ACK 无法正常送到FS</a></li><li><a href=/opensips/ch7/30-seconds-drop/>7.9 30秒自动挂断</a></li><li><a href=/opensips/ch7/cfg-trace/>7.10 script_trace 打印opensips的脚本执行过程</a></li><li><a href=/opensips/ch7/one-leg-audio/>7.11 一方听不到另外一方的声音</a></li><li><a href=/opensips/ch7/echo-back/>7.12 回音问题调研</a></li><li><a href=/opensips/ch7/without-log/>7.13 opensips启动失败没有任何报错日志</a></li><li><a href=/opensips/ch7/poor-quality/>7.14 通话质量差</a></li><li><a href=/opensips/ch7/without-default-carrier/>7.15 ERROR:carrierroute:carrier_tree_fixup: default_carrier not found</a></li></ul></li><li><ol start=8><li>脚本学习</li></ol><ul><li><a href=/opensips/ch8/topology-hiding/>8.1 拓扑隐藏学习以及实践</a></li><li><a href=/opensips/ch8/serial-183/>8.2 serial_183</a></li><li><a href=/opensips/ch8/replicate/>8.3 replicate</a></li><li><a href=/opensips/ch8/redirect/>8.4 redirect</a></li><li><a href=/opensips/ch8/pstn/>8.5 pstn</a></li><li><a href=/opensips/ch8/nathelper/>8.6 nathelper</a></li><li><a href=/opensips/ch8/msilo/>8.7 msilo</a></li><li><a href=/opensips/ch8/logging/>8.8 logging</a></li><li><a href=/opensips/ch8/httpd/>8.9 httpd</a></li><li><a href=/opensips/ch8/fork/>8.10 fork</a></li><li><a href=/opensips/ch8/flag-reply/>8.11 flag reply</a></li><li><a href=/opensips/ch8/exec/>8.12 exec</a></li><li><a href=/opensips/ch8/acc/>8.13 acc</a></li><li><a href=/opensips/ch8/acc-mysql/>8.14 acc-mysql</a></li><li><a href=/opensips/ch8/default/>8.15 default</a></li><li><a href=/opensips/ch8/mid-register/>8.16 mid register</a></li><li><a href=/opensips/ch8/fs-loadbalance/>8.17 fs loadbalance</a></li><li><a href=/opensips/ch8/fraud/>8.18 fraud</a></li><li><a href=/opensips/ch8/dtmf-lan/>8.19 dtmf</a></li><li><a href=/opensips/ch8/siprec/>8.20 siprec</a></li></ul></li><li><ol start=9><li>扩展</li></ol><ul><li><a href=/opensips/ch9/webrtc-ref/>9.1 WebRTC学习资料分享</a></li><li><a href=/opensips/ch9/notes/>9.2 WebRTC简介</a></li><li><a href=/opensips/ch9/webrtc-pdf/>9.3 opensips with webrtc</a></li><li><a href=/opensips/ch9/blf/>9.4 BLF指示灯</a></li><li><a href=/opensips/ch9/isup-sip-isdn/>9.5 ISUP SIP ISDN对照码表</a></li><li><a href=/opensips/ch9/rtpengine-manu/>9.6 rtpengine cli</a></li><li><a href=/opensips/ch9/rtpengine-ilbc/>9.7 rtpengine 增加对ilbc编解码的支持</a></li><li><a href=/opensips/ch9/sdp/>9.8 sdp协议简介</a></li><li><a href=/opensips/ch9/rtpproxy/>9.9 rtpproxy学习</a></li><li><a href=/opensips/ch9/feature-code/>9.10 SIP feature codes SIP功能码</a></li><li><a href=/opensips/ch9/100-rel/>9.11 sbc 100rel</a></li><li><a href=/opensips/ch9/blf-note/>9.12 blf 功能笔记</a></li><li><a href=/opensips/ch9/nat-single-interface/>9.13 NAT场景下的信令处理 - 单网卡</a></li><li><a href=/opensips/ch9/cluster-share-location/>9.14 集群共享分机注册信息</a></li><li><a href=/opensips/ch9/books/>9.15 参考资料与书籍</a></li></ul></li><li><ol start=10><li>相关工具</li></ol><ul><li><a href=/opensips/tools/tshark/>10.1 tshark 快速分析语音流问题</a></li><li><a href=/opensips/tools/heplify/>10.2 heplify SIP信令抓包客户端</a></li><li><a href=/opensips/tools/baresip/>10.3 baresip 非常好用的终端SIP UA</a></li><li><a href=/opensips/tools/sipsak/>10.4 sipsak</a></li><li><a href=/opensips/tools/wireshark-player-pcap/>10.5 wireshark 播放抓包文件</a></li><li><a href=/opensips/tools/sngrep/>10.6 sngrep: 最好用的sip可视化抓包工具</a></li><li><a href=/opensips/tools/homer/>10.7 homer: 统一的sip包集中处理工具</a></li><li><a href=/opensips/tools/siphub/>10.8 siphub 轻量级实时SIP信令收包的服务</a></li><li><a href=/opensips/tools/sipp/>10.9 SIPp：sip压测模拟ua工具</a></li><li><a href=/opensips/tools/sipp-subscriber/>10.10 SIPP subscriber 测试</a></li><li><a href=/opensips/tools/tcp-dump/>10.11 tcpdump</a></li><li><a href=/opensips/tools/pjsip/>10.12 pjsip</a></li><li><a href=/opensips/tools/wireshark-sip/>10.13 Wireshark SIP 抓包</a></li><li><a href=/opensips/tools/kamailio/>10.14 另一个功能强大的sip server: kamailio</a></li></ul></li><li><ol start=11><li>官方博客</li></ol><ul><li><a href=/opensips/blog/load-balance/>Load Balancing in OpenSIPS</a></li><li><a href=/opensips/blog/dialog-trigers/>Dialog triggers, or how to control the calls from script</a></li><li><a href=/opensips/blog/cross-dialog-data/>Cross-dialog data accessing</a></li><li><a href=/opensips/blog/calls-manager/>Calls management using the new Call API tool</a></li><li><a href=/opensips/blog/call-stat/>Improved series-based call statistics using OpenSIPS 3.2</a></li><li><a href=/opensips/blog/opensips3-tls/>Exploring SSL/TLS libraries for OpenSIPS 3.2</a></li><li><a href=/opensips/blog/openssl-opensips/>The OpenSIPS and OpenSSL journey</a></li><li><a href=/opensips/blog/mutltiple-interface/>SIP bridging over multiple interfaces</a></li><li><a href=/opensips/blog/cancel-reason/>CANCEL请求和Reason头</a></li><li><a href=/opensips/blog/opensips3x/>Introducing OpenSIPS 3.0</a></li><li><a href=/opensips/blog/cluster-location/>Clustered SIP User Location: The Full Sharing Topology</a></li><li><a href=/opensips/blog/cluster-call/>Clustering ongoing calls with OpenSIPS 2.4</a></li><li><a href=/opensips/blog/full-anycast/>Full Anycast support in OpenSIPS 2.4</a></li><li><a href=/opensips/blog/deepin-stat-engine/>深入OpenSIPS统计引擎</a></li><li><a href=/opensips/blog/runing-opensips-in-cloud/>Running OpenSIPS in the Cloud</a></li><li><a href=/opensips/blog/troubleshooting-opensips-script/>Troubleshooting OpenSIPS script</a></li><li><a href=/opensips/blog/miss-ack/>Troubleshooting missing ACK in SIP</a></li><li><a href=/opensips/blog/memory-usage/>理解并测量OpenSIPS的内存资源</a></li></ul></li><li><p>问题列表</p><ul><li><a href=/opensips/ch1/utime-task-scheduled>utimer task already scheduled</a></li></ul></li><li><p>OpenSIPS 3X</p><ul><li><a href=/opensips/3x/module-args/>模块传参的重构</a></li></ul></li><li><p><a href=/opensips/module-dev/>模块开发实战</a></p></li><li><p><a href=/opensips/pdf/>OpenSIPS Summit PDF学习资料</a></p></li><li><p><a href=/opensips/dev-audio/>源码学习视频教程</a></p></li></ul><h1 id=文章列表>文章列表<a hidden class=anchor aria-hidden=true href=#文章列表>#</a></h1></div><article class=post-entry><header class=entry-header><h2>BLF指示灯</h2></header><section class=entry-content><p>What Is a Busy Lamp Field (BLF) and Why Do You Need It? Busy lamp field is a presence indicator that allows you to see who in your organization is available (or not) for a phone call at any given time.
The term “busy lamp field” sounds a bit more involved than it really is. Put simply, it just means the ability to see who in your organization is available or not for a phone call at any given time....</p></section><footer class=entry-footer><span title='2020-11-20 15:45:56 +0800 CST'>2020-11-20 15:45:56</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to BLF指示灯" href=https://wdd.js.org/opensips/ch9/blf/></a></article><article class=post-entry><header class=entry-header><h2>siphub 轻量级实时SIP信令收包的服务</h2></header><section class=entry-content><p>o我写siphub的原因是homer太难用了！！经常查不到想查的数据，查询的速度也很慢。
项目地址：https://github.com/wangduanduan/siphub
架构 SIP服务器例如OpenSIPS或者FS可以通过hep协议将数据写到siphub, siphub将数据规整之后写入MySql, siphub同时也提供Web页面来查询和展示SIP消息。 功能介绍 sip-hub是一个专注sip信令的搜索以及时序图可视化展示的服务。
相比于Homer, sip-hub做了大量的功能简化。同时也提供了一些个性化的查询，例如被叫后缀查询，仅域名查询等。
sip-hub服务仅有3个页面
sip消息搜索页面，用于按照主被叫、域名和时间范围搜索呼叫记录 时序图展示页面，用于展示SIP时序图和原始SIP消息 可以导入导出SIP消息 可以查找A-Leg 监控功能 大量简化搜索结果页面。siphub的搜索结果页面，每个callId相同的消息，只展示一条。 相关截图 搜索页面 siphub的搜索结果仅仅展示callId相同的最早的一条记录，这样就避免了像homer那种，看起来很多个消息，实际上都是属于一个INVITE的。 From字段和To字段都支持域名查询：@test.cc From字段也支持后缀查询，例如1234这种号码，可以只输入234就能查到，但是后缀要写完整，只查23是查不到的。 To字段仅仅支持精确查询 信令展示页面 点击对应的消息，详情也会自动跳转出来。 安装 首先需要安装MySql数据库，并在其中建立一个名为siphub的数据库 运行 dbHost 数据库地址 dbUser 数据库用户 dbName 数据库名 dataKeepDays 抓包保存天数 3000端口是web页面端口 9060是hep消息收取端口 docker run -d -p 3000:3000 -p 9060:9060/udp \ --env NODE_ENV=production \ --env dbHost=1.2.3.4 \ --env dbUser=root \ --env dbPwd=123456 \ --env dbName=siphub \ --env dataKeepDays=3 \ --name siphub wangduanduan/siphub 集成 OpenSIPS集成 test witch OpenSIPS 2....</p></section><footer class=entry-footer><span title='2020-08-06 11:19:01 +0800 CST'>2020-08-06 11:19:01</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to siphub 轻量级实时SIP信令收包的服务" href=https://wdd.js.org/opensips/tools/siphub/></a></article><article class=post-entry><header class=entry-header><h2>sipsak</h2></header><section class=entry-content><p>sipsak is a command line tool which can send simple requests to a SIP server. It can run additional tests on a SIP server which are usefull for admins and developers of SIP enviroments.
https://github.com/nils-ohlmeier/sipsak
安装 apt-get install sipsak 发送options sipsak -vv -p 192.168.2.63:5060 -s sip:8001@test.cc man SIPSAK(1) User Manuals SIPSAK(1) NAME sipsak - a utility for various tests on sip servers and user agents SYNOPSIS sipsak [-dFGhiILnNMRSTUVvwz] [-a PASSWORD ] [-b NUMBER ] [-c SIPURI ] [-C SIPURI ] [-D NUMBER ] [-e NUMBER ] [-E STRING ] [-f FILE ] [-g STRING ] [-H HOSTNAME ] [-j STRING ] [-J STRING ] [-l PORT ] [-m NUMBER ] [-o NUMBER ] [-p HOSTNAME ] [-P NUMBER ] [-q REGEXP ] [-r PORT ] [-t NUMBER ] [-u STRING ] [-W NUMBER ] [-x NUMBER ] -s SIPURI DESCRIPTION sipsak is a SIP stress and diagnostics utility....</p></section><footer class=entry-footer><span title='2020-07-31 19:16:36 +0800 CST'>2020-07-31 19:16:36</span>&nbsp;·&nbsp;15 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to sipsak" href=https://wdd.js.org/opensips/tools/sipsak/></a></article><article class=post-entry><header class=entry-header><h2>[todo] db_mode调优</h2></header><section class=entry-content><p>opensips在多实例时，会有一些数据同步策略的问题。
～</p></section><footer class=entry-footer><span title='2020-07-22 14:25:16 +0800 CST'>2020-07-22 14:25:16</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to [todo] db_mode调优" href=https://wdd.js.org/opensips/ch5/db-mode/></a></article><article class=post-entry><header class=entry-header><h2>使用m4增强opensips.cfg脚本预处理能力</h2></header><section class=entry-content><p>相比于kamailo的脚本的预处理能力，opensips的脚本略显单薄。OpenSIPS官方也认识到了这一点，但是也并未准备如何提高这部分能力。因为OpenSIPS是想将预处理交给这方面的专家，也就是大名鼎鼎的m4(当然，你可能根本不知道m4是啥)。
举例来说 我们看一下opensips自带脚本的中的一小块。 里面就有三个要配置的地方
这个listen的地址： listen=udp:127.0.0.1:5060 数据库地址的配置：modparam(“usrloc”, “db_url”, “dbdriver://username:password@dbhost/dbname”) 数据库地址的配置：modparam(“acc”, “db_url”, “mysql://user:password@localhost/opensips”) auto_aliases=no listen=udp:127.0.0.1:5060 # CUSTOMIZE ME mpath="/usr/local//lib/opensips/modules/" loadmodule "usrloc.so" modparam("usrloc", "db_url", "dbdriver://username:password@dbhost/dbname") modparam("acc", "early_media", 0) modparam("acc", "report_cancels", 0) modparam("acc", "detect_direction", 0) modparam("acc", "db_url", "mysql://user:password@localhost/opensips") 随着脚本代码的增多，各种配置往往越来越多。真是脚本里，配置的地方远远不止三处！
你开发了OpenSIPS的脚本，但是真正部署的服务的可能是其他人。那么其他拿到你的脚本的时候，他们怎么知道要改哪些地方呢，难道要搜索一下，所有出现#CUSTOMIZE ME的地方就是需要配置的？ 难道他们每次部署一个服务，就要改一遍脚本的内容？ 改错了谁负责？
如果你不想被运维人员在背后骂娘，就不要把配置性的数据写死到脚本里！
如果你不想在打游戏的时候被运维人员点电话问这个配置出错应该怎么解决，就不要把配置型数据写死到脚本里！
** 那么，你就需要用到M4**
什么是M4？ M4是一种宏语言，如果你不清楚什么是宏，你就可以把M4想想成一种字符串替换的工具。
如何安装M4? 大部分Linux上都已经默认安装了m4, 你可以用m4 --version检查一下m4是否已经存在。
m4 --version Copyright © 2021 Free Software Foundation, Inc. GPLv3+ 许可证: GNU 通用公共许可证第三版或更高版本 &lt;https://gnu.org/licenses/gpl.html>。 这是自由软件: 您可自由更改并重新分发它。 在法律所允许的范围内，不附带任何担保条款。 如果不存在的话，可以用对应常用的包管理工具来安装，例如
apt-get install m4 能否举个m4例子？ hello-world....</p></section><footer class=entry-footer><span title='2020-07-22 14:16:17 +0800 CST'>2020-07-22 14:16:17</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to 使用m4增强opensips.cfg脚本预处理能力" href=https://wdd.js.org/opensips/ch5/m4/></a></article><article class=post-entry><header class=entry-header><h2>SIP bridging over multiple interfaces</h2></header><section class=entry-content><p>There are scenarios where you need OpenSIPS to route SIP traffic across more than one IP interface. Such a typical scenario is where OpenSIPS is required to perform bridging. The bridging may be between different IP networks (like public versus private, IPv4 versus IPv6) or between different transport protocols for SIP (like UDP versus TCP versus TLS).So, how do we switch to a different outbound interface in OpenSIPS ?
Auto detection OpenSIPS has a built in automatic way of picking up the right outbound interface, the so called “Multi homed” support or shortly “mhomed”, controlled by the mhomed core parameter....</p></section><footer class=entry-footer><span title='2020-07-16 14:20:50 +0800 CST'>2020-07-16 14:20:50</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to SIP bridging over multiple interfaces" href=https://wdd.js.org/opensips/blog/mutltiple-interface/></a></article><article class=post-entry><header class=entry-header><h2>通话质量差</h2></header><section class=entry-content><p>通话质量差，一般可能以下因素有关。
媒体服务器或者媒体代理服务器CPU, 内存异常 通信网络差 中继或者网关送过来的本来音质就不好。 解决思路：
这个需要监控媒体服务器或者媒体代理CPU，内存是否正常 也可以在媒体代理上用tupdump抓包，然后用wireshark分析 调听服务端的录音，看看服务端录音是否也存在音质差的问题</p></section><footer class=entry-footer><span title='2020-07-08 18:50:35 +0800 CST'>2020-07-08 18:50:35</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to 通话质量差" href=https://wdd.js.org/opensips/ch7/poor-quality/></a></article><article class=post-entry><header class=entry-header><h2>一方听不到另外一方的声音</h2></header><section class=entry-content><p>这个问题很大可能和和SDP没有正确修改有关。需要排查SIP信令的sdp地址是否正确。 防火墙策略问题：有的网络允许udp出去，但是不允许udp进来。需要设置防火墙策略。 udp端口范围太小。一般一个通话需要占用4个udp端口。如果开放的udp端口太少，在通话达到一定数量后，就会出现一部分呼叫没有可用端口。 用户设备的问题。例如用户的电脑声卡或者扬声器出现问题。 由于网络的复杂性，还有很多可能 一般遇到这个问题，可以按照如下的思路排查：
服务端有录音功能的，可以先在服务端听录音，看看服务端录音里是否正常。一般来说有四种情况。 两方的录音都没有 主叫方有，被叫方没有 被叫方有，主叫方没有 主被叫都有。但是就是一方听不到另一方。 通过排查服务端的录音，就可以大致知道到底是AB两个leg, 每个leg上的语音流收发的情况。
从信令的的sdp中分析，这个需要一定的SIP协议的分析能力。有些时候，sdp里面的媒体地址不正确，也会导致媒体流无法正常首发。 NAT策略。NAT一般有四种，用的比较多的是端口限制型。这种NAT要求外网流量在进入NAT内部时，必需先有内部的流量出去。当内部流量出去之后，这个NAT洞才会出现，外部的流量才能从这个洞进入。如果NAT内部设备一直不发送rtp包，那么外部的流量即使进来，也会被防火墙拦截掉。 无论是运维人员还是开发人员，在遇到媒体流问题时，一定要先搞清楚整个软交换的网络拓扑架构。否则只能南辕北辙。 sngrep -cr, 加上r这个参数，可以实时观察媒体流的流动情况。是个非常好的功能。但是对于那种加密的媒体流，sngrep是抓不到的，这点要注意。常见的WebRTC的媒体流就是加密的。 最终如果还是解决不了，那么只能祭出最后的杀器：tcpdump + wireshark。服务端抓包的话，虽然sngrep可以抓包，但是比较浪费内存还可能会出现丢包。最好用tcpdump抓包成文件，然后在wireshark上分析。</p></section><footer class=entry-footer><span title='2020-07-08 18:49:58 +0800 CST'>2020-07-08 18:49:58</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to 一方听不到另外一方的声音" href=https://wdd.js.org/opensips/ch7/one-leg-audio/></a></article><article class=post-entry><header class=entry-header><h2>30秒自动挂断</h2></header><section class=entry-content><p>在通话接近30秒时，呼叫自动挂断。
有很大的可能和丢失了ACK有关。这个需要用sngrep去抓包看SIP时序图来确定是否是ACK丢失。
丢失ACK的原因很大可能是NAT没有处理好，或者是网络协议不匹配等等。</p></section><footer class=entry-footer><span title='2020-07-08 18:47:06 +0800 CST'>2020-07-08 18:47:06</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to 30秒自动挂断" href=https://wdd.js.org/opensips/ch7/30-seconds-drop/></a></article><article class=post-entry><header class=entry-header><h2>媒体路径与信令路径</h2></header><section class=entry-content><p>一般的sip网关同时具有信令和媒体处理的能力，如下图。
但是也有信令和媒体分开的网关。在和网关信令交互过程中，网关会将媒体地址放到sdp中。
难点就来了，在nat存在的场景下，你并不知道sdp里的媒体地址是否是真实的地址。
那么你就要选择，是相信sdp中的媒体地址，还是把sip信令的源ip作为媒体地址呢？</p></section><footer class=entry-footer><span title='2020-06-24 09:11:35 +0800 CST'>2020-06-24 09:11:35</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to 媒体路径与信令路径" href=https://wdd.js.org/opensips/ch1/sip-rtp-path/></a></article><footer class=page-footer><nav class=pagination><a class=prev href=https://wdd.js.org/opensips/page/5/>« Prev Page</a>
<a class=next href=https://wdd.js.org/opensips/page/7/>Next Page »</a></nav></footer></main><footer class=footer><span>&copy; 2023 <a href=https://wdd.js.org>洞香春</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>