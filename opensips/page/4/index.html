<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>OpenSIPS2.4.X 中文实战系列 | 洞香春</title><meta name=keywords content><meta name=description content="OpenSIPS VOIP"><meta name=author content="王端端"><link rel=canonical href=https://wdd.js.org/opensips/><link crossorigin=anonymous href=/assets/css/stylesheet.min.ceab085cbbf58c0ec96f6d415d51b3b44e204edfd71a45b4fa2d4aac13f119d0.css integrity="sha256-zqsIXLv1jA7Jb21BXVGztE4gTt/XGkW0+i1KrBPxGdA=" rel="preload stylesheet" as=style><link crossorigin=anonymous herf=/font-awesome/css/font-awesome.min.css rel=stylesheet type=text/css><link rel=preload href=/cowboy.ico as=image><link rel=icon href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/cowboy.ico><link rel=apple-touch-icon href=https://wdd.js.org/cowboy.ico><link rel=mask-icon href=https://wdd.js.org/cowboy.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.107.0"><link rel=alternate type=application/rss+xml href=https://wdd.js.org/opensips/index.xml><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="OpenSIPS2.4.X 中文实战系列"><meta property="og:description" content="OpenSIPS VOIP"><meta property="og:type" content="website"><meta property="og:url" content="https://wdd.js.org/opensips/"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="og:site_name" content="洞香春"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="OpenSIPS2.4.X 中文实战系列"><meta name=twitter:description content="OpenSIPS VOIP"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"OpenSIPS2.4.X 中文实战系列","item":"https://wdd.js.org/opensips/"}]}</script></head><body class="list dark" id=top><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org accesskey=h title="洞香春 (Alt + H)"><img src=/cowboy.ico alt=logo aria-label=logo height=35>洞香春</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/fe/ title=Frontend><span>Frontend</span></a></li><li><a href=https://wdd.js.org/golang/ title=Golang><span>Golang</span></a></li><li><a href=https://wdd.js.org/container/ title=k8s/docker><span>k8s/docker</span></a></li><li><a href=https://wdd.js.org/network/ title=Network><span>Network</span></a></li><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span class=active>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/shell/ title=Shell><span>Shell</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/categories/ title=分类><span>分类</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://wdd.js.org>Home</a></div><h1>OpenSIPS2.4.X 中文实战系列</h1><div class=post-description>OpenSIPS VOIP</div></header><div class=post-content><p>本系列文章是我在学习 OpenSIPS 过程中，慢慢总结出来的。虽说是实战，但是笔记的成分可能会多点，我也无法保证里面的内容是否完全正确。</p><p>VOIP 对我来说是个比较陌生的领域。进入这个领域可以说是一个意外。在学习过程和实战过程中，我发现了 VOIP 有很大的复杂性。生产环境也会有常常有怪异棘手的各种问题。在解决这些问题的过程中，有种升级打怪的感觉。</p><p>本知识库重点在于讲解 OpenSIPS，当然其中也涵盖了 SIP 协议，FreeSWITCH, rtpproxy, rtpengine，以及一些排查问题的工具。</p><p>推荐在学习的过程中，一定要啃一遍 RFC 3261 协议，这是 VOIP 的基石。</p><h1 id=文章目录>文章目录<a hidden class=anchor aria-hidden=true href=#文章目录>#</a></h1><ul><li><p>1: SIP 协议</p><ul><li><a href=/opensips/ch1/study-tips>1.1 学习建议</a></li><li><a href=/opensips/ch1/sip-overview>1.2 SIP 协议简介</a></li><li><a href=ch1/via-route-record-route>1.3 Via route Record-Route 的区别</a></li><li><a href=/opensips/ch1/sip-path>1.4 SIP Path 头</a></li><li><a href=/opensips/ch1/trunk-pbx-gateway>1.5 Trunk PBX Gateway</a></li><li><a href=/opensips/ch1/sip-notes>1.6 SIP 协议拾遗补缺</a></li><li><a href=/opensips/ch1/sip-with-sdp>1.7 SIP 与 SDP 的关系</a></li><li><a href=/opensips/ch1/nat-sip-rtp>1.8 SIP 信令和媒体都绕不开的 NAT 问题</a></li><li><a href=/opensips/ch1/stun-notes>1.9 STUN 协议笔记</a></li><li><a href=/opensips/ch1/sip-register>1.10 SIP 注册调研</a></li><li><a href=/opensips/ch1/sip-ack>1.11 深入 SIP ACK 消息</a></li><li><a href=/opensips/ch1/ua-answer-mode>1.12 UA 应答模式</a></li><li><a href=/opensips/ch1/deep-in-nat>1.13 NAT 深入学习</a></li><li><a href=/opensips/ch1/fix-nat>1.14 解决 NAT 问题</a></li><li><a href=/opensips/ch1/from-to-request-url>1.15 From To Request URL 之间的关系</a></li><li><a href=/opensips/ch1/sip-rfcs>1.16 SIP 相关 RFC 协议</a></li><li><a href=/opensips/ch1/story-of-nat>1.17 漫话 NAT 的历史</a></li><li><a href=/opensips/ch1/offer-answer>1.18 媒体协商 offer/answer 模型</a></li><li><a href=/opensips/ch1/sip-rtp-path>1.19 媒体路径与信令路径</a></li><li><a href=/opensips/ch1/csta-call-model>1.20 CSTA 呼叫模型简介</a></li></ul></li><li><ol start=2><li>常识</li></ol><ul><li><a href=/opensips/ch2/early-media-type>2.1 几种常用电话信号音的含义</a></li><li><a href=/opensips/ch2/early-media>2.2 回铃音</a></li></ul></li><li><ol start=3><li>OpenSIPS安装与管理</li></ol><ul><li><a href=/opensips/ch3/about-opensips>3.1 opensips介绍</a></li><li><a href=/opensips/ch3/install-opensips>3.2 debian jessie opensips 2.4.7 安装</a></li><li><a href=/opensips/ch3/centos-install>3.3 centos7 安装opensips</a></li><li><a href=/opensips/ch3/log>3.4 设置独立日志文件</a></li><li><a href=/opensips/ch3/core-mi>3.5 核心MI命令</a></li><li><a href=/opensips/ch3/opensipsctl>3.6 opensips管理命令</a></li><li><a href=/opensips/ch3/centos7-2.4/>3.7 centos7 2.2 升级到2.4.6</a></li><li><a href=/opensips/ch3/opensips-monitor/>3.8 OpenSIPS监控</a></li><li><a href=/opensips/ch3/cache-reload/>3.9 模块缓存策略与reload方法</a></li><li><a href=/opensips/ch3/sip-crlf/>3.10 SIP消息格式CRLF</a></li><li><a href=/opensips/ch3/elk/>3.10 opensips日志写入elasticsearch</a></li><li><a href=/opensips/ch3/prd-warning/>3.10 生产环境监控告警</a></li></ul></li><li><ol start=4><li>媒体相关</li></ol><ul><li><a href=/opensips/ch4/rtp-timestamp/>4.1 RTP 不连续的timestamp和SSRC</a></li><li><a href=/opensips/ch4/media-codec/>4.2 常见媒体流编码及其特点</a></li><li><a href=/opensips/ch4/rtp-record/>4.2 rtpproxy录音</a></li><li><a href=/opensips/ch4/codec-table/>4.2 rtp编码表</a></li></ul></li><li><ol start=5><li>配置文件和路由脚本</li></ol><ul><li><a href=/opensips/ch5/routing-script/>5.1 配置文件</a></li><li><a href=/opensips/ch5/global-params/>5.2 全局参数配置</a></li><li><a href=/opensips/ch5/routing-type/>5.3 路由分类</a></li><li><a href=/opensips/ch5/triger-time/>5.4 路由的触发时机</a></li><li><a href=/opensipsch5/strict-loose-routing/>5.5 严格路由和松散路由</a></li><li><a href=/opensips/ch5/function/>5.6 函数特点</a></li><li><a href=/opensips/ch5/return/>5.7 使用return语句减少逻辑嵌套</a></li><li><a href=/opensips/ch5/condition/>5.8 条件语句特点</a></li><li><a href=/opensips/ch5/statement/>5.9 常用语句</a></li><li><a href=/opensips/ch5/var/>5.10 变量的使用</a></li><li><a href=/opensips/ch5/core-var/>5.11 核心变量说明</a></li><li><a href=/opensips/ch5/xlog/>5.12 优雅的使用xlog输出日志行</a></li><li><a href=/opensips/ch5/module/>5.13 脚本路由模块化</a></li><li><a href=/opensips/ch5/stateful-stateless/>5.14 有状态和无状态路由</a></li><li><a href=/opensips/ch5/init-seque/>5.15 【重点】初始化请求和序列化请求</a></li><li><a href=/opensips/ch5/via-route/>5.16 SIP路由头</a></li><li><a href=/opensips/ch5/avp-db-query/>5.17 avp_db_query数值null值比较</a></li><li><a href=/opensips/ch5/xlog-level/>5.18 日志xlog</a></li><li><a href=/opensips/ch5/homer6/>5.19 opensips 集成 homer6</a></li><li><a href=/opensips/ch5/adv-address/>5.20 【必读】深入对外公布地址</a></li><li><a href=/opensips/ch5/m4/>5.21 使用m4增强opensips.cfg脚本预处理能力</a></li><li><a href=/opensips/ch5/db-mode/>5.22 db_mode调优</a></li><li><a href=/opensips/ch5/sql-table/>5.23 mysql建表语句</a></li><li><a href=/opensips/ch5/core-var-2/>5.24 核心变量解读2-100%</a></li></ul></li><li><ol start=6><li>模块使用教程</li></ol><ul><li><a href=/opensips/ch6/acc/>6.1 acc呼叫记录模块</a></li><li><a href=/opensips/ch6/cachedb/>6.2 cachedb的相关问题</a></li><li><a href=/opensips/ch6/load-balance/>6.3 负载均衡模块load_balance</a></li><li><a href=/opensips/ch6/dispatcher/>6.4 sip消息分发之dispatcher模块</a></li></ul></li><li><ol start=7><li>常见问题</li></ol><ul><li><a href=/opensips/ch7/tm-send-failed/>7.1 opensips 477 Send failed (477/TM)</a></li><li><a href=/opensips/ch7/sendmsg-failed/>7.2 sendmsg failed on 0: Socket operation on non-socket</a></li><li><a href=/opensips/ch7/escape-msg/>7.3 信令路径逃逸分析</a></li><li><a href=/opensips/ch7/crash/>7.4 opensips崩溃分析</a></li><li><a href=/opensips/ch7/can-not-run/>7.5 opensips无法启动</a></li><li><a href=/opensips/ch7/big-udp-msg/>7.6 UDP分片导致SIP消息丢失</a></li><li><a href=/opensips/ch7/rtp-broken-connection>7.7 奥科网关 Rtp Broken Connection</a></li><li><a href=/opensips/ch7/miss-ack/>7.8 ACK 无法正常送到FS</a></li><li><a href=/opensips/ch7/30-seconds-drop/>7.9 30秒自动挂断</a></li><li><a href=/opensips/ch7/cfg-trace/>7.10 script_trace 打印opensips的脚本执行过程</a></li><li><a href=/opensips/ch7/one-leg-audio/>7.11 一方听不到另外一方的声音</a></li><li><a href=/opensips/ch7/echo-back/>7.12 回音问题调研</a></li><li><a href=/opensips/ch7/without-log/>7.13 opensips启动失败没有任何报错日志</a></li><li><a href=/opensips/ch7/poor-quality/>7.14 通话质量差</a></li><li><a href=/opensips/ch7/without-default-carrier/>7.15 ERROR:carrierroute:carrier_tree_fixup: default_carrier not found</a></li></ul></li><li><ol start=8><li>脚本学习</li></ol><ul><li><a href=/opensips/ch8/topology-hiding/>8.1 拓扑隐藏学习以及实践</a></li><li><a href=/opensips/ch8/serial-183/>8.2 serial_183</a></li><li><a href=/opensips/ch8/replicate/>8.3 replicate</a></li><li><a href=/opensips/ch8/redirect/>8.4 redirect</a></li><li><a href=/opensips/ch8/pstn/>8.5 pstn</a></li><li><a href=/opensips/ch8/nathelper/>8.6 nathelper</a></li><li><a href=/opensips/ch8/msilo/>8.7 msilo</a></li><li><a href=/opensips/ch8/logging/>8.8 logging</a></li><li><a href=/opensips/ch8/httpd/>8.9 httpd</a></li><li><a href=/opensips/ch8/fork/>8.10 fork</a></li><li><a href=/opensips/ch8/flag-reply/>8.11 flag reply</a></li><li><a href=/opensips/ch8/exec/>8.12 exec</a></li><li><a href=/opensips/ch8/acc/>8.13 acc</a></li><li><a href=/opensips/ch8/acc-mysql/>8.14 acc-mysql</a></li><li><a href=/opensips/ch8/default/>8.15 default</a></li><li><a href=/opensips/ch8/mid-register/>8.16 mid register</a></li><li><a href=/opensips/ch8/fs-loadbalance/>8.17 fs loadbalance</a></li><li><a href=/opensips/ch8/fraud/>8.18 fraud</a></li><li><a href=/opensips/ch8/dtmf-lan/>8.19 dtmf</a></li><li><a href=/opensips/ch8/siprec/>8.20 siprec</a></li></ul></li><li><ol start=9><li>扩展</li></ol><ul><li><a href=ch9/webrtc-ref/>9.1 WebRTC学习资料分享</a></li><li><a href=ch9/notes/>9.1 WebRTC简介</a></li><li><a href=ch9/webrtc-pdf/>9.1 opensips with webrtc</a></li><li><a href=ch9/blf/>9.1 BLF指示灯</a></li><li><a href=ch9/isup-sip-isdn/>9.1 ISUP SIP ISDN对照码表</a></li><li><a href=ch9/rtpengine-manu/>9.1 rtpengine cli</a></li><li><a href=ch9/rtpengine-ilbc/>rtpengine 增加对ilbc编解码的支持</a></li><li><a href=ch9/sdp/>sdp协议简介</a></li><li><a href=ch9/rtpproxy/>rtpproxy学习</a></li><li><a href=ch9/feature-code/>SIP feature codes SIP功能码</a></li></ul></li><li><ol start=10><li>相关工具</li></ol><ul><li><a href=tools/tshark/>tshark 快速分析语音流问题</a></li><li><a href=tools/heplify/>heplify SIP信令抓包客户端</a></li><li><a href=tools/baresip/>baresip 非常好用的终端SIP UA</a></li><li><a href=tools/sipsak/>sipsak</a></li><li><a href=tools/wireshark-player-pcap/>wireshark 播放抓包文件</a></li><li><a href=tools/sngrep/>sngrep: 最好用的sip可视化抓包工具</a></li><li><a href=tools/homer/>homer: 统一的sip包集中处理工具</a></li><li><a href=tools/siphub/>siphub 轻量级实时SIP信令收包的服务</a></li><li><a href=tools/sipp/>SIPp：sip压测模拟ua工具</a></li><li><a href=tools/sipp-subscriber/>SIPP subscriber 测试</a></li><li><a href=tools/tcp-dump/>tcpdump</a></li><li><a href=tools/pjsip/>pjsip</a></li><li><a href=tools/wireshark-sip/>Wireshark SIP 抓包</a></li></ul></li><li><p>问题列表</p><ul><li><a href=/opensips/ch1/utime-task-scheduled>utimer task already scheduled</a></li></ul></li></ul><h1 id=文章列表>文章列表<a hidden class=anchor aria-hidden=true href=#文章列表>#</a></h1></div><article class=post-entry><header class=entry-header><h2>subscribe场景测试</h2></header><section class=entry-content><p>时序图 场景解释 step1: SUBSCRIBE 客户端想要订阅某个分机的状态 step2: 200 Ok 服务端接受了这个订阅消息 step3: NOTIFY 服务端向客户端返回他的订阅目标的状态 step4: 200 Ok 客户端返回表示接受 场景文件 &lt;?xml version="1.0" encoding="iso-8859-2" ?> &lt;!DOCTYPE scenario SYSTEM "sipp.dtd"> &lt;scenario name="subscibe wait notify"> &lt;send retrans="500"> &lt;![CDATA[ SUBSCRIBE sip:[my_monitor]@[my_domain] SIP/2.0 Via: SIP/2.0/[transport] [local_ip]:[local_port];branch=[branch] From: sipp &lt;sip:[my_ext]@[my_domain]>;tag=[call_number] To: &lt;sip:[my_monitor]@[my_domain]:[remote_port]> Call-ID: [call_id] CSeq: [cseq] SUBSCRIBE Contact: sip:[my_ext]@[local_ip]:[local_port] Max-Forwards: 10 Event: dialog Expires: 120 User-Agent: SIPp/Win32 Accept: application/dialog-info+xml, multipart/related, application/rlmi+xml Content-Length: 0 ]]> &lt;/send> &lt;recv response="200" rtd="true"> &lt;/recv> &lt;recv request="NOTIFY" crlf="true" rrs="true"> &lt;/recv> &lt;send> &lt;!...</p></section><footer class=entry-footer><span title='2021-04-08 12:32:49 +0800 CST'>2021-04-08 12:32:49</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;王端端&nbsp;&nbsp;| 本文总阅读量<span id=busuanzi_value_page_pv></span>次</footer><a class=entry-link aria-label="post link to subscribe场景测试" href=https://wdd.js.org/opensips/tools/sipp-subscriber/></a></article><article class=post-entry><header class=entry-header><h2>常用语句</h2></header><section class=entry-content><p>if if (expr) { actions } else { actions; } if (expr) { actions } else if (expr) { actions; } 表达式操作符号 常用的用黄色标记。
== 等于 != 不等于 =~ 正则匹配 $rU =~ '^1800*' is “$rU begins with 1800” !~ 正则不匹配 大于
= 大于等于
&lt; 小于 &lt;= 小于等于 && 逻辑与 **|| **逻辑或 **! **逻辑非 [ … ] - test operator - inside can be any arithmetic expression 其他 出了常见的if语句，opensips还支持switch, while, for each, 因为用的比较少。各位可以看官方文档说明。...</p></section><footer class=entry-footer><span title='2021-03-23 15:05:06 +0800 CST'>2021-03-23 15:05:06</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;王端端&nbsp;&nbsp;| 本文总阅读量<span id=busuanzi_value_page_pv></span>次</footer><a class=entry-link aria-label="post link to 常用语句" href=https://wdd.js.org/opensips/ch5/statement/></a></article><article class=post-entry><header class=entry-header><h2>使用return语句减少逻辑嵌套</h2></header><section class=entry-content><p>使用return(int)语句可以返回整数值。
return(0) 相当于exit(), 后续的路由都不在执行 return(正整数) 后续的路由还会继续执行，if测试为true return(负整数) 后续的路由还会继续执行, if测试为false 可以使用 $rc 或者 $retcode 获取上一个路由的返回值 # 请求路由 route{ route(check_is_feature_code); xlog("check_is_feature_code return code is $rc"); ... ... route(some_other_check); } route[check_is_feature_code]{ if ($rU !~ "^\*[0-9]+") { xlog("check_is_feature_code: is not feature code $rU"); # 非feature code, 提前返回 return(1); } # 下面就是feature code的处理 ...... } route[some_other_check]{ ... }</p></section><footer class=entry-footer><span title='2021-03-23 14:54:08 +0800 CST'>2021-03-23 14:54:08</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;王端端&nbsp;&nbsp;| 本文总阅读量<span id=busuanzi_value_page_pv></span>次</footer><a class=entry-link aria-label="post link to 使用return语句减少逻辑嵌套" href=https://wdd.js.org/opensips/ch5/return/></a></article><article class=post-entry><header class=entry-header><h2>核心变量说明</h2></header><section class=entry-content><p>$ru $rU 可读可写以下面的sip URL举例
sip:8001@test.cc;a=1;b=2 $ru 代表整个sip url就是 sip:8001@test.cc;a=1;b=2 $rU代表用户部分，就是8001 **
$du 可读可写
$du = "sip:192.468.2.40"; $du可以理解为外呼代理，我们想让这个请求发到下一个sip服务器，就把$du设置为下一跳的地址。</p></section><footer class=entry-footer><span title='2021-03-23 14:47:07 +0800 CST'>2021-03-23 14:47:07</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;王端端&nbsp;&nbsp;| 本文总阅读量<span id=busuanzi_value_page_pv></span>次</footer><a class=entry-link aria-label="post link to 核心变量说明" href=https://wdd.js.org/opensips/ch5/core-var/></a></article><article class=post-entry><header class=entry-header><h2>SIP feature codes SIP功能码</h2></header><section class=entry-content><p>功能描述 用户可以拨打一个特殊的号码，用来触发特定的功能。常见的功能码一般以 * 开头，例如
*1 组内代接 *1(EXT) 代接指定的分机 *2 呼叫转移 **87 请勿打扰 … 上面的栗子，具体的功能码，对应的业务逻辑是可配置的。
场景举例 我的分机是8001，我看到8008的分机正在振铃，此时我需要把电话接起来。但是我不能走到8008的工位上去接电话，我必须要在自己的工位上接电话。
那么我在自己的分机上输入*18008 这时SIP服务端就知道你想代8008接听正在振铃的电话。
说起来功能码就是一种使用话机上按键的一组暗号。
话机上一般只有0-9*#，一共12个按键。没法办用其他的编码告诉服务端自己想做什么，所以只能用功能码。
参考 https://www.ipcomms.net/support/myoffice-pbx/feature-codes https://www.cisco.com/c/en/us/td/docs/voice_ip_comm/cucme/admin/configuration/manual/cmeadm/cmefacs.pdf https://help.yeastar.com/en/s-series/topic/feature_code.html?hl=feature%2Ccode&_ga=2.76562834.622619423.1615949948-1155631884.1615949948</p></section><footer class=entry-footer><span title='2021-03-17 10:57:45 +0800 CST'>2021-03-17 10:57:45</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;王端端&nbsp;&nbsp;| 本文总阅读量<span id=busuanzi_value_page_pv></span>次</footer><a class=entry-link aria-label="post link to SIP feature codes SIP功能码" href=https://wdd.js.org/opensips/ch9/feature-code/></a></article><article class=post-entry><header class=entry-header><h2>ACK 无法正常送到FS</h2></header><section class=entry-content><p>通过sngrep抓包发现，通话正常，ACK无法送到FS。导致通话一段时间后，FS因为没有收到ACK，就发送了BYE来挂断呼叫。
sngrep定位到问题可能出在OpenSIPS上，然后分析opensips的日志。
Mar 9 16:58:00 dd opensips[84]: ERROR:dialog:dlg_validate_dialog: failed to validate remote contact: dlg=[sip:9999@192.168.2.161:5080;transport=udp] , req =[sip:192.168.2.109:18627;lr;ftag=CX3CDinLARXn1ZRNIlPaFexgirQczdr7;did=4c1.a9657441] 上面的日志，提示问题出在dialog验证上，dialog验证失败的原因可能与contact头有关。
然后我有仔细的分析了一下SIP转包。发现contact中的ip地址192.168.2.161并不是fs的地址。但是它为什么会出现在fs回的200ok中呢？
这是我就想起了fs vars.xml，其中有几个参数是用来配置服务器的ip地址的。
由于我的fs是个树莓派，ip是自动分配的，重启之后，可能获取了新的ip。但是老的ip地址，还是存在于vars.xml中。
然后我就去排查了一下fs的var.xml， 发现下面三个参数都是192.168.2.161， 但是实际上树莓派的地址已经不是这个了。
bind_server_ip external_rtp_ip external_sip_ip 解决方案：改变fs vars.xml中的地址配置信息，然后重启fs。
除了fs的原因，还有一部分原因可能是错误的使用了fix_nated_contact。**务必记住：对于位于边界的SIP服务器来说，对于进入的SIP请求，一般需要fix_nated_contaced。对于这个请求的响应，则不需要进行nat处理。
深入思考一下，为什么concact头修改的错了，往往ack就会有问题呢？ 实际上ack请求的url部分，就是由响应消息的contact头的ulr部分。</p></section><footer class=entry-footer><span title='2021-03-09 17:10:54 +0800 CST'>2021-03-09 17:10:54</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;王端端&nbsp;&nbsp;| 本文总阅读量<span id=busuanzi_value_page_pv></span>次</footer><a class=entry-link aria-label="post link to ACK 无法正常送到FS" href=https://wdd.js.org/opensips/ch7/miss-ack/></a></article><article class=post-entry><header class=entry-header><h2>SIP消息格式CRLF</h2></header><section class=entry-content><p>generic-message = start-line *message-header CRLF [ message-body ] start-line = Request-Line / Status-Line 其中在rfc2543中规定
CR = %d13 ; US-ASCII CR, carriage return character LF = %d10 ; US-ASCII LF, line feed character 项目 十进制 字符串表示 CR 13 \r LF 10 \n 也就是说在一个SIP消息中
headline\r\n key:v\r\n \r\n some_body\r\n 所以CRLF就是 \r\n 参考 https://tools.ietf.org/html/rfc3261 https://tools.ietf.org/html/rfc2543</p></section><footer class=entry-footer><span title='2020-12-25 17:44:31 +0800 CST'>2020-12-25 17:44:31</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;王端端&nbsp;&nbsp;| 本文总阅读量<span id=busuanzi_value_page_pv></span>次</footer><a class=entry-link aria-label="post link to SIP消息格式CRLF" href=https://wdd.js.org/opensips/ch3/sip-crlf/></a></article><article class=post-entry><header class=entry-header><h2>BLF指示灯</h2></header><section class=entry-content><p>What Is a Busy Lamp Field (BLF) and Why Do You Need It? Busy lamp field is a presence indicator that allows you to see who in your organization is available (or not) for a phone call at any given time.
The term “busy lamp field” sounds a bit more involved than it really is. Put simply, it just means the ability to see who in your organization is available or not for a phone call at any given time....</p></section><footer class=entry-footer><span title='2020-11-20 15:45:56 +0800 CST'>2020-11-20 15:45:56</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;王端端&nbsp;&nbsp;| 本文总阅读量<span id=busuanzi_value_page_pv></span>次</footer><a class=entry-link aria-label="post link to BLF指示灯" href=https://wdd.js.org/opensips/ch9/blf/></a></article><article class=post-entry><header class=entry-header><h2>siphub 轻量级实时SIP信令收包的服务</h2></header><section class=entry-content><p>o我写siphub的原因是homer太难用了！！经常查不到想查的数据，查询的速度也很慢。
项目地址：https://github.com/wangduanduan/siphub
架构 SIP服务器例如OpenSIPS或者FS可以通过hep协议将数据写到siphub, siphub将数据规整之后写入MySql, siphub同时也提供Web页面来查询和展示SIP消息。 功能介绍 sip-hub是一个专注sip信令的搜索以及时序图可视化展示的服务。
相比于Homer, sip-hub做了大量的功能简化。同时也提供了一些个性化的查询，例如被叫后缀查询，仅域名查询等。
sip-hub服务仅有3个页面
sip消息搜索页面，用于按照主被叫、域名和时间范围搜索呼叫记录 时序图展示页面，用于展示SIP时序图和原始SIP消息 可以导入导出SIP消息 可以查找A-Leg 监控功能 大量简化搜索结果页面。siphub的搜索结果页面，每个callId相同的消息，只展示一条。 相关截图 搜索页面 siphub的搜索结果仅仅展示callId相同的最早的一条记录，这样就避免了像homer那种，看起来很多个消息，实际上都是属于一个INVITE的。 From字段和To字段都支持域名查询：@test.cc From字段也支持后缀查询，例如1234这种号码，可以只输入234就能查到，但是后缀要写完整，只查23是查不到的。 To字段仅仅支持精确查询 信令展示页面 点击对应的消息，详情也会自动跳转出来。 安装 首先需要安装MySql数据库，并在其中建立一个名为siphub的数据库 运行 dbHost 数据库地址 dbUser 数据库用户 dbName 数据库名 dataKeepDays 抓包保存天数 3000端口是web页面端口 9060是hep消息收取端口 docker run -d -p 3000:3000 -p 9060:9060/udp \ --env NODE_ENV=production \ --env dbHost=1.2.3.4 \ --env dbUser=root \ --env dbPwd=123456 \ --env dbName=siphub \ --env dataKeepDays=3 \ --name siphub wangduanduan/siphub 集成 OpenSIPS集成 test witch OpenSIPS 2....</p></section><footer class=entry-footer><span title='2020-08-06 11:19:01 +0800 CST'>2020-08-06 11:19:01</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;王端端&nbsp;&nbsp;| 本文总阅读量<span id=busuanzi_value_page_pv></span>次</footer><a class=entry-link aria-label="post link to siphub 轻量级实时SIP信令收包的服务" href=https://wdd.js.org/opensips/tools/siphub/></a></article><article class=post-entry><header class=entry-header><h2>sipsak</h2></header><section class=entry-content><p>sipsak is a command line tool which can send simple requests to a SIP server. It can run additional tests on a SIP server which are usefull for admins and developers of SIP enviroments.
https://github.com/nils-ohlmeier/sipsak
安装 apt-get install sipsak 发送options sipsak -vv -p 192.168.2.63:5060 -s sip:8001@test.cc man SIPSAK(1) User Manuals SIPSAK(1) NAME sipsak - a utility for various tests on sip servers and user agents SYNOPSIS sipsak [-dFGhiILnNMRSTUVvwz] [-a PASSWORD ] [-b NUMBER ] [-c SIPURI ] [-C SIPURI ] [-D NUMBER ] [-e NUMBER ] [-E STRING ] [-f FILE ] [-g STRING ] [-H HOSTNAME ] [-j STRING ] [-J STRING ] [-l PORT ] [-m NUMBER ] [-o NUMBER ] [-p HOSTNAME ] [-P NUMBER ] [-q REGEXP ] [-r PORT ] [-t NUMBER ] [-u STRING ] [-W NUMBER ] [-x NUMBER ] -s SIPURI DESCRIPTION sipsak is a SIP stress and diagnostics utility....</p></section><footer class=entry-footer><span title='2020-07-31 19:16:36 +0800 CST'>2020-07-31 19:16:36</span>&nbsp;·&nbsp;15 min&nbsp;·&nbsp;王端端&nbsp;&nbsp;| 本文总阅读量<span id=busuanzi_value_page_pv></span>次</footer><a class=entry-link aria-label="post link to sipsak" href=https://wdd.js.org/opensips/tools/sipsak/></a></article><footer class=page-footer><nav class=pagination><a class=prev href=https://wdd.js.org/opensips/page/3/>« Prev Page</a>
<a class=next href=https://wdd.js.org/opensips/page/5/>Next Page »</a></nav></footer></main><footer class=footer><span>&copy; 2022 <a href=https://wdd.js.org>洞香春</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span>
<span id=busuanzi_container_site_pv>本站访问量：<span id=busuanzi_value_site_pv></span>次</span>
&nbsp;
<span id=busuanzi_container_site_uv>您是本站第 <span id=busuanzi_value_site_uv></span> 位访问者</span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>