<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>OpenSIPS2.4.X 中文实战系列 | 洞香春</title>
<meta name=keywords content><meta name=description content="OpenSIPS VOIP"><meta name=author content="Eddie Wang"><link rel=canonical href=https://wdd.js.org/opensips/><link crossorigin=anonymous href=/assets/css/stylesheet.821c51435cba3e33e49e590a06514c54c32ac7957095ffcc1e0f390c47cf3228.css integrity="sha256-ghxRQ1y6PjPknlkKBlFMVMMqx5Vwlf/MHg85DEfPMig=" rel="preload stylesheet" as=style><link rel=icon href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/cowboy.ico><link rel=apple-touch-icon href=https://wdd.js.org/cowboy.ico><link rel=mask-icon href=https://wdd.js.org/cowboy.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://wdd.js.org/opensips/index.xml><link rel=alternate hreflang=en href=https://wdd.js.org/opensips/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://wdd.js.org/opensips/"><meta property="og:site_name" content="洞香春"><meta property="og:title" content="OpenSIPS2.4.X 中文实战系列"><meta property="og:description" content="OpenSIPS VOIP"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="OpenSIPS2.4.X 中文实战系列"><meta name=twitter:description content="OpenSIPS VOIP"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"OpenSIPS2.4.X 中文实战系列","item":"https://wdd.js.org/opensips/"}]}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org/ accesskey=h title="洞香春 (Alt + H)"><img src=https://wdd.js.org/cowboy.ico alt aria-label=logo height=35>洞香春</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wdd.js.org/books/ title=读书><span>读书</span></a></li><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/golang/ title=Golang><span>Golang</span></a></li><li><a href=https://wdd.js.org/kamailio/ title=Kamailio><span>Kamailio</span></a></li><li><a href=https://wdd.js.org/kamailio/56/ title="Kamailio 5.6 wiki"><span>Kamailio 5.6 wiki</span></a></li><li><a href=https://wdd.js.org/network/ title=Network><span>Network</span></a></li><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span class=active>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/categories/ title=分类><span>分类</span></a></li><li><a href=https://wdd.js.org/fe/ title=前端><span>前端</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://wdd.js.org/>Home</a></div><h1>OpenSIPS2.4.X 中文实战系列</h1><div class=post-description>OpenSIPS VOIP</div></header><div class=post-content><p>本系列文章是我在学习 OpenSIPS 过程中，慢慢总结出来的。虽说是实战，但是笔记的成分可能会多点，我也无法保证里面的内容是否完全正确。</p><p>VOIP 对我来说是个比较陌生的领域。进入这个领域可以说是一个意外。在学习过程和实战过程中，我发现了 VOIP 有很大的复杂性。生产环境也会有常常有怪异棘手的各种问题。在解决这些问题的过程中，有种升级打怪的感觉。</p><p>本知识库重点在于讲解 OpenSIPS，当然其中也涵盖了 SIP 协议，FreeSWITCH, rtpproxy, rtpengine，以及一些排查问题的工具。</p><p>推荐在学习的过程中，一定要啃一遍 RFC 3261 协议，这是 VOIP 的基石。</p><p>QQ学习交流群：983873052</p><h1 id=文章目录>文章目录<a hidden class=anchor aria-hidden=true href=#文章目录>#</a></h1><ul><li><p>1: SIP 协议</p><ul><li><a href=/opensips/ch1/study-tips>1.1 学习建议</a></li><li><a href=/opensips/ch1/sip-overview>1.2 SIP 协议简介</a></li><li><a href=ch1/via-route-record-route>1.3 Via route Record-Route 的区别</a></li><li><a href=/opensips/ch1/sip-path>1.4 SIP Path 头</a></li><li><a href=/opensips/ch1/trunk-pbx-gateway>1.5 Trunk PBX Gateway</a></li><li><a href=/opensips/ch1/sip-notes>1.6 SIP 协议拾遗补缺</a></li><li><a href=/opensips/ch1/sip-with-sdp>1.7 SIP 与 SDP 的关系</a></li><li><a href=/opensips/ch1/nat-sip-rtp>1.8 SIP 信令和媒体都绕不开的 NAT 问题</a></li><li><a href=/opensips/ch1/stun-notes>1.9 STUN 协议笔记</a></li><li><a href=/opensips/ch1/sip-register>1.10 SIP 注册调研</a></li><li><a href=/opensips/ch1/sip-ack>1.11 深入 SIP ACK 消息</a></li><li><a href=/opensips/ch1/ua-answer-mode>1.12 UA 应答模式</a></li><li><a href=/opensips/ch1/deep-in-nat>1.13 NAT 深入学习</a></li><li><a href=/opensips/ch1/fix-nat>1.14 解决 NAT 问题</a></li><li><a href=/opensips/ch1/from-to-request-url>1.15 From To Request URL 之间的关系</a></li><li><a href=/opensips/ch1/sip-rfcs>1.16 SIP 相关 RFC 协议</a></li><li><a href=/opensips/ch1/story-of-nat>1.17 漫话 NAT 的历史</a></li><li><a href=/opensips/ch1/offer-answer>1.18 媒体协商 offer/answer 模型</a></li><li><a href=/opensips/ch1/sip-rtp-path>1.19 媒体路径与信令路径</a></li><li><a href=/opensips/ch1/csta-call-model>1.20 CSTA 呼叫模型简介</a></li></ul></li><li><ol start=2><li>常识</li></ol><ul><li><a href=/opensips/ch2/early-media-type>2.1 几种常用电话信号音的含义</a></li><li><a href=/opensips/ch2/early-media>2.2 回铃音</a></li><li><a href=/opensips/ch2/axb>2.3 AXB的玩法说明</a></li></ul></li><li><ol start=3><li>OpenSIPS安装与管理</li></ol><ul><li><a href=/opensips/ch3/about-opensips>3.1 opensips介绍</a></li><li><a href=/opensips/ch3/install-opensips>3.2 debian jessie opensips 2.4.7 安装</a></li><li><a href=/opensips/ch3/centos-install>3.3 centos7 安装opensips</a></li><li><a href=/opensips/ch3/log>3.4 设置独立日志文件</a></li><li><a href=/opensips/ch3/core-mi>3.5 核心MI命令</a></li><li><a href=/opensips/ch3/opensipsctl>3.6 opensips管理命令</a></li><li><a href=/opensips/ch3/centos7-2.4/>3.7 centos7 2.2 升级到2.4.6</a></li><li><a href=/opensips/ch3/opensips-monitor/>3.8 OpenSIPS监控</a></li><li><a href=/opensips/ch3/cache-reload/>3.9 模块缓存策略与reload方法</a></li><li><a href=/opensips/ch3/sip-crlf/>3.10 SIP消息格式CRLF</a></li><li><a href=/opensips/ch3/elk/>3.10 opensips日志写入elasticsearch</a></li><li><a href=/opensips/ch3/prd-warning/>3.10 生产环境监控告警</a></li></ul></li><li><ol start=4><li>媒体相关</li></ol><ul><li><a href=/opensips/ch4/rtp-timestamp/>4.1 RTP 不连续的timestamp和SSRC</a></li><li><a href=/opensips/ch4/media-codec/>4.2 常见媒体流编码及其特点</a></li><li><a href=/opensips/ch4/rtp-record/>4.2 rtpproxy录音</a></li><li><a href=/opensips/ch4/codec-table/>4.2 rtp编码表</a></li></ul></li><li><ol start=5><li>配置文件和路由脚本</li></ol><ul><li><a href=/opensips/ch5/routing-script/>5.1 配置文件</a></li><li><a href=/opensips/ch5/global-params/>5.2 全局参数配置</a></li><li><a href=/opensips/ch5/routing-type/>5.3 路由分类</a></li><li><a href=/opensips/ch5/triger-time/>5.4 路由的触发时机</a></li><li><a href=/opensipsch5/strict-loose-routing/>5.5 严格路由和松散路由</a></li><li><a href=/opensips/ch5/function/>5.6 函数特点</a></li><li><a href=/opensips/ch5/return/>5.7 使用return语句减少逻辑嵌套</a></li><li><a href=/opensips/ch5/condition/>5.8 条件语句特点</a></li><li><a href=/opensips/ch5/statement/>5.9 常用语句</a></li><li><a href=/opensips/ch5/var/>5.10 变量的使用</a></li><li><a href=/opensips/ch5/core-var/>5.11 核心变量说明</a></li><li><a href=/opensips/ch5/xlog/>5.12 优雅的使用xlog输出日志行</a></li><li><a href=/opensips/ch5/module/>5.13 脚本路由模块化</a></li><li><a href=/opensips/ch5/stateful-stateless/>5.14 有状态和无状态路由</a></li><li><a href=/opensips/ch5/init-seque/>5.15 【重点】初始化请求和序列化请求</a></li><li><a href=/opensips/ch5/via-route/>5.16 SIP路由头</a></li><li><a href=/opensips/ch5/avp-db-query/>5.17 avp_db_query数值null值比较</a></li><li><a href=/opensips/ch5/xlog-level/>5.18 日志xlog</a></li><li><a href=/opensips/ch5/homer6/>5.19 opensips 集成 homer6</a></li><li><a href=/opensips/ch5/adv-address/>5.20 【必读】深入对外公布地址</a></li><li><a href=/opensips/ch5/m4/>5.21 使用m4增强opensips.cfg脚本预处理能力</a></li><li><a href=/opensips/ch5/db-mode/>5.22 db_mode调优</a></li><li><a href=/opensips/ch5/sql-table/>5.23 mysql建表语句</a></li><li><a href=/opensips/ch5/core-var-2/>5.24 核心变量解读2-100%</a></li></ul></li><li><ol start=6><li>模块使用教程</li></ol><ul><li><a href=/opensips/ch6/acc/>6.1 acc呼叫记录模块</a></li><li><a href=/opensips/ch6/cachedb/>6.2 cachedb的相关问题</a></li><li><a href=/opensips/ch6/load-balance/>6.3 负载均衡模块load_balance</a></li><li><a href=/opensips/ch6/dispatcher/>6.4 sip消息分发之dispatcher模块</a></li></ul></li><li><ol start=7><li>常见问题</li></ol><ul><li><a href=/opensips/ch7/tm-send-failed/>7.1 opensips 477 Send failed (477/TM)</a></li><li><a href=/opensips/ch7/sendmsg-failed/>7.2 sendmsg failed on 0: Socket operation on non-socket</a></li><li><a href=/opensips/ch7/escape-msg/>7.3 信令路径逃逸分析</a></li><li><a href=/opensips/ch7/crash/>7.4 opensips崩溃分析</a></li><li><a href=/opensips/ch7/can-not-run/>7.5 opensips无法启动</a></li><li><a href=/opensips/ch7/big-udp-msg/>7.6 UDP分片导致SIP消息丢失</a></li><li><a href=/opensips/ch7/rtp-broken-connection>7.7 奥科网关 Rtp Broken Connection</a></li><li><a href=/opensips/ch7/miss-ack/>7.8 ACK 无法正常送到FS</a></li><li><a href=/opensips/ch7/30-seconds-drop/>7.9 30秒自动挂断</a></li><li><a href=/opensips/ch7/cfg-trace/>7.10 script_trace 打印opensips的脚本执行过程</a></li><li><a href=/opensips/ch7/one-leg-audio/>7.11 一方听不到另外一方的声音</a></li><li><a href=/opensips/ch7/echo-back/>7.12 回音问题调研</a></li><li><a href=/opensips/ch7/without-log/>7.13 opensips启动失败没有任何报错日志</a></li><li><a href=/opensips/ch7/poor-quality/>7.14 通话质量差</a></li><li><a href=/opensips/ch7/without-default-carrier/>7.15 ERROR:carrierroute:carrier_tree_fixup: default_carrier not found</a></li></ul></li><li><ol start=8><li>脚本学习</li></ol><ul><li><a href=/opensips/ch8/topology-hiding/>8.1 拓扑隐藏学习以及实践</a></li><li><a href=/opensips/ch8/serial-183/>8.2 serial_183</a></li><li><a href=/opensips/ch8/replicate/>8.3 replicate</a></li><li><a href=/opensips/ch8/redirect/>8.4 redirect</a></li><li><a href=/opensips/ch8/pstn/>8.5 pstn</a></li><li><a href=/opensips/ch8/nathelper/>8.6 nathelper</a></li><li><a href=/opensips/ch8/msilo/>8.7 msilo</a></li><li><a href=/opensips/ch8/logging/>8.8 logging</a></li><li><a href=/opensips/ch8/httpd/>8.9 httpd</a></li><li><a href=/opensips/ch8/fork/>8.10 fork</a></li><li><a href=/opensips/ch8/flag-reply/>8.11 flag reply</a></li><li><a href=/opensips/ch8/exec/>8.12 exec</a></li><li><a href=/opensips/ch8/acc/>8.13 acc</a></li><li><a href=/opensips/ch8/acc-mysql/>8.14 acc-mysql</a></li><li><a href=/opensips/ch8/default/>8.15 default</a></li><li><a href=/opensips/ch8/mid-register/>8.16 mid register</a></li><li><a href=/opensips/ch8/fs-loadbalance/>8.17 fs loadbalance</a></li><li><a href=/opensips/ch8/fraud/>8.18 fraud</a></li><li><a href=/opensips/ch8/dtmf-lan/>8.19 dtmf</a></li><li><a href=/opensips/ch8/siprec/>8.20 siprec</a></li></ul></li><li><ol start=9><li>扩展</li></ol><ul><li><a href=/opensips/ch9/webrtc-ref/>9.1 WebRTC学习资料分享</a></li><li><a href=/opensips/ch9/notes/>9.2 WebRTC简介</a></li><li><a href=/opensips/ch9/webrtc-pdf/>9.3 opensips with webrtc</a></li><li><a href=/opensips/ch9/blf/>9.4 BLF指示灯</a></li><li><a href=/opensips/ch9/isup-sip-isdn/>9.5 ISUP SIP ISDN对照码表</a></li><li><a href=/opensips/ch9/rtpengine-manu/>9.6 rtpengine cli</a></li><li><a href=/opensips/ch9/rtpengine-ilbc/>9.7 rtpengine 增加对ilbc编解码的支持</a></li><li><a href=/opensips/ch9/sdp/>9.8 sdp协议简介</a></li><li><a href=/opensips/ch9/rtpproxy/>9.9 rtpproxy学习</a></li><li><a href=/opensips/ch9/feature-code/>9.10 SIP feature codes SIP功能码</a></li><li><a href=/opensips/ch9/100-rel/>9.11 sbc 100rel</a></li><li><a href=/opensips/ch9/blf-note/>9.12 blf 功能笔记</a></li><li><a href=/opensips/ch9/nat-single-interface/>9.13 NAT场景下的信令处理 - 单网卡</a></li><li><a href=/opensips/ch9/cluster-share-location/>9.14 集群共享分机注册信息</a></li><li><a href=/opensips/ch9/books/>9.15 参考资料与书籍</a></li></ul></li><li><ol start=10><li>相关工具</li></ol><ul><li><a href=/opensips/tools/tshark/>10.1 tshark 快速分析语音流问题</a></li><li><a href=/opensips/tools/heplify/>10.2 heplify SIP信令抓包客户端</a></li><li><a href=/opensips/tools/baresip/>10.3 baresip 非常好用的终端SIP UA</a></li><li><a href=/opensips/tools/sipsak/>10.4 sipsak</a></li><li><a href=/opensips/tools/wireshark-player-pcap/>10.5 wireshark 播放抓包文件</a></li><li><a href=/opensips/tools/sngrep/>10.6 sngrep: 最好用的sip可视化抓包工具</a></li><li><a href=/opensips/tools/homer/>10.7 homer: 统一的sip包集中处理工具</a></li><li><a href=/opensips/tools/siphub/>10.8 siphub 轻量级实时SIP信令收包的服务</a></li><li><a href=/opensips/tools/sipp/>10.9 SIPp：sip压测模拟ua工具</a></li><li><a href=/opensips/tools/sipp-subscriber/>10.10 SIPP subscriber 测试</a></li><li><a href=/opensips/tools/tcp-dump/>10.11 tcpdump</a></li><li><a href=/opensips/tools/pjsip/>10.12 pjsip</a></li><li><a href=/opensips/tools/wireshark-sip/>10.13 Wireshark SIP 抓包</a></li><li><a href=/opensips/tools/kamailio/>10.14 另一个功能强大的sip server: kamailio</a></li></ul></li><li><ol start=11><li>官方博客</li></ol><ul><li><a href=/opensips/blog/load-balance/>Load Balancing in OpenSIPS</a></li><li><a href=/opensips/blog/dialog-trigers/>Dialog triggers, or how to control the calls from script</a></li><li><a href=/opensips/blog/cross-dialog-data/>Cross-dialog data accessing</a></li><li><a href=/opensips/blog/calls-manager/>Calls management using the new Call API tool</a></li><li><a href=/opensips/blog/call-stat/>Improved series-based call statistics using OpenSIPS 3.2</a></li><li><a href=/opensips/blog/opensips3-tls/>Exploring SSL/TLS libraries for OpenSIPS 3.2</a></li><li><a href=/opensips/blog/openssl-opensips/>The OpenSIPS and OpenSSL journey</a></li><li><a href=/opensips/blog/mutltiple-interface/>SIP bridging over multiple interfaces</a></li><li><a href=/opensips/blog/cancel-reason/>CANCEL请求和Reason头</a></li><li><a href=/opensips/blog/opensips3x/>Introducing OpenSIPS 3.0</a></li><li><a href=/opensips/blog/cluster-location/>Clustered SIP User Location: The Full Sharing Topology</a></li><li><a href=/opensips/blog/cluster-call/>Clustering ongoing calls with OpenSIPS 2.4</a></li><li><a href=/opensips/blog/full-anycast/>Full Anycast support in OpenSIPS 2.4</a></li><li><a href=/opensips/blog/deepin-stat-engine/>深入OpenSIPS统计引擎</a></li><li><a href=/opensips/blog/runing-opensips-in-cloud/>Running OpenSIPS in the Cloud</a></li><li><a href=/opensips/blog/troubleshooting-opensips-script/>Troubleshooting OpenSIPS script</a></li><li><a href=/opensips/blog/miss-ack/>Troubleshooting missing ACK in SIP</a></li><li><a href=/opensips/blog/memory-usage/>理解并测量OpenSIPS的内存资源</a></li></ul></li><li><p>问题列表</p><ul><li><a href=/opensips/ch1/utime-task-scheduled>utimer task already scheduled</a></li></ul></li><li><p>OpenSIPS 3X</p><ul><li><a href=/opensips/3x/module-args/>模块传参的重构</a></li></ul></li><li><p><a href=/opensips/module-dev/>模块开发实战</a></p></li><li><p><a href=/opensips/pdf/>OpenSIPS Summit PDF学习资料</a></p></li><li><p><a href=/opensips/dev-audio/>源码学习视频教程</a></p></li></ul><h1 id=文章列表>文章列表<a hidden class=anchor aria-hidden=true href=#文章列表>#</a></h1></div><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>msilo</h2></header><div class=entry-content><p># # MSILO usage example # # $ID: daniel $ # children=2 check_via=no # (cmd. line: -v) dns=off # (cmd. line: -r) rev_dns=off # (cmd. line: -R) # ------------------ module loading ---------------------------------- #set module path mpath="/usr/local/lib/opensips/modules/" loadmodule "textops.so" loadmodule "sl.so" loadmodule "db_mysql.so" loadmodule "maxfwd.so" loadmodule "tm.so" loadmodule "usrloc.so" loadmodule "registrar.so" loadmodule "msilo.so" # ----------------- setting module-specific parameters --------------- # -- registrar params -- modparam("registrar", "default_expires", 120) # -- usrloc params -- modparam("usrloc", "db_mode", 0) # -- msilo params -- modparam("msilo", "db_url", "mysql://opensips:opensipsrw@localhost/opensips") # -- tm params -- modparam("tm", "fr_timer", 10 ) modparam("tm", "fr_inv_timer", 15 ) modparam("tm", "wt_timer", 10 ) route{ if ( !mf_process_maxfwd_header("10") ) { sl_send_reply("483","To Many Hops"); exit; }; if (is_myself("$rd")) { # for testing purposes, simply okay all REGISTERs # is_method("XYZ") is faster than ($rm=="XYZ") # but requires textops module if (is_method("REGISTER")) { save("location"); log("REGISTER received -> dumping messages with MSILO\n"); # MSILO - dumping user's offline messages if (m_dump()) { log("MSILO: offline messages dumped - if they were\n"); } else { log("MSILO: no offline messages dumped\n"); }; exit; }; # backup r-uri for m_dump() in case of delivery failure $avp(11) = $ru; # domestic SIP destinations are handled using our USRLOC DB if(!lookup("location")) { if (! t_newtran()) { sl_reply_error(); exit; }; # we do not care about anything else but MESSAGEs if (!is_method("MESSAGE")) { if (!t_reply("404", "Not found")) { sl_reply_error(); }; exit; }; log("MESSAGE received -> storing using MSILO\n"); # MSILO - storing as offline message if (m_store("$ru")) { log("MSILO: offline message stored\n"); if (!t_reply("202", "Accepted")) { sl_reply_error(); }; }else{ log("MSILO: offline message NOT stored\n"); if (!t_reply("503", "Service Unavailable")) { sl_reply_error(); }; }; exit; }; # if the downstream UA does not support MESSAGE requests # go to failure_route[1] t_on_failure("1"); t_relay(); exit; }; # forward anything else t_relay(); } failure_route[1] { # forwarding failed -- check if the request was a MESSAGE if (!is_method("MESSAGE")) exit; log(1,"MSILO: the downstream UA does not support MESSAGE requests ...\n"); # we have changed the R-URI with the contact address -- ignore it now if (m_store("$avp(11)")) { log("MSILO: offline message stored\n"); t_reply("202", "Accepted"); }else{ log("MSILO: offline message NOT stored\n"); t_reply("503", "Service Unavailable"); }; }</p></div><footer class=entry-footer><span title='2020-05-28 10:00:04 +0800 CST'>2020-05-28 10:00:04</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to msilo" href=https://wdd.js.org/opensips/ch8/msilo/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>loggin</h2></header><div class=entry-content><p># # logging example # # ------------------ module loading ---------------------------------- port=5060 log_stderror=yes log_level=3 # ------------------------- request routing logic ------------------- # main routing logic route{ # for testing purposes, simply okay all REGISTERs if (is_method("REGISTER")) { log(1, "REGISTER received\n"); } else { log(1, "non-REGISTER received\n"); }; if ($ru=~"sip:.*[@:]siphub.net") { xlog("request for siphub.net received\n"); } else { xlog("request for other domain [$rd] received\n"); }; }</p></div><footer class=entry-footer><span title='2020-05-28 09:59:45 +0800 CST'>2020-05-28 09:59:45</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to loggin" href=https://wdd.js.org/opensips/ch8/logging/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>httpd</h2></header><div class=entry-content><p># # $Id$ # # this example shows use of opensips's provisioning interface # # ------------------ module loading ---------------------------------- #set module path mpath="/usr/local/lib64/opensips/modules/" loadmodule "db_mysql.so" loadmodule "httpd.so" modparam("httpd", "port", 8888) loadmodule "mi_http.so" loadmodule "pi_http.so" modparam("pi_http", "framework", "/usr/local/src/opensips/examples/pi_framework.xml") loadmodule "mi_xmlrpc_ng.so" # ------------------------- request routing logic ------------------- # main routing logic route{ exit; }</p></div><footer class=entry-footer><span title='2020-05-28 09:59:25 +0800 CST'>2020-05-28 09:59:25</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to httpd" href=https://wdd.js.org/opensips/ch8/httpd/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>flag_reply</h2></header><div class=entry-content><p># # simple quick-start config script # # ----------- global configuration parameters ------------------------ log_level=3 # logging level (cmd line: -dddddddddd) log_stderror=no # (cmd line: -E) check_via=no # (cmd. line: -v) dns=no # (cmd. line: -r) rev_dns=no # (cmd. line: -R) children=4 port=5060 # ------------------ module loading ---------------------------------- #set module path mpath="/usr/local/lib/opensips/modules/" # Uncomment this if you want to use SQL database #loadmodule "db_mysql.so" loadmodule "sl.so" loadmodule "tm.so" loadmodule "rr.so" loadmodule "maxfwd.so" loadmodule "usrloc.so" loadmodule "registrar.so" loadmodule "textops.so" loadmodule "mi_fifo.so" # Uncomment this if you want digest authentication # mysql.so must be loaded ! #loadmodule "auth.so" #loadmodule "auth_db.so" # ----------------- setting module-specific parameters --------------- # -- mi_fifo params -- modparam("mi_fifo", "fifo_name", "/tmp/opensips_fifo") # -- usrloc params -- modparam("usrloc", "db_mode", 0) # Uncomment this if you want to use SQL database # for persistent storage and comment the previous line #modparam("usrloc", "db_mode", 2) # -- auth params -- # Uncomment if you are using auth module # #modparam("auth_db", "calculate_ha1", yes) # # If you set "calculate_ha1" parameter to yes (which true in this config), # uncomment also the following parameter) # #modparam("auth_db", "password_column", "password") # ------------------------- request routing logic ------------------- # main routing logic route{ setflag(1); t_on_failure("1"); t_on_reply("1"); log(1, "message received\n"); t_relay("udp:opensips.org:5060"); } onreply_route[1] { if (isflagset(1)) { log(1, "onreply: flag set\n"); } else { log(1, "onreply: flag unset\n"); }; } failure_route[1] { if (isflagset(1)) { log(1, "failure: flag set\n"); } else { log(1, "failure: flag unset\n"); }; }</p></div><footer class=entry-footer><span title='2020-05-28 09:58:33 +0800 CST'>2020-05-28 09:58:33</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to flag_reply" href=https://wdd.js.org/opensips/ch8/flag-reply/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>exec</h2></header><div class=entry-content><p># # $Id$ # # simple quick-start config script # # ----------- global configuration parameters ------------------------ #set module path mpath="/usr/local/lib/opensips/modules/" loadmodule "sl.so" loadmodule "tm.so" loadmodule "usrloc.so" loadmodule "registrar.so" loadmodule "exec.so" # ----------------- setting module-specific parameters --------------- route{ # uri for my domain ? if (is_myself("$rd")) { if ($rm=="REGISTER") { save("location"); return; }; # native SIP destinations are handled using our USRLOC DB if (!lookup("location")) { # proceed to email notification if ($rm=="INVITE") route(1) else sl_send_reply("404", "Not Found"); exit; }; }; # user found, forward to his current uri now if (!t_relay()) { sl_reply_error(); }; } /* handling of missed calls */ route[1] { # don't continue if it is a retransmission if ( !t_newtran()) { sl_reply_error(); exit; }; # external script: lookup user, if user exists, send # an email notification to him if (!exec_msg(' QUERY="select email_address from subscriber where user=\"$$SIP_OUSER\""; EMAIL=`mysql -Bsuser -pheslo -e "$$QUERY" ser`; if [ -z "$$EMAIL" ] ; then exit 1; fi ; echo "SIP request received from $$SIP_HF_FROM for $$SIP_OUSER" | mail -s "request for you" $$EMAIL ')) { # exec returned error ... user does not exist # send a stateful reply t_reply("404", "User does not exist"); } else { t_reply("600", "No messages for this user"); }; exit; }</p></div><footer class=entry-footer><span title='2020-05-28 09:58:09 +0800 CST'>2020-05-28 09:58:09</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to exec" href=https://wdd.js.org/opensips/ch8/exec/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>acc</h2></header><div class=entry-content><p># # $Id$ # # example: accounting calls to nummerical destinations # # ------------------ module loading ---------------------------------- #set module path mpath="/usr/local/lib/opensips/modules/" loadmodule "tm.so" loadmodule "acc.so" loadmodule "sl.so" loadmodule "maxfwd.so" loadmodule "rr.so" # ----------------- setting module-specific parameters --------------- # -- acc params -- # set the reporting log level modparam("acc", "log_level", 1) # number of flag, which will be used for accounting; if a message is # labeled with this flag, its completion status will be reported modparam("acc", "log_flag", 1 ) # ------------------------- request routing logic ------------------- # main routing logic route{ /* ********* ROUTINE CHECKS ********************************** */ # filter too old messages if (!mf_process_maxfwd_header("10")) { log("LOG: Too many hops\n"); sl_send_reply("483","Too Many Hops"); exit; }; if ($ml >= 2048 ) { sl_send_reply("513", "Message too big"); exit; }; # Process record-routing if (loose_route()) { # label BYEs for accounting if (is_method("BYE")) setflag(1); t_relay(); exit; }; # labeled all transaction for accounting setflag(1); # record-route INVITES to make sure BYEs will visit our server too if (is_method("INVITE")) record_route(); # forward the request statefuly now; (we need *stateful* forwarding, # because the stateful mode correlates requests with replies and # drops retranmissions; otherwise, we would have to report on # every single message received) if (!t_relay()) { sl_reply_error(); exit; }; }</p></div><footer class=entry-footer><span title='2020-05-28 09:57:46 +0800 CST'>2020-05-28 09:57:46</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to acc" href=https://wdd.js.org/opensips/ch8/acc/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>acc-mysql</h2></header><div class=entry-content><p># # Sample config for MySQL accouting with OpenSIPS # # - db_mysql module must be compiled and installed # # - new columns have to be added since by default only few are recorded # - here are full SQL statements to create acc and missed_calls tables # # CREATE TABLE `acc` ( # `id` int(10) unsigned NOT NULL auto_increment, # `method` varchar(16) NOT NULL default '', # `from_tag` varchar(64) NOT NULL default '', # `to_tag` varchar(64) NOT NULL default '', # `callid` varchar(128) NOT NULL default '', # `sip_code` char(3) NOT NULL default '', # `sip_reason` varchar(32) NOT NULL default '', # `time` datetime NOT NULL default '0000-00-00 00:00:00', # `src_ip` varchar(64) NOT NULL default '', # `dst_user` varchar(64) NOT NULL default '', # `dst_domain` varchar(128) NOT NULL default '', # `src_user` varchar(64) NOT NULL default '', # `src_domain` varchar(128) NOT NULL default '', # INDEX acc_callid (`callid`), # PRIMARY KEY (`id`) # ); # # CREATE TABLE `missed_calls` ( # `id` int(10) unsigned NOT NULL auto_increment, # `method` varchar(16) NOT NULL default '', # `from_tag` varchar(64) NOT NULL default '', # `to_tag` varchar(64) NOT NULL default '', # `callid` varchar(128) NOT NULL default '', # `sip_code` char(3) NOT NULL default '', # `sip_reason` varchar(32) NOT NULL default '', # `time` datetime NOT NULL default '0000-00-00 00:00:00', # `src_ip` varchar(64) NOT NULL default '', # `dst_user` varchar(64) NOT NULL default '', # `dst_domain` varchar(128) NOT NULL default '', # `src_user` varchar(64) NOT NULL default '', # `src_domain` varchar(128) NOT NULL default '', # INDEX acc_callid (`callid`), # PRIMARY KEY (`id`) # ); # # # ----------- global configuration parameters ------------------------ log_level=3 # debug level (cmd line: -dddddddddd) log_stderror=no # (cmd line: -E) /* Uncomment these lines to enter debugging mode */ #debug_mode=yes check_via=no # (cmd. line: -v) dns=no # (cmd. line: -r) rev_dns=no # (cmd. line: -R) port=5060 children=4 # # uncomment the following lines for TLS support #disable_tls = 0 #listen = tls:your_IP:5061 #tls_verify_server = 1 #tls_verify_client = 1 #tls_require_client_certificate = 0 #tls_method = TLSv1 #tls_certificate = "/usr/local/etc/opensips/tls/user/user-cert.pem" #tls_private_key = "/usr/local/etc/opensips/tls/user/user-privkey.pem" #tls_ca_list = "/usr/local/etc/opensips/tls/user/user-calist.pem" # ------------------ module loading ---------------------------------- # set module path mpath="/usr/local/lib/opensips/modules/" # Uncomment this if you want to use SQL database # - MySQL loaded for accounting as well loadmodule "db_mysql.so" loadmodule "sl.so" loadmodule "tm.so" loadmodule "rr.so" loadmodule "maxfwd.so" loadmodule "usrloc.so" loadmodule "registrar.so" loadmodule "textops.so" loadmodule "acc.so" loadmodule "mi_fifo.so" # Uncomment this if you want digest authentication # db_mysql.so must be loaded ! #loadmodule "auth.so" #loadmodule "auth_db.so" # ----------------- setting module-specific parameters --------------- # -- mi_fifo params -- modparam("mi_fifo", "fifo_name", "/tmp/opensips_fifo") # -- usrloc params -- #modparam("usrloc", "db_mode", 0) # Uncomment this if you want to use SQL database # for persistent storage and comment the previous line modparam("usrloc", "db_mode", 2) # -- auth params -- # Uncomment if you are using auth module # #modparam("auth_db", "calculate_ha1", yes) # # If you set "calculate_ha1" parameter to yes (which true in this config), # uncomment also the following parameter) # #modparam("auth_db", "password_column", "password") # -- acc params -- modparam("acc", "db_url", "mysql://opensips:opensipsrw@localhost/opensips") # flag to record to db modparam("acc", "db_flag", 1) modparam("acc", "db_missed_flag", 2) # flag to log to syslog modparam("acc", "log_flag", 1) modparam("acc", "log_missed_flag", 2) # use extra accounting to record caller and callee username/domain # - take them from From URI and R-URI modparam("acc", "log_extra", "src_user=$fU;src_domain=$fd;dst_user=$rU;dst_domain=$rd") modparam("acc", "db_extra", "src_user=$fU;src_domain=$fd;dst_user=$rU;dst_domain=$rd") # ------------------------- request routing logic ------------------- # main routing logic route{ # initial sanity checks -- messages with # max_forwards==0, or excessively long requests if (!mf_process_maxfwd_header("10")) { sl_send_reply("483","Too Many Hops"); exit; }; # subsequent messages withing a dialog should take the # path determined by record-routing if (loose_route()) { # mark routing logic in request append_hf("P-hint: rr-enforced\r\n"); if(is_method("BYE")) { # account BYE for STOP record setflag(1); } route(1); }; # we record-route all messages -- to make sure that # subsequent messages will go through our proxy; that's # particularly good if upstream and downstream entities # use different transport protocol if (!is_method("REGISTER")) record_route(); # account all calls if(is_method("INVITE")) { # set accounting on for INVITE (success or missed call) setflag(1); setflag(2); } if (!is_myself("$rd")) { # mark routing logic in request append_hf("P-hint: outbound\r\n"); # if you have some interdomain connections via TLS #if($ru=~"@tls_domain1.net") { # t_relay("tls:domain1.net"); # exit; #} else if($ru=~"@tls_domain2.net") { # t_relay("tls:domain2.net"); # exit; #} route(1); }; # if the request is for other domain use UsrLoc # (in case, it does not work, use the following command # with proper names and addresses in it) if (is_myself("$rd")) { if (is_method("REGISTER")) { # Uncomment this if you want to use digest authentication #if (!www_authorize("opensips.org", "subscriber")) { # www_challenge("opensips.org", "0"); # exit; #}; save("location"); exit; }; if (!is_myself("$rd")) { append_hf("P-hint: outbound alias\r\n"); route(1); }; # native SIP destinations are handled using our USRLOC DB if (!lookup("location")) { sl_send_reply("404", "Not Found"); exit; }; append_hf("P-hint: usrloc applied\r\n"); }; route(1); } route[1] { # send it out now; use stateful forwarding as it works reliably # even for UDP2TCP if (!t_relay()) { sl_reply_error(); }; exit; }</p></div><footer class=entry-footer><span title='2020-05-28 09:57:04 +0800 CST'>2020-05-28 09:57:04</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to acc-mysql" href=https://wdd.js.org/opensips/ch8/acc-mysql/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>script_trace 打印opensips的脚本执行过程</h2></header><div class=entry-content><p>script_trace是核心函数，不需要引入模块。
script_trace([log_level, pv_format_string[, info_string]]) This function start the script tracing - this helps to better understand the flow of execution in the OpenSIPS script, like what function is executed, what line it is, etc. Moreover, you can also trace the values of pseudo-variables, as script execution progresses. The blocks of the script where script tracing is enabled will print a line for each individual action that is done (e.g. assignments, conditional tests, module functions, core functions, etc.). Multiple pseudo-variables can be monitored by specifying a pv_format_string (e.g. "$ru---$avp(var1)"). The logs produced by multiple/different traced regions of your script can be differentiated (tagged) by specifying an additional plain string - info_string - as the 3rd parameter. To disable script tracing, just do script_trace(). Otherwise, the tracing will automatically stop at the end the end of the top route. Example of usage: script_trace( 1, "$rm from $si, ruri=$ru", "me"); will produce: [line 578][me][module consume_credentials] -> (INVITE from 127.0.0.1 , ruri=sip:111211@opensips.org) [line 581][me][core setsflag] -> (INVITE from 127.0.0.1 , ruri=sip:111211@opensips.org) [line 583][me][assign equal] -> (INVITE from 127.0.0.1 , ruri=sip:111211@opensips.org) [line 592][me][core if] -> (INVITE from 127.0.0.1 , ruri=sip:tester@opensips.org) [line 585][me][module is_avp_set] -> (INVITE from 127.0.0.1 , ruri=sip:tester@opensips.org) [line 589][me][core if] -> (INVITE from 127.0.0.1 , ruri=sip:tester@opensips.org) [line 586][me][module is_method] -> (INVITE from 127.0.0.1 , ruri=sip:tester@opensips.org) [line 587][me][module trace_dialog] -> (INVITE 127.0.0.1 , ruri=sip:tester@opensips.org) [line 590][me][core setflag] -> (INVITE from 127.0.0.1 , ruri=sip:tester@opensips.org)</p></div><footer class=entry-footer><span title='2020-05-27 16:54:47 +0800 CST'>2020-05-27 16:54:47</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to script_trace 打印opensips的脚本执行过程" href=https://wdd.js.org/opensips/ch7/cfg-trace/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>负载均衡模块load_balance</h2></header><div class=entry-content><p>负载均衡只能均衡INVITE, 不能均衡REGISTER请求。因为load_blance底层是使用dialog模块去跟踪目标地址的负载情况。 load_balance方法会改变INVITE的$du, 而不会修改SIP URL 呼叫结束的时候，目标地址的负载会自动释放 选择逻辑 网关A 网关B 通道数 30 60 正在使用的通道数 20 55 空闲通道数 10 5 load_balance是会先选择最大可用资源的目标地址。假如A网关的最大并发呼叫是30， B网关最大并发呼叫是60。在某个时刻，A网关上已经有20和呼叫了, B网关上已经有55个呼叫。 此时load_balance会优先选择网关A。
参考 https://opensips.org/Documentation/Tutorials-LoadBalancing-1-9</p></div><footer class=entry-footer><span title='2020-05-19 09:42:10 +0800 CST'>2020-05-19 09:42:10</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to 负载均衡模块load_balance" href=https://wdd.js.org/opensips/ch6/load-balance/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>rtpproxy录音</h2></header><div class=entry-content><p>-a -R -r /recording -S spool -P -a 所有的通话都录音 -R 不要把RTCP也写文件 -r 指定录音文件的位置 -S 临时文件的位置，注意不要和录音文件位置相同 -P 录成pcap文件的格式，而不要录成默认的 Ad-hoc的模式</p></div><footer class=entry-footer><span title='2020-05-14 16:13:10 +0800 CST'>2020-05-14 16:13:10</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to rtpproxy录音" href=https://wdd.js.org/opensips/ch4/rtp-record/></a></article><footer class=page-footer><nav class=pagination><a class=prev href=https://wdd.js.org/opensips/page/7/>«&nbsp;Prev&nbsp;
</a><a class=next href=https://wdd.js.org/opensips/page/9/>Next&nbsp;&nbsp;»</a></nav></footer></main><footer class=footer><span>&copy; 2025 <a href=https://wdd.js.org/>洞香春</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>