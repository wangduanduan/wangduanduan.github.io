<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>OpenSIPS2.4.X 中文实战系列 | 洞香春</title>
<meta name=keywords content><meta name=description content="OpenSIPS VOIP"><meta name=author content="Eddie Wang"><link rel=canonical href=https://wdd.js.org/opensips/><link crossorigin=anonymous href=/assets/css/stylesheet.821c51435cba3e33e49e590a06514c54c32ac7957095ffcc1e0f390c47cf3228.css integrity="sha256-ghxRQ1y6PjPknlkKBlFMVMMqx5Vwlf/MHg85DEfPMig=" rel="preload stylesheet" as=style><link rel=icon href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/cowboy.ico><link rel=apple-touch-icon href=https://wdd.js.org/cowboy.ico><link rel=mask-icon href=https://wdd.js.org/cowboy.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://wdd.js.org/opensips/index.xml><link rel=alternate hreflang=en href=https://wdd.js.org/opensips/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://wdd.js.org/opensips/"><meta property="og:site_name" content="洞香春"><meta property="og:title" content="OpenSIPS2.4.X 中文实战系列"><meta property="og:description" content="OpenSIPS VOIP"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="OpenSIPS2.4.X 中文实战系列"><meta name=twitter:description content="OpenSIPS VOIP"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"OpenSIPS2.4.X 中文实战系列","item":"https://wdd.js.org/opensips/"}]}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org/ accesskey=h title="洞香春 (Alt + H)"><img src=https://wdd.js.org/cowboy.ico alt aria-label=logo height=35>洞香春</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wdd.js.org/books/ title=读书><span>读书</span></a></li><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/kamailio/ title=Kamailio><span>Kamailio</span></a></li><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span class=active>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/categories/ title=分类><span>分类</span></a></li><li><a href=https://wdd.js.org/fe/ title=前端><span>前端</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://wdd.js.org/>Home</a></div><h1>OpenSIPS2.4.X 中文实战系列</h1><div class=post-description>OpenSIPS VOIP</div></header><div class=post-content><p>本系列文章是我在学习 OpenSIPS 过程中，慢慢总结出来的。虽说是实战，但是笔记的成分可能会多点，我也无法保证里面的内容是否完全正确。</p><p>VOIP 对我来说是个比较陌生的领域。进入这个领域可以说是一个意外。在学习过程和实战过程中，我发现了 VOIP 有很大的复杂性。生产环境也会有常常有怪异棘手的各种问题。在解决这些问题的过程中，有种升级打怪的感觉。</p><p>本知识库重点在于讲解 OpenSIPS，当然其中也涵盖了 SIP 协议，FreeSWITCH, rtpproxy, rtpengine，以及一些排查问题的工具。</p><p>推荐在学习的过程中，一定要啃一遍 RFC 3261 协议，这是 VOIP 的基石。</p><p>如果感觉本教程对您有所帮助， 欢迎加入博主的知识星球，一起学习探讨，一起进步。</p><p>在知识星球中，你可以得到以下服务：</p><ul><li><ol><li>与博主和其他星球成员一起交流学习</li></ol></li><li><ol start=2><li>提出问题，博主会第一时间回复</li></ol></li><li><ol start=3><li>后续考虑在知识星球上更新OpenSIP 3.X和kamailio 6.X教程</li></ol></li></ul><p><img alt=知识星球 loading=lazy src=/opensips/zs2.jpg></p><h1 id=文章目录>文章目录<a hidden class=anchor aria-hidden=true href=#文章目录>#</a></h1><ul><li><p>1: SIP 协议</p><ul><li><a href=/opensips/ch1/study-tips>1.1 学习建议</a></li><li><a href=/opensips/ch1/sip-overview>1.2 SIP 协议简介</a></li><li><a href=ch1/via-route-record-route>1.3 Via route Record-Route 的区别</a></li><li><a href=/opensips/ch1/sip-path>1.4 SIP Path 头</a></li><li><a href=/opensips/ch1/trunk-pbx-gateway>1.5 Trunk PBX Gateway</a></li><li><a href=/opensips/ch1/sip-notes>1.6 SIP 协议拾遗补缺</a></li><li><a href=/opensips/ch1/sip-with-sdp>1.7 SIP 与 SDP 的关系</a></li><li><a href=/opensips/ch1/nat-sip-rtp>1.8 SIP 信令和媒体都绕不开的 NAT 问题</a></li><li><a href=/opensips/ch1/stun-notes>1.9 STUN 协议笔记</a></li><li><a href=/opensips/ch1/sip-register>1.10 SIP 注册调研</a></li><li><a href=/opensips/ch1/sip-ack>1.11 深入 SIP ACK 消息</a></li><li><a href=/opensips/ch1/ua-answer-mode>1.12 UA 应答模式</a></li><li><a href=/opensips/ch1/deep-in-nat>1.13 NAT 深入学习</a></li><li><a href=/opensips/ch1/fix-nat>1.14 解决 NAT 问题</a></li><li><a href=/opensips/ch1/from-to-request-url>1.15 From To Request URL 之间的关系</a></li><li><a href=/opensips/ch1/sip-rfcs>1.16 SIP 相关 RFC 协议</a></li><li><a href=/opensips/ch1/story-of-nat>1.17 漫话 NAT 的历史</a></li><li><a href=/opensips/ch1/offer-answer>1.18 媒体协商 offer/answer 模型</a></li><li><a href=/opensips/ch1/sip-rtp-path>1.19 媒体路径与信令路径</a></li><li><a href=/opensips/ch1/csta-call-model>1.20 CSTA 呼叫模型简介</a></li></ul></li><li><ol start=2><li>常识</li></ol><ul><li><a href=/opensips/ch2/early-media-type>2.1 几种常用电话信号音的含义</a></li><li><a href=/opensips/ch2/early-media>2.2 回铃音</a></li><li><a href=/opensips/ch2/axb>2.3 AXB的玩法说明</a></li></ul></li><li><ol start=3><li>OpenSIPS安装与管理</li></ol><ul><li><a href=/opensips/ch3/about-opensips>3.1 opensips介绍</a></li><li><a href=/opensips/ch3/install-opensips>3.2 debian jessie opensips 2.4.7 安装</a></li><li><a href=/opensips/ch3/centos-install>3.3 centos7 安装opensips</a></li><li><a href=/opensips/ch3/log>3.4 设置独立日志文件</a></li><li><a href=/opensips/ch3/core-mi>3.5 核心MI命令</a></li><li><a href=/opensips/ch3/opensipsctl>3.6 opensips管理命令</a></li><li><a href=/opensips/ch3/centos7-2.4/>3.7 centos7 2.2 升级到2.4.6</a></li><li><a href=/opensips/ch3/opensips-monitor/>3.8 OpenSIPS监控</a></li><li><a href=/opensips/ch3/cache-reload/>3.9 模块缓存策略与reload方法</a></li><li><a href=/opensips/ch3/sip-crlf/>3.10 SIP消息格式CRLF</a></li><li><a href=/opensips/ch3/elk/>3.10 opensips日志写入elasticsearch</a></li><li><a href=/opensips/ch3/prd-warning/>3.10 生产环境监控告警</a></li></ul></li><li><ol start=4><li>媒体相关</li></ol><ul><li><a href=/opensips/ch4/rtp-timestamp/>4.1 RTP 不连续的timestamp和SSRC</a></li><li><a href=/opensips/ch4/media-codec/>4.2 常见媒体流编码及其特点</a></li><li><a href=/opensips/ch4/rtp-record/>4.2 rtpproxy录音</a></li><li><a href=/opensips/ch4/codec-table/>4.2 rtp编码表</a></li></ul></li><li><ol start=5><li>配置文件和路由脚本</li></ol><ul><li><a href=/opensips/ch5/routing-script/>5.1 配置文件</a></li><li><a href=/opensips/ch5/global-params/>5.2 全局参数配置</a></li><li><a href=/opensips/ch5/routing-type/>5.3 路由分类</a></li><li><a href=/opensips/ch5/triger-time/>5.4 路由的触发时机</a></li><li><a href=/opensipsch5/strict-loose-routing/>5.5 严格路由和松散路由</a></li><li><a href=/opensips/ch5/function/>5.6 函数特点</a></li><li><a href=/opensips/ch5/return/>5.7 使用return语句减少逻辑嵌套</a></li><li><a href=/opensips/ch5/condition/>5.8 条件语句特点</a></li><li><a href=/opensips/ch5/statement/>5.9 常用语句</a></li><li><a href=/opensips/ch5/var/>5.10 变量的使用</a></li><li><a href=/opensips/ch5/core-var/>5.11 核心变量说明</a></li><li><a href=/opensips/ch5/xlog/>5.12 优雅的使用xlog输出日志行</a></li><li><a href=/opensips/ch5/module/>5.13 脚本路由模块化</a></li><li><a href=/opensips/ch5/stateful-stateless/>5.14 有状态和无状态路由</a></li><li><a href=/opensips/ch5/init-seque/>5.15 【重点】初始化请求和序列化请求</a></li><li><a href=/opensips/ch5/via-route/>5.16 SIP路由头</a></li><li><a href=/opensips/ch5/avp-db-query/>5.17 avp_db_query数值null值比较</a></li><li><a href=/opensips/ch5/xlog-level/>5.18 日志xlog</a></li><li><a href=/opensips/ch5/homer6/>5.19 opensips 集成 homer6</a></li><li><a href=/opensips/ch5/adv-address/>5.20 【必读】深入对外公布地址</a></li><li><a href=/opensips/ch5/m4/>5.21 使用m4增强opensips.cfg脚本预处理能力</a></li><li><a href=/opensips/ch5/db-mode/>5.22 db_mode调优</a></li><li><a href=/opensips/ch5/sql-table/>5.23 mysql建表语句</a></li><li><a href=/opensips/ch5/core-var-2/>5.24 核心变量解读2-100%</a></li></ul></li><li><ol start=6><li>模块使用教程</li></ol><ul><li><a href=/opensips/ch6/acc/>6.1 acc呼叫记录模块</a></li><li><a href=/opensips/ch6/cachedb/>6.2 cachedb的相关问题</a></li><li><a href=/opensips/ch6/load-balance/>6.3 负载均衡模块load_balance</a></li><li><a href=/opensips/ch6/dispatcher/>6.4 sip消息分发之dispatcher模块</a></li></ul></li><li><ol start=7><li>常见问题</li></ol><ul><li><a href=/opensips/ch7/tm-send-failed/>7.1 opensips 477 Send failed (477/TM)</a></li><li><a href=/opensips/ch7/sendmsg-failed/>7.2 sendmsg failed on 0: Socket operation on non-socket</a></li><li><a href=/opensips/ch7/escape-msg/>7.3 信令路径逃逸分析</a></li><li><a href=/opensips/ch7/crash/>7.4 opensips崩溃分析</a></li><li><a href=/opensips/ch7/can-not-run/>7.5 opensips无法启动</a></li><li><a href=/opensips/ch7/big-udp-msg/>7.6 UDP分片导致SIP消息丢失</a></li><li><a href=/opensips/ch7/rtp-broken-connection>7.7 奥科网关 Rtp Broken Connection</a></li><li><a href=/opensips/ch7/miss-ack/>7.8 ACK 无法正常送到FS</a></li><li><a href=/opensips/ch7/30-seconds-drop/>7.9 30秒自动挂断</a></li><li><a href=/opensips/ch7/cfg-trace/>7.10 script_trace 打印opensips的脚本执行过程</a></li><li><a href=/opensips/ch7/one-leg-audio/>7.11 一方听不到另外一方的声音</a></li><li><a href=/opensips/ch7/echo-back/>7.12 回音问题调研</a></li><li><a href=/opensips/ch7/without-log/>7.13 opensips启动失败没有任何报错日志</a></li><li><a href=/opensips/ch7/poor-quality/>7.14 通话质量差</a></li><li><a href=/opensips/ch7/without-default-carrier/>7.15 ERROR:carrierroute:carrier_tree_fixup: default_carrier not found</a></li></ul></li><li><ol start=8><li>脚本学习</li></ol><ul><li><a href=/opensips/ch8/topology-hiding/>8.1 拓扑隐藏学习以及实践</a></li><li><a href=/opensips/ch8/serial-183/>8.2 serial_183</a></li><li><a href=/opensips/ch8/replicate/>8.3 replicate</a></li><li><a href=/opensips/ch8/redirect/>8.4 redirect</a></li><li><a href=/opensips/ch8/pstn/>8.5 pstn</a></li><li><a href=/opensips/ch8/nathelper/>8.6 nathelper</a></li><li><a href=/opensips/ch8/msilo/>8.7 msilo</a></li><li><a href=/opensips/ch8/logging/>8.8 logging</a></li><li><a href=/opensips/ch8/httpd/>8.9 httpd</a></li><li><a href=/opensips/ch8/fork/>8.10 fork</a></li><li><a href=/opensips/ch8/flag-reply/>8.11 flag reply</a></li><li><a href=/opensips/ch8/exec/>8.12 exec</a></li><li><a href=/opensips/ch8/acc/>8.13 acc</a></li><li><a href=/opensips/ch8/acc-mysql/>8.14 acc-mysql</a></li><li><a href=/opensips/ch8/default/>8.15 default</a></li><li><a href=/opensips/ch8/mid-register/>8.16 mid register</a></li><li><a href=/opensips/ch8/fs-loadbalance/>8.17 fs loadbalance</a></li><li><a href=/opensips/ch8/fraud/>8.18 fraud</a></li><li><a href=/opensips/ch8/dtmf-lan/>8.19 dtmf</a></li><li><a href=/opensips/ch8/siprec/>8.20 siprec</a></li></ul></li><li><ol start=9><li>扩展</li></ol><ul><li><a href=/opensips/ch9/webrtc-ref/>9.1 WebRTC学习资料分享</a></li><li><a href=/opensips/ch9/notes/>9.2 WebRTC简介</a></li><li><a href=/opensips/ch9/webrtc-pdf/>9.3 opensips with webrtc</a></li><li><a href=/opensips/ch9/blf/>9.4 BLF指示灯</a></li><li><a href=/opensips/ch9/isup-sip-isdn/>9.5 ISUP SIP ISDN对照码表</a></li><li><a href=/opensips/ch9/rtpengine-manu/>9.6 rtpengine cli</a></li><li><a href=/opensips/ch9/rtpengine-ilbc/>9.7 rtpengine 增加对ilbc编解码的支持</a></li><li><a href=/opensips/ch9/sdp/>9.8 sdp协议简介</a></li><li><a href=/opensips/ch9/rtpproxy/>9.9 rtpproxy学习</a></li><li><a href=/opensips/ch9/feature-code/>9.10 SIP feature codes SIP功能码</a></li><li><a href=/opensips/ch9/100-rel/>9.11 sbc 100rel</a></li><li><a href=/opensips/ch9/blf-note/>9.12 blf 功能笔记</a></li><li><a href=/opensips/ch9/nat-single-interface/>9.13 NAT场景下的信令处理 - 单网卡</a></li><li><a href=/opensips/ch9/cluster-share-location/>9.14 集群共享分机注册信息</a></li><li><a href=/opensips/ch9/books/>9.15 参考资料与书籍</a></li></ul></li><li><ol start=10><li>相关工具</li></ol><ul><li><a href=/opensips/tools/tshark/>10.1 tshark 快速分析语音流问题</a></li><li><a href=/opensips/tools/heplify/>10.2 heplify SIP信令抓包客户端</a></li><li><a href=/opensips/tools/baresip/>10.3 baresip 非常好用的终端SIP UA</a></li><li><a href=/opensips/tools/sipsak/>10.4 sipsak</a></li><li><a href=/opensips/tools/wireshark-player-pcap/>10.5 wireshark 播放抓包文件</a></li><li><a href=/opensips/tools/sngrep/>10.6 sngrep: 最好用的sip可视化抓包工具</a></li><li><a href=/opensips/tools/homer/>10.7 homer: 统一的sip包集中处理工具</a></li><li><a href=/opensips/tools/siphub/>10.8 siphub 轻量级实时SIP信令收包的服务</a></li><li><a href=/opensips/tools/sipp/>10.9 SIPp：sip压测模拟ua工具</a></li><li><a href=/opensips/tools/sipp-subscriber/>10.10 SIPP subscriber 测试</a></li><li><a href=/opensips/tools/tcp-dump/>10.11 tcpdump</a></li><li><a href=/opensips/tools/pjsip/>10.12 pjsip</a></li><li><a href=/opensips/tools/wireshark-sip/>10.13 Wireshark SIP 抓包</a></li><li><a href=/opensips/tools/kamailio/>10.14 另一个功能强大的sip server: kamailio</a></li></ul></li><li><ol start=11><li>官方博客</li></ol><ul><li><a href=/opensips/blog/load-balance/>Load Balancing in OpenSIPS</a></li><li><a href=/opensips/blog/dialog-trigers/>Dialog triggers, or how to control the calls from script</a></li><li><a href=/opensips/blog/cross-dialog-data/>Cross-dialog data accessing</a></li><li><a href=/opensips/blog/calls-manager/>Calls management using the new Call API tool</a></li><li><a href=/opensips/blog/call-stat/>Improved series-based call statistics using OpenSIPS 3.2</a></li><li><a href=/opensips/blog/opensips3-tls/>Exploring SSL/TLS libraries for OpenSIPS 3.2</a></li><li><a href=/opensips/blog/openssl-opensips/>The OpenSIPS and OpenSSL journey</a></li><li><a href=/opensips/blog/mutltiple-interface/>SIP bridging over multiple interfaces</a></li><li><a href=/opensips/blog/cancel-reason/>CANCEL请求和Reason头</a></li><li><a href=/opensips/blog/opensips3x/>Introducing OpenSIPS 3.0</a></li><li><a href=/opensips/blog/cluster-location/>Clustered SIP User Location: The Full Sharing Topology</a></li><li><a href=/opensips/blog/cluster-call/>Clustering ongoing calls with OpenSIPS 2.4</a></li><li><a href=/opensips/blog/full-anycast/>Full Anycast support in OpenSIPS 2.4</a></li><li><a href=/opensips/blog/deepin-stat-engine/>深入OpenSIPS统计引擎</a></li><li><a href=/opensips/blog/runing-opensips-in-cloud/>Running OpenSIPS in the Cloud</a></li><li><a href=/opensips/blog/troubleshooting-opensips-script/>Troubleshooting OpenSIPS script</a></li><li><a href=/opensips/blog/miss-ack/>Troubleshooting missing ACK in SIP</a></li><li><a href=/opensips/blog/memory-usage/>理解并测量OpenSIPS的内存资源</a></li></ul></li><li><p>问题列表</p><ul><li><a href=/opensips/ch1/utime-task-scheduled>utimer task already scheduled</a></li></ul></li><li><p>OpenSIPS 3X</p><ul><li><a href=/opensips/3x/module-args/>模块传参的重构</a></li></ul></li><li><p><a href=/opensips/module-dev/>模块开发实战</a></p></li><li><p><a href=/opensips/pdf/>OpenSIPS Summit PDF学习资料</a></p></li><li><p><a href=/opensips/dev-audio/>源码学习视频教程</a></p></li></ul><h1 id=文章列表>文章列表<a hidden class=anchor aria-hidden=true href=#文章列表>#</a></h1></div><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>Full Anycast support in OpenSIPS 2.4</h2></header><div class=entry-content><p>he advantages of doing Load Balancing and High Availability **without **any particular requirements from the clients side are starting to make Anycast IPs more and more appealing in the VoIP world. But are you actually using the best out of it? This article describes how you can use OpenSIPS 2.4 to make the best use of an anycast environment.Anycast is a UDP-based special network setup where a single IP is assigned to multiple nodes, each of them being able to actively use it (as opposed to a VRRP setup, where only one instance can use the IP). When a packet reaches the network with an anycast destination, the router sends it to the “closest” node, based on different metrics (application status, network latency, etc). This behavior ensures that traffic is (1) balanced by sending it to one of the least busy nodes (based on application status) and also ensures (2) geo-distribution, by sending the request to the closest node (based on latency). Moreover, if a node goes down, it will be completely put out of route, ensuring (3) high availability for your platform. All these features without any special requirements from your customers, all they need is to send traffic to the anycast IP.Sounds wonderful, right? It really is! And if you are running using anycast IPs in a transaction stateless mode, things just work out of the box.
...</p></div><footer class=entry-footer><span title='2019-07-31 13:37:31 +0800 CST'>2019-07-31 13:37:31</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to Full Anycast support in OpenSIPS 2.4" href=https://wdd.js.org/opensips/blog/full-anycast/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>Clustering ongoing calls with OpenSIPS 2.4</h2></header><div class=entry-content><p>Dialog replication in OpenSIPS has been around since version 1.10, when it became clear that sharing real-time data through a database is no longer feasible in a large VoIP platform. Further steps in this direction have been made in 2.2, with the advent of the clusterer module, which manages OpenSIPS instances and their inter-communication. But have we been able to achieve the objective of a true and complete solution for clustering dialog support? In this article we are going to look into the limitations of distributing ongoing calls in previous OpenSIPS versions and how we overcame them and added new possibilities in 2.4, based on the improved clustering engine.
...</p></div><footer class=entry-footer><span title='2019-07-31 13:36:53 +0800 CST'>2019-07-31 13:36:53</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to Clustering ongoing calls with OpenSIPS 2.4" href=https://wdd.js.org/opensips/blog/cluster-call/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>Clustered SIP User Location: The Full Sharing Topology</h2></header><div class=entry-content><p>The distributed SIP user location support is one of the major features of the latest stable OpenSIPS release, namely 2.4. The aim of this extension of the OpenSIPS usrloc module is to provide a horizontally scalable solution that is easy to set up and maintain, while remaining flexible enough to cope with varying needs of each specific deployment.Throughout this text, by “data” we refer to SIP Addresses-of-Record (subscribers) and their dynamic SIP Contact bindings (network coordinates of their SIP devices) — all of these must be replicated across cluster nodes. From a data sharing point of view, we can break the distributed user location support down in two major modes of usage:
...</p></div><footer class=entry-footer><span title='2019-07-31 13:34:05 +0800 CST'>2019-07-31 13:34:05</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to Clustered SIP User Location: The Full Sharing Topology" href=https://wdd.js.org/opensips/blog/cluster-location/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>Introducing OpenSIPS 3.0</h2></header><div class=entry-content><p>You already know the story – one more year, one more evolution cycle, one more OpenSIPS major release. Even more, a new OpenSIPS direction is about to start. So let me introduce you to the upcoming OpenSIPS 3.0 .For the upcoming OpenSIPS 3.0 release (and 3.x family) the main focus is on the **_devops _**concept. Shortly said, this translates into:
making the OpenSIPS script writing/developing much easier simplifying the operational activities around OpenSIPS What features and functionalities a software is able to deliver is a very important factor. Nevertheless, how easy to use and operate the software is, it;s a another factor with almost the same importance . Especially if we consider the case of OpenSIPS which is a very complex software to configure, to integrate and to operate in large scale multi-party platforms.
...</p></div><footer class=entry-footer><span title='2019-07-31 13:31:30 +0800 CST'>2019-07-31 13:31:30</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to Introducing OpenSIPS 3.0" href=https://wdd.js.org/opensips/blog/opensips3x/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>核心MI命令</h2></header><div class=entry-content><p>在所有的fifo命令中，which命令比较重要，因为它可以列出所有的其他命令。
有些mi命令是存在于各个模块之中，所以加载的模块不通。opensipsctl fifo which输出的命令也不通。
获取执行参数 opensipsctl fifo arg 列出TCP连接数量 opensipsctl fifo list_tcp_conns 查看进程信息 opensipsctl fifo ps 查看opensips运行时长 opensipsctl fifo uptime 查看所有支持的指令 opensipsctl fifo which 获取统计数据 opensipsctl fifo get_statistics rcv_requests 重置统计数据 opensipsctl fifo get_statistics received_replies get_statistics reset_statistics uptime version pwd arg which ps kill debug cache_store cache_fetch cache_remove event_subscribe events_list subscribers_list list_tcp_conns help list_blacklists regex_reload t_uac_dlg t_uac_cancel t_hash t_reply ul_rm ul_rm_contact ul_dump ul_flush ul_add ul_show_contact ul_sync domain_reload domain_dump dlg_list dlg_list_ctx dlg_end_dlg dlg_db_sync dlg_restore_db profile_get_size profile_list_dlgs profile_get_values list_all_profiles nh_enable_ping cr_reload_routes cr_dump_routes cr_replace_host cr_deactivate_host cr_activate_host cr_add_host cr_delete_host dp_reload dp_translate address_reload address_dump subnet_dump allow_uri dr_reload dr_gw_status dr_carrier_status lb_reload lb_resize lb_list lb_status httpd_list_root_path sip_trace rtpengine_enable rtpengine_show rtpengine_reload teardown</p></div><footer class=entry-footer><span title='2019-07-18 13:54:58 +0800 CST'>2019-07-18 13:54:58</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to 核心MI命令" href=https://wdd.js.org/opensips/ch3/core-mi/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>from vs to vs request-url之间的关系</h2></header><div class=entry-content><p>from字段用来标记请求的发起者ID to字段用来标记请求接受者的ID to字段并不能用于路由，request-url可以用来路由 一般情况下，sip消息再传输过程中，from和to字段都不会改，而request-url很可能会因为路由而改变 对于最初的请求，除了注册请求之外，request-url和to字段中的url一致 from字段：The From header field is a required header field that indicates the originator of the request. It is one of two addresses used to identify the dialog. The From header field contains a URI, but it may not contain the transport, maddr, or ttl URI parameters. A From header field may contain a tag used to identify a particular call. A From header field may contain a display name, in which case the URI is enclosed in &lt; >. If there is both a URI parameter and a tag, then the URI including any parameters must be enclosed in &lt; >. Examples are shown in Table 6.8. A From tag was optional in RFC 2543 but is mandatory to include in RFC 3261.
...</p></div><footer class=entry-footer><span title='2019-07-11 07:38:53 +0800 CST'>2019-07-11 07:38:53</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to from vs to vs request-url之间的关系" href=https://wdd.js.org/opensips/ch1/from-to-request-url/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>日志xlog</h2></header><div class=entry-content><p>建议日志格式 xlog("$rm $fu->$tu:$cfg_line some msg") 日志级别 L_ALERT (-3) L_CRIT (-2) L_ERR (-1) - this is used by default if log_level is omitted L_WARN (1) L_NOTICE (2) L_INFO (3) L_DBG (4) 日志级别如果设置为2， 那么只会打印小于等于2的日志。默认使用xlog(“hello”), 那么日志级别就会是L_ERR
生产环境建议将日志界别调整到-1
1.x的opensips使用 debug=3 设置日志级别2.x的opensips使用 log_level=3 设置日志级别
动态设置日志级别 在程序运行时，可以通过opensipctl 命令动态设置日志级别
opensipsctl fifo log_level -2 最好使用日志级别 不要为了简便，都用 xlog("msg") 如果msg是信息级别，用xlog("L_INFO", "msg") 如果msg是错误信息，则使用xlog("msg")</p></div><footer class=entry-footer><span title='2019-07-09 17:52:55 +0800 CST'>2019-07-09 17:52:55</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to 日志xlog" href=https://wdd.js.org/opensips/ch5/xlog-level/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>opensips-summit-fraud</h2></header><div class=entry-content><p># # $Id$ # # OpenSIPS residential configuration script # by OpenSIPS Solutions &lt;team@opensips-solutions.com> # # This script was generated via "make menuconfig", from # the "Residential" scenario. # You can enable / disable more features / functionalities by # re-generating the scenario with different options.# # # Please refer to the Core CookBook at: # http://www.opensips.org/Resources/DocsCookbooks # for a explanation of possible statements, functions and parameters. # ####### Global Parameters ######### log_level=3 log_stderror=yes log_facility=LOG_LOCAL0 children=4 memdump=-1 /* uncomment the following line to enable debugging */ #debug_mode=yes /* uncomment the next line to enable the auto temporary blacklisting of not available destinations (default disabled) */ #disable_dns_blacklist=no /* uncomment the next line to enable IPv6 lookup after IPv4 dns lookup failures (default disabled) */ #dns_try_ipv6=yes /* comment the next line to enable the auto discovery of local aliases based on revers DNS on IPs */ auto_aliases=no listen=udp:127.0.0.1:5060 # CUSTOMIZE ME listen=udp:10.0.2.8:5060 # CUSTOMIZE ME ####### Modules Section ######## #set module path mpath="modules/" loadmodule "proto_udp.so" #### SIGNALING module loadmodule "signaling.so" #### StateLess module loadmodule "sl.so" #### Transaction Module loadmodule "tm.so" modparam("tm", "fr_timeout", 5) modparam("tm", "fr_inv_timeout", 30) modparam("tm", "restart_fr_on_each_reply", 0) modparam("tm", "onreply_avp_mode", 1) #### Record Route Module loadmodule "rr.so" /* do not append from tag to the RR (no need for this script) */ modparam("rr", "append_fromtag", 0) #### MAX ForWarD module loadmodule "maxfwd.so" #### SIP MSG OPerationS module loadmodule "sipmsgops.so" #### FIFO Management Interface loadmodule "mi_fifo.so" modparam("mi_fifo", "fifo_name", "/tmp/opensips_fifo") modparam("mi_fifo", "fifo_mode", 0666) #### URI module loadmodule "uri.so" modparam("uri", "use_uri_table", 0) #### USeR LOCation module loadmodule "usrloc.so" modparam("usrloc", "nat_bflag", "NAT") modparam("usrloc", "db_mode", 1) modparam("usrloc", "db_url", "mysql://root:summit2017@127.0.0.1/opensips_2_3") #### REGISTRAR module loadmodule "registrar.so" loadmodule "drouting.so" modparam("drouting", "db_url", "mysql://root:summit2017@127.0.0.1/opensips_2_3") loadmodule "fraud_detection.so" modparam("fraud_detection", "db_url", "mysql://root:summit2017@127.0.0.1/opensips_2_3") loadmodule "event_route.so" loadmodule "cachedb_local.so" #loadmodule "aaa_radius.so" #modparam("aaa_radius","radius_config","modules/acc/etc/radius/radiusclient.conf") #### ACCounting module loadmodule "acc.so" /* what special events should be accounted ? */ #modparam("acc", "aaa_url", "radius:modules/acc/etc/radius/radiusclient.conf") modparam("acc", "early_media", 0) modparam("acc", "report_cancels", 0) /* by default we do not adjust the direct of the sequential requests. if you enable this parameter, be sure the enable "append_fromtag" in "rr" module */ modparam("acc", "detect_direction", 0) #modparam("acc", "multi_leg_info", "text1=$avp(src);text2=$avp(dst)") #modparam("acc", "multi_leg_bye_info", "text1=$avp(src);text2=$avp(dst)") /* account triggers (flags) */ loadmodule "avpops.so" modparam("avpops", "db_url", "1 mysql://root:summit2017@127.0.0.1/opensips_2_3") loadmodule "db_mysql.so" modparam("db_mysql", "exec_query_threshold", 500000) loadmodule "cfgutils.so" loadmodule "dialog.so" loadmodule "rest_client.so" loadmodule "dispatcher.so" modparam("dispatcher", "db_url", "mysql://root:summit2017@127.0.0.1/opensips_2_3") ####### Routing Logic ######## # main request routing logic route { if (!mf_process_maxfwd_header("10")) { sl_send_reply("483","Too Many Hops"); exit; } if (has_totag()) { # sequential requests within a dialog should # take the path determined by record-routing if (loose_route()) { if (is_method("INVITE")) { # even if in most of the cases is useless, do RR for # re-INVITEs alos, as some buggy clients do change route set # during the dialog. record_route(); } # route it out to whatever destination was set by loose_route() # in $du (destination URI). route(relay); } else { if ( is_method("ACK") ) { if ( t_check_trans() ) { # non loose-route, but stateful ACK; must be an ACK after # a 487 or e.g. 404 from upstream server t_relay(); exit; } else { # ACK without matching transaction -> # ignore and discard exit; } } sl_send_reply("404","Not here"); } exit; } if (is_method("REGISTER")) { if (!save("location")) sl_reply_error(); exit; } # CANCEL processing if (is_method("CANCEL")) { if (t_check_trans()) t_relay(); exit; } t_check_trans(); if ( !(is_method("REGISTER") ) ) { if (from_uri==myself) { } else { # if caller is not local, then called number must be local } } # preloaded route checking if (loose_route()) { xlog("L_ERR", "Attempt to route with preloaded Route's [$fu/$tu/$ru/$ci]"); if (!is_method("ACK")) sl_send_reply("403","Preload Route denied"); exit; } # record routing if (!is_method("REGISTER|MESSAGE")) record_route(); # account only INVITEs if (is_method("INVITE")) { create_dialog(); do_accounting("evi", "cdr|missed|failed"); } if (!uri==myself) { append_hf("P-hint: outbound\r\n"); route(relay); } # requests for my domain if (is_method("PUBLISH|SUBSCRIBE")) { sl_send_reply("503", "Service Unavailable"); exit; } if ($rU==NULL) { # request with no Username in RURI sl_send_reply("484","Address Incomplete"); exit; } if (!check_fraud("$fU", "$rU", "2")) { send_reply("403", "Forbidden"); exit; } $du = "sip:10.0.2.8:7050"; route(relay); } route [relay] { # for INVITEs enable some additional helper routes if (is_method("INVITE")) { t_on_branch("per_branch_ops"); t_on_reply("handle_nat"); t_on_failure("missed_call"); } if (!t_relay()) { send_reply("500","Internal Error"); }; exit; } branch_route[per_branch_ops] { xlog("new branch at $ru\n"); } onreply_route[handle_nat] { xlog("incoming reply\n"); } route [ds_route] { xlog("foo\n"); } failure_route[missed_call] { if (t_was_cancelled()) { exit; } # uncomment the following lines if you want to block client # redirect based on 3xx replies. ##if (t_check_status("3[0-9][0-9]")) { ##t_reply("404","Not found"); ## exit; ##} } event_route [E_FRD_WARNING] { fetch_event_params("$var(param);$var(val);$var(thr);$var(user);$var(number);$var(ruleid)"); xlog("E_FRD_WARNING: $var(param);$var(val);$var(thr);$var(user);$var(number);$var(ruleid)\n"); if ($var(param) == "calls per minute") { xlog("e_frd_cpm++!\n"); cache_add("local", "e_frd_cpm", 1, 0); } else if ($var(param) == "call_duration") { xlog("e_frd_cdur++!\n"); cache_add("local", "e_frd_cdur", 1, 0); } else if ($var(param) == "total calls") { xlog("e_frd_tc++!\n"); cache_add("local", "e_frd_tc", 1, 0); } else if ($var(param) == "concurrent calls") { xlog("e_frd_cc++!\n"); cache_add("local", "e_frd_cc", 1, 0); } else if ($var(param) == "sequential calls") { xlog("e_frd_seq++!\n"); cache_add("local", "e_frd_seq", 1, 0); } } event_route [E_FRD_CRITICAL] { fetch_event_params("$var(param);$var(val);$var(thr);$var(user);$var(number);$var(ruleid)"); xlog("E_FRD_CRITICAL: $var(param);$var(val);$var(thr);$var(user);$var(number);$var(ruleid)\n"); if ($var(param) == "calls per minute") { xlog("e_frd_critcpm++\n"); cache_add("local", "e_frd_critcpm", 1, 0); } else if ($var(param) == "call_duration") { xlog("e_frd_critcdur++\n"); cache_add("local", "e_frd_critcdur", 1, 0); } else if ($var(param) == "total calls") { xlog("e_frd_crittc++!\n"); cache_add("local", "e_frd_crittc", 1, 0); } else if ($var(param) == "concurrent calls") { xlog("e_frd_critcc++!\n"); cache_add("local", "e_frd_critcc", 1, 0); } else if ($var(param) == "sequential calls") { xlog("e_frd_critseq++!\n"); cache_add("local", "e_frd_critseq", 1, 0); } } route [store_influxdb] { $var(body) = $param(2) + ",host=" + $param(3) + " value=" + $param(4); xlog("XXX posting: $var(body) ($param(1) / $param(2) / $param(4))\n"); if (!rest_post("http://localhost:8086/write?db=$param(1)", "$var(body)", , "$var(body)")) { xlog("ERR in rest_post!\n"); exit; } } timer_route [dump_fraud_cpm, 1] { $var(cpm) = 0; $var(ccpm) = 0; cache_counter_fetch("local", "e_frd_cpm", $var(cpm)); cache_counter_fetch("local", "e_frd_critcpm", $var(ccpm)); cache_remove("local", "e_frd_cpm"); cache_remove("local", "e_frd_critcpm"); route(store_influxdb, "fraud_demo", "cpm", "serverA", $var(cpm)); route(store_influxdb, "fraud_demo", "critcpm", "serverA", $var(ccpm)); xlog("XXX stats: $var(cpm) / $var(ccpm)\n"); } timer_route [dump_fraud_cdur, 1] { $var(cdur) = 0; $var(ccdur) = 0; cache_counter_fetch("local", "e_frd_cdur", $var(cdur)); cache_counter_fetch("local", "e_frd_critcdur", $var(ccdur)); cache_remove("local", "e_frd_cdur"); cache_remove("local", "e_frd_critcdur"); route(store_influxdb, "fraud_demo", "cdur", "serverA", $var(cdur)); route(store_influxdb, "fraud_demo", "critcdur", "serverA", $var(ccdur)); xlog("XXX stats: $var(cdur) / $var(ccdur)\n"); } timer_route [dump_fraud_tc, 1] { $var(tc) = 0; $var(ctc) = 0; cache_counter_fetch("local", "e_frd_tc", $var(tc)); cache_counter_fetch("local", "e_frd_crittc", $var(ctc)); cache_remove("local", "e_frd_tc"); cache_remove("local", "e_frd_crittc"); route(store_influxdb, "fraud_demo", "tc", "serverA", $var(tc)); route(store_influxdb, "fraud_demo", "crittc", "serverA", $var(ctc)); xlog("XXX stats: $var(tc) / $var(ctc)\n"); } timer_route [dump_fraud_cc, 1] { $var(cc) = 0; $var(ccc) = 0; cache_counter_fetch("local", "e_frd_cc", $var(cc)); cache_counter_fetch("local", "e_frd_critcc", $var(ccc)); cache_remove("local", "e_frd_cc"); cache_remove("local", "e_frd_critcc"); route(store_influxdb, "fraud_demo", "cc", "serverA", $var(cc)); route(store_influxdb, "fraud_demo", "critcc", "serverA", $var(ccc)); xlog("XXX stats: $var(cc) / $var(ccc)\n"); } timer_route [dump_fraud_seq, 1] { $var(seq) = 0; $var(cseq) = 0; cache_counter_fetch("local", "e_frd_seq", $var(seq)); cache_counter_fetch("local", "e_frd_critseq", $var(cseq)); cache_remove("local", "e_frd_seq"); cache_remove("local", "e_frd_critseq"); route(store_influxdb, "fraud_demo", "seq", "serverA", $var(seq)); route(store_influxdb, "fraud_demo", "critseq", "serverA", $var(cseq)); xlog("XXX stats: $var(seq) / $var(cseq)\n"); }</p></div><footer class=entry-footer><span title='2019-07-02 22:35:03 +0800 CST'>2019-07-02 22:35:03</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to opensips-summit-fraud" href=https://wdd.js.org/opensips/ch8/fraud/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>cluecon-fslb</h2></header><div class=entry-content><p># # OpenSIPS residential configuration script # by OpenSIPS Solutions &lt;team@opensips-solutions.com> # # This script was generated via "make menuconfig", from # the "Residential" scenario. # You can enable / disable more features / functionalities by # re-generating the scenario with different options.# # # Please refer to the Core CookBook at: # http://www.opensips.org/Resources/DocsCookbooks # for a explanation of possible statements, functions and parameters. # ####### Global Parameters ######### log_level=3 memdump=1 log_stderror=yes log_facility=LOG_LOCAL0 children=10 /* uncomment the following lines to enable debugging */ #debug_mode=yes /* uncomment the next line to enable the auto temporary blacklisting of not available destinations (default disabled) */ #disable_dns_blacklist=no /* uncomment the next line to enable IPv6 lookup after IPv4 dns lookup failures (default disabled) */ #dns_try_ipv6=yes /* comment the next line to enable the auto discovery of local aliases based on revers DNS on IPs */ auto_aliases=no listen=udp:192.168.56.1:5070 # CUSTOMIZE ME ####### Modules Section ######## #set module path mpath="modules/" loadmodule "httpd.so" modparam("httpd", "port", 8081) loadmodule "mi_json.so" #### SIGNALING module loadmodule "signaling.so" #### StateLess module loadmodule "sl.so" #### Transaction Module loadmodule "tm.so" modparam("tm", "fr_timeout", 2) modparam("tm", "fr_inv_timeout", 30) modparam("tm", "restart_fr_on_each_reply", 0) modparam("tm", "onreply_avp_mode", 1) loadmodule "cachedb_local.so" loadmodule "mathops.so" modparam("mathops", "decimal_digits", 12) loadmodule "rest_client.so" #### Record Route Module loadmodule "rr.so" /* do not append from tag to the RR (no need for this script) */ modparam("rr", "append_fromtag", 0) #### MAX ForWarD module loadmodule "maxfwd.so" #### SIP MSG OPerationS module loadmodule "sipmsgops.so" #### FIFO Management Interface loadmodule "mi_fifo.so" modparam("mi_fifo", "fifo_name", "/tmp/opensips_fifo_2") modparam("mi_fifo", "fifo_mode", 0666) #### URI module loadmodule "uri.so" modparam("uri", "use_uri_table", 0) loadmodule "cfgutils.so" #### USeR LOCation module loadmodule "usrloc.so" modparam("usrloc", "nat_bflag", "NAT") modparam("usrloc", "db_mode", 0) #### REGISTRAR module loadmodule "registrar.so" modparam("registrar", "tcp_persistent_flag", "TCP_PERSISTENT") /* uncomment the next line not to allow more than 10 contacts per AOR */ #modparam("registrar", "max_contacts", 10) #### ACCounting module loadmodule "acc.so" /* what special events should be accounted ? */ modparam("acc", "early_media", 0) modparam("acc", "report_cancels", 0) /* by default we do not adjust the direct of the sequential requests. if you enable this parameter, be sure the enable "append_fromtag" in "rr" module */ modparam("acc", "detect_direction", 0) loadmodule "proto_udp.so" loadmodule "dialog.so" loadmodule "statistics.so" loadmodule "load_balancer.so" modparam("load_balancer", "db_url", "mysql://opensips:opensipsrw@192.168.56.128/opensips") modparam("load_balancer", "initial_freeswitch_load", 15) modparam("load_balancer", "fetch_freeswitch_stats", 1) loadmodule "freeswitch.so" loadmodule "db_mysql.so" ####### Routing Logic ######## # main request routing logic startup_route { $stat(neg_replies) = 0; } route { if ($stat(neg_replies) == "&lt;null>") $stat(neg_replies) = 0; if (!mf_process_maxfwd_header("10")) { sl_send_reply("483","Too Many Hops"); exit; } if (has_totag()) { # handle hop-by-hop ACK (no routing required) if ( is_method("ACK") && t_check_trans() ) { t_relay(); exit; } # sequential request within a dialog should # take the path determined by record-routing if ( !loose_route() ) { # we do record-routing for all our traffic, so we should not # receive any sequential requests without Route hdr. sl_send_reply("404","Not here"); exit; } if (is_method("BYE")) { # do accounting even if the transaction fails do_accounting("log","failed"); } # route it out to whatever destination was set by loose_route() # in $du (destination URI). route(relay); exit; } # CANCEL processing if (is_method("CANCEL")) { if (t_check_trans()) t_relay(); exit; } t_check_trans(); if ( !(is_method("REGISTER") ) ) { if (is_myself("$fd")) { } else { # if caller is not local, then called number must be local if (!is_myself("$rd")) { send_reply("403","Rely forbidden"); exit; } } } # preloaded route checking if (loose_route()) { xlog("L_ERR", "Attempt to route with preloaded Route's [$fu/$tu/$ru/$ci]"); if (!is_method("ACK")) sl_send_reply("403","Preload Route denied"); exit; } # record routing if (!is_method("REGISTER|MESSAGE")) record_route(); # account only INVITEs if (is_method("INVITE")) { create_dialog(); $dlg_val(start_ts) = $Ts; $dlg_val(start_tsm) = $Tsm; $dlg_val(pdd_pen) = "0"; t_on_reply("invite_reply"); do_accounting("log"); } if (!is_myself("$rd")) { append_hf("P-hint: outbound\r\n"); route(relay); } # requests for my domain if (is_method("PUBLISH|SUBSCRIBE")) { sl_send_reply("501", "Not Implemented"); exit; } if (is_method("REGISTER")) { if (!save("location")) sl_reply_error(); exit; } if ($rU==NULL) { # request with no Username in RURI sl_send_reply("484","Address Incomplete"); exit; } if (!load_balance("2", "call")) { xlog("no available destinations!\n"); send_reply("503", "No available dsts"); exit; } # when routing via usrloc, log the missed calls also do_accounting("log","missed"); route(relay); } onreply_route [invite_reply] { if ($rs == 180) { if ($Ts == $(dlg_val(start_ts){s.int})) { $var(diff_sec) = 0; $var(diff_usec) = $Tsm - $(dlg_val(start_tsm){s.int}); } else if ($Tsm > $(dlg_val(start_tsm){s.int})) { $var(diff_sec) = $Ts - $(dlg_val(start_ts){s.int}); $var(diff_usec) = $Tsm - $(dlg_val(start_tsm){s.int}); } else { $var(diff_sec) = $Ts - $(dlg_val(start_ts){s.int}) - 1; $var(diff_usec) = 1000000 + $Tsm - $(dlg_val(start_tsm){s.int}); } $var(diff_usec) = $var(diff_usec) + $dlg_val(pdd_pen); cache_add("local", "tot_sec", $var(diff_sec), 0, $var(nsv)); cache_add("local", "tot_usec", $var(diff_usec), 0, $var(nmsv)); cache_add("local", "tot", 1, 0); xlog("XXXX: $var(diff_sec) s, $var(diff_usec) us | $var(nsv) | $var(nmsv)\n"); } } route[relay] { # for INVITEs enable some additional helper routes if (is_method("INVITE")) { t_on_branch("per_branch_ops"); t_on_failure("missed_call"); } if (!t_relay()) { send_reply("500","Internal Error"); } exit; } branch_route[per_branch_ops] { xlog("new branch at $ru\n"); } onreply_route[handle_nat] { xlog("incoming reply\n"); } failure_route[missed_call] { if (t_was_cancelled()) { exit; } if (!math_eval("$dlg_val(pdd_pen) + 10000", "$dlg_val(pdd_pen)")) { xlog("math eval error $rc\n"); } cache_add("local", "neg_replies", 1, 0); if (t_check_status("(5|6)[0-9][0-9]") || (t_check_status("408") && t_local_replied("all"))) { xlog("ERROR: FS GW error, status=$rs\n"); if (!lb_next()) { xlog("ERROR: all FS are down!\n"); send_reply("503", "No available destination"); exit; } } xlog("rerouting to $ru / $du\n"); t_on_reply("invite_reply"); t_on_failure("missed_call"); t_relay(); exit; # uncomment the following lines if you want to block client # redirect based on 3xx replies. ##if (t_check_status("3[0-9][0-9]")) { ##t_reply("404","Not found"); ## exit; ##} } timer_route [dump_pdd, 1] { $var(out) = 0; $var(out_us) = 0; $var(tot) = 0; $var(result) = 0; cache_counter_fetch("local", "tot_sec", $var(out)); cache_counter_fetch("local", "tot_usec", $var(out_us)); cache_counter_fetch("local", "tot", $var(tot)); cache_remove("local", "tot_sec"); cache_remove("local", "tot_usec"); cache_remove("local", "tot"); if ($var(tot) > 0) { if (!math_eval("($var(out) + ($var(out_us) / 1000000)) / $var(tot)", "$var(result)")) { xlog("math eval error $rc\n"); } route(store_influxdb, "fsdemo", "pdd", "serverB", $var(result)); } } #route [lb_route] #{ # xlog("foo: $(avp(lb_loads)[*])\n"); # route(store_influxdb, "fsdemo", "bal", "serverA", $(avp(lb_loads)[0])); # if ($(avp(lb_loads)[1]) != NULL) { # route(store_influxdb, "fsdemo", "bal", "serverB", $(avp(lb_loads)[1])); # } #} route [store_influxdb] { $var(body) = $param(2) + ",host=" + $param(3) + " value=" + $param(4); xlog("XXX posting: $var(body) ($param(1) / $param(2) / $param(4))\n"); if (!rest_post("http://localhost:8086/write?db=$param(1)", "$var(body)", , "$var(body)")) { xlog("ERR in rest_post!\n"); exit; } } timer_route [dump_reply_stats, 1] { $var(nr) = 0; cache_counter_fetch("local", "neg_replies", $var(nr)); cache_remove("local", "neg_replies"); route(store_influxdb, "fsdemo", "neg", "serverB", $var(nr)); route(store_influxdb, "fsdemo", "rpl", "serverB", $stat(rcv_replies)); xlog("XXX stats: $var(nr)\n"); }</p></div><footer class=entry-footer><span title='2019-07-02 22:34:43 +0800 CST'>2019-07-02 22:34:43</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to cluecon-fslb" href=https://wdd.js.org/opensips/ch8/fs-loadbalance/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>freeswitch-dtmf-language</h2></header><div class=entry-content><p># # OpenSIPS residential configuration script # by OpenSIPS Solutions &lt;team@opensips-solutions.com> # # This script was generated via "make menuconfig", from # the "Residential" scenario. # You can enable / disable more features / functionalities by # re-generating the scenario with different options.# # # Please refer to the Core CookBook at: # http://www.opensips.org/Resources/DocsCookbooks # for a explanation of possible statements, functions and parameters. # ####### Global Parameters ######### log_level=4 log_stderror=no log_facility=LOG_LOCAL0 children=4 /* uncomment the following lines to enable debugging */ #debug_mode=yes /* uncomment the next line to enable the auto temporary blacklisting of not available destinations (default disabled) */ #disable_dns_blacklist=no /* uncomment the next line to enable IPv6 lookup after IPv4 dns lookup failures (default disabled) */ #dns_try_ipv6=yes /* comment the next line to enable the auto discovery of local aliases based on revers DNS on IPs */ auto_aliases=no listen = udp:10.0.0.10:5060 ####### Modules Section ######## #set module path mpath="/usr/local/lib/opensips/modules/" #### SIGNALING module loadmodule "signaling.so" #### StateLess module loadmodule "sl.so" #### Transaction Module loadmodule "tm.so" modparam("tm", "fr_timeout", 5) modparam("tm", "fr_inv_timeout", 30) modparam("tm", "restart_fr_on_each_reply", 0) modparam("tm", "onreply_avp_mode", 1) #### Record Route Module loadmodule "rr.so" /* do not append from tag to the RR (no need for this script) */ modparam("rr", "append_fromtag", 0) #### MAX ForWarD module loadmodule "maxfwd.so" #### SIP MSG OPerationS module loadmodule "sipmsgops.so" #### FIFO Management Interface loadmodule "mi_fifo.so" modparam("mi_fifo", "fifo_name", "/tmp/opensips_fifo") modparam("mi_fifo", "fifo_mode", 0666) #### URI module loadmodule "uri.so" modparam("uri", "use_uri_table", 0) #### USeR LOCation module loadmodule "usrloc.so" modparam("usrloc", "nat_bflag", "NAT") modparam("usrloc", "db_mode", 0) #### REGISTRAR module loadmodule "registrar.so" modparam("registrar", "tcp_persistent_flag", "TCP_PERSISTENT") /* uncomment the next line not to allow more than 10 contacts per AOR */ #modparam("registrar", "max_contacts", 10) #### ACCounting module loadmodule "acc.so" /* what special events should be accounted ? */ modparam("acc", "early_media", 0) modparam("acc", "report_cancels", 0) /* by default we do not adjust the direct of the sequential requests. if you enable this parameter, be sure the enable "append_fromtag" in "rr" module */ modparam("acc", "detect_direction", 0) loadmodule "cachedb_local.so" loadmodule "freeswitch.so" loadmodule "freeswitch_scripting.so" modparam("freeswitch_scripting", "fs_subscribe", "fs://:ClueCon@10.0.0.246:8021/database?DTMF,CHANNEL_STATE,CHANNEL_ANSWER,HEARTBEAT") loadmodule "db_mysql.so" loadmodule "cfgutils.so" loadmodule "drouting.so" modparam("drouting", "db_url", "mysql://root:liviusmysqlpassword@localhost/opensips") loadmodule "event_route.so" loadmodule "json.so" loadmodule "proto_udp.so" ####### Routing Logic ######## # main request routing logic # $param(1) - 1 if the R-URI IP:port should be rewritten route [goes_to_support] { if ($param(1) == 1) $var(flags) = ""; else $var(flags) = "C"; if (do_routing("0", "$var(flags)")) return(1); return(-1); } route [FREESWITCH_XFER_BY_DTMF_LANG] { # this call has already been transferred if (cache_fetch("local", "DTMF-$json(body/Unique-ID)", $var(_))) return; switch ($json(body/DTMF-Digit)) { case "1": xlog("transferring to English support line\n"); freeswitch_esl("bgapi uuid_transfer $json(body/Unique-ID) -aleg 1001", "$var(fs_box)", "$var(output)"); break; case "2": xlog("transferring to Spanish support line\n"); freeswitch_esl("bgapi uuid_transfer $json(body/Unique-ID) -aleg 1002", "$var(fs_box)", "$var(output)"); break; default: xlog("DEFAULT: transferring to English support line\n"); freeswitch_esl("bgapi uuid_transfer $json(body/Unique-ID) -aleg 1001", "$var(fs_box)", "$var(output)"); } xlog("ran FS uuid_transfer, output: $var(output)\n"); cache_store("local", "DTMF-$json(body/Unique-ID)", "OK", 600); } event_route [E_FREESWITCH] { fetch_event_params("$var(event_name);$var(fs_box);$var(event_body)"); xlog("FreeSWITCH event $var(event_name) from $var(fs_box), with $var(event_body)\n"); $json(body) := $var(event_body); if ($var(event_name) == "DTMF") { $rU = $json(body/Caller-Destination-Number); if (!$rU) { xlog("SCRIPT:DTMF:ERR: missing body/Caller-Destination-Number field!\n"); return; } if (route(goes_to_support, 0)) route(FREESWITCH_XFER_BY_DTMF_LANG); } } route { if (!mf_process_maxfwd_header("10")) { sl_send_reply("483","Too Many Hops"); exit; } if (has_totag()) { # handle hop-by-hop ACK (no routing required) if ( is_method("ACK") && t_check_trans() ) { t_relay(); exit; } # sequential request within a dialog should # take the path determined by record-routing if ( !loose_route() ) { # we do record-routing for all our traffic, so we should not # receive any sequential requests without Route hdr. sl_send_reply("404","Not here"); exit; } if (is_method("BYE")) { # do accounting even if the transaction fails do_accounting("log","failed"); } # route it out to whatever destination was set by loose_route() # in $du (destination URI). route(relay); exit; } # CANCEL processing if (is_method("CANCEL")) { if (t_check_trans()) t_relay(); exit; } t_check_trans(); if ( !(is_method("REGISTER") ) ) { if (is_myself("$fd")) { } else { # if caller is not local, then called number must be local if (!is_myself("$rd")) { send_reply("403","Rely forbidden"); exit; } } } # preloaded route checking if (loose_route()) { xlog("L_ERR", "Attempt to route with preloaded Route's [$fu/$tu/$ru/$ci]"); if (!is_method("ACK")) sl_send_reply("403","Preload Route denied"); exit; } # record routing if (!is_method("REGISTER|MESSAGE")) record_route(); # requests for my domain if (is_method("PUBLISH|SUBSCRIBE")) { sl_send_reply("503", "Service Unavailable"); exit; } if (is_method("REGISTER")) { if (!save("location")) sl_reply_error(); exit; } if (!is_method("INVITE")) { sl_send_reply("405", "Method Not Allowed"); exit; } do_accounting("log"); if (!is_myself("$rd")) { append_hf("P-hint: outbound\r\n"); route(relay); } if ($rU==NULL) { # request with no Username in RURI sl_send_reply("484","Address Incomplete"); exit; } # do lookup with method filtering if (!lookup("location","m")) { t_reply("404", "Not Found"); exit; } # when routing via usrloc, log the missed calls also do_accounting("log","missed"); route(relay); } route[relay] { # for INVITEs enable some additional helper routes if (is_method("INVITE")) { t_on_branch("per_branch_ops"); t_on_reply("handle_nat"); t_on_failure("missed_call"); } if (!t_relay()) { send_reply("500","Internal Error"); }; exit; } branch_route[per_branch_ops] { xlog("new branch at $ru\n"); } onreply_route[handle_nat] { xlog("incoming reply\n"); } failure_route[missed_call] { if (t_was_cancelled()) { exit; } # uncomment the following lines if you want to block client # redirect based on 3xx replies. ##if (t_check_status("3[0-9][0-9]")) { ##t_reply("404","Not found"); ## exit; ##} }</p></div><footer class=entry-footer><span title='2019-07-02 22:34:27 +0800 CST'>2019-07-02 22:34:27</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;Eddie Wang</footer><a class=entry-link aria-label="post link to freeswitch-dtmf-language" href=https://wdd.js.org/opensips/ch8/dtmf-lan/></a></article><footer class=page-footer><nav class=pagination><a class=prev href=https://wdd.js.org/opensips/page/12/>«&nbsp;Prev&nbsp;
</a><a class=next href=https://wdd.js.org/opensips/page/14/>Next&nbsp;&nbsp;»</a></nav></footer></main><footer class=footer><span>&copy; 2025 <a href=https://wdd.js.org/>洞香春</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>