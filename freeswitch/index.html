<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>FreeSWITCH之路 | 洞香春</title><meta name=keywords content><meta name=description content="VOIP"><meta name=author content="王端端"><link rel=canonical href=https://wdd.js.org/freeswitch/><meta name=google-site-verification content="G-SGW660ZWKM"><link crossorigin=anonymous href=/assets/css/stylesheet.min.ceab085cbbf58c0ec96f6d415d51b3b44e204edfd71a45b4fa2d4aac13f119d0.css integrity="sha256-zqsIXLv1jA7Jb21BXVGztE4gTt/XGkW0+i1KrBPxGdA=" rel="preload stylesheet" as=style><link crossorigin=anonymous herf=/font-awesome/css/font-awesome.min.css rel=stylesheet type=text/css><link rel=preload href=/cowboy.ico as=image><link rel=icon href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/cowboy.ico><link rel=apple-touch-icon href=https://wdd.js.org/cowboy.ico><link rel=mask-icon href=https://wdd.js.org/cowboy.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.105.0"><link rel=alternate type=application/rss+xml href=https://wdd.js.org/freeswitch/index.xml><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-SGW660ZWKM"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SGW660ZWKM",{anonymize_ip:!1})}</script><meta property="og:title" content="FreeSWITCH之路"><meta property="og:description" content="VOIP"><meta property="og:type" content="website"><meta property="og:url" content="https://wdd.js.org/freeswitch/"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="og:site_name" content="洞香春"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="FreeSWITCH之路"><meta name=twitter:description content="VOIP"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"FreeSWITCH之路","item":"https://wdd.js.org/freeswitch/"}]}</script></head><body class="list dark" id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org accesskey=h title="洞香春 (Alt + H)"><img src=/cowboy.ico alt=logo aria-label=logo height=35>洞香春</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span class=active>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/fe/ title=Frontend><span>Frontend</span></a></li><li><a href=https://wdd.js.org/golang/ title=Golang><span>Golang</span></a></li><li><a href=https://wdd.js.org/container/ title=k8s/docker><span>k8s/docker</span></a></li><li><a href=https://wdd.js.org/network/ title=Network><span>Network</span></a></li><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/shell/ title=Shell><span>Shell</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/categories/ title=分类><span>分类</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://wdd.js.org>Home</a></div><h1>FreeSWITCH之路</h1><div class=post-description>VOIP</div></header><div class=post-content><div class="notice note"><div class=notice-title><i class="fa fa-sticky-note" aria-hidden=true></i>Note</div><div class=notice-content>曲径通幽处，禅房花木深。</div></div></div><article class=post-entry><header class=entry-header><h2>WebRTC 人声检测与舒适噪音</h2></header><section class=entry-content><p>人声检测 VAD 人声检测(VAD: Voice Activity Detection)是区分语音中是人说话的声音，还是其他例如环境音的一种功能。
除此以外，人声检测还能用于减少网络中语音包传输的数据量，从而极大的降低语音的带宽，极限情况下能降低50%的带宽。
在一个通话中，一般都是只有一个人说话，另一人听。很少可能是两个人都说话的。
例如A在说话的时候，B可能在等待。
虽然B在等待过程中，B的语音流依然再按照原始速度和编码再发给A, 即使这里面是环境噪音或者是无声。
A ----> B # A在说话 A &lt;--- B # B在等待过程中，B的语音流依然再按照原始速度和编码再发给A 如果B具有VAD检测功能，那么B就可以在不说话的时候，发送特殊标记的语音流或者通过减少语音流发送的频率，来减少无意义语音的发送。
从而极大的降低B->A的语音流。
下图是Wireshark抓包的两种RTP包，g711编码的占214字节，但是用舒适噪音编码的只有63字节。将近减少了4倍的带宽。
舒适噪音生成器 CNG 舒适噪音(CN stands for Comfort Noise), 是一种模拟的背景环境音。舒适噪音生成器在接收端根据发送到给的参数，来产生类似接收端的舒适噪音, 用来模拟发送方的噪音环境。
CN也是一种RTP包的格式，定义在RFC 3389
舒适噪音的payload, 也被称作静音插入描述帧(SID: a Silence Insertion Descriptor frame), 包括一个字节的数据，用来描述噪音的级别。也可以包含其他的额外的数据。早期版本的舒适噪音的格式定义在RFC 1890中，这个版本的格式只包含一个字段，就是噪音级别。
噪音级别占用一个字节，其中第一个bit必须是0， 因此噪音级别有127中可能。
0 1 2 3 4 5 6 7 +-+-+-+-+-+-+-+-+ |0| level | +-+-+-+-+-+-+-+-+ 跟着噪音级别的后续字节都是声音的频谱信息。
Byte 1 2 3 ... M+1 +-----+-----+-----+-----+-----+ |level| N1 | N2 | ....</p></section><footer class=entry-footer><span title='2022-06-01 08:27:53 +0800 +0800'>2022-06-01 08:27:53</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;王端端</footer><a class=entry-link aria-label="post link to WebRTC 人声检测与舒适噪音" href=https://wdd.js.org/freeswitch/webrtc-vad-cng/></a></article><article class=post-entry><header class=entry-header><h2>安装bcg729模块</h2></header><section class=entry-content><p>g729编码的占用带宽是g711的1/8，使用g729编码，可以极大的降低带宽的费用。fs原生的mod_g927模块是需要按并发数收费的，但是我们可以使用开源的bcg729模块。
这里需要准备两个仓库，为了加快clone速度，我将这两个模块导入到gitee上。
https://gitee.com/wangduanduan/mod_bcg729 https://gitee.com/wangduanduan/bcg729 安装前提 已经安装好了freeswitch, 编译mod_bcg729模块，需要指定freeswitch头文件的位置
step0: 切换到工作目录 cd /usr/local/src/ step1: clone mod_bcg729 git clone https://gitee.com/wangduanduan/mod_bcg729.git step2: clone bcg729 mod_bcg729模块在编辑的时候，会检查当前目录下有没有bcg729的目录。 如果没有这个目录，就会从github上clone bcg729的项目。 所以我们可以在编译之前，先把bcg729 clone到mob_bcg729目录下
cd mod_bcg729 git clone https://gitee.com/wangduanduan/bcg729.git step3: 编辑mod_bcg729 编译mod_bcg729需要指定fs头文件switch.h的位置。 在Makefile项目里有FS_INCLUDES这个变量用来定义fs头文件的位置
FS_INCLUDES=/usr/include/freeswitch FS_MODULES=/usr/lib/freeswitch/mod 如果你的源码头文件路径不是/usr/include/freeswitch， 则需要在执行make命令时通过参数指定， 例如下面编译的时候。
make FS_INCLUDES=/usr/local/freeswitch/include/freeswitch Tip 如何找到头文件的目录？ 头文件一般在fs安装目录的include/freeswitch目录下 如果还是找不到，则可以使用 find /usr -name switch.h -type f 搜索对应的头文件 step4: 复制so文件 mod_bcg729编译之后，可以把生成的mod_bcg729.so拷贝到fs安装目录的mod目录下
step5: 加载模块 命令行加载
load mod_bcg729 配置文件加载 命令行加载重启后就失效了，可以将加载的模块写入到配置文件中。 在modules.conf.xml中加入
&lt;load module="mod_bcg729"/> step5: vars.xml修改 &lt;X-PRE-PROCESS cmd="set" data="global_codec_prefs=PCMU,PCMA,G729" /> &lt;X-PRE-PROCESS cmd="set" data="outbound_codec_prefs=PCMU,PCMA,G729"/> &lt;X-PRE-PROCESScmd="set"data="media_mix_inbound_outbound_codecs=true"/> step6: sip profile修改 开启转码...</p></section><footer class=entry-footer><span title='2022-05-28 17:34:13 +0800 +0800'>2022-05-28 17:34:13</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;王端端</footer><a class=entry-link aria-label="post link to 安装bcg729模块" href=https://wdd.js.org/freeswitch/install-bcg729/></a></article><article class=post-entry><header class=entry-header><h2>会议提示音无法正常播放</h2></header><section class=entry-content><p>呼入到会议，正常来说，当会议室有且只有一人时，应该会报“当前只有一人的提示音”。但是测试的时候，输入了密码，进入了会议，却没有播报正常的提示音。
经过排查发现，dialplan中，会议室的名字中含有@符号。
按照fs的文档，发现@后面应该是profilename, 然而fs的conference.conf.xml却没有这个profile, 进而导致语音无法播报的问题。所以只要加入这个profile, 或者直接用@default, 就可以正确的播报语音了。
Action data Description confname profile is “default”, no flags or pin confname+1234 profile is “default”, pin is 1234 confname@profilename+1234 profile is “profilename”, pin=1234, no flags confname+1234+flags{mute} profile is “default”, pin=1234, one flag confname++flags{endconf|moderator} profile is “default”, no p.i.n., multiple flags bridge:confname:1000@${domain_name} a “bridging” conference, you must provide another endpoint, or ’none'. bridge:uuid:none a “bridging” conference with UUID assigned as conference name 所以，当你遇到问题的时候，应该仔细的再去阅读一下官方的接口文档。
参考文档...</p></section><footer class=entry-footer><span title='2022-05-28 17:17:54 +0800 +0800'>2022-05-28 17:17:54</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;王端端</footer><a class=entry-link aria-label="post link to 会议提示音无法正常播放" href=https://wdd.js.org/freeswitch/conference-announce/></a></article><article class=post-entry><header class=entry-header><h2>FS日志设置</h2></header><section class=entry-content><p>开启sip信令的日志 这样会让fs把收发的sip信令打印到fs_cli里面，但不是日志文件里面
sofia global siptrace on # sofia global siptrace off 关闭 开启sofia模块的日志 sofia 模块的日志即使开启，也是输出到fs_cli里面的，不会输出到日志文件里面
sofia loglevel all 7 # sofia loglevel &lt;all|default|tport|iptsec|nea|nta|nth_client|nth_server|nua|soa|sresolv|stun> [0-9] 将fs_cli的输出，写到日志文件里 sofia tracelevel 会将某些日志重定向到日志文件里 sofia tracelevel debug # sofia tracelevel &lt;console|alert|crit|err|warning|notice|info|debug> 注意，debug级别的日志非常多，仅仅适用于debug
大量的日志写入磁盘
占用太多的io 磁盘空间可能很快占满</p></section><footer class=entry-footer><span title='2022-05-28 17:14:05 +0800 +0800'>2022-05-28 17:14:05</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;王端端</footer><a class=entry-link aria-label="post link to FS日志设置" href=https://wdd.js.org/freeswitch/log-settings/></a></article><article class=post-entry><header class=entry-header><h2>Sofia 模块全部配置</h2></header><section class=entry-content><p>About Sofia is a FreeSWITCH™ module (mod_sofia) that provides SIP connectivity to and from FreeSWITCH in the form of a User Agent. A “User Agent” (“UA”) is an application used for handling a certain network protocol; the network protocol in Sofia’s case is SIP. Sofia is the general name of any User Agent in FreeSWITCH using the SIP network protocol. For example, Sofia receives calls sent to FreeSWITCH from other SIP User Agents (UAs), sends calls to other UAs, acts as a client to register FreeSWITCH with other UAs, lets clients register with FreeSWITCH, and connects calls (i....</p></section><footer class=entry-footer><span title='2022-05-28 14:57:59 +0800 +0800'>2022-05-28 14:57:59</span>&nbsp;·&nbsp;32 min&nbsp;·&nbsp;王端端</footer><a class=entry-link aria-label="post link to Sofia 模块全部配置" href=https://wdd.js.org/freeswitch/sofia-config/></a></article><article class=post-entry><header class=entry-header><h2>FS常用运维手册</h2></header><section class=entry-content><p>安装单个模块 make mod_sofia-install make mod_ilbc-install fs-cli事件订阅 /event plain ALL /event plain CHANNEL_ANSWER sofia 帮助文档 sofia help USAGE: -------------------------------------------------------------------------------- sofia global siptrace &lt;on|off> sofia capture &lt;on|off> watchdog &lt;on|off> sofia profile &lt;name> [start | stop | restart | rescan] [wait] flush_inbound_reg [&lt;call_id> | &lt;[user]@domain>] [reboot] check_sync [&lt;call_id> | &lt;[user]@domain>] [register | unregister] [&lt;gateway name> | all] killgw &lt;gateway name> [stun-auto-disable | stun-enabled] [true | false]] siptrace &lt;on|off> capture &lt;on|off> watchdog &lt;on|off> sofia &lt;status|xmlstatus> profile &lt;name> [reg [&lt;contact str>]] | [pres &lt;pres str>] | [user &lt;user@domain>] sofia &lt;status|xmlstatus> gateway &lt;name> sofia loglevel &lt;all|default|tport|iptsec|nea|nta|nth_client|nth_server|nua|soa|sresolv|stun> [0-9] sofia tracelevel &lt;console|alert|crit|err|warning|notice|info|debug> sofia help -------------------------------------------------------------------------------- 开启消息头压缩 &lt;param name="enable-compact-headers" value="true"/> fs需要重启...</p></section><footer class=entry-footer><span title='2022-05-28 14:54:40 +0800 +0800'>2022-05-28 14:54:40</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;王端端</footer><a class=entry-link aria-label="post link to FS常用运维手册" href=https://wdd.js.org/freeswitch/tips/></a></article><article class=post-entry><header class=entry-header><h2>FreeSWITCH 媒体相关操作</h2></header><section class=entry-content><p>查看FS支持的编码 show codec 编码设置 vars.xml
global_codec_prefs=G722,PCMU,PCMA,GSM outbound_codec_prefs=PCMU,PCMA,GSM 查看FS使用的编码 > sofia status profile internal CODECS IN ILBC,PCMU,PCMA,GSM CODECS OUT ILBC,PCMU,PCMA,GSM > sofia status profile external CODECS IN ILBC,PCMU,PCMA,GSM CODECS OUT ILBC,PCMU,PCMA,GSM 使修改后的profile生效 > sofia profile internal rescan > sofia profile external rescan 重启profile > sofia profile internal restart > sofia profile external restart</p></section><footer class=entry-footer><span title='2022-05-28 14:50:55 +0800 +0800'>2022-05-28 14:50:55</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;王端端</footer><a class=entry-link aria-label="post link to FreeSWITCH 媒体相关操作" href=https://wdd.js.org/freeswitch/media-settings/></a></article></main><footer class=footer><span>&copy; 2022 <a href=https://wdd.js.org>洞香春</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>