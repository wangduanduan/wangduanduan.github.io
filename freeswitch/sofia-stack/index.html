<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Sofia SIP Stack | 洞香春</title>
<meta name=keywords content><meta name=description content="Sofia is a SIP stack used by FreeSWITCH. When you see &ldquo;sofia&rdquo; anywhere in your configuration, think &ldquo;This is SIP stuff.&rdquo; It takes a while to master it all, so please be patient with yourself. SIP is a crazy protocol and it will make you crazy too if you aren&rsquo;t careful. Read on for information on setting up SIP/Sofia in your FreeSWITCH configuration.
mod_sofia exposes the Sofia API and sets up the FreeSWITCH SIP endpoint."><meta name=author content="Eddie Wang"><link rel=canonical href=https://wdd.js.org/freeswitch/sofia-stack/><link crossorigin=anonymous href=/assets/css/stylesheet.6d3944e058d85363bbe8a792a9b5f40002bca80be859dc19c466dd8de223973e.css integrity="sha256-bTlE4FjYU2O76KeSqbX0AAK8qAvoWdwZxGbdjeIjlz4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/cowboy.ico><link rel=apple-touch-icon href=https://wdd.js.org/cowboy.ico><link rel=mask-icon href=https://wdd.js.org/cowboy.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Sofia SIP Stack"><meta property="og:description" content="Sofia is a SIP stack used by FreeSWITCH. When you see &ldquo;sofia&rdquo; anywhere in your configuration, think &ldquo;This is SIP stuff.&rdquo; It takes a while to master it all, so please be patient with yourself. SIP is a crazy protocol and it will make you crazy too if you aren&rsquo;t careful. Read on for information on setting up SIP/Sofia in your FreeSWITCH configuration.
mod_sofia exposes the Sofia API and sets up the FreeSWITCH SIP endpoint."><meta property="og:type" content="article"><meta property="og:url" content="https://wdd.js.org/freeswitch/sofia-stack/"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="freeswitch"><meta property="article:published_time" content="2019-12-10T11:27:17+08:00"><meta property="article:modified_time" content="2019-12-10T11:27:17+08:00"><meta property="og:site_name" content="洞香春"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Sofia SIP Stack"><meta name=twitter:description content="Sofia is a SIP stack used by FreeSWITCH. When you see &ldquo;sofia&rdquo; anywhere in your configuration, think &ldquo;This is SIP stuff.&rdquo; It takes a while to master it all, so please be patient with yourself. SIP is a crazy protocol and it will make you crazy too if you aren&rsquo;t careful. Read on for information on setting up SIP/Sofia in your FreeSWITCH configuration.
mod_sofia exposes the Sofia API and sets up the FreeSWITCH SIP endpoint."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"FreeSWITCH之路","item":"https://wdd.js.org/freeswitch/"},{"@type":"ListItem","position":3,"name":"Sofia SIP Stack","item":"https://wdd.js.org/freeswitch/sofia-stack/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Sofia SIP Stack","name":"Sofia SIP Stack","description":"Sofia is a SIP stack used by FreeSWITCH. When you see \u0026ldquo;sofia\u0026rdquo; anywhere in your configuration, think \u0026ldquo;This is SIP stuff.\u0026rdquo; It takes a while to master it all, so please be patient with yourself. SIP is a crazy protocol and it will make you crazy too if you aren\u0026rsquo;t careful. Read on for information on setting up SIP/Sofia in your FreeSWITCH configuration.\nmod_sofia exposes the Sofia API and sets up the FreeSWITCH SIP endpoint.","keywords":[],"articleBody":"Sofia is a SIP stack used by FreeSWITCH. When you see “sofia” anywhere in your configuration, think “This is SIP stuff.” It takes a while to master it all, so please be patient with yourself. SIP is a crazy protocol and it will make you crazy too if you aren’t careful. Read on for information on setting up SIP/Sofia in your FreeSWITCH configuration.\nmod_sofia exposes the Sofia API and sets up the FreeSWITCH SIP endpoint. Endpoint A FreeSWITCH endpoint represents a full user agent and controls the signaling protocol and media streaming necessary to process calls. The endpoint is analogous to a physical VoIP telephone sitting on your desk. It speaks a particular protocol such as SIP or Verto, to the outside world and interprets that for the FreeSWITCH core. Configuration Files sofia.conf.xml contains the configuration settings for mod_sofiaSee Sofia Configuration Files. SIP profiles See SIP profiles section in Configuring FreeSWITCH. What if these commands don’t work for me? Make sure that you are not running another SIP server at the same time as FreeSWITCH. It is not always obvious that another SIP server is running. If you type in Sofia commands such as ‘sofia status profile default’ and it doesn’t work then you may have another SIP server running. Stop the other SIP server and restart FreeSWITCH.On Linux, you may wish to try, as a superuser (often “root”):netstat -lunp | less# -l show listeners, -u show only UDP sockets,# -n numeric output (do not translate addresses or UDP port numbers)# -p show process information (PID, command). Only the superuser is allowed to see this infoWith the less search facility (usually the keystroke “/”), look for :5060 which is the usual SIP port.To narrow the focus, you can use grep. In the example configs, port 5060 is the “internal” profile. Try this:netstat -lnp | grep 5060See if something other than FreeSWITCH is using port 5060. Sofia Recover sofia recoverYou can ask Sofia to recover calls that were up, after crashing (or other scenarios).Sofia recover can also be used, if your core db uses ODBC to achieve HA / failover.For FreeSWITCH HA configuration, see Freeswitch HA. Flushing and rebooting registered endpoints You can flush a registration or reboot specific registered endpoint by issuing a flush_inbound_reg command from the console.freeswitch\u003e sofia profile flush_inbound_reg [|user@host] [reboot]If you leave out and/or user@host, you will flush/reboot every registered endpoint on a profile.\nNote: For polycom phone, the command causes the phone to check its configuration from the server. If the file is different (you may add extra space at the end of file), the phone will reboot. You should not change the value of voIpProt.SIP.specialEvent.checkSync.alwaysReboot=“0” to “1” in sip.cfg as that allows potential a DOS attack on the phone. You can also use the check_sync command:sofia profile check_sync | user@domain\nNote: The polycom phones do not reload -directory.xml configuration in response to either of these commands, they only reload the configuration. If you want new speed dials to take effect, you’ll need to do a full reboot of the phone or enable the alwaysReboot option. (Suggestions from anyone with more detailed PolyCom knowledge would be appreciated here.) Starting a new profile If you have created a new profile you need to start it from the console:freeswitch\u003e sofia profile start Reloading profiles and gateways You can reload a specific SIP profile by issuing a rescan/restart command from the consolefreeswitch\u003e sofia profile [|] reloadxmlThe difference between rescan and restart is that rescan will just load new config and not stop FreeSWITCH from processing any more calls on a profile.** Some config options like IP address and (UDP) port are not reloaded with rescan.** Deleting gateways You can delete a specific gateway by issuing a killgw command from the console. If you use all as gateway name, all gateways will be killedfreeswitch\u003e sofia profile killgw Restarting gateways You can force a gateway to restart ( good for forcing a re-registration or similar ) by issuing a killgw command from the console followed by a profile rescan. This is safe to perform on a profile that has active calls.freeswitch\u003e sofia profile killgw freeswitch\u003e sofia profile rescan Adding / Changing Existing Gateways It will be assumed that you have all your gateways in the /usr/local/freeswitch/conf/sip_profiles/external directory and that you have just created a new entry. You can add a new gateway to FreeSWITCH by issuing a rescan reloadxml command from the console as seen in the example below. This will load the newly created gateway and not affect any calls that are currently up.freeswitch\u003e sofia profile external rescan reloadxml\nYou now realize that you have screwed up the IP address in the new gateway and need to change it. So you edit your gateway file and make any changes that you want. You will then need to issue the following commands to destroy the gateway, and then have FreeSWITCH reload the changes with affecting any existing calls that are currently up.\nfreeswitch\u003e sofia profile external killgw freeswitch\u003e sofia profile external rescan reloadxml View SIP Registrations You can view all the devices that have registered by running the following from the console.freeswitch\u003e sofia status profile regfreeswitch\u003e sofia status profile default regfreeswitch\u003e sofia status profile outbound regYou can also use the xmlstatus key to retrieve statuses in XML format. This is specially useful if you are using mod_xml_rpc.Commands are as follows:freeswitch\u003e sofia xmlstatus profile regfreeswitch\u003e sofia xmlstatus profile default regfreeswitch\u003e sofia xmlstatus profile outbound reg List the status of gateways For the gateways that are in-service:freeswitch\u003e sofia profile gwlist upFor the gateways that are out-of-service:freeswitch\u003e sofia profile gwlist downNotes:\nIt should be used together with . See Sofia_Configuration_Files It can also be used to feed into mod distributor to exclude dead gateways. List gateway data To retrieve the value of an inbound variable:sofia_gateway_data ivar To retrieve the value of an outbound variable:sofia_gateway_data ovar To retrieve the value of either use:sofia_gateway_data var This first checks for an inbound variable, then checks for an outbound variable if there’s no matching inbound. View User Presence Data Displays presence data from registered devices as seen by the serverUsage:sofia_presence_data [list|status|rpid|user_agent] [profile/]@domainsofia_presence_data list */2005status|rpid|user_agent|network_ip|network_portAway|away|Bria 3 release 3.5.1 stamp 69738|192.168.20.150|21368+OK\nIts possible to retrieve only one valuesofia_presence_data status */2005Away\nYou can use this value in the dialplan, e.g. Debugging Sofia-SIP The Sofia-SIP components can output various debugging information. The detail of the debugging output is determined by the debugging level. The level is usually module-specific and it can be modified by module-specific environment variable. There is also a default level for all modules, controlled by environment variable #SOFIA_DEBUG.The environment variables controlling the logging and other debug output are as follows:- #SOFIA_DEBUG Default debug level (0..9)- #NUA_DEBUG User Agent engine (nua) debug level (0..9)- #SOA_DEBUG SDP Offer/Answer engine (soa) debug level (0..9)- #NEA_DEBUG Event engine (nea) debug level (0..9)- #IPTSEC_DEBUG HTTP/SIP authentication module debug level (0..9)- #NTA_DEBUG Transaction engine debug level (0..9)- #TPORT_DEBUG Transport event debug level (0..9)- #TPORT_LOG If set, print out all parsed SIP messages on transport layer- #TPORT_DUMP Filename for dumping unparsed messages from transport- #SU_DEBUG su module debug level (0..9)The defined debug output levels are:- 0 SU_DEBUG_0() - fatal errors, panic- 1 SU_DEBUG_1() - critical errors, minimal progress at subsystem level- 2 SU_DEBUG_2() - non-critical errors- 3 SU_DEBUG_3() - warnings, progress messages- 5 SU_DEBUG_5() - signaling protocol actions (incoming packets, …)- 7 SU_DEBUG_7() - media protocol actions (incoming packets, …)- 9 SU_DEBUG_9() - entering/exiting functions, very verbatim progressStarting with 1.0.4, those parameters can be controlled from the console by doingfreeswitch\u003e sofia loglevel [0-9]“all” Will change every component’s loglevelA log level of 0 turns off debugging, to turn them all off, you can dofreeswitch\u003e sofia loglevel all 0To report a bug, you can turn on debugging with more verbosesofia global siptrace onsofia loglevel all 9sofia tracelevel alertconsole loglevel debugfsctl debug_level 10 Debugging presence and SLA As of Jan 14, 2011, sofia supports a new debugging command: sofia global debug. It can turn on debugging for SLA, presence, or both. Usage is:sofia global debug slasofia global debug presencesofia global debug noneThe first two enable debugging SLA and presence, respectively. The third one turns off SLA and/or presence debugging. Sample Export (Linux/Unix) Alternatively, the levels can also be read from environment variables. The following bash commands turn on all debugging levels, and is equivalent to “sofia loglevel all 9”export SOFIA_DEBUG=9export NUA_DEBUG=9export SOA_DEBUG=9export NEA_DEBUG=9export IPTSEC_DEBUG=9export NTA_DEBUG=9export TPORT_DEBUG=9export TPORT_LOG=9export TPORT_DUMP=/tmp/tport_sip.logexport SU_DEBUG=9To turn this debugging off again, you have to exit FreeSWITCH and type unset. For example:unset TPORT_LOG Sample Set (Windows) The following bash commands turn on all debugging levels.set SOFIA_DEBUG=9set NUA_DEBUG=9set SOA_DEBUG=9set NEA_DEBUG=9set IPTSEC_DEBUG=9set NTA_DEBUG=9set TPORT_DEBUG=9set TPORT_LOG=9set TPORT_DUMP=/tmp/tport_sip.logset SU_DEBUG=9To turn this debugging off again, you have to exit FreeSWITCH and type unset. For example:set TPORT_LOG=You can also control SIP Debug output within fs_cli, the FreeSWITCH client app.freeswitch\u003e sofia profile siptrace on|offOn newer software release, you can now be able to issue siptrace for all profiles:sofia global siptrace [on|off]\nTo have the SIP Debug details put in the /usr/local/freeswitch/log/freeswitch.log file, usefreeswitch\u003e sofia tracelevel info (or any other loglevel name or number)To have the SIP details put into the log file automatically on startup, add this to sofia.conf.xml:……\nand the following to the sip profile xml file:…………\nProfile Configurations Track Call ACL You can restrict access by IP address for either REGISTERs or INVITEs (or both) by using the following options in the sofia profile.See ACL for other access controlsSee acl.conf.xml for list configuration Disabling Hold Disable all calls on this profile from putting the call on hold:\nSee also: rtp_disable_hold variable Using A Single Domain For All Registrations You can force all registrations in a particular profile to use a single domain. In other words, you can ignore the domain in the SIP message. You will need to modify several sofia profile settings. challenge realm auto_from - uses the from field as the value for the SIP realm. auto_to - uses the to field as the value for the SIP realm. - you can input any value to use for the SIP realm. force-register-domain Preference Weight Transport Port Address================================================================================1 0.500 udp 5060 74.51.38.151 0.500 tcp 5060 74.51.38.15 Flushing Inbound Registrations From time to time, you may need to kill a registration.You can kill a registration from the CLI, or anywhere that accepts API commands with a command similar to the following:sofia profile flush_inbound_reg [optional_callid] Dial out of a gateway Basic form:sofia/gateway//Example 1:sofia/gateway/asterlink/18005551212gateway: is a keyword and not a “gateway” name. It has special meaning and tells the stack which credentials to use when challenged for the call. is the actual name of the gateway through which you want to send the call\nYour available gateways (usually configured in conf/sip_profiles/external/*.xml) will show up in sofia status:freeswitch#\u003e sofia status\nName Type Data State=================================================================================================default profile sip:mod_sofia@2.3.4.5:5060 RUNNING (2)mygateway gateway sip:username@1.2.3.4 NOREGphonebooth.example.com alias default ALIASED=================================================================================================1 profile 1 alias Modifying the To: header You can override the To: header by appending ^.Example 1:sofia/foo/user%192.168.1.1^101@$${domain}\nSpecifying SIP Proxy With fs_path You can route a call through a specific SIP proxy by using the “fs_path” directive. Example:sofia/foo/user@that.domain;fs_path=sip:proxy.this.domain Safe SIP URI Formatting As of commit https://freeswitch.org/stash/projects/FS/repos/freeswitch/commits/76370f4d1767bb0dcf828a3d6cde6e015b2cfa03 the User part of the SIP URI has been “safely” encoded in the case where spaces or other special characters appear.\nChannel Variables Adding Request Headers You can add arbitrary headers to outbound SIP calls by prefixing the string ‘sip_h_’ to any channel variable, for example:Note that for BYE requests, you will need to use the prefix ‘sip_bye_h_’ on the channel variable.\nWhile not required, you should prefix your headers with “X-” to avoid issues with interoperability with other SIP stacks.All inbound SIP calls will install any X- headers into local variables.This means you can easily bridge any X- header from one FreeSWITCH instance to another.To access the header above on a 2nd box, use the channel variable ${sip_h_X-Answer}It is important to note that the syntax ${sip_h_custom-header} can’t be used to retrieve any custom header not starting with X-.It is because Sofia only reads and puts into variables custom headers starting with X-.\nAdding Response Headers There are three types of response header prefixes that can be set:\nResponse headersip_rh_ Provisional response headersip_ph_ Bye response headersip_bye_h_ Each prefix will exclusively add headers for their given types of requests - there is no “global” response header prefix that will add a header to all response messages.For example:\nAdding Custom Headers For instance, you may need P-Charge-Info to append to your INVITE header, you may do as follows:Then, you would see it in SIP message:INVITE sip:19099099099@1.2.3.4 SIP/2.0Via: SIP/2.0/UDP 5.6.7.8:5080;rport;branch=z9hG4bKyg61X9v3gUD4gMax-Forwards: 69From: “DJB” sip:2132132132@5.6.7.8;tag=XQKQ322vQF5gKTo: sip:19099099099@1.2.3.4Call-ID: b6c776f6-47ed-1230-0085-000f1f659e58CSeq: 30776798 INVITEContact: sip:mod_sofia@5.6.7.8:5080User-Agent: FreeSWITCH-mod_sofia/1.2.0-rc2+git~20120713T162602Z~0afd7318bd+unclean~20120713T184029ZAllow: INVITE, ACK, BYE, CANCEL, OPTIONS, MESSAGE, UPDATE, INFO, REGISTER, REFER, NOTIFYSupported: timer, precondition, path, replacesAllow-Events: talk, hold, conference, referContent-Type: application/sdpContent-Disposition: sessionContent-Length: 229P-Charge-Info: sip:2132132132@5.6.7.8;npi=0;noa=3X-FS-Support: update_display,send_info.Remote-Party-ID: “DJB” sip:2132132132@5.6.7.8;party=calling;screen=yes;privacy=off Strip Individual SIP Headers Sometimes a SIP provider will add extra header information. Most of the time they do that for their own use (tracking calls). But that extra information can cause a lot of problems. For example: I get a call from the PSTN via a DID provider (provider1). Since im not in the office the call gets bridged to my cell phone (provider2). Provider1 add’s extra information to the sip packet like displayed below:X-voipnow-did: 01234567890X-voipnow-extension: 987654321…In some scenario, we bridge this call directly to provider2 the calls get dropped since provider2 doesnt accept the X-voipnow header, so we have to strip off those SIP headers.To strip them off, use the application UNSET in the dialplan (the inverse of SET):… Strip All custom SIP Headers If you wish to strip all custom headers while keeping only those defined in dialplan:… Additional Channel variables Additional variables may also be set to influence the way calls are handled by sofia.For example, contacts can be filtered by setting the ‘sip_exclude_contact’ variable. Example:Or you can perform SIP Digest authorization on outgoing calls by setting sip_auth_username and sip_auth_password variables to avoid using Gateways to authenticate. Example:Changing the SIP Contact user FreeSWITCH normally uses mod_sofia@ip:port for the internal SIP contact. To change this to foo@ip:port, there is a variable, sip_contact_user:{sip_contact_user=foo}sofia/my_profile/1234@192.168.0.1;transport=tcp sip_renegotiate_codec_on_reinvite true|false sip_recovery_break_rfc true|false Transcoding Issues G729 and G723 will not let you transcode because of licensing issues. Calls will fail if for example originating endpoint has set G729 with higher priority and receiving endpoint has G723 with highest priority. The logic is to fail the call rather than attempt to find a codec match. If you are having issues due to transcoding you may disable transcoding and both endpoints will negotiate the compatible codec rather than just fail the call.disable-transcoding will take the preferred codec from the inbound leg of your call and only offer that codec on the outbound leg.Add the following command along with to your sofia profile\nExample:\nCustom Events The following are events that can be subscribed to via Event Socket\nRegistration sofia::register* sofia::pre_register* sofia::register_attempt* sofia::register_failure* sofia::unregister - explicit unregister calls* sofia::expire - when a user registration expires Gateways sofia::gateway_add* sofia::gateway_delete* sofia::gateway_state - when a gateway is detected as down or back up Call recovery sofia::recovery_send* sofia::recovery_recv* sofia::recovery_recovered Other sofia::notify_refer* sofia::reinvite* sofia::error FAQ Does it use UDP or TCP? By default it uses both, but you can add ;transport=tcp to the Sofia URL to force it to use TCP.For example:sofia/profile/foo@bar.com;transport=tcpAlso there is a parameter in the gateway config:That will cause it to use the TCP transport for the registration and all subsequent SIP messages.Not sure if this is needed or what it does, but the following can also be used in gateway settings:\n","wordCount":"2575","inLanguage":"en","datePublished":"2019-12-10T11:27:17+08:00","dateModified":"2019-12-10T11:27:17+08:00","author":{"@type":"Person","name":"Eddie Wang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wdd.js.org/freeswitch/sofia-stack/"},"publisher":{"@type":"Organization","name":"洞香春","logo":{"@type":"ImageObject","url":"https://wdd.js.org/cowboy.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org accesskey=h title="洞香春 (Alt + H)"><img src=https://wdd.js.org/cowboy.ico alt aria-label=logo height=35>洞香春</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/fe/ title=Frontend><span>Frontend</span></a></li><li><a href=https://wdd.js.org/golang/ title=Golang><span>Golang</span></a></li><li><a href=https://wdd.js.org/container/ title=k8s/docker><span>k8s/docker</span></a></li><li><a href=https://wdd.js.org/network/ title=Network><span>Network</span></a></li><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/shell/ title=Shell><span>Shell</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/categories/ title=分类><span>分类</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wdd.js.org>Home</a>&nbsp;»&nbsp;<a href=https://wdd.js.org/freeswitch/>FreeSWITCH之路</a></div><h1 class=post-title>Sofia SIP Stack</h1><div class=post-meta>&lt;span title='2019-12-10 11:27:17 +0800 CST'>2019-12-10 11:27:17&lt;/span>&amp;nbsp;·&amp;nbsp;13 min&amp;nbsp;·&amp;nbsp;Eddie Wang&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/freeswitch/sofia-stack/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#endpoint aria-label=Endpoint><strong>Endpoint</strong></a></li><li><a href=#configuration-files aria-label="Configuration Files"><strong>Configuration Files</strong></a></li><li><a href=#sip-profiles aria-label="SIP profiles"><strong>SIP profiles</strong></a></li><li><a href=#what-if-these-commands-dont-work-for-me aria-label="What if these commands don&amp;rsquo;t work for me?"><strong>What if these commands don&rsquo;t work for me?</strong></a></li><li><a href=#sofia-recover aria-label="Sofia Recover"><strong>Sofia Recover</strong></a></li><li><a href=#flushing-and-rebooting-registered-endpoints aria-label="Flushing and rebooting registered endpoints"><strong>Flushing and rebooting registered endpoints</strong></a></li><li><a href=#starting-a-new-profile aria-label="Starting a new profile"><strong>Starting a new profile</strong></a></li><li><a href=#reloading-profiles-and-gateways aria-label="Reloading profiles and gateways"><strong>Reloading profiles and gateways</strong></a></li><li><a href=#deleting-gateways aria-label="Deleting gateways"><strong>Deleting gateways</strong></a></li><li><a href=#restarting-gateways aria-label="Restarting gateways"><strong>Restarting gateways</strong></a></li><li><a href=#adding--changing-existing-gateways aria-label="Adding / Changing Existing Gateways"><strong>Adding / Changing Existing Gateways</strong></a></li><li><a href=#view-sip-registrations aria-label="View SIP Registrations"><strong>View SIP Registrations</strong></a></li><li><a href=#list-the-status-of-gateways aria-label="List the status of gateways"><strong>List the status of gateways</strong></a></li><li><a href=#list-gateway-data aria-label="List gateway data"><strong>List gateway data</strong></a></li><li><a href=#view-user-presence-data aria-label="View User Presence Data"><strong>View User Presence Data</strong></a></li><li><a href=#debugging-sofia-sip aria-label="Debugging Sofia-SIP"><strong>Debugging Sofia-SIP</strong></a><ul><li><a href=#debugging-presence-and-sla aria-label="Debugging presence and SLA"><strong>Debugging presence and SLA</strong></a></li><li><a href=#sample-export-linuxunix aria-label="Sample Export (Linux/Unix)"><strong>Sample Export (Linux/Unix)</strong></a></li><li><a href=#sample-set-windows aria-label="Sample Set (Windows)"><strong>Sample Set (Windows)</strong></a></li></ul></li><li><a href=#profile-configurations aria-label="Profile Configurations"><strong>Profile Configurations</strong></a><ul><li><a href=#track-call aria-label="Track Call"><strong>Track Call</strong></a></li><li><a href=#acl aria-label=ACL><strong>ACL</strong></a></li><li><a href=#disabling-hold aria-label="Disabling Hold"><strong>Disabling Hold</strong></a></li><li><a href=#using-a-single-domain-for-all-registrations aria-label="Using A Single Domain For All Registrations"><strong>Using A Single Domain For All Registrations</strong></a><ul><li><a href=#challenge-realm aria-label="challenge realm"><strong>challenge realm</strong></a></li><li><a href=#force-register-domain aria-label=force-register-domain><strong>force-register-domain</strong></a></li></ul></li><li><a href=#flushing-inbound-registrations aria-label="Flushing Inbound Registrations"><strong>Flushing Inbound Registrations</strong></a></li><li><a href=#dial-out-of-a-gateway aria-label="Dial out of a gateway"><strong>Dial out of a gateway</strong></a></li><li><a href=#modifying-the-to-header aria-label="Modifying the To: header"><strong>Modifying the To: header</strong></a></li><li><a href=#specifying-sip-proxy-with-fs_path aria-label="Specifying SIP Proxy With fs_path"><strong>Specifying SIP Proxy With fs_path</strong></a></li><li><a href=#safe-sip-uri-formatting aria-label="Safe SIP URI Formatting"><strong>Safe SIP URI Formatting</strong></a></li></ul></li><li><a href=#channel-variables aria-label="Channel Variables"><strong>Channel Variables</strong></a><ul><li><a href=#adding-request-headers aria-label="Adding Request Headers"><strong>Adding Request Headers</strong></a></li><li><a href=#adding-response-headers aria-label="Adding Response Headers"><strong>Adding Response Headers</strong></a></li><li><a href=#adding-custom-headers aria-label="Adding Custom Headers"><strong>Adding Custom Headers</strong></a></li><li><a href=#strip-individual-sip-headers aria-label="Strip Individual SIP Headers"><strong>Strip Individual SIP Headers</strong></a></li><li><a href=#strip-all-custom-sip-headers aria-label="Strip All custom SIP Headers"><strong>Strip All custom SIP Headers</strong></a></li><li><a href=#additional-channel-variables aria-label="Additional Channel variables"><strong>Additional Channel variables</strong></a><ul><li><a href=#sip_renegotiate_codec_on_reinvite aria-label=sip_renegotiate_codec_on_reinvite><strong>sip_renegotiate_codec_on_reinvite</strong></a></li><li><a href=#sip_recovery_break_rfc aria-label=sip_recovery_break_rfc><strong>sip_recovery_break_rfc</strong></a></li></ul></li></ul></li><li><a href=#transcoding-issues aria-label="Transcoding Issues"><strong>Transcoding Issues</strong></a></li><li><a href=#custom-events aria-label="Custom Events"><strong>Custom Events</strong></a></li><li><a href=#faq aria-label=FAQ><strong>FAQ</strong></a><ul><li><a href=#does-it-use-udp-or-tcp aria-label="Does it use UDP or TCP?"><strong>Does it use UDP or TCP?</strong></a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>Sofia is a SIP stack used by FreeSWITCH. When you see &ldquo;sofia&rdquo; anywhere in your configuration, think &ldquo;This is SIP stuff.&rdquo; It takes a while to master it all, so please be patient with yourself. SIP is a crazy protocol and it will make you crazy too if you aren&rsquo;t careful. Read on for information on setting up SIP/Sofia in your FreeSWITCH configuration.</p><p>mod_sofia exposes the Sofia API and sets up the FreeSWITCH SIP endpoint.</p><h2 id=endpoint><strong>Endpoint</strong><a hidden class=anchor aria-hidden=true href=#endpoint>#</a></h2><p>A FreeSWITCH endpoint represents a full user agent and controls the signaling protocol and media streaming necessary to process calls. The endpoint is analogous to a physical VoIP telephone sitting on your desk. It speaks a particular protocol  such as SIP or Verto, to the outside world and interprets that for the FreeSWITCH core.</p><h2 id=configuration-files><strong>Configuration Files</strong><a hidden class=anchor aria-hidden=true href=#configuration-files>#</a></h2><p>sofia.conf.xml contains the configuration settings for mod_sofiaSee <a href="https://freeswitch.org/confluence/plugins/servlet/mobile?contentId=1048969#content/view/7144453">Sofia Configuration Files</a>.</p><h2 id=sip-profiles><strong>SIP profiles</strong><a hidden class=anchor aria-hidden=true href=#sip-profiles>#</a></h2><p>See <a href=https://freeswitch.org/confluence/display/FREESWITCH/Configuring+FreeSWITCH#ConfiguringFreeSWITCH-SIPProfilessip-profiles>SIP profiles</a> section in <a href="https://freeswitch.org/confluence/plugins/servlet/mobile?contentId=1048969#content/view/1048906">Configuring FreeSWITCH</a>. </p><h2 id=what-if-these-commands-dont-work-for-me><strong>What if these commands don&rsquo;t work for me?</strong><a hidden class=anchor aria-hidden=true href=#what-if-these-commands-dont-work-for-me>#</a></h2><p>Make sure that you are not running another SIP server at the same time as FreeSWITCH. It is not always obvious that another SIP server is running. If you type in Sofia commands such as &lsquo;sofia status profile default&rsquo; and it doesn&rsquo;t work then you may have another SIP server running. Stop the other SIP server and restart FreeSWITCH.On Linux, you may wish to try, as a superuser (often &ldquo;root&rdquo;):netstat -lunp | less# -l show listeners, -u show only UDP sockets,# -n numeric output (do not translate addresses or UDP port numbers)# -p show process information (PID, command). Only the superuser is allowed to see this infoWith the less search facility (usually the keystroke &ldquo;/&rdquo;), look for :5060 which is the usual SIP port.To narrow the focus, you can use grep. In the example configs, port 5060 is the &ldquo;internal&rdquo; profile. Try this:netstat -lnp | grep 5060See if something other than FreeSWITCH is using port 5060.</p><h2 id=sofia-recover><strong>Sofia Recover</strong><a hidden class=anchor aria-hidden=true href=#sofia-recover>#</a></h2><p>sofia recoverYou can ask Sofia to recover calls that were up, after crashing (or other scenarios).Sofia recover can also be used, if your core db uses ODBC to achieve HA / failover.For FreeSWITCH HA configuration, see <a href="https://freeswitch.org/confluence/plugins/servlet/mobile?contentId=1048969#content/view/7143926">Freeswitch HA</a>.</p><h2 id=flushing-and-rebooting-registered-endpoints><strong>Flushing and rebooting registered endpoints</strong><a hidden class=anchor aria-hidden=true href=#flushing-and-rebooting-registered-endpoints>#</a></h2><p>You can flush a registration or reboot specific registered endpoint by issuing a flush_inbound_reg command from the console.freeswitch> sofia profile &lt;profile_name> flush_inbound_reg [&lt;call_id>|<a href=mailto:user@host>user@host</a>] [reboot]If you leave out &lt;call_id> and/or <a href=mailto:user@host>user@host</a>, you will flush/reboot every registered endpoint on a profile.</p><ul><li>Note: For polycom phone, the command causes the phone to check its configuration from the server. If the file is different (you may add extra space at the end of file), the phone will reboot. You should not change the value of voIpProt.SIP.specialEvent.checkSync.alwaysReboot=&ldquo;0&rdquo; to &ldquo;1&rdquo; in sip.cfg as that allows potential a DOS attack on the phone.</li></ul><p>You can also use the check_sync command:sofia profile &lt;profile_name> check_sync &lt;call_id> | <a href=mailto:user@domain>user@domain</a></p><ul><li>Note: The polycom phones do not reload -directory.xml configuration in response to either of these commands, they only reload the configuration. If you want new speed dials to take effect, you&rsquo;ll need to do a full reboot of the phone or enable the alwaysReboot option. (Suggestions from anyone with more detailed PolyCom knowledge would be appreciated here.)</li></ul><h2 id=starting-a-new-profile><strong>Starting a new profile</strong><a hidden class=anchor aria-hidden=true href=#starting-a-new-profile>#</a></h2><p>If you have created a new profile you need to start it from the console:freeswitch> sofia profile &lt;new_profile_name> start</p><h2 id=reloading-profiles-and-gateways><strong>Reloading profiles and gateways</strong><a hidden class=anchor aria-hidden=true href=#reloading-profiles-and-gateways>#</a></h2><p>You can reload a specific SIP profile by issuing a rescan/restart command from the consolefreeswitch> <strong>sofia profile &lt;profile_name> [|] reloadxml</strong>The difference between rescan and restart is that rescan will just load new config and not stop FreeSWITCH from processing any more calls on a profile.** Some config options like IP address and (UDP) port are not reloaded with rescan.**</p><h2 id=deleting-gateways><strong>Deleting gateways</strong><a hidden class=anchor aria-hidden=true href=#deleting-gateways>#</a></h2><p>You can delete a specific gateway by issuing a killgw command from the console. If you use <strong><em>all</em></strong> as gateway name, all gateways will be killedfreeswitch> sofia profile &lt;profile_name> killgw &lt;gateway_name></p><h2 id=restarting-gateways><strong>Restarting gateways</strong><a hidden class=anchor aria-hidden=true href=#restarting-gateways>#</a></h2><p>You can force a gateway to restart ( good for forcing a re-registration or similar ) by issuing a killgw command from the console followed by a profile rescan. This is safe to perform on a profile that has active calls.freeswitch> sofia profile &lt;profile_name> killgw &lt;gateway_name>freeswitch> sofia profile &lt;profile_name> rescan</p><h2 id=adding--changing-existing-gateways><strong>Adding / Changing Existing Gateways</strong><a hidden class=anchor aria-hidden=true href=#adding--changing-existing-gateways>#</a></h2><p>It will be assumed that you have all your gateways in the /usr/local/freeswitch/conf/sip_profiles/external directory and that you have just created a new entry. You can add a new gateway to FreeSWITCH by issuing a rescan reloadxml command from the console as seen in the example below. This will load the newly created gateway and not affect any calls that are currently up.freeswitch> sofia profile external rescan reloadxml</p><p>You now realize that you have screwed up the IP address in the new gateway and need to change it. So you edit your gateway file and make any changes that you want. You will then need to issue the following commands to destroy the gateway, and then have FreeSWITCH reload the changes with affecting any existing calls that are currently up.</p><p>freeswitch> sofia profile external killgw &lt;gateway_name>freeswitch> sofia profile external rescan reloadxml</p><h2 id=view-sip-registrations><strong>View SIP Registrations</strong><a hidden class=anchor aria-hidden=true href=#view-sip-registrations>#</a></h2><p>You can view all the devices that have registered by running the following from the console.freeswitch> sofia status profile regfreeswitch> sofia status profile default regfreeswitch> sofia status profile outbound regYou can also use the xmlstatus key to retrieve statuses in XML format. This is specially useful if you are using mod_xml_rpc.Commands are as follows:freeswitch> sofia xmlstatus profile regfreeswitch> sofia xmlstatus profile default regfreeswitch> sofia xmlstatus profile outbound reg</p><h2 id=list-the-status-of-gateways><strong>List the status of gateways</strong><a hidden class=anchor aria-hidden=true href=#list-the-status-of-gateways>#</a></h2><p>For the gateways that are in-service:freeswitch> sofia profile gwlist upFor the gateways that are out-of-service:freeswitch> sofia profile gwlist down<strong>Notes:</strong></p><ul><li>It should be used together with . See <a href="https://freeswitch.org/confluence/plugins/servlet/mobile?contentId=1048969#content/view/7144453">Sofia_Configuration_Files</a></li><li>It can also be used to feed into mod distributor to exclude dead gateways.</li></ul><h2 id=list-gateway-data><strong>List gateway data</strong><a hidden class=anchor aria-hidden=true href=#list-gateway-data>#</a></h2><p>To retrieve the value of an inbound variable:sofia_gateway_data &lt;gateway_name> ivar To retrieve the value of an outbound variable:sofia_gateway_data &lt;gateway_name> ovar To retrieve the value of either use:sofia_gateway_data &lt;gateway_name> var This first checks for an inbound variable, then checks for an outbound variable if there&rsquo;s no matching inbound.</p><h2 id=view-user-presence-data><strong>View User Presence Data</strong><a hidden class=anchor aria-hidden=true href=#view-user-presence-data>#</a></h2><p>Displays presence data from registered devices as seen by the serverUsage:sofia_presence_data [list|status|rpid|user_agent] [profile/]@domainsofia_presence_data list */2005status|rpid|user_agent|network_ip|network_portAway|away|Bria 3 release 3.5.1 stamp 69738|192.168.20.150|21368+OK</p><p>Its possible to retrieve only one valuesofia_presence_data status */2005Away</p><p>You can use this value in the dialplan, e.g.</p><h2 id=debugging-sofia-sip><strong>Debugging Sofia-SIP</strong><a hidden class=anchor aria-hidden=true href=#debugging-sofia-sip>#</a></h2><p>The Sofia-SIP components can output various debugging information. The detail of the debugging output is determined by the debugging level. The level is usually module-specific and it can be modified by module-specific environment variable. There is also a default level for all modules, controlled by environment variable #SOFIA_DEBUG.The environment variables controlling the logging and other debug output are as follows:- #SOFIA_DEBUG Default debug level (0..9)- #NUA_DEBUG User Agent engine (nua) debug level (0..9)- #SOA_DEBUG SDP Offer/Answer engine (soa) debug level (0..9)- #NEA_DEBUG Event engine (nea) debug level (0..9)- #IPTSEC_DEBUG HTTP/SIP authentication module debug level (0..9)- #NTA_DEBUG Transaction engine debug level (0..9)- #TPORT_DEBUG Transport event debug level (0..9)- #TPORT_LOG If set, print out all parsed SIP messages on transport layer- #TPORT_DUMP Filename for dumping unparsed messages from transport- #SU_DEBUG su module debug level (0..9)The defined debug output levels are:- 0 SU_DEBUG_0() - fatal errors, panic- 1 SU_DEBUG_1() - critical errors, minimal progress at subsystem level- 2 SU_DEBUG_2() - non-critical errors- 3 SU_DEBUG_3() - warnings, progress messages- 5 SU_DEBUG_5() - signaling protocol actions (incoming packets, &mldr;)- 7 SU_DEBUG_7() - media protocol actions (incoming packets, &mldr;)- 9 SU_DEBUG_9() - entering/exiting functions, very verbatim progressStarting with 1.0.4, those parameters can be controlled from the console by doingfreeswitch> sofia loglevel &lt;all|default|tport|iptsec|nea|nta|nth_client|nth_server|nua|soa|sresolv|stun> [0-9]&ldquo;all&rdquo; Will change every component&rsquo;s loglevelA log level of 0 turns off debugging, to turn them all off, you can dofreeswitch> sofia loglevel all 0To report a bug, you can turn on debugging with more verbosesofia global siptrace onsofia loglevel all 9sofia tracelevel alertconsole loglevel debugfsctl debug_level 10</p><h3 id=debugging-presence-and-sla><strong>Debugging presence and SLA</strong><a hidden class=anchor aria-hidden=true href=#debugging-presence-and-sla>#</a></h3><p>As of Jan 14, 2011, sofia supports a new debugging command: sofia global debug. It can turn on debugging for SLA, presence, or both. Usage is:sofia global debug slasofia global debug presencesofia global debug noneThe first two enable debugging SLA and presence, respectively. The third one turns off SLA and/or presence debugging.</p><h3 id=sample-export-linuxunix><strong>Sample Export (Linux/Unix)</strong><a hidden class=anchor aria-hidden=true href=#sample-export-linuxunix>#</a></h3><p>Alternatively, the levels can also be read from environment variables. The following bash commands turn on all debugging levels, and is equivalent to &ldquo;sofia loglevel all 9&rdquo;export SOFIA_DEBUG=9export NUA_DEBUG=9export SOA_DEBUG=9export NEA_DEBUG=9export IPTSEC_DEBUG=9export NTA_DEBUG=9export TPORT_DEBUG=9export TPORT_LOG=9export TPORT_DUMP=/tmp/tport_sip.logexport SU_DEBUG=9To turn this debugging off again, you have to exit FreeSWITCH and type unset. For example:unset TPORT_LOG</p><h3 id=sample-set-windows><strong>Sample Set (Windows)</strong><a hidden class=anchor aria-hidden=true href=#sample-set-windows>#</a></h3><p>The following bash commands turn on all debugging levels.set SOFIA_DEBUG=9set NUA_DEBUG=9set SOA_DEBUG=9set NEA_DEBUG=9set IPTSEC_DEBUG=9set NTA_DEBUG=9set TPORT_DEBUG=9set TPORT_LOG=9set TPORT_DUMP=/tmp/tport_sip.logset SU_DEBUG=9To turn this debugging off again, you have to exit FreeSWITCH and type unset. For example:set TPORT_LOG=You can also control SIP Debug output within fs_cli, the FreeSWITCH client app.freeswitch> sofia profile siptrace on|offOn newer software release, you can now be able to issue siptrace for all profiles:sofia global siptrace [on|off]</p><p>To have the SIP Debug details put in the /usr/local/freeswitch/log/freeswitch.log file, usefreeswitch> sofia tracelevel info (or any other loglevel name or number)To have the SIP details put into the log file automatically on startup, add this to sofia.conf.xml:&lt;global_settings>&mldr;&mldr;&lt;/global_settings></p><p>and the following to the sip profile xml file:&mldr;&mldr;&mldr;&mldr;</p><p></p><h2 id=profile-configurations><strong>Profile Configurations</strong><a hidden class=anchor aria-hidden=true href=#profile-configurations>#</a></h2><p></p><h3 id=track-call><strong>Track Call</strong><a hidden class=anchor aria-hidden=true href=#track-call>#</a></h3><p></p><h3 id=acl><strong>ACL</strong><a hidden class=anchor aria-hidden=true href=#acl>#</a></h3><p>You can restrict access by IP address for either REGISTERs or INVITEs (or both) by using the following options in the sofia profile.See <a href=https://confluence.freeswitch.org/display/FREESWITCH/ACL>ACL</a> for other access controlsSee <a href=https://freeswitch.org/stash/projects/FS/repos/freeswitch/browse/conf/vanilla/autoload_configs/acl.conf.xml>acl.conf.xml</a> for list configuration</p><h3 id=disabling-hold><strong>Disabling Hold</strong><a hidden class=anchor aria-hidden=true href=#disabling-hold>#</a></h3><p>Disable all calls on this profile from putting the call on hold:</p><ul><li>See also: <a href=https://freeswitch.org/confluence/display/FREESWITCH/__Channel+Variables#id-__ChannelVariables-rtp_disable_hold>rtp_disable_hold</a> variable</li></ul><h3 id=using-a-single-domain-for-all-registrations><strong>Using A Single Domain For All Registrations</strong><a hidden class=anchor aria-hidden=true href=#using-a-single-domain-for-all-registrations>#</a></h3><p>You can force all registrations in a particular profile to use a single domain. In other words, you can ignore the domain in the SIP message. You will need to modify several sofia profile settings.</p><h4 id=challenge-realm><strong>challenge realm</strong><a hidden class=anchor aria-hidden=true href=#challenge-realm>#</a></h4><ul><li>auto_from - uses the from field as the value for the SIP realm.</li><li>auto_to - uses the to field as the value for the SIP realm.</li><li>- you can input any value to use for the SIP realm.</li></ul><h4 id=force-register-domain><strong>force-register-domain</strong><a hidden class=anchor aria-hidden=true href=#force-register-domain>#</a></h4><p>Preference Weight Transport Port Address================================================================================1 0.500 udp 5060 74.51.38.151 0.500 tcp 5060 74.51.38.15</p><h3 id=flushing-inbound-registrations><strong>Flushing Inbound Registrations</strong><a hidden class=anchor aria-hidden=true href=#flushing-inbound-registrations>#</a></h3><p>From time to time, you may need to kill a registration.You can kill a registration from the CLI, or anywhere that accepts API commands with a command similar to the following:sofia profile &lt;profile_name_here> flush_inbound_reg [optional_callid]</p><h3 id=dial-out-of-a-gateway><strong>Dial out of a gateway</strong><a hidden class=anchor aria-hidden=true href=#dial-out-of-a-gateway>#</a></h3><p>Basic form:sofia/gateway//&lt;number_to_dial>Example 1:sofia/gateway/asterlink/18005551212gateway: is a keyword and not a &ldquo;gateway&rdquo; name. It has special meaning and tells the stack which credentials to use when challenged for the call. is the actual name of the gateway through which you want to send the call</p><p>Your available gateways (usually configured in conf/sip_profiles/external/*.xml) will show up in <strong>sofia status</strong>:freeswitch#> sofia status</p><p>Name Type     Data State=================================================================================================default profile sip:mod_<a href=mailto:sofia@2.3.4.5>sofia@2.3.4.5</a>:5060 RUNNING (2)mygateway gateway     sip:username@1.2.3.4 NOREGphonebooth.example.com alias default ALIASED=================================================================================================1 profile 1 alias</p><h3 id=modifying-the-to-header><strong>Modifying the To: header</strong><a hidden class=anchor aria-hidden=true href=#modifying-the-to-header>#</a></h3><p>You can override the To: header by appending ^<em></em>.Example 1:sofia/foo/user%192.168.1.1^101@$${domain}</p><p></p><h3 id=specifying-sip-proxy-with-fs_path><strong>Specifying SIP Proxy With fs_path</strong><a hidden class=anchor aria-hidden=true href=#specifying-sip-proxy-with-fs_path>#</a></h3><p>You can route a call through a specific SIP proxy by using the &ldquo;fs_path&rdquo; directive. Example:<a href=mailto:sofia/foo/user@that.domain>sofia/foo/user@that.domain</a>;fs_path=sip:proxy.this.domain</p><h3 id=safe-sip-uri-formatting><strong>Safe SIP URI Formatting</strong><a hidden class=anchor aria-hidden=true href=#safe-sip-uri-formatting>#</a></h3><p>As of commit <a href=https://freeswitch.org/stash/projects/FS/repos/freeswitch/commits/76370f4d1767bb0dcf828a3d6cde6e015b2cfa03>https://freeswitch.org/stash/projects/FS/repos/freeswitch/commits/76370f4d1767bb0dcf828a3d6cde6e015b2cfa03</a> the User part of the SIP URI has been &ldquo;safely&rdquo; encoded in the case where spaces or other special characters appear.</p><p></p><h2 id=channel-variables><strong>Channel Variables</strong><a hidden class=anchor aria-hidden=true href=#channel-variables>#</a></h2><p></p><h3 id=adding-request-headers><strong>Adding Request Headers</strong><a hidden class=anchor aria-hidden=true href=#adding-request-headers>#</a></h3><p>You can add arbitrary headers to outbound SIP calls by prefixing the string &lsquo;sip_h_&rsquo; to any channel variable, for example:Note that for BYE requests, you will need to use the prefix &lsquo;sip_bye_h_&rsquo; on the channel variable.</p><hr><p>While not required, you should prefix your headers with &ldquo;X-&rdquo; to avoid issues with interoperability with other SIP stacks.All inbound SIP calls will install any X- headers into local variables.This means you can easily bridge any X- header from one FreeSWITCH instance to another.To access the header above on a 2nd box, use the channel variable ${sip_h_X-Answer}It is important to note that the syntax ${sip_h_custom-header} can&rsquo;t be used to retrieve any custom header not starting with X-.It is because Sofia only reads and puts into variables custom headers starting with X-.</p><p></p><h3 id=adding-response-headers><strong>Adding Response Headers</strong><a hidden class=anchor aria-hidden=true href=#adding-response-headers>#</a></h3><p>There are three types of response header prefixes that can be set:</p><ul><li>Response headersip_rh_</li><li>Provisional response headersip_ph_</li><li>Bye response headersip_bye_h_</li></ul><p>Each prefix will exclusively add headers for their given types of requests - there is no &ldquo;global&rdquo; response header prefix that will add a header to all response messages.For example:</p><p></p><h3 id=adding-custom-headers><strong>Adding Custom Headers</strong><a hidden class=anchor aria-hidden=true href=#adding-custom-headers>#</a></h3><p>For instance, you may need <strong>P-Charge-Info</strong> to append to your INVITE header, you may do as follows:Then, you would see it in SIP message:INVITE sip:19099099099@1.2.3.4 SIP/2.0Via: SIP/2.0/UDP 5.6.7.8:5080;rport;branch=z9hG4bKyg61X9v3gUD4gMax-Forwards: 69From: &ldquo;DJB&rdquo; <a href=sip:2132132132@5.6.7.8>sip:2132132132@5.6.7.8</a>;tag=XQKQ322vQF5gKTo: <a href=sip:19099099099@1.2.3.4>sip:19099099099@1.2.3.4</a>Call-ID: b6c776f6-47ed-1230-0085-000f1f659e58CSeq: 30776798 INVITEContact: <a href=sip:mod_sofia@5.6.7.8:5080>sip:mod_sofia@5.6.7.8:5080</a>User-Agent: FreeSWITCH-mod_sofia/1.2.0-rc2+git~20120713T162602Z~0afd7318bd+unclean~20120713T184029ZAllow: INVITE, ACK, BYE, CANCEL, OPTIONS, MESSAGE, UPDATE, INFO, REGISTER, REFER, NOTIFYSupported: timer, precondition, path, replacesAllow-Events: talk, hold, conference, referContent-Type: application/sdpContent-Disposition: sessionContent-Length: 229P-Charge-Info: <a href=sip:2132132132@5.6.7.8>sip:2132132132@5.6.7.8</a>;npi=0;noa=3X-FS-Support: update_display,send_info.Remote-Party-ID: &ldquo;DJB&rdquo; <a href=sip:2132132132@5.6.7.8>sip:2132132132@5.6.7.8</a>;party=calling;screen=yes;privacy=off</p><h3 id=strip-individual-sip-headers><strong>Strip Individual SIP Headers</strong><a hidden class=anchor aria-hidden=true href=#strip-individual-sip-headers>#</a></h3><p>Sometimes a SIP provider will add extra header information. Most of the time they do that for their own use (tracking calls). But that extra information can cause a lot of problems. For example: I get a call from the PSTN via a DID provider (provider1). Since im not in the office the call gets bridged to my cell phone (provider2). Provider1 add&rsquo;s extra information to the sip packet like displayed below:X-voipnow-did: 01234567890X-voipnow-extension: 987654321&mldr;In some scenario, we bridge this call directly to provider2 the calls get dropped since provider2 doesnt accept the X-voipnow header, so we have to strip off those SIP headers.To strip them off, use the application UNSET in the dialplan (the inverse of SET):&mldr;</p><h3 id=strip-all-custom-sip-headers><strong>Strip All custom SIP Headers</strong><a hidden class=anchor aria-hidden=true href=#strip-all-custom-sip-headers>#</a></h3><p>If you wish to strip all custom headers while keeping only those defined in dialplan:&mldr;</p><h3 id=additional-channel-variables><strong>Additional Channel variables</strong><a hidden class=anchor aria-hidden=true href=#additional-channel-variables>#</a></h3><p>Additional variables may also be set to influence the way calls are handled by sofia.For example, contacts can be filtered by setting the &lsquo;sip_exclude_contact&rsquo; variable. Example:Or you can perform SIP Digest authorization on outgoing calls by setting <strong>sip_auth_username</strong> and <strong>sip_auth_password</strong> variables to avoid using Gateways to authenticate. Example:Changing the SIP Contact user FreeSWITCH normally uses mod_sofia@<a href=http://ipport/>ip:port</a> for the internal SIP contact. To change this to foo@<a href=http://ipport/>ip:port</a>, there is a variable, sip_contact_user:{sip_<a href="mailto:contact_user=foo%7Dsofia/my_profile/1234@192.168.0.1">contact_user=foo}sofia/my_profile/1234@192.168.0.1</a>;transport=tcp</p><h4 id=sip_renegotiate_codec_on_reinvite><strong>sip_renegotiate_codec_on_reinvite</strong><a hidden class=anchor aria-hidden=true href=#sip_renegotiate_codec_on_reinvite>#</a></h4><p>true|false</p><h4 id=sip_recovery_break_rfc><strong>sip_recovery_break_rfc</strong><a hidden class=anchor aria-hidden=true href=#sip_recovery_break_rfc>#</a></h4><p>true|false</p><h2 id=transcoding-issues><strong>Transcoding Issues</strong><a hidden class=anchor aria-hidden=true href=#transcoding-issues>#</a></h2><p>G729 and G723 will not let you transcode because of licensing issues. Calls will fail if for example originating endpoint has set G729 with higher priority and receiving endpoint has G723 with highest priority. The logic is to fail the call rather than attempt to find a codec match. If you are having issues due to transcoding you may disable transcoding and both endpoints will negotiate the compatible codec rather than just fail the call.disable-transcoding will take the preferred codec from the inbound leg of your call and only offer that codec on the outbound leg.Add the following command along with to your sofia profile</p><p>Example:</p><p></p><h2 id=custom-events><strong>Custom Events</strong><a hidden class=anchor aria-hidden=true href=#custom-events>#</a></h2><p>The following are events that can be subscribed to via <a href="https://freeswitch.org/confluence/plugins/servlet/mobile?contentId=1048969#content/view/1048914">Event Socket</a></p><ul><li>Registration</li></ul><ul><li>sofia::register* sofia::pre_register* sofia::register_attempt* sofia::register_failure* sofia::unregister - explicit unregister calls* sofia::expire - when a user registration expires</li></ul><ul><li>Gateways</li></ul><ul><li>sofia::gateway_add* sofia::gateway_delete* sofia::gateway_state - when a gateway is detected as down or back up</li></ul><ul><li>Call recovery</li></ul><ul><li>sofia::recovery_send* sofia::recovery_recv* sofia::recovery_recovered</li></ul><ul><li>Other</li></ul><ul><li>sofia::notify_refer* sofia::reinvite* sofia::error</li></ul><h2 id=faq><strong>FAQ</strong><a hidden class=anchor aria-hidden=true href=#faq>#</a></h2><p></p><h3 id=does-it-use-udp-or-tcp><strong>Does it use UDP or TCP?</strong><a hidden class=anchor aria-hidden=true href=#does-it-use-udp-or-tcp>#</a></h3><p>By default it uses both, but you can add ;transport=tcp to the Sofia URL to force it to use TCP.For example:<a href=mailto:sofia/profile/foo@bar.com>sofia/profile/foo@bar.com</a>;transport=tcpAlso there is a parameter in the gateway config:That will cause it to use the TCP transport for the registration and all subsequent SIP messages.Not sure if this is needed or what it does, but the following can also be used in gateway settings:</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://wdd.js.org>洞香春</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>