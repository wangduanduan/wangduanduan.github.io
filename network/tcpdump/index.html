<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Tcpdump抓包教程 | 洞香春</title><meta name=keywords content><meta name=description content="查看帮助文档 从帮助文档可以看出，包过滤的表达式一定要放在最后一个参数
tcpdump [ -AbdDefhHIJKlLnNOpqStuUvxX# ] [ -B buffer_size ] [ -c count ] [ --count ] [ -C file_size ] [ -E spi@ipaddr algo:secret,... ] [ -F file ] [ -G rotate_seconds ] [ -i interface ] [ --immediate-mode ] [ -j tstamp_type ] [ -m module ] [ -M secret ] [ --number ] [ --print ] [ -Q in|out|inout ] [ -r file ] [ -s snaplen ] [ -T type ] [ --version ] [ -V file ] [ -w file ] [ -W filecount ] [ -y datalinktype ] [ -z postrotate-command ] [ -Z user ] [ --time-stamp-precision=tstamp_precision ] [ --micro ] [ --nano ] [ expression ] 列出所有网卡 tcpdump -D 1."><meta name=author content="Eddie Wang"><link rel=canonical href=https://wdd.js.org/network/tcpdump/><link crossorigin=anonymous href=/assets/css/stylesheet.6d3944e058d85363bbe8a792a9b5f40002bca80be859dc19c466dd8de223973e.css integrity="sha256-bTlE4FjYU2O76KeSqbX0AAK8qAvoWdwZxGbdjeIjlz4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/cowboy.ico><link rel=apple-touch-icon href=https://wdd.js.org/cowboy.ico><link rel=mask-icon href=https://wdd.js.org/cowboy.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Tcpdump抓包教程"><meta property="og:description" content="查看帮助文档 从帮助文档可以看出，包过滤的表达式一定要放在最后一个参数
tcpdump [ -AbdDefhHIJKlLnNOpqStuUvxX# ] [ -B buffer_size ] [ -c count ] [ --count ] [ -C file_size ] [ -E spi@ipaddr algo:secret,... ] [ -F file ] [ -G rotate_seconds ] [ -i interface ] [ --immediate-mode ] [ -j tstamp_type ] [ -m module ] [ -M secret ] [ --number ] [ --print ] [ -Q in|out|inout ] [ -r file ] [ -s snaplen ] [ -T type ] [ --version ] [ -V file ] [ -w file ] [ -W filecount ] [ -y datalinktype ] [ -z postrotate-command ] [ -Z user ] [ --time-stamp-precision=tstamp_precision ] [ --micro ] [ --nano ] [ expression ] 列出所有网卡 tcpdump -D 1."><meta property="og:type" content="article"><meta property="og:url" content="https://wdd.js.org/network/tcpdump/"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="network"><meta property="article:published_time" content="2022-10-25T09:09:05+08:00"><meta property="article:modified_time" content="2022-10-25T09:09:05+08:00"><meta property="og:site_name" content="洞香春"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Tcpdump抓包教程"><meta name=twitter:description content="查看帮助文档 从帮助文档可以看出，包过滤的表达式一定要放在最后一个参数
tcpdump [ -AbdDefhHIJKlLnNOpqStuUvxX# ] [ -B buffer_size ] [ -c count ] [ --count ] [ -C file_size ] [ -E spi@ipaddr algo:secret,... ] [ -F file ] [ -G rotate_seconds ] [ -i interface ] [ --immediate-mode ] [ -j tstamp_type ] [ -m module ] [ -M secret ] [ --number ] [ --print ] [ -Q in|out|inout ] [ -r file ] [ -s snaplen ] [ -T type ] [ --version ] [ -V file ] [ -w file ] [ -W filecount ] [ -y datalinktype ] [ -z postrotate-command ] [ -Z user ] [ --time-stamp-precision=tstamp_precision ] [ --micro ] [ --nano ] [ expression ] 列出所有网卡 tcpdump -D 1."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Networks","item":"https://wdd.js.org/network/"},{"@type":"ListItem","position":3,"name":"Tcpdump抓包教程","item":"https://wdd.js.org/network/tcpdump/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Tcpdump抓包教程","name":"Tcpdump抓包教程","description":"查看帮助文档 从帮助文档可以看出，包过滤的表达式一定要放在最后一个参数\ntcpdump [ -AbdDefhHIJKlLnNOpqStuUvxX# ] [ -B buffer_size ] [ -c count ] [ --count ] [ -C file_size ] [ -E spi@ipaddr algo:secret,... ] [ -F file ] [ -G rotate_seconds ] [ -i interface ] [ --immediate-mode ] [ -j tstamp_type ] [ -m module ] [ -M secret ] [ --number ] [ --print ] [ -Q in|out|inout ] [ -r file ] [ -s snaplen ] [ -T type ] [ --version ] [ -V file ] [ -w file ] [ -W filecount ] [ -y datalinktype ] [ -z postrotate-command ] [ -Z user ] [ --time-stamp-precision=tstamp_precision ] [ --micro ] [ --nano ] [ expression ] 列出所有网卡 tcpdump -D 1.","keywords":[],"articleBody":"查看帮助文档 从帮助文档可以看出，包过滤的表达式一定要放在最后一个参数\ntcpdump [ -AbdDefhHIJKlLnNOpqStuUvxX# ] [ -B buffer_size ] [ -c count ] [ --count ] [ -C file_size ] [ -E spi@ipaddr algo:secret,... ] [ -F file ] [ -G rotate_seconds ] [ -i interface ] [ --immediate-mode ] [ -j tstamp_type ] [ -m module ] [ -M secret ] [ --number ] [ --print ] [ -Q in|out|inout ] [ -r file ] [ -s snaplen ] [ -T type ] [ --version ] [ -V file ] [ -w file ] [ -W filecount ] [ -y datalinktype ] [ -z postrotate-command ] [ -Z user ] [ --time-stamp-precision=tstamp_precision ] [ --micro ] [ --nano ] [ expression ] 列出所有网卡 tcpdump -D 1.enp89s0 [Up, Running, Connected] 2.docker0 [Up, Running, Connected] 3.vetha051ecc [Up, Running, Connected] 4.vethe67e03a [Up, Running, Connected] 5.vethc58c174 [Up, Running, Connected] 指定网卡 -i tcpdump -i eth0 所有网卡 tcpdump -i any 不要域名解析 tcpdump -n -i any 指定主机 tcpdoump host 192.168.0.1 指定源IP或者目标IP # 根据源IP过滤 tcpdump src 192.168.3.2 # 根据目标IP过滤 tcpdump dst 192.168.3.2 指定协议过滤 tcpdump tcp 指定端口 # 根据某个端口过滤 tcpdomp port 33 # 根据源端口或者目标端口过滤 tcpdump dst port 33 tcpdump src port 33 # 根据端口范围过滤 tcpdump portrange 30-90 根据IP和地址 tcpdump -i ens33 tcp and host 192.168.40.30 抓包结果写文件 tcpdump -i ens33 tcp and host 192.168.40.30 -w log.pcap 每隔30秒写一个文件 -G 30 表示每隔30秒写一个文件 文件名中的%实际上是时间格式 tcpdump -i ens33 -G 30 tcp and host 192.168.40.30 -w %Y_%m%d_%H%M_%S.log.pcap 每达到30MB产生一个文件 -C 30 每达到30MB产生一个文件 tcpdump -i ens33 -C 30 tcp and host 192.168.40.30 -w log.pcap 指定抓包的个数 在流量很大的网络上抓包，如果写文件的话，很可能将磁盘写满。所以最好指定一个最大的抓包个数，在达到包的个数后，自动退出。\ntcpdump -c 100000 -i eth0 host 21.23.3.2 -w test.pcap 抓包文件太大，切割成小包 把原来的包文件切割成20M大小的多个包\ntcpdump -r old_file -w new_files -C 20 按照包长大小过滤 # 包长小于某个值 tcpdump less 30 # 包长大于某个值 tcpdump greater 30 按照16进制的方式显示包的内容 BPF 过滤规则 port 53 src port 53 dest port 53 host 1.2.3.4 src host 1.2.3.4 dest host 1.2.3.4 host 1.2.3.4 and port 53 读取old.pcap文件 然后根据条件过滤 产生新的文件 适用于从一个大的pcap文件中过滤出需要的包\ntcpdump -r old.pcap -w new.pcap less 1280 最佳实践 1. 关注 packets dropped by kernel的值 有时候，抓包停止后，tcpdump打印xxx个包drop by kernel。一旦这个值不为零，就要注意了。某些包并不是在网络中丢包了，而是在tcpdump这个工具给丢弃了。\n60 packets captured 279514 packets received by filter 279368 packets dropped by kernel 默认情况下，tcpdump抓包时会做dns解析，这个dns解析会降低tcpdump的处理速度，造成tcpdump的buffer被填满，然后就被tcpdump丢弃。\n我们可以用两个方法解决这个问题\n-B 指定buffer的大小，默认单位为kb。例如-B 1024 -n -nn 设置tcpdump 不要解析host地址，不要抓换协议和端口号 -n Don't convert host addresses to names. This can be used to avoid DNS lookups. -nn Don't convert protocol and port numbers etc. to names either. -B buffer_size --buffer-size=buffer_size Set the operating system capture buffer size to buffer_size, in units of KiB (1024 bytes). 参考 https://serverfault.com/questions/131872/how-to-split-a-pcap-file-into-a-set-of-smaller-ones http://alumni.cs.ucr.edu/~marios/ethereal-tcpdump.pdf ethereal-tcpdump.pdf https://unix.stackexchange.com/questions/144794/why-would-the-kernel-drop-packets ","wordCount":"386","inLanguage":"en","datePublished":"2022-10-25T09:09:05+08:00","dateModified":"2022-10-25T09:09:05+08:00","author":{"@type":"Person","name":"Eddie Wang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wdd.js.org/network/tcpdump/"},"publisher":{"@type":"Organization","name":"洞香春","logo":{"@type":"ImageObject","url":"https://wdd.js.org/cowboy.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org accesskey=h title="洞香春 (Alt + H)"><img src=https://wdd.js.org/cowboy.ico alt aria-label=logo height=35>洞香春</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wdd.js.org/books/ title=百分之一阅读法><span>百分之一阅读法</span></a></li><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/golang/ title=Golang><span>Golang</span></a></li><li><a href=https://wdd.js.org/kamailio/ title=Kamailio><span>Kamailio</span></a></li><li><a href=https://wdd.js.org/network/ title=Network><span>Network</span></a></li><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/categories/ title=分类><span>分类</span></a></li><li><a href=https://wdd.js.org/fe/ title=前端><span>前端</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wdd.js.org>Home</a>&nbsp;»&nbsp;<a href=https://wdd.js.org/network/>Networks</a></div><h1 class=post-title>Tcpdump抓包教程</h1><div class=post-meta><span title='2022-10-25 09:09:05 +0800 CST'>2022-10-25 09:09:05</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;Eddie Wang&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/network/tcpdump.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e6%9f%a5%e7%9c%8b%e5%b8%ae%e5%8a%a9%e6%96%87%e6%a1%a3 aria-label=查看帮助文档>查看帮助文档</a></li><li><a href=#%e5%88%97%e5%87%ba%e6%89%80%e6%9c%89%e7%bd%91%e5%8d%a1 aria-label=列出所有网卡>列出所有网卡</a></li><li><a href=#%e6%8c%87%e5%ae%9a%e7%bd%91%e5%8d%a1--i aria-label="指定网卡 -i">指定网卡 -i</a></li><li><a href=#%e6%89%80%e6%9c%89%e7%bd%91%e5%8d%a1 aria-label=所有网卡>所有网卡</a></li><li><a href=#%e4%b8%8d%e8%a6%81%e5%9f%9f%e5%90%8d%e8%a7%a3%e6%9e%90 aria-label=不要域名解析>不要域名解析</a></li><li><a href=#%e6%8c%87%e5%ae%9a%e4%b8%bb%e6%9c%ba aria-label=指定主机>指定主机</a></li><li><a href=#%e6%8c%87%e5%ae%9a%e6%ba%90ip%e6%88%96%e8%80%85%e7%9b%ae%e6%a0%87ip aria-label=指定源IP或者目标IP>指定源IP或者目标IP</a></li><li><a href=#%e6%8c%87%e5%ae%9a%e5%8d%8f%e8%ae%ae%e8%bf%87%e6%bb%a4 aria-label=指定协议过滤>指定协议过滤</a></li><li><a href=#%e6%8c%87%e5%ae%9a%e7%ab%af%e5%8f%a3 aria-label=指定端口>指定端口</a></li><li><a href=#%e6%a0%b9%e6%8d%aeip%e5%92%8c%e5%9c%b0%e5%9d%80 aria-label=根据IP和地址>根据IP和地址</a></li><li><a href=#%e6%8a%93%e5%8c%85%e7%bb%93%e6%9e%9c%e5%86%99%e6%96%87%e4%bb%b6 aria-label=抓包结果写文件>抓包结果写文件</a></li><li><a href=#%e6%af%8f%e9%9a%9430%e7%a7%92%e5%86%99%e4%b8%80%e4%b8%aa%e6%96%87%e4%bb%b6 aria-label=每隔30秒写一个文件>每隔30秒写一个文件</a></li><li><a href=#%e6%af%8f%e8%be%be%e5%88%b030mb%e4%ba%a7%e7%94%9f%e4%b8%80%e4%b8%aa%e6%96%87%e4%bb%b6 aria-label=每达到30MB产生一个文件>每达到30MB产生一个文件</a></li><li><a href=#%e6%8c%87%e5%ae%9a%e6%8a%93%e5%8c%85%e7%9a%84%e4%b8%aa%e6%95%b0 aria-label=指定抓包的个数>指定抓包的个数</a></li><li><a href=#%e6%8a%93%e5%8c%85%e6%96%87%e4%bb%b6%e5%a4%aa%e5%a4%a7%e5%88%87%e5%89%b2%e6%88%90%e5%b0%8f%e5%8c%85 aria-label=抓包文件太大，切割成小包>抓包文件太大，切割成小包</a></li><li><a href=#%e6%8c%89%e7%85%a7%e5%8c%85%e9%95%bf%e5%a4%a7%e5%b0%8f%e8%bf%87%e6%bb%a4 aria-label=按照包长大小过滤>按照包长大小过滤</a></li><li><a href=#%e6%8c%89%e7%85%a716%e8%bf%9b%e5%88%b6%e7%9a%84%e6%96%b9%e5%bc%8f%e6%98%be%e7%a4%ba%e5%8c%85%e7%9a%84%e5%86%85%e5%ae%b9 aria-label=按照16进制的方式显示包的内容>按照16进制的方式显示包的内容</a></li><li><a href=#bpf-%e8%bf%87%e6%bb%a4%e8%a7%84%e5%88%99 aria-label="BPF 过滤规则">BPF 过滤规则</a></li><li><a href=#%e8%af%bb%e5%8f%96oldpcap%e6%96%87%e4%bb%b6-%e7%84%b6%e5%90%8e%e6%a0%b9%e6%8d%ae%e6%9d%a1%e4%bb%b6%e8%bf%87%e6%bb%a4-%e4%ba%a7%e7%94%9f%e6%96%b0%e7%9a%84%e6%96%87%e4%bb%b6 aria-label="读取old.pcap文件 然后根据条件过滤 产生新的文件">读取old.pcap文件 然后根据条件过滤 产生新的文件</a></li><li><a href=#%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5 aria-label=最佳实践>最佳实践</a><ul><li><a href=#1-%e5%85%b3%e6%b3%a8-packets-dropped-by-kernel%e7%9a%84%e5%80%bc aria-label="1. 关注 packets dropped by kernel的值">1. 关注 packets dropped by kernel的值</a></li></ul></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考>参考</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=查看帮助文档>查看帮助文档<a hidden class=anchor aria-hidden=true href=#查看帮助文档>#</a></h1><p>从帮助文档可以看出，包过滤的表达式一定要放在最后一个参数</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>       tcpdump <span style=color:#f92672>[</span> -AbdDefhHIJKlLnNOpqStuUvxX# <span style=color:#f92672>]</span> <span style=color:#f92672>[</span> -B buffer_size <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>               <span style=color:#f92672>[</span> -c count <span style=color:#f92672>]</span> <span style=color:#f92672>[</span> --count <span style=color:#f92672>]</span> <span style=color:#f92672>[</span> -C file_size <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>               <span style=color:#f92672>[</span> -E spi@ipaddr algo:secret,...  <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>               <span style=color:#f92672>[</span> -F file <span style=color:#f92672>]</span> <span style=color:#f92672>[</span> -G rotate_seconds <span style=color:#f92672>]</span> <span style=color:#f92672>[</span> -i interface <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>               <span style=color:#f92672>[</span> --immediate-mode <span style=color:#f92672>]</span> <span style=color:#f92672>[</span> -j tstamp_type <span style=color:#f92672>]</span> <span style=color:#f92672>[</span> -m module <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>               <span style=color:#f92672>[</span> -M secret <span style=color:#f92672>]</span> <span style=color:#f92672>[</span> --number <span style=color:#f92672>]</span> <span style=color:#f92672>[</span> --print <span style=color:#f92672>]</span> <span style=color:#f92672>[</span> -Q in|out|inout <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>               <span style=color:#f92672>[</span> -r file <span style=color:#f92672>]</span> <span style=color:#f92672>[</span> -s snaplen <span style=color:#f92672>]</span> <span style=color:#f92672>[</span> -T type <span style=color:#f92672>]</span> <span style=color:#f92672>[</span> --version <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>               <span style=color:#f92672>[</span> -V file <span style=color:#f92672>]</span> <span style=color:#f92672>[</span> -w file <span style=color:#f92672>]</span> <span style=color:#f92672>[</span> -W filecount <span style=color:#f92672>]</span> <span style=color:#f92672>[</span> -y datalinktype <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>               <span style=color:#f92672>[</span> -z postrotate-command <span style=color:#f92672>]</span> <span style=color:#f92672>[</span> -Z user <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>               <span style=color:#f92672>[</span> --time-stamp-precision<span style=color:#f92672>=</span>tstamp_precision <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>               <span style=color:#f92672>[</span> --micro <span style=color:#f92672>]</span> <span style=color:#f92672>[</span> --nano <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>               <span style=color:#f92672>[</span> expression <span style=color:#f92672>]</span>
</span></span></code></pre></div><h1 id=列出所有网卡>列出所有网卡<a hidden class=anchor aria-hidden=true href=#列出所有网卡>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tcpdump -D
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>1.enp89s0 <span style=color:#f92672>[</span>Up, Running, Connected<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>2.docker0 <span style=color:#f92672>[</span>Up, Running, Connected<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>3.vetha051ecc <span style=color:#f92672>[</span>Up, Running, Connected<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>4.vethe67e03a <span style=color:#f92672>[</span>Up, Running, Connected<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>5.vethc58c174 <span style=color:#f92672>[</span>Up, Running, Connected<span style=color:#f92672>]</span>
</span></span></code></pre></div><h1 id=指定网卡--i>指定网卡 -i<a hidden class=anchor aria-hidden=true href=#指定网卡--i>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tcpdump -i eth0
</span></span></code></pre></div><h1 id=所有网卡>所有网卡<a hidden class=anchor aria-hidden=true href=#所有网卡>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tcpdump -i any
</span></span></code></pre></div><h1 id=不要域名解析>不要域名解析<a hidden class=anchor aria-hidden=true href=#不要域名解析>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tcpdump -n -i any
</span></span></code></pre></div><h1 id=指定主机>指定主机<a hidden class=anchor aria-hidden=true href=#指定主机>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tcpdoump host 192.168.0.1
</span></span></code></pre></div><h1 id=指定源ip或者目标ip>指定源IP或者目标IP<a hidden class=anchor aria-hidden=true href=#指定源ip或者目标ip>#</a></h1><pre tabindex=0><code># 根据源IP过滤
tcpdump src 192.168.3.2

# 根据目标IP过滤
tcpdump dst 192.168.3.2
</code></pre><h1 id=指定协议过滤>指定协议过滤<a hidden class=anchor aria-hidden=true href=#指定协议过滤>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tcpdump tcp
</span></span></code></pre></div><h1 id=指定端口>指定端口<a hidden class=anchor aria-hidden=true href=#指定端口>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 根据某个端口过滤</span>
</span></span><span style=display:flex><span>tcpdomp port <span style=color:#ae81ff>33</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 根据源端口或者目标端口过滤</span>
</span></span><span style=display:flex><span>tcpdump dst port <span style=color:#ae81ff>33</span>
</span></span><span style=display:flex><span>tcpdump src port <span style=color:#ae81ff>33</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 根据端口范围过滤</span>
</span></span><span style=display:flex><span>tcpdump portrange 30-90
</span></span></code></pre></div><h1 id=根据ip和地址>根据IP和地址<a hidden class=anchor aria-hidden=true href=#根据ip和地址>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tcpdump -i ens33 tcp and host 192.168.40.30
</span></span></code></pre></div><h1 id=抓包结果写文件>抓包结果写文件<a hidden class=anchor aria-hidden=true href=#抓包结果写文件>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tcpdump -i ens33 tcp and host 192.168.40.30 -w log.pcap
</span></span></code></pre></div><h1 id=每隔30秒写一个文件>每隔30秒写一个文件<a hidden class=anchor aria-hidden=true href=#每隔30秒写一个文件>#</a></h1><ul><li><code>-G 30</code> 表示每隔30秒写一个文件</li><li>文件名中的%实际上是时间格式</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tcpdump -i ens33 -G <span style=color:#ae81ff>30</span> tcp and host 192.168.40.30 -w %Y_%m%d_%H%M_%S.log.pcap
</span></span></code></pre></div><h1 id=每达到30mb产生一个文件>每达到30MB产生一个文件<a hidden class=anchor aria-hidden=true href=#每达到30mb产生一个文件>#</a></h1><ul><li><code>-C 30</code> 每达到30MB产生一个文件</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tcpdump -i ens33 -C <span style=color:#ae81ff>30</span> tcp and host 192.168.40.30 -w log.pcap
</span></span></code></pre></div><h1 id=指定抓包的个数>指定抓包的个数<a hidden class=anchor aria-hidden=true href=#指定抓包的个数>#</a></h1><p>在流量很大的网络上抓包，如果写文件的话，很可能将磁盘写满。所以最好指定一个最大的抓包个数，在达到包的个数后，自动退出。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tcpdump -c <span style=color:#ae81ff>100000</span> -i eth0 host 21.23.3.2 -w test.pcap
</span></span></code></pre></div><h1 id=抓包文件太大切割成小包>抓包文件太大，切割成小包<a hidden class=anchor aria-hidden=true href=#抓包文件太大切割成小包>#</a></h1><p>把原来的包文件切割成20M大小的多个包</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>tcpdump</span> <span style=color:#960050;background-color:#1e0010>-r</span> <span style=color:#960050;background-color:#1e0010>old_file</span> <span style=color:#960050;background-color:#1e0010>-w</span> <span style=color:#960050;background-color:#1e0010>new_files</span> <span style=color:#960050;background-color:#1e0010>-C</span> <span style=color:#960050;background-color:#1e0010>20</span>
</span></span></code></pre></div><h1 id=按照包长大小过滤>按照包长大小过滤<a hidden class=anchor aria-hidden=true href=#按照包长大小过滤>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 包长小于某个值</span>
</span></span><span style=display:flex><span>tcpdump less <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 包长大于某个值</span>
</span></span><span style=display:flex><span>tcpdump greater <span style=color:#ae81ff>30</span>
</span></span></code></pre></div><h1 id=heading><a hidden class=anchor aria-hidden=true href=#heading>#</a></h1><h1 id=按照16进制的方式显示包的内容>按照16进制的方式显示包的内容<a hidden class=anchor aria-hidden=true href=#按照16进制的方式显示包的内容>#</a></h1><h1 id=bpf-过滤规则>BPF 过滤规则<a hidden class=anchor aria-hidden=true href=#bpf-过滤规则>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>port <span style=color:#ae81ff>53</span>
</span></span><span style=display:flex><span>src port <span style=color:#ae81ff>53</span>
</span></span><span style=display:flex><span>dest port <span style=color:#ae81ff>53</span>
</span></span><span style=display:flex><span>host 1.2.3.4
</span></span><span style=display:flex><span>src host 1.2.3.4
</span></span><span style=display:flex><span>dest host 1.2.3.4
</span></span><span style=display:flex><span>host 1.2.3.4 and port <span style=color:#ae81ff>53</span>
</span></span></code></pre></div><h1 id=读取oldpcap文件-然后根据条件过滤-产生新的文件>读取old.pcap文件 然后根据条件过滤 产生新的文件<a hidden class=anchor aria-hidden=true href=#读取oldpcap文件-然后根据条件过滤-产生新的文件>#</a></h1><p>适用于从一个大的pcap文件中过滤出需要的包</p><pre tabindex=0><code>tcpdump -r old.pcap -w new.pcap less 1280
</code></pre><h1 id=最佳实践>最佳实践<a hidden class=anchor aria-hidden=true href=#最佳实践>#</a></h1><h2 id=1-关注-packets-dropped-by-kernel的值>1. 关注 packets dropped by kernel的值<a hidden class=anchor aria-hidden=true href=#1-关注-packets-dropped-by-kernel的值>#</a></h2><p>有时候，抓包停止后，tcpdump打印xxx个包drop by kernel。一旦这个值不为零，就要注意了。某些包并不是在网络中丢包了，而是在tcpdump这个工具给丢弃了。</p><pre tabindex=0><code>60 packets captured
279514 packets received by filter
279368 packets dropped by kernel
</code></pre><p>默认情况下，tcpdump抓包时会做dns解析，这个dns解析会降低tcpdump的处理速度，造成tcpdump的buffer被填满，然后就被tcpdump丢弃。</p><p>我们可以用两个方法解决这个问题</p><ol><li>-B 指定buffer的大小，默认单位为kb。例如-B 1024</li><li>-n -nn 设置tcpdump 不要解析host地址，不要抓换协议和端口号</li></ol><pre tabindex=0><code>-n     Don&#39;t convert host addresses to names.  This can be used to avoid DNS lookups.

-nn    Don&#39;t convert protocol and port numbers etc. to names either.

-B buffer_size
--buffer-size=buffer_size
  Set the operating system capture buffer size to buffer_size, in units of KiB (1024 bytes).
</code></pre><h1 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h1><ul><li><a href=https://serverfault.com/questions/131872/how-to-split-a-pcap-file-into-a-set-of-smaller-ones>https://serverfault.com/questions/131872/how-to-split-a-pcap-file-into-a-set-of-smaller-ones</a></li><li><a href=http://alumni.cs.ucr.edu/~marios/ethereal-tcpdump.pdf>http://alumni.cs.ucr.edu/~marios/ethereal-tcpdump.pdf</a></li><li><a href="https://www.yuque.com/attachments/yuque/0/2021/pdf/280451/1626588032882-a3eda373-8e1e-46be-9f97-5ad42473a6d9.pdf?_lake_card=%7B%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2021%2Fpdf%2F280451%2F1626588032882-a3eda373-8e1e-46be-9f97-5ad42473a6d9.pdf%22%2C%22name%22%3A%22ethereal-tcpdump.pdf%22%2C%22size%22%3A78412%2C%22type%22%3A%22application%2Fpdf%22%2C%22ext%22%3A%22pdf%22%2C%22status%22%3A%22done%22%2C%22taskId%22%3A%22u847a776e-8d93-4565-9217-1ea315a6320%22%2C%22taskType%22%3A%22upload%22%2C%22id%22%3A%22ua4c30b92%22%2C%22card%22%3A%22file%22%7D">ethereal-tcpdump.pdf</a></li><li><a href=https://unix.stackexchange.com/questions/144794/why-would-the-kernel-drop-packets>https://unix.stackexchange.com/questions/144794/why-would-the-kernel-drop-packets</a></li></ul></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://wdd.js.org/network/wireshark/><span class=title>« Prev</span><br><span>Wireshark抓包教程</span></a>
<a class=next href=https://wdd.js.org/network/httpry/><span class=title>Next »</span><br><span>http抓包工具httpry使用</span></a></nav></footer><script src=https://giscus.app/client.js data-repo=wangduanduan/wangduanduan.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxMTkyMjMyNjA=" data-category=Announcements data-category-id=DIC_kwDOBxsz3M4CAjBq data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://wdd.js.org>洞香春</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>