<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Linux 日志系统简述 | 洞香春</title><meta name=keywords content="journal,linux"><meta name=description content="1. 序言 日志文件包含系统的运行信息，包括内核、服务、应用程序等的日志。日志在分析系统故障、排查应用问题等方面，有着至关重要的作用。
2. 哪些进程负责管理日志？ 默认情况下，系统上有两个守护进程服务管理日志。journald和rsyslogd。
journald是systemd的一个组件，journald的负责收集日志，日志可以来自
Syslog日志 内核日志 初始化内存日志 启动日志 所有服务写到标准输出和标准错误的日志 journal收集并整理收到的日志，使其易于被使用。
有以下几点需要注意
默认情况下，journal的日志是不会持久化的。 journal的日志是二进制的格式，并不能使用文本查看工具，例如cat, 或者vim去分析。journal的日志需要用journalctl命令去读取。 journald会把日志写到一个socket中，rsyslog可以通过这个socket来获取日志，然后去写文件。
3. 日志文件文件位置 日志文件位置 /var/log/ 目录 4. 日志配置文件位置 /etc/rsyslog.conf rsyslogd配置文件 /etc/logrotate.conf 日志回滚的相关配置 /etc/systemd/journald.conf journald的配置文件 5. rsyslog.conf 5.1. 模块加载 注意 imjournal就是用来负责访问journal中的日志 imuxsock 提供本地日志输入支持，例如使用logger命令输入日志 $ModLoad imuxsock # provides support for local system logging (e.g. via logger command) $ModLoad imjournal # provides access to the systemd journal 5.2. 过滤 5.2.1. 优先级过滤 **模式：FACILITY.**PRIORITY
设备(FACILITY): kern (0), user (1), mail (2), daemon (3), auth (4), syslog (5), lpr (6), news (7), cron (8), authpriv (9), ftp (10), and local0 through local7 (16 - 23)."><meta name=author content="王端端"><link rel=canonical href=https://wdd.js.org/posts/2022/linux-journal/><meta name=google-site-verification content="G-SGW660ZWKM"><link crossorigin=anonymous href=/assets/css/stylesheet.min.ceab085cbbf58c0ec96f6d415d51b3b44e204edfd71a45b4fa2d4aac13f119d0.css integrity="sha256-zqsIXLv1jA7Jb21BXVGztE4gTt/XGkW0+i1KrBPxGdA=" rel="preload stylesheet" as=style><link crossorigin=anonymous herf=/font-awesome/css/font-awesome.min.css rel=stylesheet type=text/css><link rel=preload href=/cowboy.ico as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/cowboy.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/cowboy.ico><link rel=apple-touch-icon href=https://wdd.js.org/cowboy.ico><link rel=mask-icon href=https://wdd.js.org/cowboy.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.105.0"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-SGW660ZWKM"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SGW660ZWKM",{anonymize_ip:!1})}</script><meta property="og:title" content="Linux 日志系统简述"><meta property="og:description" content="1. 序言 日志文件包含系统的运行信息，包括内核、服务、应用程序等的日志。日志在分析系统故障、排查应用问题等方面，有着至关重要的作用。
2. 哪些进程负责管理日志？ 默认情况下，系统上有两个守护进程服务管理日志。journald和rsyslogd。
journald是systemd的一个组件，journald的负责收集日志，日志可以来自
Syslog日志 内核日志 初始化内存日志 启动日志 所有服务写到标准输出和标准错误的日志 journal收集并整理收到的日志，使其易于被使用。
有以下几点需要注意
默认情况下，journal的日志是不会持久化的。 journal的日志是二进制的格式，并不能使用文本查看工具，例如cat, 或者vim去分析。journal的日志需要用journalctl命令去读取。 journald会把日志写到一个socket中，rsyslog可以通过这个socket来获取日志，然后去写文件。
3. 日志文件文件位置 日志文件位置 /var/log/ 目录 4. 日志配置文件位置 /etc/rsyslog.conf rsyslogd配置文件 /etc/logrotate.conf 日志回滚的相关配置 /etc/systemd/journald.conf journald的配置文件 5. rsyslog.conf 5.1. 模块加载 注意 imjournal就是用来负责访问journal中的日志 imuxsock 提供本地日志输入支持，例如使用logger命令输入日志 $ModLoad imuxsock # provides support for local system logging (e.g. via logger command) $ModLoad imjournal # provides access to the systemd journal 5.2. 过滤 5.2.1. 优先级过滤 **模式：FACILITY.**PRIORITY
设备(FACILITY): kern (0), user (1), mail (2), daemon (3), auth (4), syslog (5), lpr (6), news (7), cron (8), authpriv (9), ftp (10), and local0 through local7 (16 - 23)."><meta property="og:type" content="article"><meta property="og:url" content="https://wdd.js.org/posts/2022/linux-journal/"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-26T08:44:12+08:00"><meta property="article:modified_time" content="2022-10-26T08:44:12+08:00"><meta property="og:site_name" content="洞香春"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Linux 日志系统简述"><meta name=twitter:description content="1. 序言 日志文件包含系统的运行信息，包括内核、服务、应用程序等的日志。日志在分析系统故障、排查应用问题等方面，有着至关重要的作用。
2. 哪些进程负责管理日志？ 默认情况下，系统上有两个守护进程服务管理日志。journald和rsyslogd。
journald是systemd的一个组件，journald的负责收集日志，日志可以来自
Syslog日志 内核日志 初始化内存日志 启动日志 所有服务写到标准输出和标准错误的日志 journal收集并整理收到的日志，使其易于被使用。
有以下几点需要注意
默认情况下，journal的日志是不会持久化的。 journal的日志是二进制的格式，并不能使用文本查看工具，例如cat, 或者vim去分析。journal的日志需要用journalctl命令去读取。 journald会把日志写到一个socket中，rsyslog可以通过这个socket来获取日志，然后去写文件。
3. 日志文件文件位置 日志文件位置 /var/log/ 目录 4. 日志配置文件位置 /etc/rsyslog.conf rsyslogd配置文件 /etc/logrotate.conf 日志回滚的相关配置 /etc/systemd/journald.conf journald的配置文件 5. rsyslog.conf 5.1. 模块加载 注意 imjournal就是用来负责访问journal中的日志 imuxsock 提供本地日志输入支持，例如使用logger命令输入日志 $ModLoad imuxsock # provides support for local system logging (e.g. via logger command) $ModLoad imjournal # provides access to the systemd journal 5.2. 过滤 5.2.1. 优先级过滤 **模式：FACILITY.**PRIORITY
设备(FACILITY): kern (0), user (1), mail (2), daemon (3), auth (4), syslog (5), lpr (6), news (7), cron (8), authpriv (9), ftp (10), and local0 through local7 (16 - 23)."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://wdd.js.org/posts/"},{"@type":"ListItem","position":3,"name":"Linux 日志系统简述","item":"https://wdd.js.org/posts/2022/linux-journal/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Linux 日志系统简述","name":"Linux 日志系统简述","description":"1. 序言 日志文件包含系统的运行信息，包括内核、服务、应用程序等的日志。日志在分析系统故障、排查应用问题等方面，有着至关重要的作用。\n2. 哪些进程负责管理日志？ 默认情况下，系统上有两个守护进程服务管理日志。journald和rsyslogd。\njournald是systemd的一个组件，journald的负责收集日志，日志可以来自\nSyslog日志 内核日志 初始化内存日志 启动日志 所有服务写到标准输出和标准错误的日志 journal收集并整理收到的日志，使其易于被使用。\n有以下几点需要注意\n默认情况下，journal的日志是不会持久化的。 journal的日志是二进制的格式，并不能使用文本查看工具，例如cat, 或者vim去分析。journal的日志需要用journalctl命令去读取。 journald会把日志写到一个socket中，rsyslog可以通过这个socket来获取日志，然后去写文件。\n3. 日志文件文件位置 日志文件位置 /var/log/ 目录 4. 日志配置文件位置 /etc/rsyslog.conf rsyslogd配置文件 /etc/logrotate.conf 日志回滚的相关配置 /etc/systemd/journald.conf journald的配置文件 5. rsyslog.conf 5.1. 模块加载 注意 imjournal就是用来负责访问journal中的日志 imuxsock 提供本地日志输入支持，例如使用logger命令输入日志 $ModLoad imuxsock # provides support for local system logging (e.g. via logger command) $ModLoad imjournal # provides access to the systemd journal 5.2. 过滤 5.2.1. 优先级过滤 **模式：FACILITY.**PRIORITY\n设备(FACILITY): kern (0), user (1), mail (2), daemon (3), auth (4), syslog (5), lpr (6), news (7), cron (8), authpriv (9), ftp (10), and local0 through local7 (16 - 23).","keywords":["journal","linux"],"articleBody":" 1. 序言 日志文件包含系统的运行信息，包括内核、服务、应用程序等的日志。日志在分析系统故障、排查应用问题等方面，有着至关重要的作用。\n2. 哪些进程负责管理日志？ 默认情况下，系统上有两个守护进程服务管理日志。journald和rsyslogd。\njournald是systemd的一个组件，journald的负责收集日志，日志可以来自\nSyslog日志 内核日志 初始化内存日志 启动日志 所有服务写到标准输出和标准错误的日志 journal收集并整理收到的日志，使其易于被使用。\n有以下几点需要注意\n默认情况下，journal的日志是不会持久化的。 journal的日志是二进制的格式，并不能使用文本查看工具，例如cat, 或者vim去分析。journal的日志需要用journalctl命令去读取。 journald会把日志写到一个socket中，rsyslog可以通过这个socket来获取日志，然后去写文件。\n3. 日志文件文件位置 日志文件位置 /var/log/ 目录 4. 日志配置文件位置 /etc/rsyslog.conf rsyslogd配置文件 /etc/logrotate.conf 日志回滚的相关配置 /etc/systemd/journald.conf journald的配置文件 5. rsyslog.conf 5.1. 模块加载 注意 imjournal就是用来负责访问journal中的日志 imuxsock 提供本地日志输入支持，例如使用logger命令输入日志 $ModLoad imuxsock # provides support for local system logging (e.g. via logger command) $ModLoad imjournal # provides access to the systemd journal 5.2. 过滤 5.2.1. 优先级过滤 **模式：FACILITY.**PRIORITY\n设备(FACILITY): kern (0), user (1), mail (2), daemon (3), auth (4), syslog (5), lpr (6), news (7), cron (8), authpriv (9), ftp (10), and local0 through local7 (16 - 23). 日志等级：debug (7), info (6), notice (5), warning (4), err (3), crit (2), alert (1), and emerg (0). 正则 = 指定某个级别 ! 排除某个级别 匹配所有级别 Example: kern.* #选择所有的内核信息 mail.crit #选择所有优先级高于等于crit cron.!info # 选择cron日志不是info级别的日志 5.2.2. 属性过滤 模式：:PROPERTY, [!]COMPARE_OPERATION, “STRING” **\n比较操作符（COMPARE_OPERATION） contains 包含 isequal 相等 starswitch 以xxx开头 regex 正则匹配 ** 举个比较常见的例子.\n如果日志中包含 wdd 这个字符串，就把日志写到/var/log/wdd.log 这个文件里。\n首先编辑一下/etc/rsyslog.conf 文件\n注意 :msg 表示消息的内容 详情可以参考 man rsyslog.conf 关于Available Properties的部分内容\n:msg,contains,\"wdd\" /var/log/wdd.log 保存退出，然后执行下面的命令：\ntouch /var/log/wdd.log # 创建文件 systemctl restart rsyslog # 重启服务 logger hello wdd ➜ log tail /var/log/wdd.log May 23 19:26:52 VM_0_8_centos root: hello wdd 5.2.3. Action 将rsyslog写日志文件：\n# 方式1：过滤器 日志路径 cron.* /var/log/cron.log # 方式2：过滤器\t-日志路径。注意多了个- # 默认rsyslog是同步写日志，加个-表示异步写日志。在写日志比较多时候，异步的写可以提高性能 mail.* -/var/log/cron.log # 方式3：通过网络发送日志 # @[(zNUMBER)]HOST:[PORT] zNUMBER是压缩等级 mail.* @192.168.2.3:8000 #通过UDP发送日志 cron.* @@192.168.2.3:8000 #通过TCP发送日志， 注意多了一个@ *.* @(2)192.168.2.3:8000 #通过UDP发送日志，日志会被压缩后发送，压缩等级是2。日志如果少于60字节，将不会压缩 5.2.4. 丢弃日志 cron.* stop *.* ~ # rsyslog8 支持用~丢弃日志 详情可以：man rsyslog.conf\n5.2.5. 日志回滚 man lograte 里面有很多日志\n/var/log/wdd.log { noolddir size 10M rotate 10 sharedscripts postrotate /bin/kill -HUP `cat /var/run/syslogd.pid 2\u003e /dev/null` 2\u003e /dev/null || true /bin/kill -HUP `cat /var/run/rsyslogd.pid 2\u003e /dev/null` 2\u003e /dev/null || true endscript } 6. 速度限制 6.1. journald的速度限制 RateLimitInterval 限速周期,默认30s RateLimitBurst 限速值, 默认限速值1000 针对单个service, 在一个限速周期内，如果消息量超过限速值，则丢弃本周期内的所有消息。\n/etc/systemd/journal.conf\n#RateLimitInterval=30s #RateLimitBurst=1000 如果想关闭速度限制，就将RateLimitInterval设置为0\nRateLimitInterval=, RateLimitBurst= Configures the rate limiting that is applied to all messages generated on the system. If, in the time interval defined by RateLimitInterval=, more messages than specified in RateLimitBurst= are logged by a service, all further messages within the interval are dropped until the interval is over. A message about the number of dropped messages is generated. This rate limiting is applied per-service, so that two services which log do not interfere with each other’s limits. Defaults to 1000 messages in 30s. The time specification for RateLimitInterval= may be specified in the following units: “s”, “min”, “h”, “ms”, “us”. To turn off any kind of rate\nlimiting, set either value to 0.\n6.2. rsyslog的速度限制 /etc/rsyslog.conf\n$SystemLogRateLimitInterval 2 # 单位是s $SystemLogRateLimitBurst 50 如果要关闭速度限制，就将SystemLogRateLimitInterval设置为0\n7. journal 日志清理 –vacuum-size=, –vacuum-time= Removes archived journal files until the disk space they use falls below the specified size (specified with the usual “K”, “M”, “G”, “T”\nsuffixes), or all journal files contain no data older than the specified timespan (specified with the usual “s”, “min”, “h”, “days”,\n“months”, “weeks”, “years” suffixes). Note that running –vacuum-size= has only indirect effect on the output shown by –disk-usage as\nthe latter includes active journal files, while the former only operates on archived journal files. –vacuum-size= and –vacuum-time=\nmay be combined in a single invocation to enforce both a size and time limit on the archived journal files.\n发现 /var/log/journal的目录居然有4G。\n所以需要清理。\n7.1. 手动清理 journalctl --vacuum-time=2d # 保留最近两天 journalctl --vacuum-size=500M # 保留最近500MB 按天执行一次试试：\njournalctl --vacuum-time=2d Vacuuming done, freed 3.9G of archived journals on disk. 7.2. 修改配置 为了避免以后还需要手动清理，可以修改/etc/systemd/journal.conf文件\n例如将最大使用改为200M\nSystemMaxUse=200M 重启journald: systemctl restart systemd-journald 8. linux 日志文件简介 inux的日志位于/var/log目录下。\n日志主要分为4类\n1 应用日志 2 事件日志 3 服务日志 4 系统日志 日志内容\n/var/log/messages 普通应用级别活动 /var/log/auth.log 用户验证相关事件 /var/log/secure 系统授权 /var/log/boot.log 系统启动日志 /var/log/dmesg.log 硬件设备相关 /var/log/kern.log 内核日志 /var/log/faillog 失败的登录尝试日志 /var/log/cron crontab计划任务日志 /var/log/yum.log 包安装日志 /var/log/maillog /var/log/mail.log 邮件服务相关日志 /var/log/httpd/ Apache web服务器日志 /var/log/mysql.log /var/log/mysqld.log mysql相关日志 ","wordCount":"580","inLanguage":"en","datePublished":"2022-10-26T08:44:12+08:00","dateModified":"2022-10-26T08:44:12+08:00","author":{"@type":"Person","name":"王端端"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wdd.js.org/posts/2022/linux-journal/"},"publisher":{"@type":"Organization","name":"洞香春","logo":{"@type":"ImageObject","url":"https://wdd.js.org/cowboy.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org accesskey=h title="洞香春 (Alt + H)"><img src=/cowboy.ico alt=logo aria-label=logo height=35>洞香春</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/fe/ title=Frontend><span>Frontend</span></a></li><li><a href=https://wdd.js.org/golang/ title=Golang><span>Golang</span></a></li><li><a href=https://wdd.js.org/container/ title=k8s/docker><span>k8s/docker</span></a></li><li><a href=https://wdd.js.org/network/ title=Network><span>Network</span></a></li><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/shell/ title=Shell><span>Shell</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/categories/ title=分类><span>分类</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wdd.js.org>Home</a>&nbsp;»&nbsp;<a href=https://wdd.js.org/posts/>Posts</a></div><h1 class=post-title>Linux 日志系统简述</h1><div class=post-meta><span title='2022-10-26 08:44:12 +0800 CST'>2022-10-26 08:44:12</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;王端端&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/posts/2022/linux-journal/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#1-%e5%ba%8f%e8%a8%80 aria-label="1. 序言">1. 序言</a></li><li><a href=#2-%e5%93%aa%e4%ba%9b%e8%bf%9b%e7%a8%8b%e8%b4%9f%e8%b4%a3%e7%ae%a1%e7%90%86%e6%97%a5%e5%bf%97 aria-label="2. 哪些进程负责管理日志？">2. 哪些进程负责管理日志？</a></li><li><a href=#3-%e6%97%a5%e5%bf%97%e6%96%87%e4%bb%b6%e6%96%87%e4%bb%b6%e4%bd%8d%e7%bd%ae aria-label="3. 日志文件文件位置">3. 日志文件文件位置</a></li><li><a href=#4-%e6%97%a5%e5%bf%97%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e4%bd%8d%e7%bd%ae aria-label="4. 日志配置文件位置">4. 日志配置文件位置</a></li><li><a href=#5-rsyslogconf aria-label="5. rsyslog.conf">5. rsyslog.conf</a><ul><li><a href=#51-%e6%a8%a1%e5%9d%97%e5%8a%a0%e8%bd%bd aria-label="5.1. 模块加载">5.1. 模块加载</a></li><li><a href=#52-%e8%bf%87%e6%bb%a4 aria-label="5.2. 过滤">5.2. 过滤</a><ul><li><a href=#521-%e4%bc%98%e5%85%88%e7%ba%a7%e8%bf%87%e6%bb%a4 aria-label="5.2.1. 优先级过滤">5.2.1. 优先级过滤</a></li><li><a href=#522-%e5%b1%9e%e6%80%a7%e8%bf%87%e6%bb%a4 aria-label="5.2.2. 属性过滤">5.2.2. 属性过滤</a></li><li><a href=#523-action aria-label="5.2.3. Action">5.2.3. Action</a></li><li><a href=#524-%e4%b8%a2%e5%bc%83%e6%97%a5%e5%bf%97 aria-label="5.2.4. 丢弃日志">5.2.4. 丢弃日志</a></li><li><a href=#525-%e6%97%a5%e5%bf%97%e5%9b%9e%e6%bb%9a aria-label="5.2.5. 日志回滚">5.2.5. 日志回滚</a></li></ul></li></ul></li><li><a href=#6-%e9%80%9f%e5%ba%a6%e9%99%90%e5%88%b6 aria-label="6. 速度限制">6. 速度限制</a><ul><li><a href=#61-journald%e7%9a%84%e9%80%9f%e5%ba%a6%e9%99%90%e5%88%b6 aria-label="6.1. journald的速度限制">6.1. journald的速度限制</a></li><li><a href=#62-rsyslog%e7%9a%84%e9%80%9f%e5%ba%a6%e9%99%90%e5%88%b6 aria-label="6.2. rsyslog的速度限制">6.2. rsyslog的速度限制</a></li></ul></li><li><a href=#7-journal-%e6%97%a5%e5%bf%97%e6%b8%85%e7%90%86 aria-label="7. journal 日志清理">7. journal 日志清理</a><ul><li><a href=#71-%e6%89%8b%e5%8a%a8%e6%b8%85%e7%90%86 aria-label="7.1. 手动清理">7.1. 手动清理</a></li><li><a href=#72-%e4%bf%ae%e6%94%b9%e9%85%8d%e7%bd%ae aria-label="7.2. 修改配置">7.2. 修改配置</a></li></ul></li><li><a href=#8-linux-%e6%97%a5%e5%bf%97%e6%96%87%e4%bb%b6%e7%ae%80%e4%bb%8b aria-label="8. linux 日志文件简介">8. linux 日志文件简介</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p><img loading=lazy src=2022-10-26-08-45-41.png alt></p><h1 id=1-序言>1. 序言<a hidden class=anchor aria-hidden=true href=#1-序言>#</a></h1><p>日志文件包含系统的运行信息，包括内核、服务、应用程序等的日志。日志在分析系统故障、排查应用问题等方面，有着至关重要的作用。</p><h1 id=2-哪些进程负责管理日志>2. 哪些进程负责管理日志？<a hidden class=anchor aria-hidden=true href=#2-哪些进程负责管理日志>#</a></h1><p>默认情况下，系统上有两个守护进程服务管理日志。journald和rsyslogd。</p><p>journald是systemd的一个组件，journald的负责收集日志，日志可以来自</p><ul><li>Syslog日志</li><li>内核日志</li><li>初始化内存日志</li><li>启动日志</li><li>所有服务写到标准输出和标准错误的日志</li></ul><p>journal收集并整理收到的日志，使其易于被使用。</p><p>有以下几点需要注意</p><ol><li>默认情况下，journal的日志是不会持久化的。</li><li>journal的日志是二进制的格式，并不能使用文本查看工具，例如cat, 或者vim去分析。journal的日志需要用journalctl命令去读取。</li></ol><p>journald会把日志写到一个socket中，rsyslog可以通过这个socket来获取日志，然后去写文件。</p><p><img loading=lazy src=2022-10-26-08-47-16.png alt></p><h1 id=3-日志文件文件位置>3. 日志文件文件位置<a hidden class=anchor aria-hidden=true href=#3-日志文件文件位置>#</a></h1><ul><li>日志文件位置 /var/log/ 目录</li></ul><h1 id=4-日志配置文件位置>4. 日志配置文件位置<a hidden class=anchor aria-hidden=true href=#4-日志配置文件位置>#</a></h1><ul><li>/etc/rsyslog.conf  rsyslogd配置文件</li><li>/etc/logrotate.conf  日志回滚的相关配置</li><li>/etc/systemd/journald.conf  journald的配置文件</li></ul><h1 id=5-rsyslogconf>5. rsyslog.conf<a hidden class=anchor aria-hidden=true href=#5-rsyslogconf>#</a></h1><h2 id=51-模块加载>5.1. 模块加载<a hidden class=anchor aria-hidden=true href=#51-模块加载>#</a></h2><ul><li>注意 imjournal就是用来负责访问journal中的日志</li><li>imuxsock 提供本地日志输入支持，例如使用logger命令输入日志</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ModLoad imuxsock <span style=color:#75715e># provides support for local system logging (e.g. via logger command)</span>
</span></span><span style=display:flex><span>$ModLoad imjournal <span style=color:#75715e># provides access to the systemd journal</span>
</span></span></code></pre></div><h2 id=52-过滤>5.2. 过滤<a hidden class=anchor aria-hidden=true href=#52-过滤>#</a></h2><h3 id=521-优先级过滤>5.2.1. 优先级过滤<a hidden class=anchor aria-hidden=true href=#521-优先级过滤>#</a></h3><p>**模式：FACILITY.**<strong>PRIORITY</strong></p><ul><li>设备(FACILITY): kern (0), user (1), mail (2), daemon (3), auth (4), syslog (5), lpr (6), news (7), cron (8), authpriv (9), ftp (10), and local0 through local7 (16 - 23).</li><li>日志等级：debug (7), info (6), notice (5), warning (4), err (3), crit (2), alert (1), and emerg (0).</li><li>正则<ul><li>= 指定某个级别</li><li>! 排除某个级别</li><li><ul><li>匹配所有级别</li></ul></li></ul></li></ul><p>Example: </p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kern.*  <span style=color:#75715e>#选择所有的内核信息</span>
</span></span><span style=display:flex><span>mail.crit <span style=color:#75715e>#选择所有优先级高于等于crit</span>
</span></span><span style=display:flex><span>cron.!info <span style=color:#75715e># 选择cron日志不是info级别的日志</span>
</span></span></code></pre></div><h3 id=522-属性过滤>5.2.2. 属性过滤<a hidden class=anchor aria-hidden=true href=#522-属性过滤>#</a></h3><p>模式：<strong>:PROPERTY, [!]COMPARE_OPERATION, &ldquo;STRING&rdquo;</strong>
**</p><ul><li>比较操作符（COMPARE_OPERATION）<ul><li>contains 包含</li><li>isequal 相等</li><li>starswitch 以xxx开头</li><li>regex 正则匹配</li></ul></li></ul><p>**
举个比较常见的例子.</p><p>如果日志中包含 wdd 这个字符串，就把日志写到/var/log/wdd.log 这个文件里。</p><p>首先编辑一下/etc/rsyslog.conf 文件</p><blockquote><p>注意
:msg 表示消息的内容
详情可以参考 man rsyslog.conf 关于Available Properties的部分内容</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>:msg,contains,<span style=color:#e6db74>&#34;wdd&#34;</span>                                     /var/log/wdd.log
</span></span></code></pre></div><p>保存退出，然后执行下面的命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>touch /var/log/wdd.log <span style=color:#75715e># 创建文件</span>
</span></span><span style=display:flex><span>systemctl restart rsyslog <span style=color:#75715e># 重启服务</span>
</span></span><span style=display:flex><span>logger hello wdd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>➜  log tail /var/log/wdd.log
</span></span><span style=display:flex><span>May <span style=color:#ae81ff>23</span> 19:26:52 VM_0_8_centos root: hello wdd
</span></span></code></pre></div><h3 id=523-action>5.2.3. Action<a hidden class=anchor aria-hidden=true href=#523-action>#</a></h3><p>将rsyslog写日志文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 方式1：过滤器 日志路径</span>
</span></span><span style=display:flex><span>cron.* /var/log/cron.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 方式2：过滤器	-日志路径。注意多了个-</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 默认rsyslog是同步写日志，加个-表示异步写日志。在写日志比较多时候，异步的写可以提高性能</span>
</span></span><span style=display:flex><span>mail.* -/var/log/cron.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 方式3：通过网络发送日志</span>
</span></span><span style=display:flex><span><span style=color:#75715e># @[(zNUMBER)]HOST:[PORT]  zNUMBER是压缩等级</span>
</span></span><span style=display:flex><span>mail.* @192.168.2.3:8000 <span style=color:#75715e>#通过UDP发送日志</span>
</span></span><span style=display:flex><span>cron.* @@192.168.2.3:8000 <span style=color:#75715e>#通过TCP发送日志， 注意多了一个@</span>
</span></span><span style=display:flex><span>*.* @<span style=color:#f92672>(</span>2<span style=color:#f92672>)</span>192.168.2.3:8000 <span style=color:#75715e>#通过UDP发送日志，日志会被压缩后发送，压缩等级是2。日志如果少于60字节，将不会压缩</span>
</span></span></code></pre></div><h3 id=524-丢弃日志>5.2.4. 丢弃日志<a hidden class=anchor aria-hidden=true href=#524-丢弃日志>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cron.* stop
</span></span><span style=display:flex><span>*.*   ~      <span style=color:#75715e># rsyslog8 支持用~丢弃日志</span>
</span></span></code></pre></div><p>详情可以：man rsyslog.conf</p><h3 id=525-日志回滚>5.2.5. 日志回滚<a hidden class=anchor aria-hidden=true href=#525-日志回滚>#</a></h3><p>man lograte 里面有很多日志</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/var/log/wdd.log <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        noolddir
</span></span><span style=display:flex><span>        size 10M
</span></span><span style=display:flex><span>        rotate <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>        sharedscripts
</span></span><span style=display:flex><span>        postrotate
</span></span><span style=display:flex><span>        /bin/kill -HUP <span style=color:#e6db74>`</span>cat /var/run/syslogd.pid 2&gt; /dev/null<span style=color:#e6db74>`</span> 2&gt; /dev/null <span style=color:#f92672>||</span> true
</span></span><span style=display:flex><span>        /bin/kill -HUP <span style=color:#e6db74>`</span>cat /var/run/rsyslogd.pid 2&gt; /dev/null<span style=color:#e6db74>`</span> 2&gt; /dev/null <span style=color:#f92672>||</span> true
</span></span><span style=display:flex><span>        endscript
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=6-速度限制>6. 速度限制<a hidden class=anchor aria-hidden=true href=#6-速度限制>#</a></h1><h2 id=61-journald的速度限制>6.1. journald的速度限制<a hidden class=anchor aria-hidden=true href=#61-journald的速度限制>#</a></h2><ul><li>RateLimitInterval 限速周期,默认30s</li><li>RateLimitBurst 限速值, 默认限速值1000</li></ul><p>针对单个service, 在一个限速周期内，如果消息量超过限速值，则丢弃本周期内的所有消息。</p><p>/etc/systemd/journal.conf</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#RateLimitInterval=30s</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#RateLimitBurst=1000</span>
</span></span></code></pre></div><p>如果想关闭速度限制，就将RateLimitInterval设置为0</p><blockquote><p>      RateLimitInterval=, RateLimitBurst=
          Configures the rate limiting that is applied to all messages generated on the system. If, in the time interval defined by
          RateLimitInterval=, more messages than specified in RateLimitBurst= are logged by a service, all further messages within the interval
          are dropped until the interval is over. A message about the number of dropped messages is generated. This rate limiting is applied
          per-service, so that two services which log do not interfere with each other&rsquo;s limits. Defaults to 1000 messages in 30s. The time
          specification for RateLimitInterval= may be specified in the following units: &ldquo;s&rdquo;, &ldquo;min&rdquo;, &ldquo;h&rdquo;, &ldquo;ms&rdquo;, &ldquo;us&rdquo;. To turn off any kind of rate</p></blockquote><blockquote><p>          limiting, set either value to 0.</p></blockquote><h2 id=62-rsyslog的速度限制>6.2. rsyslog的速度限制<a hidden class=anchor aria-hidden=true href=#62-rsyslog的速度限制>#</a></h2><p>/etc/rsyslog.conf</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$SystemLogRateLimitInterval <span style=color:#ae81ff>2</span> <span style=color:#75715e># 单位是s</span>
</span></span><span style=display:flex><span>$SystemLogRateLimitBurst <span style=color:#ae81ff>50</span>
</span></span></code></pre></div><p>如果要关闭速度限制，就将SystemLogRateLimitInterval设置为0</p><h1 id=7-journal-日志清理>7. journal 日志清理<a hidden class=anchor aria-hidden=true href=#7-journal-日志清理>#</a></h1><blockquote><p>       &ndash;vacuum-size=, &ndash;vacuum-time=
          Removes archived journal files until the disk space they use falls below the specified size (specified with the usual &ldquo;K&rdquo;, &ldquo;M&rdquo;, &ldquo;G&rdquo;, &ldquo;T&rdquo;</p></blockquote><blockquote><p>          suffixes), or all journal files contain no data older than the specified timespan (specified with the usual &ldquo;s&rdquo;, &ldquo;min&rdquo;, &ldquo;h&rdquo;, &ldquo;days&rdquo;,</p></blockquote><blockquote><p>          &ldquo;months&rdquo;, &ldquo;weeks&rdquo;, &ldquo;years&rdquo; suffixes). Note that running &ndash;vacuum-size= has only indirect effect on the output shown by &ndash;disk-usage as</p></blockquote><blockquote><p>          the latter includes active journal files, while the former only operates on archived journal files.  &ndash;vacuum-size= and &ndash;vacuum-time=</p></blockquote><blockquote><p>          may be combined in a single invocation to enforce both a size and time limit on the archived journal files.</p></blockquote><p>发现 /var/log/journal的目录居然有4G。</p><p>所以需要清理。</p><h2 id=71-手动清理>7.1. 手动清理<a hidden class=anchor aria-hidden=true href=#71-手动清理>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>journalctl --vacuum-time<span style=color:#f92672>=</span>2d <span style=color:#75715e># 保留最近两天</span>
</span></span><span style=display:flex><span>journalctl --vacuum-size<span style=color:#f92672>=</span>500M <span style=color:#75715e># 保留最近500MB</span>
</span></span></code></pre></div><p>按天执行一次试试：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>journalctl --vacuum-time<span style=color:#f92672>=</span>2d
</span></span><span style=display:flex><span>Vacuuming <span style=color:#66d9ef>done</span>, freed 3.9G of archived journals on disk.
</span></span></code></pre></div><h2 id=72-修改配置>7.2. 修改配置<a hidden class=anchor aria-hidden=true href=#72-修改配置>#</a></h2><p>为了避免以后还需要手动清理，可以修改/etc/systemd/journal.conf文件</p><p>例如将最大使用改为200M</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SystemMaxUse<span style=color:#f92672>=</span>200M
</span></span></code></pre></div><p>重启journald: </p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart systemd-journald
</span></span></code></pre></div><h1 id=8-linux-日志文件简介>8. linux 日志文件简介<a hidden class=anchor aria-hidden=true href=#8-linux-日志文件简介>#</a></h1><p>inux的日志位于/var/log目录下。</p><p>日志主要分为4类</p><ul><li>1 应用日志</li><li>2 事件日志</li><li>3 服务日志</li><li>4 系统日志</li></ul><p>日志内容</p><ul><li>/var/log/messages 普通应用级别活动</li><li>/var/log/auth.log 用户验证相关事件</li><li>/var/log/secure 系统授权</li><li>/var/log/boot.log 系统启动日志</li><li>/var/log/dmesg.log 硬件设备相关</li><li>/var/log/kern.log 内核日志</li><li>/var/log/faillog 失败的登录尝试日志</li><li>/var/log/cron crontab计划任务日志</li><li>/var/log/yum.log 包安装日志</li><li>/var/log/maillog /var/log/mail.log 邮件服务相关日志</li><li>/var/log/httpd/ Apache web服务器日志</li><li>/var/log/mysql.log /var/log/mysqld.log mysql相关日志</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://wdd.js.org/tags/journal/>journal</a></li><li><a href=https://wdd.js.org/tags/linux/>linux</a></li></ul><nav class=paginav><a class=prev href=https://wdd.js.org/posts/2022/deepin-install-man/><span class=title>« Prev Page</span><br><span>Deepin安装man命令</span></a>
<a class=next href=https://wdd.js.org/posts/2022/ubuntu-tips/><span class=title>Next Page »</span><br><span>Ubuntu 使用过程中遇到的问题以及解决方案</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://wdd.js.org>洞香春</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>