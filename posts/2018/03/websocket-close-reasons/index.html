<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>WebSocket断开原因分析 | 洞香春</title>
<meta name=keywords content="WebSocket"><meta name=description content="1. 把错误打印出来
WebSocket断开的原因有很多，最好在WebSocket断开时，将错误打印出来。
在线demo地址：https://wdd.js.org/websocket-demos/

ws.onerror = function (e) {
  console.log('WebSocket发生错误: ' + e.code)
  console.log(e)
}

如果你想自己玩玩WebSocket, 但是你又不想自己部署一个WebSocket服务器，你可以使用ws = new WebSocket('wss://echo.websocket.org/'), 你向echo.websocket.org发送消息，它会回复你同样的消息。
2. 重要信息错误状态码
WebSocket断开时，会触发CloseEvent, CloseEvent会在连接关闭时发送给使用 WebSockets 的客户端. 它在 WebSocket 对象的 onclose 事件监听器中使用。CloseEvent的code字段表示了WebSocket断开的原因。可以从该字段中分析断开的原因。

3. 关闭状态码表
一般来说1006的错误码出现的情况比较常见，该错误码一般出现在断网时。

  
      
          状态码
          名称
          描述
      
  
  
      
          0–999
          
          保留段, 未使用.
      
      
          1000
          CLOSE_NORMAL
          正常关闭; 无论为何目的而创建, 该链接都已成功完成任务.
      
      
          1001
          CLOSE_GOING_AWAY
          终端离开, 可能因为服务端错误, 也可能因为浏览器正从打开连接的页面跳转离开.
      
      
          1002
          CLOSE_PROTOCOL_ERROR
          由于协议错误而中断连接.
      
      
          1003
          CLOSE_UNSUPPORTED
          由于接收到不允许的数据类型而断开连接 (如仅接收文本数据的终端接收到了二进制数据).
      
      
          1004
          
          保留. 其意义可能会在未来定义.
      
      
          1005
          CLOSE_NO_STATUS
          保留.  表示没有收到预期的状态码.
      
      
          1006
          CLOSE_ABNORMAL
          保留. 用于期望收到状态码时连接非正常关闭 (也就是说, 没有发送关闭帧).
      
      
          1007
          Unsupported Data
          由于收到了格式不符的数据而断开连接 (如文本消息中包含了非 UTF-8 数据).
      
      
          1008
          Policy Violation
          由于收到不符合约定的数据而断开连接. 这是一个通用状态码, 用于不适合使用 1003 和 1009 状态码的场景.
      
      
          1009
          CLOSE_TOO_LARGE
          由于收到过大的数据帧而断开连接.
      
      
          1010
          Missing Extension
          客户端期望服务器商定一个或多个拓展, 但服务器没有处理, 因此客户端断开连接.
      
      
          1011
          Internal Error
          客户端由于遇到没有预料的情况阻止其完成请求, 因此服务端断开连接.
      
      
          1012
          Service Restart
          服务器由于重启而断开连接.
      
      
          1013
          Try Again Later
          服务器由于临时原因断开连接, 如服务器过载因此断开一部分客户端连接.
      
      
          1014
          
          由 WebSocket标准保留以便未来使用.
      
      
          1015
          TLS Handshake
          保留. 表示连接由于无法完成 TLS 握手而关闭 (例如无法验证服务器证书).
      
      
          1016–1999
          
          由 WebSocket标准保留以便未来使用.
      
      
          2000–2999
          
          由 WebSocket拓展保留使用.
      
      
          3000–3999
          
          可以由库或框架使用.? 不应由应用使用. 可以在 IANA 注册, 先到先得.
      
      
          4000–4999
          
          可以由应用使用.
      
  

4. 其他注意事项
如果你的服务所在的域是HTTPS的，那么使用的WebSocket协议也必须是wss, 而不能是ws"><meta name=author content="Eddie Wang"><link rel=canonical href=https://wdd.js.org/posts/2018/03/websocket-close-reasons/><link crossorigin=anonymous href=/assets/css/stylesheet.821c51435cba3e33e49e590a06514c54c32ac7957095ffcc1e0f390c47cf3228.css integrity="sha256-ghxRQ1y6PjPknlkKBlFMVMMqx5Vwlf/MHg85DEfPMig=" rel="preload stylesheet" as=style><link rel=icon href=https://wdd.js.org/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/favicon.ico><link rel=apple-touch-icon href=https://wdd.js.org/favicon.ico><link rel=mask-icon href=https://wdd.js.org/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://wdd.js.org/posts/2018/03/websocket-close-reasons/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://wdd.js.org/posts/2018/03/websocket-close-reasons/"><meta property="og:site_name" content="洞香春"><meta property="og:title" content="WebSocket断开原因分析"><meta property="og:description" content="1. 把错误打印出来 WebSocket断开的原因有很多，最好在WebSocket断开时，将错误打印出来。
在线demo地址：https://wdd.js.org/websocket-demos/
ws.onerror = function (e) { console.log('WebSocket发生错误: ' + e.code) console.log(e) } 如果你想自己玩玩WebSocket, 但是你又不想自己部署一个WebSocket服务器，你可以使用ws = new WebSocket('wss://echo.websocket.org/'), 你向echo.websocket.org发送消息，它会回复你同样的消息。
2. 重要信息错误状态码 WebSocket断开时，会触发CloseEvent, CloseEvent会在连接关闭时发送给使用 WebSockets 的客户端. 它在 WebSocket 对象的 onclose 事件监听器中使用。CloseEvent的code字段表示了WebSocket断开的原因。可以从该字段中分析断开的原因。
3. 关闭状态码表 一般来说1006的错误码出现的情况比较常见，该错误码一般出现在断网时。
状态码 名称 描述 0–999 保留段, 未使用. 1000 CLOSE_NORMAL 正常关闭; 无论为何目的而创建, 该链接都已成功完成任务. 1001 CLOSE_GOING_AWAY 终端离开, 可能因为服务端错误, 也可能因为浏览器正从打开连接的页面跳转离开. 1002 CLOSE_PROTOCOL_ERROR 由于协议错误而中断连接. 1003 CLOSE_UNSUPPORTED 由于接收到不允许的数据类型而断开连接 (如仅接收文本数据的终端接收到了二进制数据). 1004 保留. 其意义可能会在未来定义. 1005 CLOSE_NO_STATUS 保留. 表示没有收到预期的状态码. 1006 CLOSE_ABNORMAL 保留. 用于期望收到状态码时连接非正常关闭 (也就是说, 没有发送关闭帧). 1007 Unsupported Data 由于收到了格式不符的数据而断开连接 (如文本消息中包含了非 UTF-8 数据). 1008 Policy Violation 由于收到不符合约定的数据而断开连接. 这是一个通用状态码, 用于不适合使用 1003 和 1009 状态码的场景. 1009 CLOSE_TOO_LARGE 由于收到过大的数据帧而断开连接. 1010 Missing Extension 客户端期望服务器商定一个或多个拓展, 但服务器没有处理, 因此客户端断开连接. 1011 Internal Error 客户端由于遇到没有预料的情况阻止其完成请求, 因此服务端断开连接. 1012 Service Restart 服务器由于重启而断开连接. 1013 Try Again Later 服务器由于临时原因断开连接, 如服务器过载因此断开一部分客户端连接. 1014 由 WebSocket标准保留以便未来使用. 1015 TLS Handshake 保留. 表示连接由于无法完成 TLS 握手而关闭 (例如无法验证服务器证书). 1016–1999 由 WebSocket标准保留以便未来使用. 2000–2999 由 WebSocket拓展保留使用. 3000–3999 可以由库或框架使用.? 不应由应用使用. 可以在 IANA 注册, 先到先得. 4000–4999 可以由应用使用. 4. 其他注意事项 如果你的服务所在的域是HTTPS的，那么使用的WebSocket协议也必须是wss, 而不能是ws"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-03-29T20:35:38+08:00"><meta property="article:modified_time" content="2018-03-29T20:35:38+08:00"><meta property="article:tag" content="WebSocket"><meta property="og:image" content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="WebSocket断开原因分析"><meta name=twitter:description content="1. 把错误打印出来
WebSocket断开的原因有很多，最好在WebSocket断开时，将错误打印出来。
在线demo地址：https://wdd.js.org/websocket-demos/

ws.onerror = function (e) {
  console.log('WebSocket发生错误: ' + e.code)
  console.log(e)
}

如果你想自己玩玩WebSocket, 但是你又不想自己部署一个WebSocket服务器，你可以使用ws = new WebSocket('wss://echo.websocket.org/'), 你向echo.websocket.org发送消息，它会回复你同样的消息。
2. 重要信息错误状态码
WebSocket断开时，会触发CloseEvent, CloseEvent会在连接关闭时发送给使用 WebSockets 的客户端. 它在 WebSocket 对象的 onclose 事件监听器中使用。CloseEvent的code字段表示了WebSocket断开的原因。可以从该字段中分析断开的原因。

3. 关闭状态码表
一般来说1006的错误码出现的情况比较常见，该错误码一般出现在断网时。

  
      
          状态码
          名称
          描述
      
  
  
      
          0–999
          
          保留段, 未使用.
      
      
          1000
          CLOSE_NORMAL
          正常关闭; 无论为何目的而创建, 该链接都已成功完成任务.
      
      
          1001
          CLOSE_GOING_AWAY
          终端离开, 可能因为服务端错误, 也可能因为浏览器正从打开连接的页面跳转离开.
      
      
          1002
          CLOSE_PROTOCOL_ERROR
          由于协议错误而中断连接.
      
      
          1003
          CLOSE_UNSUPPORTED
          由于接收到不允许的数据类型而断开连接 (如仅接收文本数据的终端接收到了二进制数据).
      
      
          1004
          
          保留. 其意义可能会在未来定义.
      
      
          1005
          CLOSE_NO_STATUS
          保留.  表示没有收到预期的状态码.
      
      
          1006
          CLOSE_ABNORMAL
          保留. 用于期望收到状态码时连接非正常关闭 (也就是说, 没有发送关闭帧).
      
      
          1007
          Unsupported Data
          由于收到了格式不符的数据而断开连接 (如文本消息中包含了非 UTF-8 数据).
      
      
          1008
          Policy Violation
          由于收到不符合约定的数据而断开连接. 这是一个通用状态码, 用于不适合使用 1003 和 1009 状态码的场景.
      
      
          1009
          CLOSE_TOO_LARGE
          由于收到过大的数据帧而断开连接.
      
      
          1010
          Missing Extension
          客户端期望服务器商定一个或多个拓展, 但服务器没有处理, 因此客户端断开连接.
      
      
          1011
          Internal Error
          客户端由于遇到没有预料的情况阻止其完成请求, 因此服务端断开连接.
      
      
          1012
          Service Restart
          服务器由于重启而断开连接.
      
      
          1013
          Try Again Later
          服务器由于临时原因断开连接, 如服务器过载因此断开一部分客户端连接.
      
      
          1014
          
          由 WebSocket标准保留以便未来使用.
      
      
          1015
          TLS Handshake
          保留. 表示连接由于无法完成 TLS 握手而关闭 (例如无法验证服务器证书).
      
      
          1016–1999
          
          由 WebSocket标准保留以便未来使用.
      
      
          2000–2999
          
          由 WebSocket拓展保留使用.
      
      
          3000–3999
          
          可以由库或框架使用.? 不应由应用使用. 可以在 IANA 注册, 先到先得.
      
      
          4000–4999
          
          可以由应用使用.
      
  

4. 其他注意事项
如果你的服务所在的域是HTTPS的，那么使用的WebSocket协议也必须是wss, 而不能是ws"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wdd.js.org/posts/"},{"@type":"ListItem","position":2,"name":"WebSocket断开原因分析","item":"https://wdd.js.org/posts/2018/03/websocket-close-reasons/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"WebSocket断开原因分析","name":"WebSocket断开原因分析","description":"1. 把错误打印出来 WebSocket断开的原因有很多，最好在WebSocket断开时，将错误打印出来。\n在线demo地址：https://wdd.js.org/websocket-demos/\nws.onerror = function (e) { console.log(\u0026#39;WebSocket发生错误: \u0026#39; + e.code) console.log(e) } 如果你想自己玩玩WebSocket, 但是你又不想自己部署一个WebSocket服务器，你可以使用ws = new WebSocket('wss://echo.websocket.org/'), 你向echo.websocket.org发送消息，它会回复你同样的消息。\n2. 重要信息错误状态码 WebSocket断开时，会触发CloseEvent, CloseEvent会在连接关闭时发送给使用 WebSockets 的客户端. 它在 WebSocket 对象的 onclose 事件监听器中使用。CloseEvent的code字段表示了WebSocket断开的原因。可以从该字段中分析断开的原因。\n3. 关闭状态码表 一般来说1006的错误码出现的情况比较常见，该错误码一般出现在断网时。\n状态码 名称 描述 0–999 保留段, 未使用. 1000 CLOSE_NORMAL 正常关闭; 无论为何目的而创建, 该链接都已成功完成任务. 1001 CLOSE_GOING_AWAY 终端离开, 可能因为服务端错误, 也可能因为浏览器正从打开连接的页面跳转离开. 1002 CLOSE_PROTOCOL_ERROR 由于协议错误而中断连接. 1003 CLOSE_UNSUPPORTED 由于接收到不允许的数据类型而断开连接 (如仅接收文本数据的终端接收到了二进制数据). 1004 保留. 其意义可能会在未来定义. 1005 CLOSE_NO_STATUS 保留. 表示没有收到预期的状态码. 1006 CLOSE_ABNORMAL 保留. 用于期望收到状态码时连接非正常关闭 (也就是说, 没有发送关闭帧). 1007 Unsupported Data 由于收到了格式不符的数据而断开连接 (如文本消息中包含了非 UTF-8 数据). 1008 Policy Violation 由于收到不符合约定的数据而断开连接. 这是一个通用状态码, 用于不适合使用 1003 和 1009 状态码的场景. 1009 CLOSE_TOO_LARGE 由于收到过大的数据帧而断开连接. 1010 Missing Extension 客户端期望服务器商定一个或多个拓展, 但服务器没有处理, 因此客户端断开连接. 1011 Internal Error 客户端由于遇到没有预料的情况阻止其完成请求, 因此服务端断开连接. 1012 Service Restart 服务器由于重启而断开连接. 1013 Try Again Later 服务器由于临时原因断开连接, 如服务器过载因此断开一部分客户端连接. 1014 由 WebSocket标准保留以便未来使用. 1015 TLS Handshake 保留. 表示连接由于无法完成 TLS 握手而关闭 (例如无法验证服务器证书). 1016–1999 由 WebSocket标准保留以便未来使用. 2000–2999 由 WebSocket拓展保留使用. 3000–3999 可以由库或框架使用.? 不应由应用使用. 可以在 IANA 注册, 先到先得. 4000–4999 可以由应用使用. 4. 其他注意事项 如果你的服务所在的域是HTTPS的，那么使用的WebSocket协议也必须是wss, 而不能是ws\n","keywords":["WebSocket"],"articleBody":"1. 把错误打印出来 WebSocket断开的原因有很多，最好在WebSocket断开时，将错误打印出来。\n在线demo地址：https://wdd.js.org/websocket-demos/\nws.onerror = function (e) { console.log('WebSocket发生错误: ' + e.code) console.log(e) } 如果你想自己玩玩WebSocket, 但是你又不想自己部署一个WebSocket服务器，你可以使用ws = new WebSocket('wss://echo.websocket.org/'), 你向echo.websocket.org发送消息，它会回复你同样的消息。\n2. 重要信息错误状态码 WebSocket断开时，会触发CloseEvent, CloseEvent会在连接关闭时发送给使用 WebSockets 的客户端. 它在 WebSocket 对象的 onclose 事件监听器中使用。CloseEvent的code字段表示了WebSocket断开的原因。可以从该字段中分析断开的原因。\n3. 关闭状态码表 一般来说1006的错误码出现的情况比较常见，该错误码一般出现在断网时。\n状态码 名称 描述 0–999 保留段, 未使用. 1000 CLOSE_NORMAL 正常关闭; 无论为何目的而创建, 该链接都已成功完成任务. 1001 CLOSE_GOING_AWAY 终端离开, 可能因为服务端错误, 也可能因为浏览器正从打开连接的页面跳转离开. 1002 CLOSE_PROTOCOL_ERROR 由于协议错误而中断连接. 1003 CLOSE_UNSUPPORTED 由于接收到不允许的数据类型而断开连接 (如仅接收文本数据的终端接收到了二进制数据). 1004 保留. 其意义可能会在未来定义. 1005 CLOSE_NO_STATUS 保留. 表示没有收到预期的状态码. 1006 CLOSE_ABNORMAL 保留. 用于期望收到状态码时连接非正常关闭 (也就是说, 没有发送关闭帧). 1007 Unsupported Data 由于收到了格式不符的数据而断开连接 (如文本消息中包含了非 UTF-8 数据). 1008 Policy Violation 由于收到不符合约定的数据而断开连接. 这是一个通用状态码, 用于不适合使用 1003 和 1009 状态码的场景. 1009 CLOSE_TOO_LARGE 由于收到过大的数据帧而断开连接. 1010 Missing Extension 客户端期望服务器商定一个或多个拓展, 但服务器没有处理, 因此客户端断开连接. 1011 Internal Error 客户端由于遇到没有预料的情况阻止其完成请求, 因此服务端断开连接. 1012 Service Restart 服务器由于重启而断开连接. 1013 Try Again Later 服务器由于临时原因断开连接, 如服务器过载因此断开一部分客户端连接. 1014 由 WebSocket标准保留以便未来使用. 1015 TLS Handshake 保留. 表示连接由于无法完成 TLS 握手而关闭 (例如无法验证服务器证书). 1016–1999 由 WebSocket标准保留以便未来使用. 2000–2999 由 WebSocket拓展保留使用. 3000–3999 可以由库或框架使用.? 不应由应用使用. 可以在 IANA 注册, 先到先得. 4000–4999 可以由应用使用. 4. 其他注意事项 如果你的服务所在的域是HTTPS的，那么使用的WebSocket协议也必须是wss, 而不能是ws\n5. 如何在老IE上使用原生WebSocket？ web-socket-js是基于flash的技术，只需要引入两个js文件和一个swf文件，就可以让浏览器用于几乎原生的WebSocket接口。另外，web-socket-js还是需要在ws服务端843端口做一个flash安全策略文件的服务。\n我自己曾经基于stompjs和web-socket-js，做WebSocket兼容到IE5, 当然了stompjs在低版本的IE上有兼容性问题, 而且stompjs已经不再维护了，你可以使用我fork的一个版本，地址是：https://github.com/wangduanduan/stomp-websocket/blob/master/lib/stomp.js\n主要是老版本IE在正则表达式行为方面有点异常。\n// fix ie8, ie9, RegExp not normal problem // in chrome the frames length will be 2, but in ie8, ie9, it well be 1 // by wdd 20180321 if (frames.length === 1) { frames.push('') } 6. 参考 CloseEvent getting the reason why websockets closed with close code 1006 Defined Status Codes ","wordCount":"201","inLanguage":"en","image":"https://wdd.js.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2018-03-29T20:35:38+08:00","dateModified":"2018-03-29T20:35:38+08:00","author":{"@type":"Person","name":"Eddie Wang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wdd.js.org/posts/2018/03/websocket-close-reasons/"},"publisher":{"@type":"Organization","name":"洞香春","logo":{"@type":"ImageObject","url":"https://wdd.js.org/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org/ accesskey=h title="洞香春 (Alt + H)"><img src=https://wdd.js.org/favicon.ico alt aria-label=logo height=35>洞香春</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/kamailio/ title=Kamailio><span>Kamailio</span></a></li><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wdd.js.org/>Home</a>&nbsp;»&nbsp;<a href=https://wdd.js.org/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">WebSocket断开原因分析</h1><div class=post-meta><span title='2018-03-29 20:35:38 +0800 CST'>2018-03-29 20:35:38</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;Eddie Wang&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/posts/2018/03/websocket-close-reasons.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#1-%e6%8a%8a%e9%94%99%e8%af%af%e6%89%93%e5%8d%b0%e5%87%ba%e6%9d%a5 aria-label="1. 把错误打印出来">1. 把错误打印出来</a></li><li><a href=#2-%e9%87%8d%e8%a6%81%e4%bf%a1%e6%81%af%e9%94%99%e8%af%af%e7%8a%b6%e6%80%81%e7%a0%81 aria-label="2. 重要信息错误状态码">2. 重要信息错误状态码</a></li><li><a href=#3-%e5%85%b3%e9%97%ad%e7%8a%b6%e6%80%81%e7%a0%81%e8%a1%a8 aria-label="3. 关闭状态码表">3. 关闭状态码表</a></li><li><a href=#4-%e5%85%b6%e4%bb%96%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9 aria-label="4. 其他注意事项">4. 其他注意事项</a></li><li><a href=#5-%e5%a6%82%e4%bd%95%e5%9c%a8%e8%80%81ie%e4%b8%8a%e4%bd%bf%e7%94%a8%e5%8e%9f%e7%94%9fwebsocket aria-label="5. 如何在老IE上使用原生WebSocket？">5. 如何在老IE上使用原生WebSocket？</a></li><li><a href=#6-%e5%8f%82%e8%80%83 aria-label="6. 参考">6. 参考</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=1-把错误打印出来>1. 把错误打印出来<a hidden class=anchor aria-hidden=true href=#1-把错误打印出来>#</a></h1><p>WebSocket断开的原因有很多，最好在WebSocket断开时，将错误打印出来。</p><p>在线demo地址：https://wdd.js.org/websocket-demos/</p><p><img loading=lazy src=https://wdd.js.org/img/images/20180425112232_cxPVAD_Jietu20180425-112142.jpeg></p><pre tabindex=0><code>ws.onerror = function (e) {
  console.log(&#39;WebSocket发生错误: &#39; + e.code)
  console.log(e)
}
</code></pre><blockquote><p>如果你想自己玩玩WebSocket, 但是你又不想自己部署一个WebSocket服务器，你可以使用<code>ws = new WebSocket('wss://echo.websocket.org/')</code>, 你向echo.websocket.org发送消息，它会回复你同样的消息。</p></blockquote><h1 id=2-重要信息错误状态码>2. 重要信息错误状态码<a hidden class=anchor aria-hidden=true href=#2-重要信息错误状态码>#</a></h1><p>WebSocket断开时，会触发<code>CloseEvent</code>, CloseEvent会在连接关闭时发送给使用 WebSockets 的客户端. 它在 WebSocket 对象的 onclose 事件监听器中使用。CloseEvent的code字段表示了WebSocket断开的原因。可以从该字段中分析断开的原因。</p><p><img loading=lazy src=https://wdd.js.org/img/images/20180329204553_TjCFdu_Jietu20180329-204536.jpeg></p><h1 id=3-关闭状态码表>3. 关闭状态码表<a hidden class=anchor aria-hidden=true href=#3-关闭状态码表>#</a></h1><p>一般来说<code>1006</code>的错误码出现的情况比较常见，该错误码一般出现在断网时。</p><table><thead><tr><th>状态码</th><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>0–999</td><td></td><td>保留段, 未使用.</td></tr><tr><td>1000</td><td>CLOSE_NORMAL</td><td>正常关闭; 无论为何目的而创建, 该链接都已成功完成任务.</td></tr><tr><td>1001</td><td>CLOSE_GOING_AWAY</td><td>终端离开, 可能因为服务端错误, 也可能因为浏览器正从打开连接的页面跳转离开.</td></tr><tr><td>1002</td><td>CLOSE_PROTOCOL_ERROR</td><td>由于协议错误而中断连接.</td></tr><tr><td>1003</td><td>CLOSE_UNSUPPORTED</td><td>由于接收到不允许的数据类型而断开连接 (如仅接收文本数据的终端接收到了二进制数据).</td></tr><tr><td>1004</td><td></td><td><code>保留</code>. 其意义可能会在未来定义.</td></tr><tr><td>1005</td><td>CLOSE_NO_STATUS</td><td><code>保留</code>. 表示没有收到预期的状态码.</td></tr><tr><td><code>1006</code></td><td>CLOSE_ABNORMAL</td><td><code>保留</code>. 用于期望收到状态码时连接非正常关闭 (也就是说, 没有发送关闭帧).</td></tr><tr><td>1007</td><td>Unsupported Data</td><td>由于收到了格式不符的数据而断开连接 (如文本消息中包含了非 UTF-8 数据).</td></tr><tr><td>1008</td><td>Policy Violation</td><td>由于收到不符合约定的数据而断开连接. 这是一个通用状态码, 用于不适合使用 1003 和 1009 状态码的场景.</td></tr><tr><td>1009</td><td>CLOSE_TOO_LARGE</td><td>由于收到过大的数据帧而断开连接.</td></tr><tr><td>1010</td><td>Missing Extension</td><td>客户端期望服务器商定一个或多个拓展, 但服务器没有处理, 因此客户端断开连接.</td></tr><tr><td>1011</td><td>Internal Error</td><td>客户端由于遇到没有预料的情况阻止其完成请求, 因此服务端断开连接.</td></tr><tr><td>1012</td><td>Service Restart</td><td>服务器由于重启而断开连接.</td></tr><tr><td>1013</td><td>Try Again Later</td><td>服务器由于临时原因断开连接, 如服务器过载因此断开一部分客户端连接.</td></tr><tr><td>1014</td><td></td><td>由 WebSocket标准保留以便未来使用.</td></tr><tr><td>1015</td><td>TLS Handshake</td><td>保留. 表示连接由于无法完成 TLS 握手而关闭 (例如无法验证服务器证书).</td></tr><tr><td>1016–1999</td><td></td><td>由 WebSocket标准保留以便未来使用.</td></tr><tr><td>2000–2999</td><td></td><td>由 WebSocket拓展保留使用.</td></tr><tr><td>3000–3999</td><td></td><td>可以由库或框架使用.? 不应由应用使用. 可以在 IANA 注册, 先到先得.</td></tr><tr><td>4000–4999</td><td></td><td>可以由应用使用.</td></tr></tbody></table><h1 id=4-其他注意事项>4. 其他注意事项<a hidden class=anchor aria-hidden=true href=#4-其他注意事项>#</a></h1><p>如果你的服务所在的域是HTTPS的，那么使用的WebSocket协议也必须是<code>wss</code>, 而不能是<code>ws</code></p><h1 id=5-如何在老ie上使用原生websocket>5. 如何在老IE上使用原生WebSocket？<a hidden class=anchor aria-hidden=true href=#5-如何在老ie上使用原生websocket>#</a></h1><p><a href=https://github.com/gimite/web-socket-js>web-socket-js</a>是基于flash的技术，只需要引入两个js文件和一个swf文件，就可以让浏览器用于几乎原生的WebSocket接口。另外，web-socket-js还是需要在ws服务端843端口做一个flash安全策略文件的服务。</p><p>我自己曾经基于stompjs和web-socket-js，做WebSocket兼容到IE5, 当然了stompjs在低版本的IE上有兼容性问题, 而且stompjs已经不再维护了，你可以使用我fork的一个版本，地址是：https://github.com/wangduanduan/stomp-websocket/blob/master/lib/stomp.js</p><p>主要是老版本IE在正则表达式行为方面有点异常。</p><pre tabindex=0><code>
      // fix ie8, ie9, RegExp not normal problem
      // in chrome the frames length will be 2, but in ie8, ie9, it well be 1
      // by wdd 20180321
      if (frames.length === 1) {
        frames.push(&#39;&#39;)
      }
</code></pre><h1 id=6-参考>6. 参考<a hidden class=anchor aria-hidden=true href=#6-参考>#</a></h1><ul><li><a href=https://developer.mozilla.org/zh-CN/docs/Web/API/CloseEvent>CloseEvent</a></li><li><a href=https://stackoverflow.com/questions/19304157/getting-the-reason-why-websockets-closed-with-close-code-1006>getting the reason why websockets closed with close code 1006</a></li><li><a href=https://tools.ietf.org/html/rfc6455#section-7.4.1>Defined Status Codes</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://wdd.js.org/tags/websocket/>WebSocket</a></li></ul><nav class=paginav><a class=prev href=https://wdd.js.org/posts/2018/04/express-static-file-cache-setting-and-cleaning/><span class=title>« Prev</span><br><span>Express静态文件浏览器缓存设置与缓存清除</span>
</a><a class=next href=https://wdd.js.org/posts/2018/03/js-true-and-false-value/><span class=title>Next »</span><br><span>js中的真值和假值</span></a></nav></footer><script src=https://giscus.app/client.js data-repo=wangduanduan/wangduanduan.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxMTkyMjMyNjA=" data-category=Announcements data-category-id=DIC_kwDOBxsz3M4CAjBq data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2025 <a href=https://wdd.js.org/>洞香春</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>