<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Posts | 洞香春</title><meta name=keywords content><meta name=description content="Posts - 洞香春"><meta name=author content="Eddie Wang"><link rel=canonical href=https://wdd.js.org/posts/><link crossorigin=anonymous href=/assets/css/stylesheet.a2acda249b8eac62938bb2d2f1c562c5f74d5728640d2a1a7d6aeaec5c50ef24.css integrity="sha256-oqzaJJuOrGKTi7LS8cVixfdNVyhkDSoafWrq7FxQ7yQ=" rel="preload stylesheet" as=style><link rel=icon href=https://wdd.js.org/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://wdd.js.org/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://wdd.js.org/favicon.ico><link rel=apple-touch-icon href=https://wdd.js.org/favicon.ico><link rel=mask-icon href=https://wdd.js.org/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://wdd.js.org/posts/index.xml title=rss><link rel=alternate hreflang=en href=https://wdd.js.org/posts/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/firacode@6.2.0/distr/fira_code.css><style>body{font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,helvetica neue,Arial,noto sans,sans-serif,apple color emoji,segoe ui emoji;font-size:16px;line-height:1.6;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}h1,h2,h3,h4,h5,h6{font-weight:600;letter-spacing:-.02em}code,pre{font-family:fira code,jetbrains mono,Consolas,monospace;font-variant-ligatures:normal;font-size:.95em}</style><meta property="og:url" content="https://wdd.js.org/posts/"><meta property="og:site_name" content="洞香春"><meta property="og:title" content="Posts"><meta property="og:description" content="Eddie Wang的个人博客"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta name=twitter:card content="summary"><meta name=twitter:title content="Posts"><meta name=twitter:description content="Eddie Wang的个人博客"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wdd.js.org/posts/"}]}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wdd.js.org/ accesskey=h title="洞香春 (Alt + H)"><img src=https://wdd.js.org/favicon.ico alt aria-label=logo height=35>洞香春</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wdd.js.org/opensips/ title=OpenSIPS><span>OpenSIPS</span></a></li><li><a href=https://wdd.js.org/kamailio/ title=Kamailio><span>Kamailio</span></a></li><li><a href=https://wdd.js.org/freeswitch/ title=FreeSWITCH><span>FreeSWITCH</span></a></li><li><a href=https://wdd.js.org/books/ title=读书><span>读书</span></a></li><li><a href=https://wdd.js.org/vim/ title=VIM><span>VIM</span></a></li><li><a href=https://wdd.js.org/fe/ title=前端><span>前端</span></a></li><li><a href=https://wdd.js.org/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wdd.js.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://wdd.js.org/archives/ title=归档><span>归档</span></a></li><li><a href=https://wdd.js.org/about/ title=我><span>我</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://wdd.js.org/>Home</a></div><h1>Posts</h1></header><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>天下苦 VOS 久矣</h2></header><div class=entry-content><p>天下苦 VOS 久矣。 此言非怒而发，乃久用之后，积怨成理也。
VOS3x、VOS5x，曾有其功。 当年软交换荒芜，SIP 规范未成体系，工程师多凭经验行事。VOS 以一套封装良好的系统，解“能跑”之急，立一时之功，不可不认。
然功成之后，不思进化； 市占既稳，便少革新。
天下之患，莫大于此。
一、垄断既久，问题反成常态 今之 VOS，已非“可选方案”，而成“默认答案”。
选型之时，不问架构，只问“是不是 VOS”； 排障之时，不查协议，只等“厂商回复”。
于是，奇景频出：
SIP 行为异于 RFC，而曰“产品设计如此” 性能瓶颈不可测，而曰“经验上差不多” 复杂需求难以实现，而曰“VOS 不支持” 简单需求可实现，而曰“得加钱” 故障定位止于日志，而曰“已提交工单” 久而久之， 问题不再被解决， 只是被习惯。
二、用 VOS，工程师何其卑微 用 VOS 者，常有此感：
系统在跑， 却不知为何如此跑； 问题已现， 却不知从何而断。
工程师所做者，不过：
点配置 调参数 猜行为 等回复 软交换本该是工程， 却活成了玄学。
三、OpenSIPS / Kamailio：让系统“讲人话” 或问：
“不用 VOS，又当用谁？”
曰：OpenSIPS，Kamailio。
二者之道，不在“省钱”，而在透明：
SIP 即 SIP，不自创私货 路由即代码，行为白纸黑字 性能可压测，瓶颈可定位 出问题先看脚本，而非先写邮件 在此体系之中， 系统不再“猜你想要什么”， 而是“严格执行你所写之逻辑”。
这是工程， 不是占卜。
四、开源之苦，在前；开源之利，在后 诚然，OpenSIPS / Kamailio 不好上手。 学习曲线陡峭，踩坑在所难免。
...</p></div><footer class=entry-footer><span title='2026-01-06 19:00:15 +0800 CST'>2026-01-06 19:00:15</span>&nbsp;·&nbsp;<span>1 min</span>&nbsp;·&nbsp;<span>Eddie Wang</span></footer><a class=entry-link aria-label="post link to 天下苦 VOS 久矣" href=https://wdd.js.org/posts/2026/the-voip-world-has-suffered-from-vos-for-too-long/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>SipWise C5 架构分析 WIP</h2></header><div class=entry-content><p>SIPWISE C5 架构分析 Sipwise C5（又称NGCP——下一代通信平台）是一款基于SIP的开源Class 5 VoIP软交换平台
整体架构上，sipwise C5 是一个三明治架构， 除了sipwise, 我也看到过类似的VoIP架构， 可见英雄所见略同。
接入层 接入层是整个平台的信令出入口，主要的职责是安全检测和负载均衡。 并不具有业务上的功能，另外也不会使用数据库。
职责
外部SIP信令的入口和内部信令的出口 SIP信令完整性检查 拒绝环回SIP信令 DOS攻击检测 暴力攻击检测 TLS转UDP转换 NAT穿透映射 端口
5060, SIP/TCP+UDP, 对外接收SIP消息 5061, SIP/TLS， 对外接收TLS消息 5060, XMLRPC/TCP, 对内处理RPC调用，来控制kamailio 这里有个风险，5060/TCP端口同时用来对外处理SIP消息和对接处理RPC调用，难道
实现
参考 https://www.sipwise.com/doc/mr6.5.8/sppro/ar01s02.html https://www.sipwise.com/doc/mr10.3.1/spce/ce/mr10.3.1/architecture/architecture.html</p></div><footer class=entry-footer><span title='2025-10-16 17:39:50 +0800 CST'>2025-10-16 17:39:50</span>&nbsp;·&nbsp;<span>1 min</span>&nbsp;·&nbsp;<span>Eddie Wang</span></footer><a class=entry-link aria-label="post link to SipWise C5 架构分析 WIP" href=https://wdd.js.org/posts/2025/sipwise-c5-arch/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>使用m4给opensips脚本增加预处理能力</h2></header><div class=entry-content><p>demo 代码仓库 ： https://cnb.cool/eddie2072/opensips-forum/-/tree/main/how-to-use-m4
使用m4给opensips脚本增加预处理能力 为什么要预处理？ 运维便利。有预处理，脚本里的IP地址，端口，密码，用户名等信息，可以由运维人员统一配置，脚本只需要引用配置文件，就可以完成脚本的运行。否则，运维人员只能手工去修改每个配置写死的地方。容易出错，且非常麻烦。 所以，我们在写脚本的时候，需要从脚本中抽离配置性质的数据。例如监听的IP地址，端口，数据库的用户名和密码等信息。
这样脚本就变层两个部份，配置文件 + 脚本本身。
运维人员只需要修改配置文件就可以。 以本demo为例子， 运维在线上部署脚本，只需要修改env.prd.m4文件就可以。
预处理可以增加脚本的复用性。 不同环境，往往需要的功能不同。A环境需要X功能，B环境不需要X功能，那么怎么维护呢。 不用怕，有了m4条件分支，可以根据不同不配置，渲染出不同的结果。
m4基本在所有linux都已经安装好了，不用额外在安装依赖。 很多有经验的程序员，往往也不知道什么是m4, 其实大名顶顶的autoconf, 底层就依赖了m4。
m4难不难学？ m4语法简单，语法强大，但是我们能用到的，基本不超过5个语法。
定义宏 下面是定义宏的语法，这样写之后，所有字符串ENV_LISTEN_IP都会被替换为127.0.0.1
define(ENV_LISTEN_IP, 127.0.0.1) 引用其他文件 有了引用，我们就不需要把所有功能放到一个大文件中。
include(&lt;&lt;src/loadmodule.m4>>) include(&lt;&lt;src/request.m4>>) include(&lt;&lt;src/relay.m4>>) include(&lt;&lt;src/per_branch_ops.m4>>) include(&lt;&lt;src/handle_nat.m4>>) include(&lt;&lt;src/missed_call.m4>>) ifelse(cond1,cond2, yes, no) 如果cond1和cond2相同，则展开第三个参数yes, 否则展开第四个参数no
ifelse(ENV_ENABLE_NAT,yes,use nat, not use nat) 引号 引号，就是用来告诉m4, 引号里的内容应该看作是一个整体。
m4默认的引号是``’’, 看起来很怪异，很难从视觉上做配对。 所有有强迫症，或者视觉洁癖的人，会非常讨厌m4。
define(`ENV_LISTEN_IP', `127.0.0.1') 但是这个引号是可以修改的，我们用changequote去修改默认的引号, 将引号改为&lt;&lt;>>
changequote(&lt;&lt;,>>) define(&lt;&lt;ENV_LISTEN_IP>>, &lt;&lt;127.0.0.1>>) 如何调试宏, 使用-dV 参数 m4 -dV opensips.m4 解决宏冲突问题 如果脚本里有个变量和m4的宏名字冲突，那么往往会出现一些怪异的问题。
m4早就想到了解决方案， 在执行m4时候，可以加上-P参数，m4所有内置的宏就会必须写成以m4_开头。 例如
m4_define(&lt;&lt;ENV_LISTEN_IP>>, &lt;&lt;127.0.0.1>>) m4 -P opensips.m4 m4的劣势 m4没有类似foreach的循环，但是可以通过m4的递归实现。 m4做简单的字符串替换，但是对于复杂字符串处理，m4的效率会比较低，而且语法比较复杂。 但是对于处理opensips的配置文件，m4则是刚刚好的完美工具。 有意思的几个扩展 检查宏是否未定义，或者是否为空字符串，空则报错退出 m4_divert(-1) m4_define(&lt;&lt;ASSERT_NOT_EMPTY>>,&lt;&lt; m4_ifelse($1,,&lt;&lt; m4_errprint(&lt;&lt;$1 is empty >>) m4_m4exit(1) >>,) >>) m4_divert(0)m4_dnl ASSERT_NOT_EMPTY(this_is_empty) foreach 循环 m4_changequote(&lt;&lt;,>>)m4_dnl m4_divert(-1) m4_define(&lt;&lt;X_FOREACH>>, &lt;&lt;m4_pushdef(&lt;&lt;$1>>)_foreach($@)m4_popdef(&lt;&lt;$1>>)>>) m4_define(&lt;&lt;_arg1>>, &lt;&lt;$1>>) m4_define(&lt;&lt;_foreach>>, &lt;&lt;m4_ifelse(&lt;&lt;$2>>, &lt;&lt;()>>, &lt;&lt;>>, &lt;&lt;m4_define(&lt;&lt;$1>>, _arg1$2)$3&lt;&lt;>>$0(&lt;&lt;$1>>, (m4_shift$2), &lt;&lt;$3>>)>>)>>) m4_divert(0)m4_dnl X_FOREACH(x,(a.com,b.com,c.com), alias=udp:x ) 上面会输出
...</p></div><footer class=entry-footer><span title='2025-08-02 11:17:08 +0800 CST'>2025-08-02 11:17:08</span>&nbsp;·&nbsp;<span>1 min</span>&nbsp;·&nbsp;<span>Eddie Wang</span></footer><a class=entry-link aria-label="post link to 使用m4给opensips脚本增加预处理能力" href=https://wdd.js.org/posts/2025/m4-with-opensips/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>【案例分享】JSSIP 电话无法挂断问题</h2></header><div class=entry-content><p>当听到分机无法挂断电话时，通常有以下几种可能的原因：
在做Record-Route时，使用了错误的内外网IP地址。导致BYE请求按照route头发送时，无法正确找到对应的服务器。 Contact头部的URI不正确，导致BYE请求无法找到对应的服务器。 时序图如下；
sequenceDiagram autonumber participant u1 as user1 participant o as opensips participant u2 as user2 u1->>o: INVITE o->>u2: INVITE u2-->>o: 200 OK o-->>u1: 200 OK u1->>o: ACK o->>u2: ACK u2->>o: BYE o-->>u2: 477 Send failed (477/TM) 477错误一般是按照route头或者contact转发时，找不到对应的socket。 在使用tcp作为传输协议时，例如tcp/tls/wss注册的分机比较常见。
有以下可能
分机到opensips的tcp连接断开 contact使用错误的transport参数 从过观察第2个信令的Conact头，发现transport=ws, User-Agent=JSSip。 正常情况下，jssip应该使用wss作为transport。
所以解决办法是，在jssip的配置中，将transport改为wss。
还有一个解决方案， 就是让jssip通过nginx转发wss请求，让nginx转发到opensips的ws端口, 也能解决问题。
sequenceDiagram autonumber jssip ->> nginx: wss nginx ->> opensips: ws</p></div><footer class=entry-footer><span title='2025-07-15 20:00:08 +0800 CST'>2025-07-15 20:00:08</span>&nbsp;·&nbsp;<span>1 min</span>&nbsp;·&nbsp;<span>Eddie Wang</span></footer><a class=entry-link aria-label="post link to 【案例分享】JSSIP 电话无法挂断问题" href=https://wdd.js.org/posts/2025/jssip-can-not-drop-call/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>【案例分享】外线呼入，SIP分机为何无响应？</h2></header><div class=entry-content><p>案例分享 最近有客户反馈，自己的话机最近一两周都没有收到来电了，感觉很奇怪，他自己呼叫400号码，然后转分机，也接不通。
组网结构 flowchart LR ua1(分机) fw1(防火墙) uas1(SIP服务器) ua1 --> fw1 fw1 --> uas1 排查思路 首先排查服务端，从日志来看，分机的注册是正常的，每隔30多秒就注册一次。 然后排查呼叫信令图，发现发送给分机的INVITE， 分机那边没有任何反应 接着请求客户远程协助，在分机上抓包，发现只能抓到注册包，没有INVITE的回应。 询问客户，他们公司有没有使用防火墙，客户说有。 然后让客户检查他们防火墙的设置，关闭SIP ALG功能，但是也无效 然后让客户找网络负责人，在防火墙上抓包，发现防火墙收到了INVITE，但是没有转发给内部分机, 原因未知 最后找防火墙厂商，发现是防火墙的UDP组包没有开启，开启UDP分片重组后，呼入电话能正常进线 总结 此刻，我回想起曾经写的 UDP分片导致SIP消息丢失
没想到，在防火墙上也遇到了同样的问题。</p></div><footer class=entry-footer><span title='2025-07-15 19:39:57 +0800 CST'>2025-07-15 19:39:57</span>&nbsp;·&nbsp;<span>1 min</span>&nbsp;·&nbsp;<span>Eddie Wang</span></footer><a class=entry-link aria-label="post link to 【案例分享】外线呼入，SIP分机为何无响应？" href=https://wdd.js.org/posts/2025/ua-not-answer/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>RTPEngine 录制 PCAP 文件</h2></header><div class=entry-content><p>为什要用 RTPEngine 来录制 PCAP 文件？ 一般我们用 Freeswitch 来作为录音服务器， 但是某些场景，例如备份录音，需要在不同节点进行录音。
如果直接录制成 wav 文件，那么比较占用资源，而且备份录音用的几率也是比较小的。
因此录制成 PCAP 文件，可以节省资源，后期 pcap 转语音也能比较容易的实现。
实现步骤 配置rtpengine启动参数 --pcaps-dir=/var/log/records --record-method=pcap --recording-format=eht 在opensips在做SDP Offer rtpengine_offer("record-call=yes"); 录音文件位置 录音文件在/var/log/records目录下，文件名是呼叫的sip Call-ID-16hex随机数.pcap
call1-1234567890abcdef.pcap call2-1234567890abcdef.pcap 录音文件内容 录音文件用wireshark分析，可以听到主被叫双方的声音。
其他 除了录音文件，一些录音的元数据，例如SDP之类的信息，会被记录到录音的目录下。</p></div><footer class=entry-footer><span title='2025-07-15 19:26:06 +0800 CST'>2025-07-15 19:26:06</span>&nbsp;·&nbsp;<span>1 min</span>&nbsp;·&nbsp;<span>Eddie Wang</span></footer><a class=entry-link aria-label="post link to RTPEngine 录制 PCAP 文件" href=https://wdd.js.org/posts/2025/rtpengine-record-pcap/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>SIP安全 - DTLS client Hello 攻击白皮书</h2></header><div class=entry-content><p>TL;DR 攻击者伪造DTLS ClientHello消息，在SIP服务器和客户端之间建立一个非预期的连接。导致正常链接被阻断。 影响软件 FreeSWITCH RTPengine asterisk FreePBX 漏洞白皮书 webrtc-hello-race-conditions-paper
表现 应答后呼叫无声 参考 https://github.com/EnableSecurity/advisories/tree/master/ES2023-03-rtpengine-dtls-hello-race https://github.com/EnableSecurity/advisories/tree/master/ES2023-02-freeswitch-dtls-hello-race https://github.com/EnableSecurity/advisories/tree/master/ES2023-03-rtpengine-dtls-hello-race</p></div><footer class=entry-footer><span title='2025-07-14 23:13:23 +0800 CST'>2025-07-14 23:13:23</span>&nbsp;·&nbsp;<span>1 min</span>&nbsp;·&nbsp;<span>Eddie Wang</span></footer><a class=entry-link aria-label="post link to SIP安全 - DTLS client Hello 攻击白皮书" href=https://wdd.js.org/posts/2025/dtls-hello-attack/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>OpenSIPS Summit 2025 速看</h2></header><div class=entry-content><p>2025 年 5 月 27 - 5 月 30 日, OpenSIPS Summit 2025 在荷兰阿姆斯特丹举行。
最近我才有时间，看完所有的会议资料，包括 PDF 和 PPT。
下面是我整理的，认为比较有价值的一些内容。以飨读者。
1. 加强 SDP 处理 对 SDP 的处理，如果用 OpenSIPS 脚本来做，将会非常蹩脚。 生产环境一般都是使用 rtpengine 或者 rtpproxy 来处理。
但是，最近的 OpenSIPS 版本，已经可以支持 SDP 处理了。 可以直接在 OpenSIPS 脚本里处理 SDP。
说实话，我看了新的方案，我觉得，还不如用 rtpengine 或者 rtpproxy。
但是聊胜于无吧，感兴趣的可以看看原文。
OpenSIPS Summit 2025 - Liviu Chircu - Enhanced Media Operations with Structured SDP
除此以外，PDF 也提到一些有趣的事情，比如 SDP 随着时间推移，增强和很多功能，包也变得越来越大
时期 内容 包大小 1998 基本媒体行 200-400 bytes 2002 编码协商，rtpmap 500-1000 bytes 2010 ICE/DTLS 1-2 kb 2015 WebRTC, Simulcast, Bound, MID 2-3kb 在线会议，SFU 3-5 kb 可以想象，随着媒体能力的增强，UDP包的SIP信令中的分片几乎成为必然，所以，是否可以考虑有限使用TCP/TLS来传输信令呢？
...</p></div><footer class=entry-footer><span title='2025-07-14 21:52:23 +0800 CST'>2025-07-14 21:52:23</span>&nbsp;·&nbsp;<span>1 min</span>&nbsp;·&nbsp;<span>Eddie Wang</span></footer><a class=entry-link aria-label="post link to OpenSIPS Summit 2025 速看" href=https://wdd.js.org/posts/2025/opensips-summit-2025/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>RTPEngine STUN包处理流程
<span class=entry-hint title=Draft><svg height="20" viewBox="0 -960 960 960" fill="currentColor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h2></header><div class=entry-content><p>STUN 请求处理 flowchart TD __wildcard_endpoint_map-->__assign_stream_fds monologue_offer_answer-->__assign_stream_fds monologue_publish-->__assign_stream_fds monologue_subscribe_request1-->__assign_stream_fds call_make_transform_media-->__assign_stream_fds __wildcard_endpoint_map -->__get_endpoint_map monologue_offer_answer -->__get_endpoint_map monologue_publish -->__get_endpoint_map monologue_subscribe_request1 -->__get_endpoint_map call_make_transform_media -->__get_endpoint_map __assign_stream_fds --> stream_fd_new __get_endpoint_map --> stream_fd_new stream_fd_new --> stream_fd_recv stream_fd_new-->stream_fd_readable stream_fd_readable-->__stream_fd_readable stream_fd_recv--> __stream_fd_readable--> stream_packet--> media_demux_protocols --> stun --> __stun_request --> ice_request 从SDP Offer之后，stream_fd_new 函数里做了几个事件订阅， 当对应的的媒体端口收到包之后，这个包可能是好几种协议，例如RTP, DTLS, STUN等。
在media_demux_protocols() 中决定了这个包是以上包的哪一种， 如果是STUN包，则进入stun()中处理。
STUN包也分为请求和响应，当消息是响应时，进入ice_request().
1int ice_request(stream_fd *sfd, const endpoint_t *src, 2 struct stun_attrs *attrs) 3{ 4 struct packet_stream *ps = sfd->stream; 5 struct call_media *media = ps->media; 6 struct ice_agent *ag; 7 const char *err; 8 struct ice_candidate *cand; 9 struct ice_candidate_pair *pair; 10 int ret; 11 12 ilogs(ice, LOG_DEBUG, "Received ICE/STUN request from %s on %s", 13 endpoint_print_buf(src), 14 endpoint_print_buf(&amp;sfd->socket.local)); flowchart TD ice_update-->__do_ice_checks ice_agents_timer_run-->__do_ice_checks __do_ice_checks --> __do_ice_check</p></div><footer class=entry-footer><span title='2025-07-03 22:26:35 +0800 CST'>2025-07-03 22:26:35</span>&nbsp;·&nbsp;<span>1 min</span>&nbsp;·&nbsp;<span>Eddie Wang</span></footer><a class=entry-link aria-label="post link to RTPEngine STUN包处理流程" href=https://wdd.js.org/posts/2025/rtpengine-stun-flow/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>DTLS协商失败导致无声问题</h2></header><div class=entry-content><p>1. 简介 DTLS（Datagram Transport Layer Security，数据报传输层安全协议）是一种为基于数据报的应用（如UDP）提供安全通信的协议。它是TLS（传输层安全协议）的扩展，专门设计用于不可靠的传输协议（如UDP），以实现数据加密、身份认证和消息完整性保护。DTLS常用于VoIP、视频会议、WebRTC等实时通信场景。
DTLS在WebRTC音视频中是强制必须使用的，否则媒体协商阶段就会失败。
使用DTLS后，就算中间人从网络中抓包，抓到了RTP流，在播放RTP流时，里面也全是噪声，无法播放的。
今天要讲的是就是DTLS协商失败导致电话即使接通，也无声的问题。
2. 网络结构说明 UAS: sip server, OpenSIPS + RTPEngine组成 UAC: WebRTC 分机 F1. UAS ----> UAC: INVITE (SDP) F2. UAS &lt;---- UAC: 180 F3. UAS &lt;---- UAC: 200 Ok (SDP) F4. UAS ----> UAC: ACK 从SIP信令上看，被叫应答后，UAS和UAC之间的双向媒体流应该建立起来，但是实际上却无声。
3. ICE/STUN/DTLS ICE: WebRTC中的ICE（Interactive Connectivity Establishment，交互式连接建立）是一种网络协议，用于帮助WebRTC客户端在不同网络环境下建立点对点（P2P）连接。ICE的主要作用是解决NAT穿透和防火墙问题，使两个终端能够找到最佳的通信路径。 STUN: WebRTC中的STUN（Session Traversal Utilities for NAT，NAT会话穿越实用工具）是一种网络协议，主要用于帮助客户端发现自己的公网IP地址和端口。由于很多设备处于NAT（网络地址转换）或防火墙之后，直接通信会遇到障碍，STUN可以让客户端知道外部网络如何访问自己 在分机应答后，并在WebRTC发送本地媒体流前，还需要两个步骤协商完成UAC才会发送语音流
3.1 STUN协商 UAC收到来自UAS的SDP, 里面一般有如下内容
m=audio 54322 UDP/TLS/RTP/SAVPF 111 0 8 a=ice-ufrag:abcd a=ice-pwd:1234567890abcdef a=ice-options:trickle a=fingerprint:sha-256 12:34:56:78:90:AB:CD:EF:12:34:56:78:90:AB:CD:EF:12:34:56:78:90:AB:CD:EF:12:34:56:78:90:AB:CD:EF a=setup:actpass a=candidate:1 1 udp 2130706431 1.2.3.4 54322 typ host STUN是一个请求响应模型的协议。UAC将会向a=candidate里的1.2.3.4:54322 发送UDP消息
...</p></div><footer class=entry-footer><span title='2025-06-24 21:06:11 +0800 CST'>2025-06-24 21:06:11</span>&nbsp;·&nbsp;<span>2 min</span>&nbsp;·&nbsp;<span>Eddie Wang</span></footer><a class=entry-link aria-label="post link to DTLS协商失败导致无声问题" href=https://wdd.js.org/posts/2025/dtls-negotiation-failed-no-audio/></a></article><footer class=page-footer><nav class=pagination><a class=next href=https://wdd.js.org/posts/page/2/>Next&nbsp;&nbsp;»</a></nav></footer></main><footer class=footer><span>&copy; 2026 <a href=https://wdd.js.org/>洞香春</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>